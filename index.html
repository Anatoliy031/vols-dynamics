<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ВОЛС — Еженедельная динамика (АО «Россети Кубань»)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{--rs-blue:#0033A0;--rs-light:#f4f7fb;--border:#e7edf5;--ok:#0a7a2d;--bad:#b00020;--muted:#5f6b7a;--card:#fff}
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--rs-light);color:#0b1a2b;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--rs-blue),#0953d6);color:#fff;padding:18px 20px;box-shadow:0 4px 18px rgba(0,0,0,.08)}
  .brand{display:flex;gap:14px;align-items:center;font-weight:800}
  .dot{width:14px;height:14px;border-radius:50%;background:#fff;opacity:.9}
  .container{max-width:1200px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px 16px}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  @media(max-width:1024px){.grid.cols-3{grid-template-columns:1fr}}
  @media(max-width:720px){.grid.cols-2{grid-template-columns:1fr}}
  .inputs{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:10px;border:1px dashed var(--border);background:#fff;border-radius:12px;padding:12px}
  input[type=file]{border:none}
  button.primary{background:var(--rs-blue);color:#fff;border:none;border-radius:12px;padding:12px 14px;font-weight:700;letter-spacing:.2px;cursor:pointer}
  button.secondary{background:#fff;color:#0033A0;border:1px solid #0033A0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
  h2{margin:4px 0 10px 0;font-size:20px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#f8fafc;color:#334155}
  .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
  @media(max-width:1024px){.kpis{grid-template-columns:repeat(2,1fr)}}
  .kpi{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .kpi .title{color:var(--muted);font-size:12px;font-weight:600}
  .kpi .value{font-size:24px;font-weight:800;margin-top:6px}
  .delta{font-size:12px;margin-top:4px}
  .up{color:var(--ok)} .down{color:var(--bad)} .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:right;font-variant-numeric:tabular-nums}
  th:first-child,td:first-child{text-align:left}
  tfoot td{font-weight:800}
  .exports{display:flex;flex-wrap:wrap;gap:10px}
  .hr{height:1px;background:var(--border);margin:12px 0}
  #presentationPrint,#summaryPrint{background:#fff;padding:20px}
  .logoTitle{font-weight:800;color:#0033A0;font-size:22px;margin-bottom:6px}
  .note{font-size:12px;color:#5f6b7a}
  .loading{display:none;color:#0033A0;font-weight:600;margin-top:10px}
  .loading.active{display:block}
  .error{color:#b00020;font-weight:600;margin-top:10px}
</style>
</head>
<body>
<header><div class="brand"><span class="dot"></span><span>АО «Россети Кубань» — ВОЛС: аналитика и отчётность</span></div></header>

<div class="container grid cols-2">
  <section class="card">
    <h2>Загрузка отчётов (PDF)</h2>
    <div class="inputs">
      <label class="pill">Предыдущая неделя (PDF)<input id="filePrev" type="file" accept="application/pdf"></label>
      <label class="pill">Текущая неделя (PDF)<input id="fileCurr" type="file" accept="application/pdf"></label>
      <button id="btnParse" class="primary">Проанализировать</button>
    </div>
    <div class="loading" id="loadingMsg">Обработка PDF файлов...</div>
    <div class="error" id="errorMsg"></div>
    <div class="hr"></div>
    <div id="dates" class="note">Даты отчётов: —</div>
    <div class="note" style="margin-top:6px">«Выявлено за неделю» = «В работе всего, шт.» (текущая − предыдущая).</div>
  </section>
  <section class="card">
    <h2>Выгрузки (формат Россети)</h2>
    <div class="exports">
      <button class="secondary" id="exportPresPDF">Скачать презентацию (PDF)</button>
      <button class="secondary" id="exportPresPPTX">Скачать презентацию (PPTX)</button>
      <button class="secondary" id="exportBriefDOCX">Скачать выжимку (Word)</button>
      <button class="secondary" id="exportBriefPDF">Скачать выжимку (PDF)</button>
    </div>
    <div class="note" id="exportStatus" style="margin-top:6px"></div>
  </section>
</div>

<div class="container card">
  <h2>Ключевые показатели</h2>
  <div id="kpis" class="kpis"></div>
</div>

<div class="container grid cols-2">
  <section class="card">
    <h2>Стр. 2 — «Всего опор, шт.» по филиалам</h2>
    <span class="badge">Динамика: текущий vs предыдущий</span>
    <canvas id="chartBranches"></canvas>
  </section>
  <section class="card">
    <h2>Таблица (стр. 2) — Δ «Всего опор, шт.»</h2>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="tblBranches">
        <thead><tr><th>Филиал</th><th>Пред., шт.</th><th>Тек., шт.</th><th>Δ, шт.</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td>Итого</td><td id="sumPrev">0</td><td id="sumCurr">0</td><td id="sumDelta">0</td></tr></tfoot>
      </table>
    </div>
  </section>
</div>

<div class="container grid cols-3">
  <section class="card">
    <h2>Стр. 4 — ПАО «Ростелеком»: Δ по филиалам</h2>
    <canvas id="chartRTKDelta"></canvas>
  </section>
  <section class="card">
    <h2>Стр. 2 — Стадии (прирост, неделя к неделе)</h2>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="tblStagesS2">
        <thead><tr><th>Стадия</th><th>Пред., шт.</th><th>Тек., шт.</th><th>Δ, шт.</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
  <section class="card">
    <h2>Стр. 4 (РТК) — Стадии (прирост)</h2>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="tblStagesS4">
        <thead><tr><th>Стадия</th><th>Пред., шт.</th><th>Тек., шт.</th><th>Δ, шт.</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<!-- Печатные области -->
<div id="presentationPrint" style="display:none">
  <div class="logoTitle">АО «Россети Кубань» — Презентация (еженедельная динамика ВОЛС)</div>
  <div id="presDates" class="note" style="margin-bottom:8px"></div>
  <div id="presKpis"></div>
  <div class="hr"></div>
  <div id="presTable"></div>
  <div class="hr"></div>
  <div id="presRTKDelta"></div>
  <div class="hr"></div>
  <div id="presStages"></div>
  <div class="hr"></div>
  <div id="presInsights"></div>
</div>

<div id="summaryPrint" style="display:none">
  <div class="logoTitle">Краткая выжимка для руководителя</div>
  <div id="briefDates" class="note" style="margin-bottom:8px"></div>
  <div id="briefBlocks"></div>
</div>

<!-- Библиотеки -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.12.0/pptxgen.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
/* ===== Константы и утилиты ===== */
const BRANCHES = [
  "Сочинские ЭС","Тимашевские ЭС","Тихорецкие ЭС","Усть-Лабинские ЭС","Юго-Западные ЭС",
  "Адыгейские ЭС","Армавирские ЭС","Краснодарские ЭС","Лабинские ЭС","Ленинградские ЭС","Славянские ЭС"
];

// Улучшенные паттерны для филиалов
const BRANCH_PATTERNS = [
  {name:"Сочинские ЭС",      re:/Сочинские\s+ЭС/i},
  {name:"Тимашевские ЭС",    re:/Тимашевские\s+ЭС/i},
  {name:"Тихорецкие ЭС",     re:/Тихорецкие\s+ЭС/i},
  {name:"Усть-Лабинские ЭС", re:/Усть[\s\u00A0\u202F\-–—-]*Лабинские\s+ЭС/i},
  {name:"Юго-Западные ЭС",   re:/Юго[\s\u00A0\u202F\-–—-]*Западные\s+ЭС/i},
  {name:"Адыгейские ЭС",     re:/Адыгейские\s+ЭС/i},
  {name:"Армавирские ЭС",    re:/Армавирские\s+ЭС/i},
  {name:"Краснодарские ЭС",  re:/Краснодарские\s+ЭС/i},
  {name:"Лабинские ЭС",      re:/Лабинские\s+ЭС/i},
  {name:"Ленинградские ЭС",  re:/Ленинградские\s+ЭС/i},
  {name:"Славянские ЭС",     re:/Славянские\s+ЭС/i},
];

// Обновленные паттерны для статусов
const STATUS_PATTERNS = [
  {key:"work",       title:"В работе у филиала",         re:/В\s*работе\s*у\s*филиала/i},
  {key:"dismantled", title:"Демонтировано",              re:/Демонтировано/i},
  {key:"rc_digit",   title:"Договор на оформлении Россети Цифра", re:/Договор\s*на\s*оформлении\s*Россети\s*Цифра/i},
  {key:"op_sign",    title:"Договор на подписании у оператора",   re:/Договор\s*на\s*подписании\s*у\s*оператора/i},
  {key:"filial_appr",title:"Договор на согласовании в филиале",   re:/Договор\s*на\s*согласовании\s*в\s*филиале/i},
  {key:"incl_next",  title:"Будет включено в следующее доп. соглашение", re:/Будет\s*включено[\s\S]*?соглашение/i},
];

const numberize = s => Number(String(s||"").replace(/[^\d]/g,"")) || 0;
const fmt = n => n.toLocaleString("ru-RU");

function normalize(txt){
  return String(txt||"")
    .replace(/\u00A0/g," ")
    .replace(/\u202F/g," ")
    .replace(/\u00AD/g,"")
    .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
    .replace(/[ \t]+/g," ")
    .trim();
}

/* ===== Чтение PDF ===== */
async function pdfToPages(file){
  try {
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      
      // Улучшенная обработка текста - сохраняем структуру
      let pageText = "";
      let lastY = null;
      
      content.items.forEach(item => {
        if(lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
          pageText += "\n";
        }
        pageText += item.str;
        lastY = item.transform[5];
      });
      
      pages.push(normalize(pageText));
    }
    
    console.log("PDF успешно прочитан, страниц:", pages.length);
    return pages;
  } catch(e) {
    console.error("Ошибка чтения PDF:", e);
    throw e;
  }
}

/* ===== Парсинг ===== */
function extractDateFromPages(pages){
  for(const pg of pages){
    const m = pg.match(/по состоянию на\s+(\d{2}\.\d{2}\.\d{4})/i);
    if(m) return m[1];
  }
  return "—";
}

function parseTotalsFromPage(page1){
  const find = (re) => {
    const m = page1.match(re);
    return m ? numberize(m[1]) : 0;
  };
  
  return {
    found_year:     find(/выявлено[^0-9]*?(\d[\d\s]+)\s*шт/i),
    legalized:      find(/Узаконено[^0-9]*?(\d[\d\s]+)/i),
    dismantled_ytd: find(/За\s*20\d{2}\s*год\s*демонтировано[^0-9]*?(\d[\d\s]+)/i),
    in_work_total:  find(/В\s*работе[^0-9]*?всего[^0-9]*?(\d[\d\s]+)\s*шт/i),
    rtk_in_work:    find(/в\s*том\s*числе\s*ПАО\s*«?Ростелеком»?[^0-9]*?(\d[\d\s]+)/i),
  };
}

/* ===== Улучшенный парсер таблицы филиалов ===== */
function parseBranchTable(pageText) {
  const text = normalize(pageText);
  const lines = text.split("\n").filter(l => l.trim());
  const branches = new Map();
  
  // Ищем каждый филиал и связанные с ним данные
  for(let i = 0; i < lines.length; i++) {
    const line = lines[i];
    
    // Проверяем, есть ли название филиала
    let branchName = null;
    for(const bp of BRANCH_PATTERNS) {
      if(bp.re.test(line)) {
        branchName = bp.name;
        break;
      }
    }
    
    if(!branchName) continue;
    
    // Ищем число "Всего опор"
    let total = 0;
    
    // Проверяем текущую строку на наличие числа
    const numsInLine = line.match(/\d[\d\s]*/g);
    if(numsInLine && numsInLine.length > 0) {
      // Берем последнее число в строке
      total = numberize(numsInLine[numsInLine.length - 1]);
    }
    
    // Если не нашли в текущей строке, проверяем следующую
    if(total === 0 && i + 1 < lines.length) {
      const nextLine = lines[i + 1];
      const numsInNext = nextLine.match(/\d[\d\s]*/g);
      if(numsInNext && numsInNext.length > 0) {
        total = numberize(numsInNext[0]);
      }
    }
    
    if(!branches.has(branchName) || branches.get(branchName).total === 0) {
      branches.set(branchName, { total, statuses: {} });
    }
    
    // Парсим статусы
    let j = i + 1;
    while(j < lines.length && j < i + 10) {
      const statusLine = lines[j];
      
      // Если встретили следующий филиал, прерываем
      if(BRANCH_PATTERNS.some(bp => bp.re.test(statusLine))) break;
      
      // Проверяем статусы
      for(const sp of STATUS_PATTERNS) {
        if(sp.re.test(statusLine)) {
          const nums = statusLine.match(/\d[\d\s]*/g);
          if(nums && nums.length > 0) {
            const value = numberize(nums[nums.length - 1]);
            if(!branches.get(branchName).statuses[sp.key]) {
              branches.get(branchName).statuses[sp.key] = value;
            }
          }
        }
      }
      j++;
    }
  }
  
  // Добавляем нулевые значения для отсутствующих филиалов
  for(const b of BRANCHES) {
    if(!branches.has(b)) {
      branches.set(b, { total: 0, statuses: {} });
    }
  }
  
  const overall = [...branches.values()].reduce((s, r) => s + (r.total || 0), 0);
  
  // Считаем общие стадии
  const stages = {};
  for(const [_, data] of branches) {
    for(const [key, value] of Object.entries(data.statuses)) {
      stages[key] = (stages[key] || 0) + value;
    }
  }
  
  return { branches, overall, stages };
}

/* ===== Парсинг отчета по страницам ===== */
function parseReportByPages(pages){
  const report = {
    date: extractDateFromPages(pages),
    p1: { totals: parseTotalsFromPage(pages[0] || "") },
    p2: parseBranchTable(pages[1] || ""),
    p3: parseBranchTable(pages[2] || ""),
    p4: parseBranchTable(pages[3] || ""),
  };
  
  console.log("Отчет распарсен:", {
    date: report.date,
    p1_totals: report.p1.totals,
    p2_overall: report.p2.overall,
    p3_overall: report.p3.overall,
    p4_overall: report.p4.overall
  });
  
  return report;
}

/* ===== Вычисление динамики ===== */
function computeDynamics(curr, prev){
  const dyn = {
    in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
    rtk_in_work:   (curr.p1.totals.rtk_in_work   - prev.p1.totals.rtk_in_work)   || 0,
    legalized:     (curr.p1.totals.legalized     - prev.p1.totals.legalized)     || 0,
    dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
  };
  dyn.found_week = dyn.in_work_total;

  const branchRows = BRANCHES.map(b => {
    const c = curr.p2.branches.get(b)?.total || 0;
    const p = prev.p2.branches.get(b)?.total || 0;
    return {b, p, c, d: c - p};
  });

  const rtkRows = BRANCHES.map(b => {
    const c = curr.p4.branches.get(b)?.total || 0;
    const p = prev.p4.branches.get(b)?.total || 0;
    return {b, p, c, d: c - p};
  });

  // Стадии
  const stageTitles = key => (STATUS_PATTERNS.find(s => s.key === key) || {}).title || key;
  
  const s2_prev = prev.p2.stages || {};
  const s2_curr = curr.p2.stages || {};
  const s4_prev = prev.p4.stages || {};
  const s4_curr = curr.p4.stages || {};

  const keys = Array.from(new Set([
    ...Object.keys(s2_prev),
    ...Object.keys(s2_curr),
    ...Object.keys(s4_prev),
    ...Object.keys(s4_curr)
  ]));

  const stagesS2 = keys.map(k => ({
    stage: stageTitles(k),
    key: k,
    p: s2_prev[k] || 0,
    c: s2_curr[k] || 0,
    d: (s2_curr[k] || 0) - (s2_prev[k] || 0)
  })).filter(s => s.p > 0 || s.c > 0);

  const stagesS4 = keys.map(k => ({
    stage: stageTitles(k),
    key: k,
    p: s4_prev[k] || 0,
    c: s4_curr[k] || 0,
    d: (s4_curr[k] || 0) - (s4_prev[k] || 0)
  })).filter(s => s.p > 0 || s.c > 0);

  return {...dyn, branchRows, rtkRows, stagesS2, stagesS4};
}

/* ===== Рендер ===== */
let chartBranches, chartRTKDelta;

function renderKpis(curr, prev, dyn){
  const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - 
              (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
  const rtkShare = curr.p1.totals.in_work_total ? 
    (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
  const effRatio = dyn.found_week > 0 ? (eff / dyn.found_week * 100) : 0;
  
  const items = [
    {title: "В работе всего, шт.", curr: curr.p1.totals.in_work_total, delta: dyn.in_work_total},
    {title: "Выявлено за неделю, шт.", curr: dyn.found_week, delta: dyn.found_week},
    {title: "Закрыто за неделю (узак.+демонт.), шт.", curr: eff, delta: eff},
    {title: "Коэф. эффективности недели, %", curr: effRatio.toFixed(1), delta: 0},
    {title: "ПАО «Ростелеком» в работе, шт. (доля, %)", 
     curr: `${fmt(curr.p1.totals.rtk_in_work)} (${rtkShare.toFixed(1)}%)`, 
     delta: dyn.rtk_in_work},
  ];
  
  document.getElementById("kpis").innerHTML = items.map(it => {
    const d = typeof it.delta === "number" ? it.delta : 0;
    const cls = d > 0 ? "up" : (d < 0 ? "down" : "muted");
    const sign = d > 0 ? "+" : "";
    return `<div class="kpi">
      <div class="title">${it.title}</div>
      <div class="value">${typeof it.curr === "number" ? fmt(it.curr) : it.curr}</div>
      <div class="delta ${cls}">${sign}${fmt(d)} неделя к неделе</div>
    </div>`;
  }).join("");
}

function renderBranchesTable(dyn){
  const tbody = document.querySelector("#tblBranches tbody");
  tbody.innerHTML = "";
  const rows = [...dyn.branchRows].sort((a, b) => Math.abs(b.d) - Math.abs(a.d));
  let sP = 0, sC = 0, sD = 0;
  
  for(const r of rows){
    const cls = r.d > 0 ? "up" : (r.d < 0 ? "down" : "muted");
    sP += r.p; sC += r.c; sD += r.d;
    tbody.insertAdjacentHTML("beforeend", 
      `<tr>
        <td>${r.b}</td>
        <td>${fmt(r.p)}</td>
        <td>${fmt(r.c)}</td>
        <td class="${cls}">${r.d > 0 ? "+" : ""}${fmt(r.d)}</td>
      </tr>`);
  }
  
  document.getElementById("sumPrev").textContent = fmt(sP);
  document.getElementById("sumCurr").textContent = fmt(sC);
  document.getElementById("sumDelta").textContent = (sD > 0 ? "+" : "") + fmt(sD);
  return rows;
}

function renderCharts(curr, prev, dyn){
  const labels = BRANCHES;
  const prevS2 = labels.map(b => prev.p2.branches.get(b)?.total || 0);
  const currS2 = labels.map(b => curr.p2.branches.get(b)?.total || 0);
  
  if(chartBranches) chartBranches.destroy();
  chartBranches = new Chart(document.getElementById("chartBranches"), {
    type: "bar",
    data: {
      labels, 
      datasets: [
        {label: "Пред. неделя", data: prevS2, backgroundColor: "#94a3b8"},
        {label: "Тек. неделя", data: currS2, backgroundColor: "#0033A0"}
      ]
    },
    options: {
      responsive: true,
      plugins: {legend: {position: "top"}},
      scales: {y: {beginAtZero: true}}
    }
  });

  const rtkD = labels.map(b => dyn.rtkRows.find(x => x.b === b)?.d || 0);
  if(chartRTKDelta) chartRTKDelta.destroy();
  chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
    type: "bar",
    data: {
      labels, 
      datasets: [{
        label: "Δ РТК (стр. 4): тек. − пред.", 
        data: rtkD,
        backgroundColor: rtkD.map(v => v > 0 ? "#0a7a2d" : "#b00020")
      }]
    },
    options: {
      responsive: true,
      plugins: {legend: {position: "top"}},
      scales: {y: {beginAtZero: true}}
    }
  });
}

function renderStagesTables(dyn){
  const fill = (id, rows) => {
    const tbody = document.querySelector(id + " tbody");
    tbody.innerHTML = rows.map(r => {
      const cls = r.d > 0 ? "up" : (r.d < 0 ? "down" : "muted");
      return `<tr>
        <td>${r.stage}</td>
        <td>${fmt(r.p)}</td>
        <td>${fmt(r.c)}</td>
        <td class="${cls}">${r.d > 0 ? "+" : ""}${fmt(r.d)}</td>
      </tr>`;
    }).join("");
  };
  fill("#tblStagesS2", dyn.stagesS2);
  fill("#tblStagesS4", dyn.stagesS4);
}

/* ===== Инсайты ===== */
function buildInsights(dyn){
  const topPos = [...dyn.branchRows].sort((a, b) => b.d - a.d).slice(0, 3);
  const topNeg = [...dyn.branchRows].sort((a, b) => a.d - b.d).slice(0, 3);
  const rtkPos = [...dyn.rtkRows].sort((a, b) => b.d - a.d).slice(0, 3);
  const rtkNeg = [...dyn.rtkRows].sort((a, b) => a.d - b.d).slice(0, 3);
  const s2Top = [...dyn.stagesS2].sort((a, b) => Math.abs(b.d) - Math.abs(a.d)).slice(0, 2);
  const s4Top = [...dyn.stagesS4].sort((a, b) => Math.abs(b.d) - Math.abs(a.d)).slice(0, 2);
  
  return `
    <div><b>ТОП-3 рост (стр. 2):</b> ${topPos.filter(r => r.d > 0).map(r => `${r.b} (+${fmt(r.d)})`).join("; ") || "нет"}</div>
    <div><b>ТОП-3 снижение (стр. 2):</b> ${topNeg.filter(r => r.d < 0).map(r => `${r.b} (${fmt(r.d)})`).join("; ") || "нет"}</div>
    <div><b>РТК — рост:</b> ${rtkPos.filter(r => r.d > 0).map(r => `${r.b} (+${fmt(r.d)})`).join("; ") || "нет"}</div>
    <div><b>РТК — снижение:</b> ${rtkNeg.filter(r => r.d < 0).map(r => `${r.b} (${fmt(r.d)})`).join("; ") || "нет"}</div>
    <div><b>Стадии (стр. 2):</b> ${s2Top.filter(s => s.d !== 0).map(s => `${s.stage} (${s.d > 0 ? '+' : ''}${fmt(s.d)})`).join("; ") || "нет изменений"}</div>
    <div><b>Стадии РТК (стр. 4):</b> ${s4Top.filter(s => s.d !== 0).map(s => `${s.stage} (${s.d > 0 ? '+' : ''}${fmt(s.d)})`).join("; ") || "нет изменений"}</div>
  `;
}

/* ===== Экспорт ===== */
function buildPresentationHTML(curr, prev, dyn, rows){
  document.getElementById("presDates").textContent = `Пред.: ${prev.date} · Тек.: ${curr.date}`;
  
  const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - 
              (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
  const rtkShare = curr.p1.totals.in_work_total ? 
    (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
  
  const box = (t, val, delta) => `
    <div style="border:1px solid #e7edf5;border-radius:10px;padding:10px;margin:6px 0">
      <div style="color:#5f6b7a;font-size:12px">${t}</div>
      <div style="font-weight:800;font-size:18px">${typeof val === "number" ? fmt(val) : val}</div>
      <div style="font-size:12px;color:${delta > 0 ? '#0a7a2d' : (delta < 0 ? '#b00020' : '#5f6b7a')}">
        ${delta > 0 ? '+' : ''}${fmt(delta)} неделя к неделе
      </div>
    </div>`;
  
  document.getElementById("presKpis").innerHTML =
    box("В работе всего, шт.", curr.p1.totals.in_work_total, dyn.in_work_total) +
    box("Выявлено за неделю, шт.", dyn.found_week, dyn.found_week) +
    box("Закрыто за неделю (узак.+демонт.), шт.", eff, eff) +
    box("ПАО «Ростелеком» в работе, шт. (доля, %)", 
        `${fmt(curr.p1.totals.rtk_in_work)} (${rtkShare.toFixed(1)}%)`, dyn.rtk_in_work);

  document.getElementById("presTable").innerHTML = `
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead><tr>
        <th style="text-align:left;border-bottom:1px solid #e7edf5;padding:6px 4px">Филиал</th>
        <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Пред.</th>
        <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Тек.</th>
        <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Δ</th>
      </tr></thead>
      <tbody>
        ${rows.map(r => `<tr>
          <td style="padding:6px 4px">${r.b}</td>
          <td style="padding:6px 4px;text-align:right">${fmt(r.p)}</td>
          <td style="padding:6px 4px;text-align:right">${fmt(r.c)}</td>
          <td style="padding:6px 4px;text-align:right;color:${r.d > 0 ? '#0a7a2d' : (r.d < 0 ? '#b00020' : '#5f6b7a')}">
            ${r.d > 0 ? '+' : ''}${fmt(r.d)}
          </td>
        </tr>`).join("")}
      </tbody>
      <tfoot>
        <tr>
          <td style="padding:6px 4px;font-weight:800">Итого</td>
          <td style="padding:6px 4px;text-align:right;font-weight:800">${document.getElementById("sumPrev").textContent}</td>
          <td style="padding:6px 4px;text-align:right;font-weight:800">${document.getElementById("sumCurr").textContent}</td>
          <td style="padding:6px 4px;text-align:right;font-weight:800">${document.getElementById("sumDelta").textContent}</td>
        </tr>
      </tfoot>
    </table>`;

  const rtkTop = [...dyn.rtkRows].sort((a, b) => Math.abs(b.d) - Math.abs(a.d)).slice(0, 7);
  document.getElementById("presRTKDelta").innerHTML =
    `<div style="font-weight:700;margin:8px 0">Стр. 4 — ПАО «Ростелеком»: ТОП-7 прирост/снижение</div>` +
    rtkTop.map(r => `<div>• ${r.b}: ${fmt(r.p)} → <b>${fmt(r.c)}</b> (${r.d > 0 ? '+' : ''}${fmt(r.d)})</div>`).join("");

  const stageTbl = (title, arr) => `
    <div style="margin:10px 0 4px;font-weight:700">${title}</div>
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead><tr>
        <th style="text-align:left;border-bottom:1px solid #e7edf5;padding:6px 4px">Стадия</th>
        <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Пред.</th>
        <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Тек.</th>
        <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Δ</th>
      </tr></thead>
      <tbody>
        ${arr.map(r => `<tr>
          <td style="padding:6px 4px">${r.stage}</td>
          <td style="padding:6px 4px;text-align:right">${fmt(r.p)}</td>
          <td style="padding:6px 4px;text-align:right">${fmt(r.c)}</td>
          <td style="padding:6px 4px;text-align:right;color:${r.d > 0 ? '#0a7a2d' : (r.d < 0 ? '#b00020' : '#5f6b7a')}">
            ${r.d > 0 ? '+' : ''}${fmt(r.d)}
          </td>
        </tr>`).join("")}
      </tbody>
    </table>`;
  
  document.getElementById("presStages").innerHTML =
    stageTbl("Стр. 2 — Стадии (прирост)", dyn.stagesS2) +
    stageTbl("Стр. 4 — Стадии РТК (прирост)", dyn.stagesS4);

  document.getElementById("presInsights").innerHTML = buildInsights(dyn);
}

async function exportPresPDF(){
  const el = document.getElementById("presentationPrint");
  el.style.display = "block";
  await html2pdf().from(el).set({
    margin: 10,
    filename: "Презентация_ВОЛС.pdf",
    image: {type: 'jpeg', quality: 0.98},
    html2canvas: {scale: 2},
    jsPDF: {unit: 'mm', format: 'a4'}
  }).save();
  el.style.display = "none";
}

async function exportPresPPTX(curr, prev, dyn, rows){
  try {
    const pptx = new PptxGenJS();
    
    // Слайд 1: Титульный
    const s1 = pptx.addSlide();
    s1.addText("АО «Россети Кубань»", {x: 0.5, y: 0.4, fontSize: 18, bold: true, color: "0033A0"});
    s1.addText("ВОЛС: еженедельная динамика", {x: 0.5, y: 1, fontSize: 28, bold: true});
    s1.addText(`Пред.: ${prev.date} · Тек.: ${curr.date}`, {x: 0.5, y: 1.6, fontSize: 12, color: "666"});
    
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - 
                (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? 
      (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    const k = (t, val, delta, y) => {
      s1.addText(t, {x: 0.5, y, fontSize: 12, color: "666"});
      s1.addText(typeof val === "number" ? fmt(val) : val, {x: 0.5, y: y + 0.25, fontSize: 18, bold: true});
      s1.addText(`${delta > 0 ? '+' : ''}${fmt(delta)} н/н`, {
        x: 3.6, y: y + 0.25, fontSize: 12, 
        color: delta > 0 ? '228B22' : (delta < 0 ? 'B00020' : '666')
      });
    };
    
    k("В работе всего, шт.", curr.p1.totals.in_work_total, dyn.in_work_total, 2.2);
    k("Выявлено за неделю, шт.", dyn.found_week, dyn.found_week, 2.9);
    k("Закрыто (узак.+демонт.), шт.", eff, eff, 3.6);
    k("ПАО «Ростелеком» в работе, шт. (доля, %)", 
      `${fmt(curr.p1.totals.rtk_in_work)} (${rtkShare.toFixed(1)}%)`, dyn.rtk_in_work, 4.3);

    // Слайд 2: Таблица филиалов
    const s2 = pptx.addSlide();
    s2.addText("Стр. 2 — Филиалы: Δ «Всего опор, шт.»", {x: 0.5, y: 0.4, fontSize: 18, bold: true, color: "0033A0"});
    s2.addTable([
      [{text: "Филиал", options: {bold: true}}, 
       {text: "Пред.", options: {bold: true}}, 
       {text: "Тек.", options: {bold: true}}, 
       {text: "Δ", options: {bold: true}}],
      ...rows.map(r => [r.b, fmt(r.p), fmt(r.c), (r.d > 0 ? '+' : '') + fmt(r.d)]),
      ["Итого", 
       document.getElementById("sumPrev").textContent, 
       document.getElementById("sumCurr").textContent, 
       document.getElementById("sumDelta").textContent]
    ], {x: 0.5, y: 1.0, w: 9.0, border: {pt: 1, color: "DDDDDD"}, fill: "FFFFFF"});

    // Слайд 3: РТК
    const s3 = pptx.addSlide();
    s3.addText("Стр. 4 — ПАО «Ростелеком»: ТОП-7 прирост/снижение", 
               {x: 0.5, y: 0.4, fontSize: 18, bold: true, color: "0033A0"});
    const rtkTop = [...dyn.rtkRows].sort((a, b) => Math.abs(b.d) - Math.abs(a.d)).slice(0, 7);
    s3.addTable([
      [{text: "Филиал", options: {bold: true}}, 
       {text: "Пред.", options: {bold: true}}, 
       {text: "Тек.", options: {bold: true}}, 
       {text: "Δ", options: {bold: true}}],
      ...rtkTop.map(r => [r.b, fmt(r.p), fmt(r.c), (r.d > 0 ? '+' : '') + fmt(r.d)])
    ], {x: 0.5, y: 1.0, w: 9.0, border: {pt: 1, color: "DDDDDD"}, fill: "FFFFFF"});

    // Слайд 4: Стадии
    const s4 = pptx.addSlide();
    s4.addText("Стадии (прирост неделя к неделе)", {x: 0.5, y: 0.4, fontSize: 18, bold: true, color: "0033A0"});
    s4.addText("Стр. 2", {x: 0.5, y: 0.9, fontSize: 14, bold: true});
    s4.addTable([
      [{text: "Стадия", options: {bold: true}}, 
       {text: "Пред.", options: {bold: true}}, 
       {text: "Тек.", options: {bold: true}}, 
       {text: "Δ", options: {bold: true}}],
      ...dyn.stagesS2.map(r => [r.stage, fmt(r.p), fmt(r.c), (r.d > 0 ? '+' : '') + fmt(r.d)])
    ], {x: 0.5, y: 1.2, w: 9.0, border: {pt: 1, color: "DDDDDD"}, fill: "FFFFFF"});
    
    s4.addText("Стр. 4 (РТК)", {x: 0.5, y: 3.8, fontSize: 14, bold: true});
    s4.addTable([
      [{text: "Стадия", options: {bold: true}}, 
       {text: "Пред.", options: {bold: true}}, 
       {text: "Тек.", options: {bold: true}}, 
       {text: "Δ", options: {bold: true}}],
      ...dyn.stagesS4.map(r => [r.stage, fmt(r.p), fmt(r.c), (r.d > 0 ? '+' : '') + fmt(r.d)])
    ], {x: 0.5, y: 4.1, w: 9.0, border: {pt: 1, color: "DDDDDD"}, fill: "FFFFFF"});

    await pptx.writeFile({fileName: "Презентация_ВОЛС.pptx"});
    document.getElementById("exportStatus").textContent = "PPTX сформирован.";
  } catch(e) {
    console.error(e);
    alert("Ошибка формирования PPTX. Подробности в консоли.");
  }
}

async function exportBriefDOCX(curr, prev, dyn, rows){
  try {
    const d = window.docx;
    const {Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType} = d;
    
    const h = t => new Paragraph({
      children: [new TextRun({text: t, bold: true, size: 26, color: "0033A0"})],
      spacing: {after: 120}
    });
    
    const p = t => new Paragraph({
      children: [new TextRun({text: "• " + t, size: 22})],
      spacing: {after: 80}
    });
    
    const tr = (vals, bold = false) => new TableRow({
      children: vals.map(v => new TableCell({
        children: [new Paragraph({children: [new TextRun({text: String(v), bold})]})]
      }))
    });
    
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - 
                (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? 
      (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const doc = new Document({
      sections: [{
        children: [
          h("Краткая выжимка (неделя к неделе)"),
          new Paragraph({
            children: [new TextRun({text: `Пред.: ${prev.date} · Тек.: ${curr.date}`, size: 20, color: "666"})],
            spacing: {after: 200}
          }),

          h("Стр. 1 — Общая информация (нарастающим)"),
          p(`В работе всего: ${fmt(curr.p1.totals.in_work_total)} (${dyn.in_work_total > 0 ? '+' : ''}${fmt(dyn.in_work_total)})`),
          p(`Выявлено за неделю: ${fmt(dyn.found_week)} (расчёт от «в работе всего»)`),
          p(`Закрыто за неделю (узак.+демонт.): ${fmt(eff)}`),
          p(`ПАО «Ростелеком» в работе: ${fmt(curr.p1.totals.rtk_in_work)} (${dyn.rtk_in_work > 0 ? '+' : ''}${fmt(dyn.rtk_in_work)}), доля: ${rtkShare.toFixed(1)}%`),

          h("Стр. 2 — Филиалы: динамика «Всего опор, шт.»"),
          new Table({
            width: {size: 100, type: WidthType.PERCENTAGE},
            rows: [
              tr(["Филиал", "Пред.", "Тек.", "Δ"], true),
              ...rows.map(r => tr([r.b, fmt(r.p), fmt(r.c), (r.d > 0 ? '+' : '') + fmt(r.d)])),
              tr(["Итого", 
                  document.getElementById("sumPrev").textContent, 
                  document.getElementById("sumCurr").textContent, 
                  document.getElementById("sumDelta").textContent], true)
            ]
          }),

          h("Стр. 3 — Приказ №425: «Всего опор, шт.» (текущая)"),
          new Table({
            width: {size: 100, type: WidthType.PERCENTAGE},
            rows: [
              tr(["Филиал", "Тек. (стр. 3)"], true),
              ...BRANCHES.map(b => tr([b, fmt(curr.p3.branches.get(b)?.total || 0)]))
            ]
          }),

          h("Стр. 4 — ПАО «Ростелеком»: Δ по филиалам"),
          new Table({
            width: {size: 100, type: WidthType.PERCENTAGE},
            rows: [
              tr(["Филиал", "Пред.", "Тек.", "Δ"], true),
              ...dyn.rtkRows.map(r => tr([r.b, fmt(r.p), fmt(r.c), (r.d > 0 ? '+' : '') + fmt(r.d)]))
            ]
          }),
          
          h("Стр. 4 — ПАО «Ростелеком»: стадии (прирост)"),
          new Table({
            width: {size: 100, type: WidthType.PERCENTAGE},
            rows: [
              tr(["Стадия", "Пред.", "Тек.", "Δ"], true),
              ...dyn.stagesS4.map(s => tr([s.stage, fmt(s.p), fmt(s.c), (s.d > 0 ? '+' : '') + fmt(s.d)]))
            ]
          }),
        ]
      }]
    });

    const blob = await Packer.toBlob(doc);
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Выжимка_ВОЛС.docx";
    a.target = "_blank";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 0);
    document.getElementById("exportStatus").textContent = "DOCX сформирован.";
  } catch(e) {
    console.error(e);
    alert("Ошибка формирования DOCX. Подробности в консоли.");
  }
}

async function exportBriefPDF(){
  const el = document.getElementById("summaryPrint");
  el.style.display = "block";
  await html2pdf().from(el).set({
    margin: 10,
    filename: "Выжимка_ВОЛС.pdf",
    image: {type: 'jpeg', quality: 0.98},
    html2canvas: {scale: 2},
    jsPDF: {unit: 'mm', format: 'a4'}
  }).save();
  el.style.display = "none";
}

/* ===== Взаимодействие ===== */
let DATA = null;

document.getElementById("btnParse").addEventListener("click", async () => {
  const fPrev = document.getElementById("filePrev").files[0];
  const fCurr = document.getElementById("fileCurr").files[0];
  
  if(!fPrev || !fCurr) {
    document.getElementById("errorMsg").textContent = "Загрузите оба PDF: предыдущий и текущий.";
    return;
  }

  try {
    document.getElementById("loadingMsg").classList.add("active");
    document.getElementById("errorMsg").textContent = "";
    
    const [pPrev, pCurr] = await Promise.all([pdfToPages(fPrev), pdfToPages(fCurr)]);
    const prev = parseReportByPages(pPrev);
    const curr = parseReportByPages(pCurr);
    const dyn = computeDynamics(curr, prev);
    DATA = {prev, curr, dyn};

    document.getElementById("dates").textContent = `Предыдущий: ${prev.date} · Текущий: ${curr.date}`;
    renderKpis(curr, prev, dyn);
    const rows = renderBranchesTable(dyn);
    renderCharts(curr, prev, dyn);
    renderStagesTables(dyn);
    buildPresentationHTML(curr, prev, dyn, rows);

    // Выжимка
    const blocks = document.getElementById("briefBlocks");
    document.getElementById("briefDates").textContent = `Предыдущий: ${prev.date} · Текущий: ${curr.date}`;
    
    const topPos = [...dyn.branchRows].sort((a, b) => b.d - a.d).slice(0, 3);
    const topNeg = [...dyn.branchRows].sort((a, b) => a.d - b.d).slice(0, 3);
    const rtkPos = [...dyn.rtkRows].sort((a, b) => b.d - a.d).slice(0, 3);
    const rtkNeg = [...dyn.rtkRows].sort((a, b) => a.d - b.d).slice(0, 3);
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - 
                (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const effRatio = dyn.found_week > 0 ? (eff / dyn.found_week * 100) : 0;

    blocks.innerHTML = `
      <h3>Стр. 1 — Общая (нарастающим)</h3>
      <div>• В работе всего: <b>${fmt(curr.p1.totals.in_work_total)}</b> (${dyn.in_work_total > 0 ? '+' : ''}${fmt(dyn.in_work_total)} н/н)</div>
      <div>• Выявлено за неделю: <b>${fmt(dyn.found_week)}</b> (расчёт от «в работе всего»)</div>
      <div>• Закрыто за неделю (узак.+демонт.): <b>${fmt(eff)}</b>; коэффициент эффективности: <b>${effRatio.toFixed(1)}%</b></div>
      <div>• ПАО «Ростелеком» в работе: <b>${fmt(curr.p1.totals.rtk_in_work)}</b> (${dyn.rtk_in_work > 0 ? '+' : ''}${fmt(dyn.rtk_in_work)})</div>
      <hr/>
      <h3>Стр. 2 — Филиалы: Δ «Всего опор, шт.»</h3>
      <div><b>ТОП-3 рост:</b> ${topPos.filter(r => r.d > 0).map(r => `${r.b} (+${fmt(r.d)})`).join("; ") || "нет"}</div>
      <div><b>ТОП-3 снижение:</b> ${topNeg.filter(r => r.d < 0).map(r => `${r.b} (${fmt(r.d)})`).join("; ") || "нет"}</div>
      <div style="margin-top:6px"><b>Итого:</b> Пред. ${document.getElementById("sumPrev").textContent}; Тек. ${document.getElementById("sumCurr").textContent}; Δ ${document.getElementById("sumDelta").textContent}</div>
      <hr/>
      <h3>Стр. 3 — Приказ №425 (срез текущей недели)</h3>
      <div>${BRANCHES.map(b => `${b}: <b>${fmt(curr.p3.branches.get(b)?.total || 0)}</b>`).join("<br/>")}</div>
      <hr/>
      <h3>Стр. 4 — ПАО «Ростелеком»: Δ и стадии</h3>
      <div><b>ТОП-3 рост:</b> ${rtkPos.filter(r => r.d > 0).map(r => `${r.b} (+${fmt(r.d)})`).join("; ") || "нет"}</div>
      <div><b>ТОП-3 снижение:</b> ${rtkNeg.filter(r => r.d < 0).map(r => `${r.b} (${fmt(r.d)})`).join("; ") || "нет"}</div>
      <div style="margin-top:6px"><b>Стадии (прирост):</b><br/>${dyn.stagesS4.map(s => `• ${s.stage}: ${fmt(s.p)} → <b>${fmt(s.c)}</b> (${s.d > 0 ? '+' : ''}${fmt(s.d)})`).join("<br/>")}</div>
    `;
    
    document.getElementById("loadingMsg").classList.remove("active");
  } catch(e) {
    console.error(e);
    document.getElementById("loadingMsg").classList.remove("active");
    document.getElementById("errorMsg").textContent = "Ошибка разбора PDF. Проверьте формат отчётов. Подробности в консоли.";
  }
});

document.getElementById("exportPresPDF").addEventListener("click", async () => {
  if(!DATA) {
    alert("Сначала проанализируйте отчёты.");
    return;
  }
  await exportPresPDF();
});

document.getElementById("exportPresPPTX").addEventListener("click", async () => {
  if(!DATA) {
    alert("Сначала проанализируйте отчёты.");
    return;
  }
  const rows = Array.from(document.querySelectorAll("#tblBranches tbody tr")).map(tr => {
    const t = tr.querySelectorAll("td");
    return {
      b: t[0].textContent,
      p: numberize(t[1].textContent),
      c: numberize(t[2].textContent),
      d: numberize(t[3].textContent)
    };
  });
  await exportPresPPTX(DATA.curr, DATA.prev, DATA.dyn, rows);
});

document.getElementById("exportBriefDOCX").addEventListener("click", async () => {
  if(!DATA) {
    alert("Сначала проанализируйте отчёты.");
    return;
  }
  const rows = Array.from(document.querySelectorAll("#tblBranches tbody tr")).map(tr => {
    const t = tr.querySelectorAll("td");
    return {
      b: t[0].textContent,
      p: numberize(t[1].textContent),
      c: numberize(t[2].textContent),
      d: numberize(t[3].textContent)
    };
  });
  await exportBriefDOCX(DATA.curr, DATA.prev, DATA.dyn, rows);
});

document.getElementById("exportBriefPDF").addEventListener("click", async () => {
  if(!DATA) {
    alert("Сначала проанализируйте отчёты.");
    return;
  }
  await exportBriefPDF();
});
</script>
</body>
</html>
