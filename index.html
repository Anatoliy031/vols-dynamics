<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–≤–µ—Å–∞ –í–û–õ–° ‚Äî –†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

  <!-- –°—Ç–∏–ª–∏ (–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∏–Ω–∏–π) -->
  <style>
    :root{
      --rs-blue:#0033A0; /* –†–æ—Å—Å–µ—Ç–∏ */
      --rs-blue-2:#0A47C6;
      --rs-bg:#F5F7FB;
      --rs-text:#101828;
      --rs-muted:#667085;
      --rs-accent:#00AEEF; /* –¥–æ–ø. –≥–æ–ª—É–±–æ–π */
      --rs-ok:#2E7D32; --rs-bad:#C62828; --rs-warn:#ED6C02;
      --card-bg:#fff; --border:#E5E7EB;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--rs-bg);color:var(--rs-text);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{
      background:linear-gradient(90deg,var(--rs-blue) 0%, var(--rs-blue-2) 100%);
      color:#fff; padding:20px 16px; position:sticky; top:0; z-index:50;
      box-shadow:0 2px 12px rgba(0,0,0,.12)
    }
    .wrap{max-width:1200px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:14px}
    .brand .logo{
      width:40px;height:40px;border-radius:50%;background:#fff;display:grid;place-items:center;color:var(--rs-blue);
      font-weight:900;letter-spacing:.5px
    }
    h1{font-size:22px; margin:0}
    main{padding:18px 16px}
    .grid{display:grid;gap:16px}
    @media(min-width:980px){ .grid-2{grid-template-columns:1fr 1fr} }
    .card{
      background:var(--card-bg); border:1px solid var(--border); border-radius:16px; padding:16px;
      box-shadow:0 4px 16px rgba(0,0,0,.04)
    }
    .card h2{margin:0 0 10px 0; font-size:18px}
    .muted{color:var(--rs-muted)}
    .u-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{
      appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;
      background:var(--rs-blue); color:#fff; box-shadow:0 2px 8px rgba(0,0,0,.08)
    }
    .btn.secondary{background:#fff;color:var(--rs-blue);border:1px solid var(--rs-blue)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input[type=file]{padding:10px;background:#fff;border:1px dashed var(--border);border-radius:12px;width:100%}
    .kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .kpi .tile{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px}
    .tile h3{margin:0 0 6px 0;font-size:14px;color:var(--rs-muted)}
    .tile .v{font-size:22px;font-weight:800}
    .delta.pos{color:var(--rs-ok)} .delta.neg{color:var(--rs-bad)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{position:sticky;top:0;background:#F2F6FF;border-bottom:2px solid var(--border)}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:right}
    th:first-child, td:first-child{text-align:left}
    tfoot td{font-weight:800;background:#FAFAFC}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:#E8F5E9;color:var(--rs-ok)}
    .warn{background:#FFF3E0;color:var(--rs-warn)}
    .bad{background:#FFEBEE;color:var(--rs-bad)}
    .footer-actions{display:flex;flex-wrap:wrap;gap:10px}
    .note{font-size:13px;color:var(--rs-muted)}
    canvas{background:#fff;border:1px solid var(--border);border-radius:16px;padding:8px}
    .hr{height:1px;background:var(--border);margin:10px 0 16px 0}
    .small{font-size:12px}
    .fit{width:100%;overflow:auto}
    .sticky-controls{position:sticky;bottom:12px;z-index:40}
  </style>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.js" integrity="sha512-2eQe5oFT2a4qG3TOFz0vSFGf0Ypkd4pV7C19fP3ITftl8hy2pLAxBlK7kMmXw8D1c3JIgtH1oE0hIGyrK8oaxw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- PptxGenJS -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
  <!-- docx -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
</head>
<body>
  <header>
    <div class="wrap u-row">
      <div class="brand">
        <div class="logo">–†–ö</div>
        <div>
          <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–≤–µ—Å–∞ –í–û–õ–° ‚Äî –ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª</h1>
          <div class="small" id="report-dates">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Ç—á—ë—Ç—ã (—Ç–µ–∫—É—â–∏–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π)</div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <section class="card">
      <h2>1) –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤ (PDF)</h2>
      <p class="muted small">–ó–∞–≥—Ä—É–∑–∏—Ç–µ <b>—Ç–µ–∫—É—â–∏–π</b> –∏ <b>–ø—Ä–µ–¥—ã–¥—É—â–∏–π</b> –æ—Ç—á—ë—Ç—ã (—Å—Ç—Ä–∞–Ω–∏—Ü—ã 2‚Äì4 –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã). –ü–∞—Ä—Å–µ—Ä —É—Å—Ç–æ–π—á–∏–≤ –∫ –ø–µ—Ä–µ–Ω–æ—Å–∞–º —Å—Ç—Ä–æ–∫, –≤–∞—Ä–∏–∞–Ω—Ç–∞–º –¥–µ—Ñ–∏—Å–æ–≤ (-, ‚Äì , ‚Äî) –∏ –ø—Ä–æ–±–µ–ª–∞–º –≤ —á–∏—Å–ª–∞—Ö.</p>
      <div class="grid grid-2">
        <div>
          <label class="small">–¢–µ–∫—É—â–∏–π –æ—Ç—á—ë—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15.08.2025)</label>
          <input type="file" id="fileCurrent" accept="application/pdf" />
        </div>
        <div>
          <label class="small">–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á—ë—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 08.08.2025)</label>
          <input type="file" id="filePrev" accept="application/pdf" />
        </div>
      </div>
      <div class="hr"></div>
      <div class="u-row sticky-controls">
        <button class="btn" id="btnParse" disabled>üîé –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        <span class="note" id="parseStatus"></span>
      </div>
    </section>

    <!-- KPI -->
    <section class="card">
      <h2>2) –ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É</h2>
      <div class="kpi" id="kpi"></div>
      <p class="note">¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª = —Ä–∞–∑–Ω–∏—Ü–∞ ¬´–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç¬ª –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –æ—Ç—á—ë—Ç–∞–º–∏ (—Å—Ç—Ä. 2, —Å—Ç—Ä–æ–∫–∞ ¬´–û–±—â–∏–π –∏—Ç–æ–≥¬ª).</p>
    </section>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 -->
    <section class="card">
      <h2>3) –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 ‚Äî –°—Ç–∞–¥–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º)</h2>
      <div id="p2Tables" class="fit"></div>
      <div class="hr"></div>
      <canvas id="p2Chart" height="120"></canvas>
    </section>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3 -->
    <section class="card">
      <h2>4) –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3 ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425 (–ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º)</h2>
      <div id="p3Tables" class="fit"></div>
      <div class="hr"></div>
      <canvas id="p3Chart" height="120"></canvas>
    </section>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 4 -->
    <section class="card">
      <h2>5) –°—Ç—Ä–∞–Ω–∏—Ü–∞ 4 ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª (–ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º)</h2>
      <div id="p4Tables" class="fit"></div>
      <div class="hr"></div>
      <canvas id="p4Chart" height="120"></canvas>
    </section>

    <!-- –í—ã–≥—Ä—É–∑–∫–∏ -->
    <section class="card">
      <h2>6) –í—ã–≥—Ä—É–∑–∫–∏</h2>
      <p class="muted small">–§–∞–π–ª—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø–æ —Ç–µ–∫—É—â–∏–º —Ä–∞—Å—á—ë—Ç–∞–º –∏ –≥—Ä–∞—Ñ–∏–∫–∞–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ.</p>
      <div class="footer-actions">
        <button class="btn" id="dlPptx">üìä –°–∫–∞—á–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é PPTX</button>
        <button class="btn secondary" id="dlPptPdf">üìä –°–∫–∞—á–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é PDF</button>
        <button class="btn" id="dlDocx">üìë –°–∫–∞—á–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é —Å–ø—Ä–∞–≤–∫—É Word</button>
        <button class="btn secondary" id="dlDocPdf">üìë –°–∫–∞—á–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é —Å–ø—Ä–∞–≤–∫—É PDF</button>
      </div>
    </section>
  </main>

<script>
/* ============================== –£–¢–ò–õ–ò–¢–´ ============================== */
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.js";

const FILIALS = [
  "–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°",
  "–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°",
  "–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°",
  "–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°",
  "–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°",
  "–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°",
  "–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°",
  "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°",
  "–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°",
  "–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°",
  "–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°",
];

const CANON_STATUSES = [
  "–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è",
  "–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞",
  "–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ",
  "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –†–æ—Å—Å–µ—Ç–∏ –¶–∏—Ñ—Ä–∞",
  "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞",
  "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –≤ —Ñ–∏–ª–∏–∞–ª–µ",
];

function normStr(s){
  if(!s) return "";
  return s
    .replace(/\u00A0/g, " ")              // NBSP -> space
    .replace(/[‚Äê-‚Äì‚Äî‚àí]/g, "-")            // –≤—Å–µ –≤–∏–¥—ã —Ç–∏—Ä–µ -> "-"
    .replace(/\s+/g, " ")                // –º–Ω. –ø—Ä–æ–±–µ–ª—ã
    .trim();
}
function toIntSmart(s){
  if(s==null) return null;
  const m = String(s).match(/-?[\d\s]+$/);
  if(!m) return null;
  return parseInt(m[0].replace(/\s+/g,""),10);
}
/** –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ pdf.js –ø–æ —Å—Ç—Ä–æ–∫–∞–º —Å —É—á—ë—Ç–æ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã Y */
async function getPdfLines(file, pageNum){
  const loadingTask = pdfjsLib.getDocument({data: await file.arrayBuffer()});
  const pdf = await loadingTask.promise;
  const page = await pdf.getPage(pageNum);
  const tc = await page.getTextContent();
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ Y (—Å –¥–æ–ø—É—Å–∫–æ–º)
  const rows = new Map();
  tc.items.forEach(item=>{
    const y = Math.round(item.transform[5]); // y
    const key = y;
    if(!rows.has(key)) rows.set(key, []);
    rows.get(key).push(item.str);
  });
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ Y –ø–æ —É–±—ã–≤–∞–Ω–∏—é (pdf.js —á–∞—Å—Ç–æ –æ—Ç –≤–µ—Ä—Ö–∞ —ç–∫—Ä–∞–Ω–∞ –∫ –Ω–∏–∑—É)
  const ys = Array.from(rows.keys()).sort((a,b)=>b-a);
  const lines = ys.map(y=>normStr(rows.get(y).join(" "))).filter(Boolean);
  return lines;
}
/** –ò—â–µ–º –¥–∞—Ç—É "–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞ dd.mm.yyyy" –Ω–∞ —Å—Ç—Ä.1 */
async function extractDateAndTotals(file){
  const lines = await getPdfLines(file, 1);
  let date = null;
  for(const line of lines){
    const m = line.match(/–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞\s+(\d{2}\.\d{2}\.\d{4})/i);
    if(m){ date = m[1]; break; }
  }
  // –ò—Ç–æ–≥–∏ "–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ ... –≤ —Ç–æ–º —á–∏—Å–ª–µ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª ..."
  let inWorkTotal = null, inWorkRt = null;
  for(const line of lines){
    const m = line.match(/–í —Ä–∞–±–æ—Ç–µ.*?–≤—Å–µ–≥–æ\s+([\d\s]+).*?–≤ —Ç–æ–º\s+—á–∏—Å–ª–µ\s+–ü–ê–û\s+¬´?–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª?\s+([\d\s]+)/i);
    if(m){ inWorkTotal = toIntSmart(m[1]); inWorkRt = toIntSmart(m[2]); break; }
  }
  return {date, inWorkTotal, inWorkRt};
}

/** –ü–∞—Ä—Å–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü (—Å—Ç—Ä.2‚Äì4): –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É per filial */
async function parseFilialsOnPage(file, pageNum){
  const lines = await getPdfLines(file, pageNum);
  // –£–∫–æ—Ä–æ—Ç–∏–º –¥–ª–∏–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å "–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ..." –¥–æ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ
  function canonStatus(line){
    // –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    if(/–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ/i.test(line) && /—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ/i.test(line)) return CANON_STATUSES[0];
    if(/–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞/i.test(line)) return CANON_STATUSES[1];
    if(/–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ/i.test(line)) return CANON_STATUSES[2];
    if(/–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏/i.test(line)) return CANON_STATUSES[3];
    if(/–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏/i.test(line)) return CANON_STATUSES[4];
    if(/–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏/i.test(line)) return CANON_STATUSES[5];
    return null;
  }
  const data = {};
  let current = null;

  for(let raw of lines){
    const line = normStr(raw);
    // –§–∏–ª–∏–∞–ª + "–í—Å–µ–≥–æ –æ–ø–æ—Ä, —à—Ç." (–Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ –∏–ª–∏ –Ω–∞ —Å–æ—Å–µ–¥–Ω–µ–π)
    const filial = FILIALS.find(f => new RegExp("^" + f.replace(/[-.*+?^${}()|[\]\\]/g,'\\$&') + "\\b").test(line));
    if(filial){
      // –ò—â–µ–º —á–∏—Å–ª–æ –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ ‚Äî —ç—Ç–æ –í—Å–µ–≥–æ)
      let total = toIntSmart(line);
      // –ï—Å–ª–∏ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–µ —á–∏—Å–ª–∞ –Ω–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)
      if(isNaN(total)){
        // –Ω–∏—á–µ–≥–æ ‚Äî –æ—Å—Ç–∞–≤–∏–º null, –ø–æ–∑–∂–µ –º–æ–∂–µ—Ç –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è "–û–±—â–∏–π –∏—Ç–æ–≥"
      }
      if(!data[filial]) data[filial] = { total: isNaN(total)? null: total, statuses:{} };
      else data[filial].total = isNaN(total)? data[filial].total : total;
      current = filial;
      continue;
    }
    // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ ‚Äî —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
    if(current){
      const st = canonStatus(line);
      if(st){
        const v = toIntSmart(line);
        if(!isNaN(v)) data[current].statuses[st] = v;
        continue;
      }
    }
  }

  // –û–±—â–∏–π –∏—Ç–æ–≥ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  let overall = null;
  const totalLine = lines.find(l=>/–û–±—â–∏–π –∏—Ç–æ–≥/i.test(l));
  if(totalLine) overall = toIntSmart(totalLine);

  return {filials:data, overall};
}

function sumObjectValues(o){
  return Object.values(o || {}).reduce((a,b)=>a+(+b || 0),0);
}
function unionStatuses(d1, d2){
  const s = new Set();
  for(const f of Object.values(d1.filials||{})) Object.keys(f.statuses||{}).forEach(x=>s.add(x));
  for(const f of Object.values(d2.filials||{})) Object.keys(f.statuses||{}).forEach(x=>s.add(x));
  // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
  const ordered = CANON_STATUSES.filter(x=>s.has(x));
  for(const x of s) if(!ordered.includes(x)) ordered.push(x);
  return ordered;
}
function ensureTotalsIfMissing(parsed){
  // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ total –ø–æ —Ñ–∏–ª–∏–∞–ª—É, –ø—Ä–æ–±—É–µ–º –≤—ã–≤–µ—Å—Ç–∏ –∫–∞–∫ —Å—É–º–º–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
  for(const [k,v] of Object.entries(parsed.filials||{})){
    if(v.total==null){
      const s = sumObjectValues(v.statuses||{});
      if(s>0) v.total = s;
    }
  }
  // –ï—Å–ª–∏ overall –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å—É–º–º–∏—Ä—É–µ–º totals
  if(parsed.overall==null){
    parsed.overall = Object.values(parsed.filials||{}).reduce((a,b)=>a+(+b.total||0),0);
  }
}

/* ========================== –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ========================== */
let CURRENT = null;  // —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π —Ç–µ–∫—É—â–∏–π
let PREV = null;     // —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π
let P2_CHART = null, P3_CHART = null, P4_CHART = null;

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* ============================== –†–ï–ù–î–ï–†–ò–ù–ì ============================== */
function nfmt(v){
  return (v==null || isNaN(v)) ? "‚Äî" : v.toLocaleString('ru-RU');
}
function deltaFmt(v){
  if(v==null || isNaN(v)) return "‚Äî";
  const cls = v>0? "pos" : v<0? "neg" : "";
  const sign = v>0? "+" : "";
  return `<span class="delta ${cls}">${sign}${v.toLocaleString('ru-RU')}</span>`;
}

function renderKpi(){
  const kpi = $("#kpi");
  kpi.innerHTML = "";
  if(!CURRENT || !PREV) return;

  // ¬´–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç¬ª –±–µ—Ä—ë–º –∏–∑ —Å—Ç—Ä.2 ¬´–û–±—â–∏–π –∏—Ç–æ–≥¬ª
  const p2c = CURRENT.p2.overall, p2p = PREV.p2.overall;
  const revealed = (p2c!=null && p2p!=null) ? (p2c - p2p) : null;

  // –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª –±–µ—Ä—ë–º –∏–∑ —Å—Ç—Ä.4 ¬´–û–±—â–∏–π –∏—Ç–æ–≥¬ª
  const rtC = CURRENT.p4.overall, rtP = PREV.p4.overall;
  const rtDelta = (rtC!=null && rtP!=null) ? (rtC - rtP) : null;

  // –î–∞—Ç–∞
  $("#report-dates").textContent = `–¢–µ–∫—É—â–∏–π: ${CURRENT.meta.date || "‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${PREV.meta.date || "‚Äî"}`;

  kpi.innerHTML = `
    <div class="tile"><h3>–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç (—Å—Ç—Ä.2, –û–±—â–∏–π –∏—Ç–æ–≥)</h3>
      <div class="v">${nfmt(p2c)}</div>
      <div class="small muted">–ü—Ä–µ–¥.: ${nfmt(p2p)} ¬∑ –ò–∑–º.: ${deltaFmt(revealed)}</div>
    </div>
    <div class="tile"><h3>¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
      <div class="v">${nfmt(revealed)}</div>
      <div class="small muted">–†–∞—Å—á—ë—Ç: —Ç–µ–∫—É—â–∏–π –º–∏–Ω—É—Å –ø—Ä–µ–¥—ã–¥—É—â–∏–π</div>
    </div>
    <div class="tile"><h3>–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª, –≤—Å–µ–≥–æ (—Å—Ç—Ä.4, –û–±—â–∏–π –∏—Ç–æ–≥)</h3>
      <div class="v">${nfmt(rtC)}</div>
      <div class="small muted">–ü—Ä–µ–¥.: ${nfmt(rtP)} ¬∑ –ò–∑–º.: ${deltaFmt(rtDelta)}</div>
    </div>
  `;
}

function renderSection(targetId, curr, prev, title){
  // –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º: –í—Å–µ–≥–æ/–ò–∑–º–µ–Ω–µ–Ω–∏–µ + —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
  // –°—Ç–æ–ª–±—Ü—ã: –§–∏–ª–∏–∞–ª | –¢–µ–∫—É—â–∏–π | –ü—Ä–µ–¥—ã–¥—É—â–∏–π | –ò–∑–º–µ–Ω–µ–Ω–∏–µ
  ensureTotalsIfMissing(curr);
  ensureTotalsIfMissing(prev);
  const statuses = unionStatuses(curr, prev);

  const byFilialRows = FILIALS.map(f=>{
    const c = curr.filials[f] || {total:null, statuses:{}};
    const p = prev.filials[f] || {total:null, statuses:{}};
    const d = (c.total!=null && p.total!=null) ? (c.total - p.total) : null;
    return {f, c:c.total, p:p.total, d};
  });

  const totalC = byFilialRows.reduce((a,r)=>a+(+r.c||0),0);
  const totalP = byFilialRows.reduce((a,r)=>a+(+r.p||0),0);
  const totalD = (totalC - totalP);

  // –¢–∞–±–ª–∏—Ü–∞ 1: –í—Å–µ–≥–æ
  let html = `<div class="fit"><table><thead>
    <tr><th>–§–∏–ª–∏–∞–ª</th><th>–¢–µ–∫—É—â–∏–π</th><th>–ü—Ä–µ–¥—ã–¥—É—â–∏–π</th><th>–ò–∑–º.</th></tr>
  </thead><tbody>`;
  byFilialRows.forEach(r=>{
    const badge = r.d==null? "" : (r.d>0? '<span class="badge ok">‚Üë</span>' : r.d<0? '<span class="badge bad">‚Üì</span>' : '<span class="badge warn">0</span>');
    html += `<tr><td>${r.f}</td><td>${nfmt(r.c)}</td><td>${nfmt(r.p)}</td><td>${deltaFmt(r.d)} ${badge}</td></tr>`;
  });
  html += `</tbody><tfoot><tr><td>–ò–¢–û–ì–û –ø–æ –æ–±—â–µ—Å—Ç–≤—É</td><td>${nfmt(totalC)}</td><td>${nfmt(totalP)}</td><td>${deltaFmt(totalD)}</td></tr></tfoot></table></div>`;

  // –¢–∞–±–ª–∏—Ü–∞ 2: –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (–∫–∞–∂–¥—ã–π —Å—Ç–∞—Ç—É—Å ‚Äî —Å—É–º–º–∞ –ø–æ –æ–±—â–µ—Å—Ç–≤—É)
  html += `<div class="hr"></div><div class="fit"><table><thead>
    <tr><th>–°—Ç–∞—Ç—É—Å</th><th>–¢–µ–∫—É—â–∏–π</th><th>–ü—Ä–µ–¥—ã–¥—É—â–∏–π</th><th>–ò–∑–º.</th></tr>
  </thead><tbody>`;
  statuses.forEach(st=>{
    const c = Object.values(curr.filials).reduce((a,v)=>a+(+v.statuses[st]||0),0);
    const p = Object.values(prev.filials).reduce((a,v)=>a+(+v.statuses[st]||0),0);
    const d = c - p;
    html += `<tr><td>${st}</td><td>${nfmt(c)}</td><td>${nfmt(p)}</td><td>${deltaFmt(d)}</td></tr>`;
  });
  html += `</tbody><tfoot><tr><td><b>–ü—Ä–æ–≤–µ—Ä–∫–∞: —Å—É–º–º–∞ —Å—Ç–∞—Ç—É—Å–æ–≤</b></td><td>${nfmt(
      statuses.reduce((a,st)=>a+Object.values(curr.filials).reduce((x,v)=>x+(+v.statuses[st]||0),0),0)
    )}</td><td>${nfmt(
      statuses.reduce((a,st)=>a+Object.values(prev.filials).reduce((x,v)=>x+(+v.statuses[st]||0),0),0)
    )}</td><td></td></tr></tfoot></table></div>`;

  document.getElementById(targetId).innerHTML = html;

  return byFilialRows; // –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
}

function renderChart(canvasId, rows, label){
  const ctx = document.getElementById(canvasId);
  const labels = rows.map(r=>r.f);
  const deltas = rows.map(r=>r.d ?? 0);
  const currs  = rows.map(r=>r.c ?? 0);
  const prevs  = rows.map(r=>r.p ?? 0);

  // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —á–∞—Ä—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å
  if(canvasId==="p2Chart" && P2_CHART){ P2_CHART.destroy(); }
  if(canvasId==="p3Chart" && P3_CHART){ P3_CHART.destroy(); }
  if(canvasId==="p4Chart" && P4_CHART){ P4_CHART.destroy(); }

  const chart = new Chart(ctx, {
    type:'bar',
    data:{
      labels,
      datasets:[
        {label:'–ò–∑–º–µ–Ω–µ–Ω–∏–µ (—Ç–µ–∫—É—â–∏–π - –ø—Ä–µ–¥—ã–¥—É—â–∏–π)', data:deltas},
        {label:'–¢–µ–∫—É—â–∏–π', data:currs},
        {label:'–ü—Ä–µ–¥—ã–¥—É—â–∏–π', data:prevs},
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{position:'bottom'}, title:{display:true, text:label}},
      scales:{x:{stacked:false}, y:{beginAtZero:true}}
    }
  });
  if(canvasId==="p2Chart") P2_CHART = chart;
  if(canvasId==="p3Chart") P3_CHART = chart;
  if(canvasId==="p4Chart") P4_CHART = chart;
}

/* ============================== –í–´–ì–†–£–ó–ö–ò ============================== */
function yymmddRus(d){ return d?.replaceAll(".","-") || "–¥–∞—Ç–∞"; }

async function downloadPptx(){
  if(!CURRENT || !PREV) return;
  const pptx = new PptxGenJS();
  const dateC = CURRENT.meta.date, dateP = PREV.meta.date;

  // –°–ª–∞–π–¥ 1
  let slide = pptx.addSlide();
  slide.background = { color: '0033A0' };
  slide.addText("–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª", { x:0.5, y:0.4, fontSize:18, color:'FFFFFF', bold:true });
  slide.addText("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º –ø–æ–¥–≤–µ—Å–µ –í–û–õ–°", { x:0.5, y:1.0, fontSize:28, color:'FFFFFF', bold:true });
  slide.addText(`–¢–µ–∫—É—â–∏–π: ${dateC || "‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${dateP || "‚Äî"}`, { x:0.5, y:1.6, fontSize:16, color:'E3ECFF' });

  // –°–ª–∞–π–¥ 2: –û–±—â–∞—è –∏–Ω—Ñ–æ
  const p2c = CURRENT.p2.overall, p2p = PREV.p2.overall, revealed = (p2c!=null&&p2p!=null)?(p2c-p2p):null;
  slide = pptx.addSlide();
  slide.addText("–ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É", {x:0.5,y:0.5,fontSize:22,bold:true,color:'0033A0'});
  slide.addText(`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${p2c?.toLocaleString('ru-RU')||"‚Äî"} (–ø—Ä–µ–¥.: ${p2p?.toLocaleString('ru-RU')||"‚Äî"})`, {x:0.5,y:1.1,fontSize:16});
  slide.addText(`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${revealed?.toLocaleString('ru-RU')||"‚Äî"}`, {x:0.5,y:1.6,fontSize:16});

  // –°–ª–∞–π–¥ 3‚Äì5: –¥–∏–∞–≥—Ä–∞–º–º—ã (–≤—Å—Ç–∞–≤–∏–º –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ canvas)
  async function addChartSlide(title, canvasId){
    const cnv = document.getElementById(canvasId);
    const b64 = cnv.toDataURL("image/png");
    const slide = pptx.addSlide();
    slide.addText(title, {x:0.5,y:0.5,fontSize:22,bold:true,color:'0033A0'});
    slide.addImage({ data: b64, x:0.5, y:1.1, w:9.0, h:4.6 });
  }
  await addChartSlide("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2", "p2Chart");
  await addChartSlide("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425", "p3Chart");
  await addChartSlide("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", "p4Chart");

  await pptx.writeFile({ fileName: `–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${yymmddRus(dateC)}.pptx` });
}

async function downloadPptPdf(){
  if(!CURRENT || !PREV) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const dateC = CURRENT.meta.date, dateP = PREV.meta.date;

  function addTitlePage(){
    doc.setFillColor("#0033A0"); doc.rect(0,0,595,842,"F");
    doc.setTextColor("#FFFFFF"); doc.setFont("helvetica","bold"); doc.setFontSize(18);
    doc.text("–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª", 40, 60);
    doc.setFontSize(26); doc.text("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º –ø–æ–¥–≤–µ—Å–µ –í–û–õ–°", 40, 110);
    doc.setFontSize(14); doc.text(`–¢–µ–∫—É—â–∏–π: ${dateC||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${dateP||"‚Äî"}`, 40, 150);
  }
  function addSummary(){
    doc.addPage(); doc.setTextColor("#0033A0"); doc.setFont("helvetica","bold"); doc.setFontSize(20);
    doc.text("–ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É", 40, 50);
    doc.setTextColor("#000"); doc.setFont("helvetica","normal"); doc.setFontSize(12);
    const p2c = CURRENT.p2.overall, p2p = PREV.p2.overall, revealed = (p2c!=null&&p2p!=null)?(p2c-p2p):null;
    doc.text(`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${p2c?.toLocaleString('ru-RU')||"‚Äî"} (–ø—Ä–µ–¥.: ${p2p?.toLocaleString('ru-RU')||"‚Äî"})`, 40, 90);
    doc.text(`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${revealed?.toLocaleString('ru-RU')||"‚Äî"}`, 40, 110);
  }
  async function addChart(title, canvasId){
    doc.addPage();
    doc.setTextColor("#0033A0"); doc.setFont("helvetica","bold"); doc.setFontSize(16);
    doc.text(title, 40, 50);
    const cnv = document.getElementById(canvasId);
    const img = cnv.toDataURL("image/png");
    doc.addImage(img, "PNG", 40, 70, 515, 300);
  }

  addTitlePage();
  addSummary();
  await addChart("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –°—Ç—Ä.2", "p2Chart");
  await addChart("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425", "p3Chart");
  await addChart("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", "p4Chart");

  doc.save(`–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${yymmddRus(dateC)}.pdf`);
}

async function downloadDocx(){
  if(!CURRENT || !PREV) return;
  const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, Packer } = docx;

  const p2Rows = FILIALS.map(f=>{
    const c = CURRENT.p2.filials[f]?.total ?? null;
    const p = PREV.p2.filials[f]?.total ?? null;
    const d = (c!=null && p!=null) ? (c - p) : null;
    return {f,c,p,d};
  });

  const head = new TableRow({
    children:[
      new TableCell({children:[new Paragraph({text:"–§–∏–ª–∏–∞–ª", bold:true})]}),
      new TableCell({children:[new Paragraph({text:"–¢–µ–∫—É—â–∏–π", bold:true})]}),
      new TableCell({children:[new Paragraph({text:"–ü—Ä–µ–¥—ã–¥—É—â–∏–π", bold:true})]}),
      new TableCell({children:[new Paragraph({text:"–ò–∑–º.", bold:true})]}),
    ]
  });

  const rows = p2Rows.map(r=>new TableRow({
    children:[
      new TableCell({children:[new Paragraph(r.f)]}),
      new TableCell({children:[new Paragraph(nfmt(r.c))]}),
      new TableCell({children:[new Paragraph(nfmt(r.p))]}),
      new TableCell({children:[new Paragraph((r.d>0?"+":"") + (r.d?.toLocaleString('ru-RU') ?? "‚Äî"))]}),
    ]
  }));

  const table = new Table({
    rows:[head, ...rows],
    width:{size:100, type:WidthType.PERCENTAGE}
  });

  const p2c = CURRENT.p2.overall, p2p = PREV.p2.overall, revealed = (p2c!=null&&p2p!=null)?(p2c-p2p):null;

  const docxFile = new Document({
    sections:[{
      properties:{},
      children:[
        new Paragraph({alignment:AlignmentType.LEFT, children:[
          new TextRun({text:"–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª", bold:true, size:28})
        ]}),
        new Paragraph({text:"–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º—É –ø–æ–¥–≤–µ—Å—É –í–û–õ–°", spacing:{after:120}}),
        new Paragraph({text:`–¢–µ–∫—É—â–∏–π: ${CURRENT.meta.date||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${PREV.meta.date||"‚Äî"}`, spacing:{after:180}}),

        new Paragraph({text:"–ò—Ç–æ–≥–∏ –ø–æ –æ–±—â–µ—Å—Ç–≤—É", bold:true}),
        new Paragraph({text:`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${nfmt(p2c)} (–ø—Ä–µ–¥.: ${nfmt(p2p)})`}),
        new Paragraph({text:`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${nfmt(revealed)}`, spacing:{after:180}}),

        new Paragraph({text:"–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (—Å—Ç—Ä.2 ‚Äî –í—Å–µ–≥–æ)", bold:true}),
        table,

        new Paragraph({text:"–ö—Ä–∞—Ç–∫–∏–µ –≤—ã–≤–æ–¥—ã:", bold:true, spacing:{before:200}}),
        new Paragraph({text:"1) –†–æ—Å—Ç/—Å–Ω–∏–∂–µ–Ω–∏–µ –≤ —Ä–∞–∑—Ä–µ–∑–µ —Ñ–∏–ª–∏–∞–ª–æ–≤ –æ—Ç—Ä–∞–∂—ë–Ω –≤ –∫–æ–ª–æ–Ω–∫–µ ¬´–ò–∑–º.¬ª."}),
        new Paragraph({text:"2) –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ ‚Äî –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –Ω–∞ —Å–∞–π—Ç–µ."}),
      ]
    }]
  });

  const blob = await Packer.toBlob(docxFile);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `–°–ø—Ä–∞–≤–∫–∞_–í–û–õ–°_${yymmddRus(CURRENT.meta.date)}.docx`;
  a.click();
}

async function downloadDocPdf(){
  if(!CURRENT || !PREV) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});

  const p2c = CURRENT.p2.overall, p2p = PREV.p2.overall, revealed = (p2c!=null&&p2p!=null)?(p2c-p2p):null;

  doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor("#0033A0");
  doc.text("–ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–º—É –ø–æ–¥–≤–µ—Å—É –í–û–õ–°", 40, 50);
  doc.setFont("helvetica","normal"); doc.setTextColor("#000");
  doc.text(`–¢–µ–∫—É—â–∏–π: ${CURRENT.meta.date||"‚Äî"} ¬∑ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${PREV.meta.date||"‚Äî"}`, 40, 75);
  doc.text(`–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç: ${nfmt(p2c)} (–ø—Ä–µ–¥.: ${nfmt(p2p)})`, 40, 100);
  doc.text(`¬´–í—ã—è–≤–ª–µ–Ω–æ¬ª –∑–∞ –Ω–µ–¥–µ–ª—é: ${nfmt(revealed)}`, 40, 120);

  // –ù–µ–±–æ–ª—å—à–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —Ç–æ–ø-5 –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const top = FILIALS.map(f=>{
    const c = CURRENT.p2.filials[f]?.total ?? null;
    const p = PREV.p2.filials[f]?.total ?? null;
    const d = (c!=null && p!=null) ? (c - p) : null;
    return {f,c,p,d};
  }).filter(x=>x.d!=null).sort((a,b)=>Math.abs(b.d)-Math.abs(a.d)).slice(0,5);

  let y = 160;
  doc.setFont("helvetica","bold"); doc.text("–¢–æ–ø-5 –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Å—Ç—Ä.2 ‚Äî –í—Å–µ–≥–æ)", 40, y);
  y+=20; doc.setFont("helvetica","normal");
  doc.text("–§–∏–ª–∏–∞–ª                –¢–µ–∫—É—â–∏–π    –ü—Ä–µ–¥.    –ò–∑–º.", 40, y); y+=14;
  top.forEach(r=>{
    const line = `${r.f.padEnd(22," ")} ${nfmt(r.c).padStart(8," ")}  ${nfmt(r.p).padStart(8," ")}  ${(r.d>0?"+":"")+(r.d?.toLocaleString('ru-RU')??"‚Äî")}`;
    doc.text(line, 40, y); y+=14;
  });

  doc.save(`–°–ø—Ä–∞–≤–∫–∞_–í–û–õ–°_${yymmddRus(CURRENT.meta.date)}.pdf`);
}

/* ============================== –ü–ê–†–°–ò–ù–ì ============================== */
async function parseOne(file){
  const meta = await extractDateAndTotals(file);
  const p2 = await parseFilialsOnPage(file, 2);
  const p3 = await parseFilialsOnPage(file, 3);
  const p4 = await parseFilialsOnPage(file, 4);

  // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è overall
  ensureTotalsIfMissing(p2);
  ensureTotalsIfMissing(p3);
  ensureTotalsIfMissing(p4);

  return { meta, p2, p3, p4 };
}

/* ============================== UI –õ–û–ì–ò–ö–ê ============================== */
const fileC = $("#fileCurrent");
const fileP = $("#filePrev");
[fileC, fileP].forEach(inp=>inp.addEventListener("change", ()=>{
  $("#btnParse").disabled = !(fileC.files[0] && fileP.files[0]);
  $("#parseStatus").textContent = "";
}));

$("#btnParse").addEventListener("click", async ()=>{
  const fC = fileC.files[0], fP = fileP.files[0];
  if(!fC || !fP) return;
  $("#btnParse").disabled = true;
  $("#parseStatus").textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF...";

  try{
    const [cur, prev] = await Promise.all([parseOne(fC), parseOne(fP)]);
    CURRENT = cur; PREV = prev;

    renderKpi();

    // –°—Ç—Ä.2
    const rows2 = renderSection("p2Tables", CURRENT.p2, PREV.p2, "–°—Ç—Ä–∞–Ω–∏—Ü–∞ 2");
    renderChart("p2Chart", rows2, "–°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 ‚Äî –í—Å–µ–≥–æ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (—Ç–µ–∫—É—â–∏–π/–ø—Ä–µ–¥—ã–¥—É—â–∏–π/–∏–∑–º–µ–Ω–µ–Ω–∏–µ)");

    // –°—Ç—Ä.3
    const rows3 = renderSection("p3Tables", CURRENT.p3, PREV.p3, "–ü—Ä–∏–∫–∞–∑ ‚Ññ425");
    renderChart("p3Chart", rows3, "–ü—Ä–∏–∫–∞–∑ ‚Ññ425 ‚Äî –í—Å–µ–≥–æ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º");

    // –°—Ç—Ä.4
    const rows4 = renderSection("p4Tables", CURRENT.p4, PREV.p4, "–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª");
    renderChart("p4Chart", rows4, "–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª ‚Äî –í—Å–µ–≥–æ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º");

    $("#parseStatus").textContent = "–ì–æ—Ç–æ–≤–æ.";
  }catch(e){
    console.error(e);
    $("#parseStatus").textContent = "–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç—Ä–∞–Ω–∏—Ü 2‚Äì4.";
  }finally{
    $("#btnParse").disabled = false;
  }
});

/* ============================== –ö–ù–û–ü–ö–ò –í–´–ì–†–£–ó–û–ö ============================== */
$("#dlPptx").addEventListener("click", downloadPptx);
$("#dlPptPdf").addEventListener("click", downloadPptPdf);
$("#dlDocx").addEventListener("click", downloadDocx);
$("#dlDocPdf").addEventListener("click", downloadDocPdf);

</script>
</body>
</html>
