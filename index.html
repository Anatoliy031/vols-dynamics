<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–î–∏–Ω–∞–º–∏–∫–∞ –í–û–õ–° | –ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== –¢–æ–∫–µ–Ω—ã –±—Ä–µ–Ω–¥–∞ (–†–æ—Å—Å–µ—Ç–∏) - –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ ====== */
    :root{
      --rs-blue:#0033A0;
      --rs-blue-600:#002E91;
      --rs-blue-700:#002680;
      --rs-accent:#00B4F0;
      --rs-accent-light:#4AC7F3;
      
      --bg:#F8FAFD;
      --bg-dark:#F1F5F9;
      --card:#FFFFFF;
      --card-hover:#FAFBFD;
      
      --border:#E2E8F0;
      --border-light:#EDF2F7;
      
      --ink:#0F172A;
      --ink-light:#1E293B;
      --muted:#64748B;
      --muted-light:#94A3B8;
      
      --success:#059669;
      --success-light:#10B981;
      --success-bg:#D1FAE5;
      
      --danger:#DC2626;
      --danger-light:#EF4444;
      --danger-bg:#FEE2E2;
      
      --warning:#D97706;
      --warning-light:#F59E0B;
      --warning-bg:#FEF3C7;
      
      --shadow-sm:0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow:0 4px 12px -2px rgba(0,0,0,0.08), 0 2px 6px -2px rgba(0,0,0,0.04);
      --shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      --shadow-xl:0 25px 50px -12px rgba(0,0,0,0.25);
      
      --radius-sm:8px;
      --radius:12px;
      --radius-lg:16px;
      --radius-xl:20px;
      
      --transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast:all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ ====== */
    *{box-sizing:border-box}
    
    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--ink);
      font-family:'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      font-size:16px;
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    
    img{max-width:100%;display:block;height:auto}
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ====== –®–∞–ø–∫–∞ ====== */
    header{
      position:sticky;
      top:0;
      z-index:50;
      background:linear-gradient(135deg, var(--rs-blue) 0%, var(--rs-blue-700) 100%);
      color:#fff;
      padding:0;
      border-bottom:1px solid rgba(255,255,255,0.1);
      box-shadow:var(--shadow-lg);
      backdrop-filter:blur(12px);
      animation: slideDown 0.6s ease-out;
    }
    
    .header-inner{
      max-width:1440px;
      margin:0 auto;
      padding:20px 24px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    
    .brand{
      display:flex;
      gap:16px;
      align-items:center;
      font-weight:700;
      font-size:18px;
      letter-spacing:-0.02em;
    }
    
    .brand .logo{
      width:48px;
      height:48px;
      background:rgba(255,255,255,0.15);
      border-radius:var(--radius);
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,0.2);
      transition:var(--transition);
    }
    
    .brand:hover .logo{
      background:rgba(255,255,255,0.25);
      transform:scale(1.05);
    }
    
    .brand .logo-icon{
      width:24px;
      height:24px;
      background:#fff;
      border-radius:50%;
      position:relative;
    }
    
    .brand .logo-icon::after{
      content:'';
      position:absolute;
      inset:6px;
      background:var(--rs-blue);
      border-radius:50%;
    }
    
    .header-badge{
      background:rgba(255,255,255,0.15);
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,0.2);
      padding:8px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .status-dot{
      width:8px;
      height:8px;
      background:#10B981;
      border-radius:50%;
      animation:pulse 2s infinite;
    }
    
    @keyframes pulse{
      0%,100%{opacity:1;transform:scale(1)}
      50%{opacity:0.8;transform:scale(1.2)}
    }

    /* ====== –ú–∞–∫–µ—Ç ====== */
    .container{
      max-width:1440px;
      margin:24px auto;
      padding:0 24px;
      animation: fadeIn 0.8s ease-out;
    }
    
    .grid{
      display:grid;
      gap:20px;
    }
    
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    
    @media(max-width:1200px){
      .cols-3{grid-template-columns:1fr}
    }
    @media(max-width:900px){
      .cols-2{grid-template-columns:1fr}
    }

    /* ====== –ö–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .card{
      background:var(--card);
      border:1px solid var(--border-light);
      border-radius:var(--radius-lg);
      padding:24px;
      box-shadow:var(--shadow);
      transition:var(--transition);
      position:relative;
      overflow:hidden;
    }
    
    .card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:4px;
      background:linear-gradient(90deg, var(--rs-accent) 0%, var(--rs-accent-light) 100%);
      opacity:0;
      transition:var(--transition);
    }
    
    .card:hover{
      box-shadow:var(--shadow-lg);
      transform:translateY(-2px);
    }
    
    .card:hover::before{
      opacity:1;
    }
    
    h2{
      margin:0 0 16px 0;
      font-size:20px;
      font-weight:700;
      color:var(--ink);
      letter-spacing:-0.02em;
    }
    
    h3{
      margin:12px 0 8px 0;
      font-size:16px;
      font-weight:600;
      color:var(--ink-light);
    }
    
    .sub{
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
    }

    /* ====== –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã ====== */
    .inputs{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    
    .pill{
      display:inline-flex;
      align-items:center;
      gap:12px;
      background:var(--bg);
      border:2px dashed var(--border);
      border-radius:var(--radius);
      padding:12px 16px;
      font-size:14px;
      font-weight:500;
      color:var(--ink-light);
      transition:var(--transition);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    
    .pill:hover{
      border-color:var(--rs-accent);
      background:var(--card);
      transform:translateY(-1px);
    }
    
    .pill::after{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(45deg, transparent 40%, rgba(0,180,240,0.1) 50%, transparent 60%);
      transform:translateX(-100%);
      transition:transform 0.6s;
    }
    
    .pill:hover::after{
      transform:translateX(100%);
    }
    
    input[type=file]{
      width:0.1px;
      height:0.1px;
      opacity:0;
      overflow:hidden;
      position:absolute;
      z-index:-1;
    }
    
    button{cursor:pointer;border:none;font-family:inherit}
    
    .btn{
      border-radius:var(--radius);
      padding:12px 20px;
      font-weight:600;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:var(--transition);
      position:relative;
      overflow:hidden;
    }
    
    .btn.primary{
      background:linear-gradient(135deg, var(--rs-blue) 0%, var(--rs-blue-600) 100%);
      color:#fff;
      box-shadow:var(--shadow);
    }
    
    .btn.primary:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow-lg);
    }
    
    .btn.secondary{
      background:var(--card);
      color:var(--rs-blue);
      border:2px solid var(--rs-blue);
    }
    
    .btn.secondary:hover{
      background:var(--rs-blue);
      color:#fff;
      transform:translateY(-2px);
    }
    
    .btn.ghost{
      background:transparent;
      border:2px dashed var(--border);
      color:var(--muted);
    }
    
    .btn.ghost:hover{
      border-color:var(--rs-accent);
      color:var(--rs-accent);
      background:var(--bg);
    }
    
    .btn::before{
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:0;
      height:0;
      border-radius:50%;
      background:rgba(255,255,255,0.3);
      transform:translate(-50%, -50%);
      transition:width 0.6s, height 0.6s;
    }
    
    .btn:hover::before{
      width:300px;
      height:300px;
    }

    .exports{display:flex;flex-wrap:wrap;gap:10px}
    .note{font-size:14px;color:var(--muted);margin-top:8px}

    /* ====== KPI ====== */
    .kpis{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:16px;
    }
    
    @media(max-width:1200px){.kpis{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.kpis{grid-template-columns:1fr}}
    
    .kpi{
      border:1px solid var(--border-light);
      border-radius:var(--radius-lg);
      padding:20px;
      background:var(--card);
      display:grid;
      gap:8px;
      transition:var(--transition);
      position:relative;
      overflow:hidden;
    }
    
    .kpi::before{
      content:'';
      position:absolute;
      top:-50%;
      right:-50%;
      width:100%;
      height:100%;
      background:radial-gradient(circle, var(--rs-accent) 0%, transparent 70%);
      opacity:0.05;
      transition:var(--transition);
    }
    
    .kpi:hover{
      transform:translateY(-4px);
      box-shadow:var(--shadow-lg);
    }
    
    .kpi:hover::before{
      opacity:0.1;
    }
    
    .kpi .title{
      color:var(--muted);
      font-size:13px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }
    
    .kpi .value{
      font-size:28px;
      font-weight:800;
      color:var(--ink);
      letter-spacing:-0.02em;
    }
    
    .kpi .delta{
      font-size:14px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    
    .up{color:var(--success)}
    .down{color:var(--danger)}
    .muted{color:var(--muted)}
    
    .up::before{content:'‚Üë'}
    .down::before{content:'‚Üì'}

    /* ====== –¢–∞–±–ª–∏—Ü—ã ====== */
    .table-wrap{
      max-height:480px;
      overflow:auto;
      border:1px solid var(--border-light);
      border-radius:var(--radius);
      background:var(--card);
      box-shadow:var(--shadow-sm);
    }
    
    .table-wrap::-webkit-scrollbar{
      width:10px;
      height:10px;
    }
    
    .table-wrap::-webkit-scrollbar-track{
      background:var(--bg);
      border-radius:var(--radius);
    }
    
    .table-wrap::-webkit-scrollbar-thumb{
      background:var(--border);
      border-radius:var(--radius);
      border:2px solid var(--bg);
    }
    
    .table-wrap::-webkit-scrollbar-thumb:hover{
      background:var(--muted-light);
    }
    
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    
    thead th{
      position:sticky;
      top:0;
      background:var(--bg-dark);
      border-bottom:2px solid var(--border);
      padding:12px 16px;
      text-align:right;
      font-weight:700;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--muted);
      z-index:1;
    }
    
    thead th:first-child{text-align:left}
    
    tbody td{
      padding:12px 16px;
      border-bottom:1px solid var(--border-light);
      text-align:right;
      font-variant-numeric:tabular-nums;
      transition:var(--transition-fast);
    }
    
    tbody td:first-child{
      text-align:left;
      font-weight:500;
      color:var(--ink-light);
    }
    
    tbody tr{
      transition:var(--transition-fast);
    }
    
    tbody tr:hover{
      background:var(--bg);
    }
    
    tbody tr:hover td{
      color:var(--ink);
    }
    
    tfoot td{
      padding:12px 16px;
      font-weight:700;
      background:var(--bg-dark);
      border-top:2px solid var(--border);
      position:sticky;
      bottom:0;
    }
    
    .badge{
      display:inline-block;
      padding:4px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      background:var(--bg);
      color:var(--muted);
      border:1px solid var(--border-light);
    }

    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º */
    .compact table{font-size:12px}
    .compact thead th,
    .compact tbody td,
    .compact tfoot td{padding:8px 12px}
    
    .hr{
      height:1px;
      background:var(--border-light);
      margin:20px 0;
      border:none;
    }

    /* ====== –ì—Ä–∞—Ñ–∏–∫–∏ ====== */
    .chart-box{
      height:400px;
      padding:16px;
      background:var(--bg);
      border-radius:var(--radius);
      position:relative;
    }
    
    .chart-box::before{
      content:'';
      position:absolute;
      inset:0;
      background:
        linear-gradient(90deg, transparent 0%, transparent calc(100% - 1px), var(--border-light) 100%),
        linear-gradient(180deg, transparent 0%, transparent calc(100% - 1px), var(--border-light) 100%);
      background-size:40px 40px;
      background-position:-1px -1px;
      opacity:0.3;
      pointer-events:none;
      border-radius:var(--radius);
    }
    
    canvas{
      width:100% !important;
      height:100% !important;
      position:relative;
      z-index:1;
    }

    /* –ú–∞—Ç—Ä–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ */
    .status-matrix-wrap{
      overflow-x:auto;
      overflow-y:hidden;
      width:100%;
      border-radius:var(--radius);
    }
    
    .status-matrix{
      min-width:700px;
      font-size:13px;
    }
    
    .status-matrix th,
    .status-matrix td{
      padding:10px 12px;
      white-space:nowrap;
    }
    
    .status-matrix tbody tr:hover{
      background:var(--bg);
    }

    /* ====== –ü–µ—á–∞—Ç–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ ====== */
    #presentationPrint,
    #summaryPrint{
      background:#fff;
      padding:32px;
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-lg);
    }
    
    .logoTitle{
      font-weight:800;
      color:var(--rs-blue);
      font-size:24px;
      margin-bottom:16px;
      letter-spacing:-0.02em;
    }

    /* ====== Loading –∏ —Å–æ–æ–±—â–µ–Ω–∏—è ====== */
    #loadingMsg{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 16px;
      background:var(--bg);
      border-radius:var(--radius);
      font-weight:500;
      color:var(--rs-accent);
    }
    
    #loadingMsg::before{
      content:'';
      width:16px;
      height:16px;
      border:2px solid var(--rs-accent);
      border-top-color:transparent;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    
    #errorMsg{
      padding:12px 16px;
      background:var(--danger-bg);
      color:var(--danger);
      border-radius:var(--radius);
      font-weight:500;
      display:inline-block;
      margin-top:8px;
    }
    
    #exportStatus{
      padding:8px 16px;
      background:var(--success-bg);
      color:var(--success);
      border-radius:var(--radius);
      font-weight:500;
      display:inline-block;
      margin-top:8px;
    }

    /* ====== –ö–∞—Å—Ç–æ–º–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ====== */
    .planfact-scale table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
    }
    
    .planfact-scale th,
    .planfact-scale td{
      padding:10px;
      border:1px solid var(--border-light);
      text-align:center;
    }
    
    .planfact-scale th{
      background:var(--bg-dark);
      font-weight:600;
      color:var(--muted);
    }
    
    .info-box{
      background:var(--bg);
      border-left:4px solid var(--rs-accent);
      padding:16px;
      margin:16px 0;
      border-radius:0 var(--radius) var(--radius) 0;
    }
    
    /* ====== –ü—Ä–∏–Ω—Ç ====== */
    @media print{
      body{background:#fff}
      header{display:none}
      .container{margin:0;padding:16px}
      .card{box-shadow:none;border:1px solid #ddd}
      .table-wrap{max-height:none;overflow:visible;box-shadow:none}
      .chart-box{page-break-inside:avoid}
      .btn{display:none}
      #presentationPrint,
      #summaryPrint{
        padding:20mm;
        box-shadow:none;
        border:none;
      }
    }

    /* ====== –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å ====== */
    @media(max-width:640px){
      .header-inner{padding:16px}
      .brand{font-size:16px}
      .brand .logo{width:40px;height:40px}
      .header-badge{display:none}
      .container{padding:0 16px;margin:16px auto}
      .card{padding:16px}
      h2{font-size:18px}
      .kpi .value{font-size:24px}
      .btn{padding:10px 16px;font-size:13px}
      .exports{gap:8px}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo">
          <div class="logo-icon"></div>
        </div>
        <span>–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª ‚Äî –í–û–õ–°: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å</span>
      </div>
      <div class="header-badge">
        <div class="status-dot"></div>
        <span>–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
      </div>
    </div>
  </header>

  <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç -->
  <div class="container grid cols-2">
    <section class="card">
      <h2>üìä –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤</h2>
      <div class="inputs">
        <label class="pill">
          üìÖ –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)
          <input id="filePrev" type="file" accept="application/pdf">
        </label>
        <label class="pill">
          üìÖ –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)
          <input id="fileCurr" type="file" accept="application/pdf">
        </label>
        <button id="btnParse" class="btn primary">üöÄ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="btnCompact" class="btn ghost" title="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º">‚ö° –ö–æ–º–ø–∞–∫—Ç</button>
      </div>
      <div class="note" id="dates">–î–∞—Ç—ã –æ—Ç—á—ë—Ç–æ–≤: ‚Äî</div>
      <div class="note">üí° ¬´–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é¬ª = ¬´–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç.¬ª (—Ç–µ–∫—É—â–∞—è ‚àí –ø—Ä–µ–¥—ã–¥—É—â–∞—è)</div>
      <div class="hr"></div>
      <div id="loadingMsg" style="display:none">–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF...</div>
      <div id="errorMsg" style="display:none"></div>
    </section>

    <section class="card">
      <h2>üíæ –í—ã–≥—Ä—É–∑–∫–∏ (—Ñ–æ—Ä–º–∞—Ç –†–æ—Å—Å–µ—Ç–∏)</h2>
      <div class="exports">
        <button class="btn secondary" id="exportPresPDF">üìë –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (PDF)</button>
        <button class="btn secondary" id="exportBriefPDF">üìã –í—ã–∂–∏–º–∫–∞ (PDF)</button>
        <button class="btn secondary" id="exportWordHTML">üìù –û—Ç—á–µ—Ç (Word HTML)</button>
        <button class="btn secondary" id="exportPresHTML">üåê –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (HTML)</button>
      </div>
      <div id="exportStatus" style="display:none"></div>
    </section>
  </div>

  <!-- KPI -->
  <div class="container card">
    <h2>üéØ –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
    <div id="kpis" class="kpis"></div>
  </div>

  <!-- –°—Ç—Ä. 2 -->
  <div class="container grid cols-2">
    <section class="card">
      <h2>üìà –°—Ç—Ä. 2 ‚Äî ¬´–í—Å–µ–≥–æ –æ–ø–æ—Ä, —à—Ç.¬ª –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º <span class="badge">Œî: —Ç–µ–∫. vs –ø—Ä–µ–¥.</span></h2>
      <div class="chart-box"><canvas id="chartBranches"></canvas></div>
    </section>
    <section class="card">
      <h2>üìä –¢–∞–±–ª–∏—Ü–∞ (—Å—Ç—Ä. 2) ‚Äî Œî ¬´–í—Å–µ–≥–æ –æ–ø–æ—Ä, —à—Ç.¬ª</h2>
      <div class="table-wrap">
        <table id="tblBranches">
          <thead><tr><th>–§–∏–ª–∏–∞–ª</th><th>–ü—Ä–µ–¥., —à—Ç.</th><th>–¢–µ–∫., —à—Ç.</th><th>Œî, —à—Ç.</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><td>–ò—Ç–æ–≥–æ</td><td id="sumPrev">0</td><td id="sumCurr">0</td><td id="sumDelta">0</td></tr></tfoot>
        </table>
      </div>
    </section>
  </div>

  <!-- –°—Ç—Ä. 3 -->
  <div class="container grid cols-2">
    <section class="card">
      <h2>üìà –°—Ç—Ä. 3 ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425: ¬´–í—Å–µ–≥–æ –æ–ø–æ—Ä, —à—Ç.¬ª –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
      <div class="chart-box"><canvas id="chartBranchesS3"></canvas></div>
    </section>
    <section class="card">
      <h2>üìä –¢–∞–±–ª–∏—Ü–∞ (—Å—Ç—Ä. 3) ‚Äî Œî ¬´–í—Å–µ–≥–æ –æ–ø–æ—Ä, —à—Ç.¬ª</h2>
      <div class="table-wrap">
        <table id="tblBranchesS3">
          <thead><tr><th>–§–∏–ª–∏–∞–ª</th><th>–ü—Ä–µ–¥., —à—Ç.</th><th>–¢–µ–∫., —à—Ç.</th><th>Œî, —à—Ç.</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><td>–ò—Ç–æ–≥–æ</td><td id="sumPrevS3">0</td><td id="sumCurrS3">0</td><td id="sumDeltaS3">0</td></tr></tfoot>
        </table>
      </div>
    </section>
  </div>

  <!-- –°—Ç—Ä. 4 -->
  <div class="container grid cols-2">
    <section class="card">
      <h2>üìà –°—Ç—Ä. 4 ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª: ¬´–í—Å–µ–≥–æ –æ–ø–æ—Ä, —à—Ç.¬ª –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
      <div class="chart-box"><canvas id="chartBranchesS4"></canvas></div>
    </section>
    <section class="card">
      <h2>üìä –¢–∞–±–ª–∏—Ü–∞ (—Å—Ç—Ä. 4) ‚Äî Œî ¬´–í—Å–µ–≥–æ –æ–ø–æ—Ä, —à—Ç.¬ª</h2>
      <div class="table-wrap">
        <table id="tblBranchesS4">
          <thead><tr><th>–§–∏–ª–∏–∞–ª</th><th>–ü—Ä–µ–¥., —à—Ç.</th><th>–¢–µ–∫., —à—Ç.</th><th>Œî, —à—Ç.</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><td>–ò—Ç–æ–≥–æ</td><td id="sumPrevS4">0</td><td id="sumCurrS4">0</td><td id="sumDeltaS4">0</td></tr></tfoot>
        </table>
      </div>
    </section>
  </div>

  <div class="container">
    <section class="card">
      <h2>üìä –°—Ç—Ä. 4 ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª: Œî –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
      <div class="chart-box"><canvas id="chartRTKDelta"></canvas></div>
    </section>
  </div>

  <!-- –°—Ç–∞–¥–∏–∏ -->
  <div class="container grid cols-3">
    <section class="card">
      <h2>üìã –°—Ç—Ä. 2 ‚Äî –°—Ç–∞–¥–∏–∏ (–ø—Ä–∏—Ä–æ—Å—Ç)</h2>
      <div class="table-wrap">
        <table id="tblStagesS2">
          <thead><tr><th>–°—Ç–∞–¥–∏—è</th><th>–ü—Ä–µ–¥., —à—Ç.</th><th>–¢–µ–∫., —à—Ç.</th><th>Œî, —à—Ç.</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    <section class="card">
      <h2>üìã –°—Ç—Ä. 4 (–†–¢–ö) ‚Äî –°—Ç–∞–¥–∏–∏ (–ø—Ä–∏—Ä–æ—Å—Ç)</h2>
      <div class="table-wrap">
        <table id="tblStagesS4">
          <thead><tr><th>–°—Ç–∞–¥–∏—è</th><th>–ü—Ä–µ–¥., —à—Ç.</th><th>–¢–µ–∫., —à—Ç.</th><th>Œî, —à—Ç.</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    <!-- –ò–Ω—Å–∞–π—Ç—ã —É–±—Ä–∞–Ω—ã —Å–æ –≤—Å–µ–≥–æ —Å–∞–π—Ç–∞ -->
    <section class="card insights-card">
      <h2>–ò–Ω—Å–∞–π—Ç—ã (–∞–≤—Ç–æ)</h2>
      <div id="insightsBox" class="sub">‚Äî</div>
    </section>
  </div>

  <!-- –ü–ï–ß–ê–¢–ù–´–ï –û–ë–õ–ê–°–¢–ò (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞) -->
  <div id="presentationPrint" class="compact" style="display:none">
    <div class="logoTitle">–î–∏–Ω–∞–º–∏–∫–∞ –í–û–õ–°</div>
    <div id="presPlanFactTop" class="section">
      <div class="planfact-scale" id="presPlanFactInner"></div>
    </div>
    <div id="presDates" class="note" style="margin:8px 0 16px"></div>
    <div id="presKpis" class="section"></div>
    <div class="hr"></div>
    <div id="presTable" class="section"></div>
    <div class="hr"></div>
    <div id="presTableS3" class="section"></div>
    <div class="hr"></div>
    <div id="presTableS4" class="section"></div>
    <div class="hr"></div>
    <div id="presStages" class="section"></div>
    <div class="hr"></div>
    <!-- –ë–ª–æ–∫ –∏–Ω—Å–∞–π—Ç–æ–≤ —Å–∫—Ä—ã—Ç/–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è -->
    <div id="presInsights" class="section" style="display:none"></div>
  </div>

  <div id="summaryPrint" class="compact" style="display:none">
    <div class="logoTitle">–ö—Ä–∞—Ç–∫–∞—è –≤—ã–∂–∏–º–∫–∞ –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è</div>
    <div id="briefPlanFactTop" class="section"><div id="briefPlanFactInner"></div></div>
    <div id="briefDates" class="note" style="margin:8px 0 16px"></div>
    <div id="briefBlocks" class="section"></div>
  </div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
  /* ==================== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã ==================== */
  const BRANCHES = [
    "–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°","–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°","–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°","–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°",
    "–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°","–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°","–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°","–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°","–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°"
  ];
  const BRANCH_PATTERNS = [
    {name:"–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°", re:/–°–æ—á–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°", re:/–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°", re:/–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ\s+–≠–°/i},
    {name:"–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–£—Å—Ç—å[\s\u00A0\u202F\-‚Äì‚Äî-]*–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°", re:/–Æ–≥–æ[\s\u00A0\u202F\-‚Äì‚Äî-]*–ó–∞–ø–∞–¥–Ω—ã–µ\s+–≠–°/i},
    {name:"–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°", re:/–ê–¥—ã–≥–µ–π—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°", re:/–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°", re:/–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°", re:/–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°", re:/–°–ª–∞–≤—è–Ω—Å–∫–∏–µ\s+–≠–°/i},
  ];

  /* –°—Ç–∞–¥–∏–∏ */
  const STATUS_PATTERNS = [
    {key:"work", title:"–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞", re:/–í\s*—Ä–∞–±–æ—Ç–µ\s*—É\s*—Ñ–∏–ª–∏–∞–ª–∞/i},
    {key:"dismantled", title:"–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ", re:/–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ/i},
    {key:"rc_digit", title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –†–æ—Å—Å–µ—Ç–∏ –¶–∏—Ñ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏\s*–†–æ—Å—Å–µ—Ç–∏\s*–¶–∏—Ñ—Ä–∞/i},
    {key:"op_sign", title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏\s*—É\s*–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞/i},
    {key:"filial_appr",title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –≤ —Ñ–∏–ª–∏–∞–ª–µ", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏\s*–≤\s*—Ñ–∏–ª–∏–∞–ª–µ/i},
    {key:"incl_next", title:"–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è",
      re:/–ë—É–¥–µ—Ç\s*–≤–∫–ª—é—á–µ–Ω–æ(?:[\s\S]{0,80})–≤(?:\s*—Å–ª–µ–¥—É—é—â–µ–µ)?(?:[\s\S]{0,80})–¥–æ–ø\.?\s*—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ(?:[\s\S]{0,80}–ø–æ—Å–ª–µ\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏—è)?/i
    },
  ];
  const STATUS_KEYS = STATUS_PATTERNS.map(s => s.key);
  const STAGE_TITLE = k => (STATUS_PATTERNS.find(s => s.key===k)||{}).title||k;

  const SHORT_STAGE_TITLES = {
    "work": "–í —Ä–∞–±–æ—Ç–µ",
    "dismantled": "–î–µ–º–æ–Ω—Ç.",
    "rc_digit": "–û—Ñ–æ—Ä–º–ª. –†–¶",
    "op_sign": "–ü–æ–¥–ø–∏—Å—å –æ–ø–µ—Ä.",
    "filial_appr": "–°–æ–≥–ª. —Ñ–∏–ª–∏–∞–ª",
    "incl_next": "–í —Å–ª–µ–¥. –¥–æ–ø.—Å–æ–≥–ª."
  };
  const SHORT_STAGE_TITLE = k => SHORT_STAGE_TITLES[k] || STAGE_TITLE(k);

  const numberize = s => {
    const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
    const n = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
    if(!n) return 0;
    const val = Number(n.replace(",", "."));
    return isNaN(val) ? 0 : val;
  };
  const fmt = n => (typeof n === "number" ? n : Number(n||0)).toLocaleString("ru-RU");
  const normalize = txt => String(txt||"")
      .replace(/\u00A0|\u202F/g," ")
      .replace(/\u00AD/g,"")
      .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
      .replace(/[ \t]+/g," ")
      .trim();

  /* ==================== –ß—Ç–µ–Ω–∏–µ PDF ==================== */
  async function pdfToPages(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      let pageText = "", lastY = null;
      content.items.forEach(item => {
        const y = item.transform[5];
        if(lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
        pageText += item.str;
        lastY = y;
      });
      pages.push(normalize(pageText));
    }
    return pages;
  }

  /* ==================== –ü–∞—Ä—Å–∏–Ω–≥ ==================== */
  function extractDateFromPages(pages){
    for(const pg of pages){
      const m = pg.match(/–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
    return "‚Äî";
  }

  function parseTotalsFromPage(page1){
    const find = (re) => {
      const m = page1.match(re);
      return m ? numberize(m[1]) : 0;
    };
    return {
      found_year: find(/–≤—ã—è–≤–ª–µ–Ω–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
      legalized: find(/–£–∑–∞–∫–æ–Ω–µ–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
      dismantled_ytd: find(/–ó–∞\s*20\d{2}\s*–≥–æ–¥\s*–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
      in_work_total: find(/–í\s*—Ä–∞–±–æ—Ç–µ[^0-9]*?–≤—Å–µ–≥–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
      rtk_in_work: find(/–≤\s*—Ç–æ–º\s*—á–∏—Å–ª–µ\s*–ü–ê–û\s*¬´?–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª?[^0-9]*?(\d[\d\s]+)/i),
    };
  }

  function parseBranchTable(pageText){
    const text = normalize(pageText);
    const lines = text.split("\n").filter(Boolean);

    const idx = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      for(const bp of BRANCH_PATTERNS){
        if(bp.re.test(line)){ idx.push({i, name: bp.name}); break; }
      }
    }
    idx.push({i: lines.length, name:null});

    const branches = new Map();
    for(let k=0;k<idx.length-1;k++){
      const start = idx[k].i, end = idx[k+1].i, branchName = idx[k].name;
      if(!branchName) continue;
      const headLine = lines[start] || "";
      const segText = lines.slice(start+1, end).join(" ");

      let total = 0;
      const headNums = headLine.match(/\d[\d\s]*/g);
      if(headNums && headNums.length) total = numberize(headNums[headNums.length-1]);
      if(total===0 && lines[start+1]){
        const n2 = (lines[start+1]||"").match(/\d[\d\s]*/g);
        if(n2 && n2.length) total = numberize(n2[n2.length-1]);
      }

      const data = { total, statuses:{} };

      function numAfter(re, hay){
        const rx = new RegExp(re.source + "[^\\d]{0,200}(\\d[\\d\\s]*)", re.flags);
        const m = hay.match(rx);
        return m ? numberize(m[1]) : null;
      }

      for(const sp of STATUS_PATTERNS){
        let v = numAfter(sp.re, segText);
        if(v === null){
          for(let j=start+1;j<end;j++){
            const l0 = lines[j]||"", l1 = lines[j+1]||"";
            if(sp.re.test(l0) || sp.re.test(l1)){
              let cap = (l0.match(/(\d[\d\s]*)/g)||[]).pop();
              if(!cap) cap = (l1.match(/(\d[\d\s]*)/g)||[]).pop();
              if(cap){ v = numberize(cap); break; }
            }
          }
        }
        if(v !== null) data.statuses[sp.key] = v;
      }
      branches.set(branchName, data);
    }

    for(const b of BRANCHES){
      if(!branches.has(b)) branches.set(b, { total:0, statuses:{} });
    }

    const stages = {};
    for(const [_, obj] of branches){
      for(const [k,v] of Object.entries(obj.statuses)){
        stages[k] = (stages[k]||0) + (v||0);
      }
    }

    const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);
    return { branches, overall, stages };
  }

  function parseReportByPages(pages){
    return {
      date: extractDateFromPages(pages),
      p1: { totals: parseTotalsFromPage(pages[0] || "") },
      p2: parseBranchTable(pages[1] || ""),
      p3: parseBranchTable(pages[2] || ""),
      p4: parseBranchTable(pages[3] || ""),
    };
  }

  /* ==================== –î–∏–Ω–∞–º–∏–∫–∞ ==================== */
  function computeDynamics(curr, prev){
    const dyn = {
      in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
      rtk_in_work: (curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work) || 0,
      legalized: (curr.p1.totals.legalized - prev.p1.totals.legalized) || 0,
      dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
    };
    dyn.found_week = dyn.in_work_total;

    const makeRows = (cPage, pPage) => BRANCHES.map(b=>{
      const c = cPage.branches.get(b)?.total || 0;
      const p = pPage.branches.get(b)?.total || 0;
      return {b, p, c, d: (c - p)};
    });

    const branchRows = makeRows(curr.p2, prev.p2);
    const branchRowsS3 = makeRows(curr.p3, prev.p3);
    const branchRowsS4 = makeRows(curr.p4, prev.p4);

    const allKeys = Array.from(new Set([
      ...Object.keys(prev.p2.stages||{}), ...Object.keys(curr.p2.stages||{}),
      ...Object.keys(prev.p3.stages||{}), ...Object.keys(curr.p3.stages||{}),
      ...Object.keys(prev.p4.stages||{}), ...Object.keys(curr.p4.stages||{}),
      ...STATUS_KEYS
    ]));

    const diffStages = (cur, prv) => allKeys.map(k=>({
      stage: STAGE_TITLE(k), short: SHORT_STAGE_TITLE(k), key: k,
      p: prv[k] || 0, c: cur[k] || 0, d: (cur[k]||0) - (prv[k]||0)
    }));

    const stagesS2 = diffStages(curr.p2.stages||{}, prev.p2.stages||{});
    const stagesS4 = diffStages(curr.p4.stages||{}, prev.p4.stages||{});

    function perBranchStages(cPage, pPage){
      return BRANCHES.map(b=>{
        const cst = cPage.branches.get(b)?.statuses || {};
        const pst = pPage.branches.get(b)?.statuses || {};
        const by = {};
        STATUS_KEYS.forEach(k=>{
          const p = pst[k]||0, c = cst[k]||0;
          by[k] = {p,c,d:c-p};
        });
        return {b, by};
      });
    }
    const s2BranchStages = perBranchStages(curr.p2, prev.p2);

    return {
      ...dyn,
      branchRows,
      branchRowsS3,
      branchRowsS4,
      stagesS2,
      stagesS4,
      s2BranchStages,
      rtkRows: branchRowsS4
    };
  }

  /* ==================== –†–µ–Ω–¥–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ==================== */
  let chartBranches, chartBranchesS3, chartBranchesS4, chartRTKDelta;

  function renderKpis(curr, prev, dyn){
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const items = [
      {title:"–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç.", curr:curr.p1.totals.in_work_total, delta:dyn.in_work_total},
      {title:"–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é, —à—Ç.", curr:dyn.found_week, delta:dyn.found_week},
      {title:"–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é (—É–∑–∞–∫.+–¥–µ–º–æ–Ω—Ç.), —à—Ç.", curr:eff, delta:eff},
      {title:"–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª –≤ —Ä–∞–±–æ—Ç–µ, —à—Ç. (–¥–æ–ª—è, %)", curr:`${fmt(curr.p1.totals.rtk_in_work)} (${rtkShare.toFixed(1)}%)`, delta:dyn.rtk_in_work},
    ];

    document.getElementById("kpis").innerHTML = items.map(it=>{
      const d = typeof it.delta==="number"?it.delta:0, cls=d>0?"up":(d<0?"down":"muted"), sign=d>0?"+":"";
      return `<div class="kpi">
        <div class="title">${it.title}</div>
        <div class="value">${typeof it.curr==="number"?fmt(it.curr):it.curr}</div>
        <div class="delta ${cls}">${sign}${fmt(d)}</div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(rows, tbodySel, sumPrevId, sumCurrId, sumDeltaId){
    const tbody = document.querySelector(tbodySel);
    tbody.innerHTML = "";
    let sP=0,sC=0,sD=0;
    const sorted = [...rows].sort((a,b)=>Math.abs((b.c-b.p)) - Math.abs((a.c-a.p)));
    for(const r0 of sorted){
      const p = Number(r0.p)||0, c = Number(r0.c)||0;
      const d = c - p;
      const cls = d>0?"up":(d<0?"down":"muted");
      sP+=p; sC+=c; sD+=d;
      tbody.insertAdjacentHTML("beforeend",
        `<tr><td>${r0.b}</td><td>${fmt(p)}</td><td>${fmt(c)}</td><td class="${cls}">${d>0?"+":""}${fmt(d)}</td></tr>`);
    }
    document.getElementById(sumPrevId).textContent = fmt(sP);
    document.getElementById(sumCurrId).textContent = fmt(sC);
    document.getElementById(sumDeltaId).textContent = (sD>0?"+":"")+fmt(sD);
  }

  function chartOpts(){
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:"top",
          labels:{
            boxWidth:16,
            usePointStyle:true,
            padding:20,
            font:{size:13, weight:600},
            color:'#64748B'
          }
        },
        tooltip:{
          backgroundColor:'rgba(15, 23, 42, 0.95)',
          titleColor:'#fff',
          bodyColor:'#fff',
          borderColor:'#E2E8F0',
          borderWidth:1,
          padding:12,
          cornerRadius:8,
          titleFont:{size:14, weight:600},
          bodyFont:{size:13},
          displayColors:true,
          boxWidth:12,
          boxHeight:12,
          usePointStyle:true
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          ticks:{
            precision:0,
            font:{size:12},
            color:'#64748B',
            padding:8
          },
          grid:{
            color:'rgba(0,0,0,0.06)',
            drawBorder:false
          }
        },
        x:{
          ticks:{
            font:{size:12},
            color:'#64748B',
            padding:8
          },
          grid:{
            display:false
          }
        }
      },
      animation:{
        duration:800,
        easing:'easeInOutQuart'
      },
      elements:{
        bar:{
          borderRadius:6,
          borderSkipped:false
        }
      }
    };
  }

  function renderCharts(curr, prev, dyn){
    const labels = BRANCHES;
    const prevS2 = labels.map(b=>prev.p2.branches.get(b)?.total||0);
    const currS2 = labels.map(b=>curr.p2.branches.get(b)?.total||0);

    if(chartBranches) chartBranches.destroy();
    chartBranches = new Chart(document.getElementById("chartBranches"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥. –Ω–µ–¥–µ–ª—è", data:prevS2, backgroundColor:"#CBD5E1", borderColor:"#94A3B8", borderWidth:1},
        {label:"–¢–µ–∫. –Ω–µ–¥–µ–ª—è", data:currS2, backgroundColor:varGet("--rs-blue"), borderColor:varGet("--rs-blue-600"), borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS3 = labels.map(b=>prev.p3.branches.get(b)?.total||0);
    const currS3 = labels.map(b=>curr.p3.branches.get(b)?.total||0);
    if(chartBranchesS3) chartBranchesS3.destroy();
    chartBranchesS3 = new Chart(document.getElementById("chartBranchesS3"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥. –Ω–µ–¥–µ–ª—è", data:prevS3, backgroundColor:"#CBD5E1", borderColor:"#94A3B8", borderWidth:1},
        {label:"–¢–µ–∫. –Ω–µ–¥–µ–ª—è", data:currS3, backgroundColor:varGet("--rs-blue"), borderColor:varGet("--rs-blue-600"), borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS4 = labels.map(b=>prev.p4.branches.get(b)?.total||0);
    const currS4 = labels.map(b=>curr.p4.branches.get(b)?.total||0);
    if(chartBranchesS4) chartBranchesS4.destroy();
    chartBranchesS4 = new Chart(document.getElementById("chartBranchesS4"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥. –Ω–µ–¥–µ–ª—è", data:prevS4, backgroundColor:"#CBD5E1", borderColor:"#94A3B8", borderWidth:1},
        {label:"–¢–µ–∫. –Ω–µ–¥–µ–ª—è", data:currS4, backgroundColor:varGet("--rs-blue"), borderColor:varGet("--rs-blue-600"), borderWidth:1}
      ]},
      options: chartOpts()
    });

    const rtkD = labels.map(b => (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).c - (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).p);
    if(chartRTKDelta) chartRTKDelta.destroy();
    chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
      type:"bar",
      data:{labels, datasets:[{
        label:"Œî –†–¢–ö (—Ç–µ–∫. ‚àí –ø—Ä–µ–¥.)",
        data:rtkD,
        backgroundColor: rtkD.map(v=>v>0?varGet("--success"):varGet("--danger")),
        borderColor: rtkD.map(v=>v>0?varGet("--success-light"):varGet("--danger-light")),
        borderWidth:1
      }]},
      options: chartOpts()
    });
  }

  function renderStagesTables(dyn){
    const fill = (id, rows) => {
      const tbody = document.querySelector(id + " tbody");
      tbody.innerHTML = rows.map(r=>{
        const p = Number(r.p)||0, c = Number(r.c)||0, d = c - p;
        const cls = d>0?"up":(d<0?"down":"muted");
        return `<tr><td>${r.stage}</td><td>${fmt(p)}</td><td>${fmt(c)}</td><td class="${cls}">${d>0?"+":""}${fmt(d)}</td></tr>`;
      }).join("");
    };
    fill("#tblStagesS2", dyn.stagesS2);
    fill("#tblStagesS4", dyn.stagesS4);
  }

  /* ==================== –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (–ø–µ—á–∞—Ç–Ω—ã–π HTML-–±–ª–æ–∫ –¥–ª—è PDF/–≤—ã–∂–∏–º–∫–∏) ==================== */
  function presTableHTML(title, rows, sumIds){
    return `<div style="font-weight:700;margin:12px 0;font-size:16px;color:#0F172A">${title}</div>
      <table style="width:100%;border-collapse:collapse;font-size:12px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
        <thead><tr style="background:#F1F5F9">
          <th style="text-align:left;padding:10px 12px;font-weight:600;color:#475569">–§–∏–ª–∏–∞–ª</th>
          <th style="text-align:right;padding:10px 12px;font-weight:600;color:#475569">–ü—Ä–µ–¥.</th>
          <th style="text-align:right;padding:10px 12px;font-weight:600;color:#475569">–¢–µ–∫.</th>
          <th style="text-align:right;padding:10px 12px;font-weight:600;color:#475569">Œî</th>
        </tr></thead>
        <tbody>
          ${rows.map((r,i) => {
            const p=Number(r.p)||0,c=Number(r.c)||0,d=c-p;
            const bg = i%2===0 ? '#fff' : '#F8FAFD';
            return `<tr style="background:${bg}">
              <td style="padding:8px 12px;border-top:1px solid #E2E8F0">${r.b}</td>
              <td style="padding:8px 12px;text-align:right;border-top:1px solid #E2E8F0">${fmt(p)}</td>
              <td style="padding:8px 12px;text-align:right;border-top:1px solid #E2E8F0">${fmt(c)}</td>
              <td style="padding:8px 12px;text-align:right;border-top:1px solid #E2E8F0;color:${d>0?'#059669':(d<0?'#DC2626':'#64748B')};font-weight:600">${d>0?'+':''}${fmt(d)}</td>
            </tr>`;
          }).join("")}
        </tbody>
        <tfoot>
          <tr style="background:#E7EEF7;font-weight:700">
            <td style="padding:10px 12px;border-top:2px solid #CBD5E1">–ò—Ç–æ–≥–æ</td>
            <td style="padding:10px 12px;text-align:right;border-top:2px solid #CBD5E1">${document.getElementById(sumIds[0]).textContent}</td>
            <td style="padding:10px 12px;text-align:right;border-top:2px solid #CBD5E1">${document.getElementById(sumIds[1]).textContent}</td>
            <td style="padding:10px 12px;text-align:right;border-top:2px solid #CBD5E1">${document.getElementById(sumIds[2]).textContent}</td>
          </tr>
        </tfoot>
      </table>`;
  }

  function stageMatrixHTML(title, branchStages){
    const cols = STATUS_KEYS;
    const head = cols.map(k=>`<th style="text-align:right;padding:8px 6px;font-weight:600;color:#475569;font-size:11px;white-space:nowrap">${SHORT_STAGE_TITLE(k)}</th>`).join("");
    let totals = {}; cols.forEach(k=>totals[k]=0);

    const body = branchStages.map((row,i)=>{
      const bg = i%2===0 ? '#fff' : '#F8FAFD';
      const cells = cols.map(k=>{
        const d = (row.by[k]?.d)||0; totals[k]+=d;
        return `<td style="padding:6px;text-align:right;color:${d>0?'#059669':(d<0?'#DC2626':'#64748B')};font-weight:500;border-top:1px solid #E2E8F0">${d>0?'+':''}${fmt(d)}</td>`;
      }).join("");
      return `<tr style="background:${bg}"><td style="padding:6px 8px;border-top:1px solid #E2E8F0">${row.b}</td>${cells}</tr>`;
    }).join("");

    const totalRow = `<tr style="background:#E7EEF7;font-weight:700">
      <td style="padding:8px;border-top:2px solid #CBD5E1">–ò—Ç–æ–≥–æ Œî</td>
      ${cols.map(k=>`<td style="padding:8px 6px;text-align:right;border-top:2px solid #CBD5E1;color:${totals[k]>0?'#059669':(totals[k]<0?'#DC2626':'#64748B')}">${totals[k]>0?'+':''}${fmt(totals[k])}</td>`).join("")}
    </tr>`;

    return `<div style="font-weight:700;margin:16px 0 8px;font-size:16px;color:#0F172A">${title}</div>
      <div class="status-matrix-wrap">
        <table class="status-matrix" style="width:100%;border-collapse:collapse;font-size:11px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
          <thead><tr style="background:#F1F5F9"><th style="text-align:left;padding:8px;font-weight:600;color:#475569">–§–∏–ª–∏–∞–ª</th>${head}</tr></thead>
          <tbody>${body}</tbody>
          <tfoot>${totalRow}</tfoot>
        </table>
      </div>`;
  }

  function stageTotalsHTML(title, totalsArray){
    return `<div style="margin:12px 0 8px;font-weight:700;font-size:16px;color:#0F172A">${title}</div>
      <table style="width:100%;border-collapse:collapse;font-size:12px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1)">
        <thead><tr style="background:#F1F5F9">
          <th style="text-align:left;padding:10px 12px;font-weight:600;color:#475569">–°—Ç–∞–¥–∏—è</th>
          <th style="text-align:right;padding:10px 12px;font-weight:600;color:#475569">–ü—Ä–µ–¥.</th>
          <th style="text-align:right;padding:10px 12px;font-weight:600;color:#475569">–¢–µ–∫.</th>
          <th style="text-align:right;padding:10px 12px;font-weight:600;color:#475569">Œî</th>
        </tr></thead>
        <tbody>
          ${totalsArray.map((r,i)=>{
            const p=Number(r.p)||0,c=Number(r.c)||0,d=c-p;
            const bg = i%2===0 ? '#fff' : '#F8FAFD';
            return `<tr style="background:${bg}">
              <td style="padding:8px 12px;border-top:1px solid #E2E8F0">${r.stage}</td>
              <td style="padding:8px 12px;text-align:right;border-top:1px solid #E2E8F0">${fmt(p)}</td>
              <td style="padding:8px 12px;text-align:right;border-top:1px solid #E2E8F0">${fmt(c)}</td>
              <td style="padding:8px 12px;text-align:right;border-top:1px solid #E2E8F0;color:${d>0?'#059669':(d<0?'#DC2626':'#64748B')};font-weight:600">${d>0?'+':''}${fmt(d)}</td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>`;
  }

  function buildPresentationHTML(curr, prev, dyn){
    document.getElementById("presDates").textContent = `–ü—Ä–µ–¥.: ${prev.date} ¬∑ –¢–µ–∫.: ${curr.date}`;

    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const box = (t, val, delta) => `<div style="border:1px solid #E2E8F0;border-radius:12px;padding:16px;margin:8px 0;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.05)">
      <div style="color:#64748B;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.05em">${t}</div>
      <div style="font-weight:800;font-size:24px;color:#0F172A;margin:4px 0">${typeof val === "number" ? fmt(val) : val}</div>
      <div style="font-size:14px;font-weight:600;color:${delta > 0 ? '#059669' : (delta < 0 ? '#DC2626' : '#64748B')}">
        ${delta > 0 ? '‚Üë +' : delta < 0 ? '‚Üì ' : ''}${fmt(delta)}
      </div>
    </div>`;

    document.getElementById("presKpis").innerHTML = `<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">` +
      box("–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ, —à—Ç.", curr.p1.totals.in_work_total, dyn.in_work_total) +
      box("–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é, —à—Ç.", dyn.found_week, dyn.found_week) +
      box("–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é (—É–∑–∞–∫.+–¥–µ–º–æ–Ω—Ç.), —à—Ç.", eff, eff) +
      box("–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª –≤ —Ä–∞–±–æ—Ç–µ, —à—Ç. (–¥–æ–ª—è, %)", `${fmt(curr.p1.totals.rtk_in_work)} (${rtkShare.toFixed(1)}%)`, dyn.rtk_in_work) +
      `</div>`;

    const rowsS2 = Array.from(document.querySelectorAll("#tblBranches tbody tr")).map(tr => {
      const t = tr.querySelectorAll("td");
      return { b: t[0].textContent, p: numberize(t[1].textContent), c: numberize(t[2].textContent), d: numberize(t[3].textContent) };
    });

    document.getElementById("presTable").innerHTML = presTableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)", rowsS2, ["sumPrev","sumCurr","sumDelta"]);
    document.getElementById("presTableS3").innerHTML = presTableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425", (DATA?.dyn?.branchRowsS3||[]), ["sumPrevS3","sumCurrS3","sumDeltaS3"]);
    document.getElementById("presTableS4").innerHTML = presTableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", (DATA?.dyn?.branchRowsS4||[]), ["sumPrevS4","sumCurrS4","sumDeltaS4"]);

    const s2Matrix = stageMatrixHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (Œî)", dyn.s2BranchStages);
    const s2Totals = stageTotalsHTML("–ò—Ç–æ–≥–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º", dyn.stagesS2);
    document.getElementById("presStages").innerHTML = s2Matrix + s2Totals;

    // –ò–Ω—Å–∞–π—Ç—ã/–¢–æ–ø ‚Äì –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é —É–¥–∞–ª–µ–Ω—ã –∏–∑ –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    const presIns = document.getElementById("presInsights");
    if (presIns) presIns.style.display = "none";
  }

  /* ==================== –ü–ª–∞–Ω-–§–∞–∫—Ç –∏–∑ Google Sheets ==================== */
  const SHEET_HTML_URL = "https://docs.google.com/spreadsheets/d/1Y9bM7zLRf_gonMUgfQLl57Iu3NgPa78rBXnpxkKLvO0/gviz/tq?tqx=out:html";
  async function injectPlanFactHTML(){
    try{
      const res = await fetch(SHEET_HTML_URL, {cache:"no-store", mode:"cors"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const html = await res.text();
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      const table = tmp.querySelector("table");
      if(!table) throw new Error("–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ HTML.");

      // –°—Ç–∏–ª–∏–∑—É–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–∞
      table.style.cssText = "width:100%;border-collapse:collapse;font-size:13px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.1)";
      
      // –°—Ç–∏–ª–∏–∑—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
      table.querySelectorAll("th").forEach(th => {
        th.style.cssText = "background:#F1F5F9;padding:10px 12px;font-weight:600;color:#475569;text-align:center;border:none";
      });
      
      // –°—Ç–∏–ª–∏–∑—É–µ–º —è—á–µ–π–∫–∏
      table.querySelectorAll("td").forEach((td, i) => {
        td.style.cssText = "padding:8px 12px;text-align:center;border-top:1px solid #E2E8F0";
      });
      
      // –ß–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫
      table.querySelectorAll("tr").forEach((tr, i) => {
        if(i > 0 && i % 2 === 0) tr.style.background = "#F8FAFD";
      });

      const caption = `<div style="font-weight:700;margin:12px 0;font-size:16px;color:#0F172A">üìä –ü–ª–∞–Ω-–§–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</div>`;
      document.getElementById("presPlanFactInner").innerHTML = caption + table.outerHTML;
      document.getElementById("briefPlanFactInner").innerHTML = caption + table.outerHTML;
    }catch(e){
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É Google Sheets:", e);
      const fallback = `<div class="info-box">‚ö†Ô∏è –ü–ª–∞–Ω-–§–∞–∫—Ç: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å HTML —Ç–∞–±–ª–∏—Ü—ã. <a href="https://docs.google.com/spreadsheets/d/1Y9bM7zLRf_gonMUgfQLl57Iu3NgPa78rBXnpxkKLvO0/edit?usp=drivesdk" target="_blank" rel="noopener" style="color:#0033A0;font-weight:600">–û—Ç–∫—Ä—ã—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ ‚Üí</a></div>`;
      document.getElementById("presPlanFactInner").innerHTML = fallback;
      document.getElementById("briefPlanFactInner").innerHTML = fallback;
    }
  }

  /* ==================== –≠–∫—Å–ø–æ—Ä—Ç PDF ==================== */
  async function exportPresPDF(){
    const el = document.getElementById("presentationPrint");
    el.style.display = "block";
    await html2pdf().from(el).set({
      margin: 10, filename: "–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°.pdf",
      image: {type: 'jpeg', quality: 0.98},
      html2canvas: {scale: 2.5, useCORS: true, letterRendering: true},
      jsPDF: {unit: 'mm', format: 'a4', compress: true},
      pagebreak: { mode: ['css','legacy'], avoid: ['tr','.avoid-break'] }
    }).save();
    el.style.display = "none";
    document.getElementById("exportStatus").textContent = "‚úÖ PDF –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω";
    document.getElementById("exportStatus").style.display = "inline-block";
    setTimeout(()=>document.getElementById("exportStatus").style.display = "none", 3000);
  }

  async function exportBriefPDF(){
    const el = document.getElementById("summaryPrint");
    el.style.display = "block";
    await html2pdf().from(el).set({
      margin: 10, filename: "–í—ã–∂–∏–º–∫–∞_–í–û–õ–°.pdf",
      image: {type: 'jpeg', quality: 0.98},
      html2canvas: {scale: 2.5, useCORS: true, letterRendering: true},
      jsPDF: {unit: 'mm', format: 'a4', compress: true},
      pagebreak: { mode: ['css','legacy'], avoid: ['tr','.avoid-break'] }
    }).save();
    el.style.display = "none";
    document.getElementById("exportStatus").textContent = "‚úÖ PDF –≤—ã–∂–∏–º–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω";
    document.getElementById("exportStatus").style.display = "inline-block";
    setTimeout(()=>document.getElementById("exportStatus").style.display = "none", 3000);
  }

  /* ==================== –≠–∫—Å–ø–æ—Ä—Ç Word-HTML ==================== */
  function exportWordHTML(){
    if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const planfactHTML = document.getElementById("presPlanFactInner").innerHTML || "<div>–ü–ª–∞–Ω-–§–∞–∫—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>";

    const htmlDoc = `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>–û—Ç—á–µ—Ç –í–û–õ–° - ${curr.date}</title>
<style>
  body{font-family:'Segoe UI',Arial,sans-serif;max-width:900px;margin:0 auto;padding:30px;line-height:1.6;color:#333}
  h1{color:#0033A0;border-bottom:3px solid #0033A0;padding-bottom:12px;font-size:28px}
  h2{color:#0033A0;margin-top:32px;font-size:22px;border-bottom:1px solid #E2E8F0;padding-bottom:8px}
  h3{color:#1E293B;margin-top:24px;font-size:18px}
  table{width:100%;border-collapse:collapse;margin:20px 0;font-size:13px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
  th,td{border:1px solid #E2E8F0;padding:10px 12px;text-align:center}
  th:first-child,td:first-child{text-align:left}
  th{background:#0033A0;color:#fff;font-weight:600}
  tr:nth-child(even){background:#F8FAFD}
  tr:hover{background:#EFF6FF}
  .positive{color:#059669;font-weight:700}
  .negative{color:#DC2626;font-weight:700}
  .info-box{background:#EFF6FF;border-left:5px solid #0033A0;padding:16px 20px;margin:20px 0;border-radius:0 8px 8px 0}
  .metric{display:inline-block;margin:8px 24px 8px 0}
  .metric-label{color:#64748B;font-size:12px;text-transform:uppercase;letter-spacing:0.05em}
  .metric-value{font-size:24px;font-weight:700;color:#0033A0}
  .footer{margin-top:40px;padding-top:20px;border-top:2px solid #E2E8F0;color:#64748B;font-size:12px}
</style></head>
<body>
<h1>–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª ‚Äî –û—Ç—á–µ—Ç –ø–æ –¥–∏–Ω–∞–º–∏–∫–µ –í–û–õ–°</h1>
<div class="info-box">
  <p style="margin:0"><b>–û—Ç—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥:</b></p>
  <p style="margin:4px 0">–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è: <b>${prev.date}</b></p>
  <p style="margin:4px 0">–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è: <b>${curr.date}</b></p>
</div>

<h2>–ü–ª–∞–Ω-–§–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</h2>
${planfactHTML}

<h2>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
<div style="background:#F8FAFD;padding:20px;border-radius:8px;margin:20px 0">
  <div class="metric">
    <div class="metric-label">–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ</div>
    <div class="metric-value">${fmt(curr.p1.totals.in_work_total)}</div>
    <span class="${dyn.in_work_total>=0?'positive':'negative'}">(${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})</span>
  </div>
  <div class="metric">
    <div class="metric-label">–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
    <div class="metric-value">${fmt(dyn.found_week)}</div>
  </div>
  <div class="metric">
    <div class="metric-label">–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
    <div class="metric-value">${fmt(eff)}</div>
  </div>
  <div class="metric">
    <div class="metric-label">–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</div>
    <div class="metric-value">${fmt(curr.p1.totals.rtk_in_work)}</div>
    <span class="${dyn.rtk_in_work>=0?'positive':'negative'}">(${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</span>
    <div style="font-size:14px;color:#64748B">–î–æ–ª—è: ${rtkShare.toFixed(1)}%</div>
  </div>
</div>

<h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
<h3>–û–±—â–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ (–≤—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã)</h3>
<table>
  <thead><tr><th>–§–∏–ª–∏–∞–ª</th><th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</th><th>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</th><th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th></tr></thead>
  <tbody>${dyn.branchRows.map(r=>`<tr>
    <td style="font-weight:500">${r.b}</td>
    <td>${fmt(r.p)}</td>
    <td style="font-weight:600">${fmt(r.c)}</td>
    <td class="${r.d>0?'positive':r.d<0?'negative':''}">${r.d>0?'+':''}${fmt(r.d)}</td>
  </tr>`).join("")}</tbody>
  <tfoot><tr style="font-weight:700;background:#E7EEF7">
    <td>–ò–¢–û–ì–û</td>
    <td>${document.getElementById("sumPrev").textContent}</td>
    <td>${document.getElementById("sumCurr").textContent}</td>
    <td>${document.getElementById("sumDelta").textContent}</td>
  </tr></tfoot>
</table>

<h3>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425</h3>
<table>
  <thead><tr><th>–§–∏–ª–∏–∞–ª</th><th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</th><th>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</th><th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th></tr></thead>
  <tbody>${(dyn.branchRowsS3||[]).map(r=>`<tr>
    <td style="font-weight:500">${r.b}</td>
    <td>${fmt(r.p)}</td>
    <td style="font-weight:600">${fmt(r.c)}</td>
    <td class="${r.d>0?'positive':r.d<0?'negative':''}">${r.d>0?'+':''}${fmt(r.d)}</td>
  </tr>`).join("")}</tbody>
  <tfoot><tr style="font-weight:700;background:#E7EEF7">
    <td>–ò–¢–û–ì–û</td>
    <td>${document.getElementById("sumPrevS3").textContent}</td>
    <td>${document.getElementById("sumCurrS3").textContent}</td>
    <td>${document.getElementById("sumDeltaS3").textContent}</td>
  </tr></tfoot>
</table>

<h3>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h3>
<table>
  <thead><tr><th>–§–∏–ª–∏–∞–ª</th><th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</th><th>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</th><th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th></tr></thead>
  <tbody>${(dyn.branchRowsS4||[]).map(r=>`<tr>
    <td style="font-weight:500">${r.b}</td>
    <td>${fmt(r.p)}</td>
    <td style="font-weight:600">${fmt(r.c)}</td>
    <td class="${r.d>0?'positive':r.d<0?'negative':''}">${r.d>0?'+':''}${fmt(r.d)}</td>
  </tr>`).join("")}</tbody>
  <tfoot><tr style="font-weight:700;background:#E7EEF7">
    <td>–ò–¢–û–ì–û</td>
    <td>${document.getElementById("sumPrevS4").textContent}</td>
    <td>${document.getElementById("sumCurrS4").textContent}</td>
    <td>${document.getElementById("sumDeltaS4").textContent}</td>
  </tr></tfoot>
</table>

<h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º —Ä–∞–±–æ—Ç</h2>
<table>
  <thead><tr><th>–°—Ç–∞—Ç—É—Å</th><th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</th><th>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</th><th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th></tr></thead>
  <tbody>${(dyn.stagesS2||[]).map(r=>`<tr>
    <td style="font-weight:500">${r.stage}</td>
    <td>${fmt(r.p)}</td>
    <td style="font-weight:600">${fmt(r.c)}</td>
    <td class="${r.d>0?'positive':r.d<0?'negative':''}">${r.d>0?'+':''}${fmt(r.d)}</td>
  </tr>`).join("")}</tbody>
</table>

<div class="footer">
  <p><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b> –û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö PDF-—Ñ–∞–π–ª–æ–≤.</p>
  <p>–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU', {year:'numeric',month:'long',day:'numeric'})}</p>
  <p>–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª ¬© ${new Date().getFullYear()}</p>
</div>
</body></html>`;

    const blob = new Blob([htmlDoc], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `–û—Ç—á–µ—Ç_–í–û–õ–°_${curr.date.replace(/\./g,'-')}.html`);
    document.getElementById("exportStatus").textContent = "‚úÖ HTML –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω";
    document.getElementById("exportStatus").style.display = "inline-block";
    setTimeout(()=>document.getElementById("exportStatus").style.display = "none", 3000);
  }

  /* ==================== –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –≤ HTML (—Ñ–∏–∫—Å: —Å–ª–∞–π–¥ 5 –≤–º–µ—â–∞–µ—Ç –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã) ==================== */
  function exportPresHTML(){
    if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
    const {curr, prev, dyn} = DATA;

    const imgS2 = document.getElementById("chartBranches").toDataURL("image/png", 1.0);
    const imgS3 = document.getElementById("chartBranchesS3").toDataURL("image/png", 1.0);
    const imgS4 = document.getElementById("chartBranchesS4").toDataURL("image/png", 1.0);

    const planfactHTML = document.getElementById("presPlanFactInner").innerHTML || "";

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ (–ê‚Üí–Ø, ru)
    const collator = new Intl.Collator("ru", {sensitivity:"base"});
    const sortByBranch = (a,b)=>collator.compare(a.b, b.b);

    const s2Sorted = [...dyn.branchRows].sort(sortByBranch);
    const s3Sorted = [...(dyn.branchRowsS3||[])].sort(sortByBranch);
    const s4Sorted = [...(dyn.branchRowsS4||[])].sort(sortByBranch);

    const tblS2HTML_sorted = presTableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)", s2Sorted, ["sumPrev","sumCurr","sumDelta"]);
    const tblS3HTML_sorted = presTableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425", s3Sorted, ["sumPrevS3","sumCurrS3","sumDeltaS3"]);
    const tblS4HTML_sorted = presTableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", s4Sorted, ["sumPrevS4","sumCurrS4","sumDeltaS4"]);

    const s2BranchStagesSorted = [...dyn.s2BranchStages].sort((a,b)=>collator.compare(a.b,b.b));
    const stagesHTML_sorted =
      stageMatrixHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (Œî)", s2BranchStagesSorted) +
      stageTotalsHTML("–ò—Ç–æ–≥–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º", dyn.stagesS2);

    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    const sign = v=> v>0?"+":"";
    const compactKPIs = `–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏: –í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ ‚Äî ${fmt(curr.p1.totals.in_work_total)} (${sign(dyn.in_work_total)}${fmt(dyn.in_work_total)}); –í—ã—è–≤–ª–µ–Ω–æ ‚Äî ${fmt(dyn.found_week)}; –ó–∞–∫—Ä—ã—Ç–æ ‚Äî ${fmt(eff)}; –†–¢–ö ‚Äî ${fmt(curr.p1.totals.rtk_in_work)} (${sign(dyn.rtk_in_work)}${fmt(dyn.rtk_in_work)}, ${rtkShare.toFixed(1)}%).`;

    const presHTML = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –í–û–õ–° - –ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    body{
      font-family:'Inter',Arial,sans-serif;
      margin:0;
      padding:0;
      background:#1e293b;
    }
    
    .slides-container{
      width:100vw;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      gap:2px;
      background:#1e293b;
      padding:40px 0;
    }
    
    .slide{
      width:1280px;
      height:720px;
      margin:0 auto;
      background:#fff;
      box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);
      padding:60px;
      box-sizing:border-box;
      page-break-after:always;
      position:relative;
      overflow:hidden;
    }
    
    .slide::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:6px;
      background:linear-gradient(90deg, #0033A0 0%, #00B4F0 100%);
    }
    
    h1{
      color:#0033A0;
      font-size:48px;
      font-weight:800;
      margin:0 0 16px 0;
      letter-spacing:-0.03em;
      line-height:1.1;
    }
    
    h2{
      color:#0033A0;
      font-size:34px;
      font-weight:700;
      margin:0 0 20px 0;
      letter-spacing:-0.02em;
    }
    
    .subline{
      font-size:18px;
      color:#64748b;
      margin:-8px 0 20px;
      font-weight:500;
    }
    
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:24px;
      height:calc(100% - 140px);
      align-items:start;
    }
    
    .panel{
      background:#f8fafd;
      border:2px solid #e2e8f0;
      border-radius:16px;
      padding:20px;
      height:100%;
      overflow:auto;
    }
    
    .imgbox{
      background:#fff;
      border:2px solid #e2e8f0;
      border-radius:16px;
      padding:20px;
      text-align:center;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .imgbox img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
    }
    
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    
    th,td{
      border:1px solid #e2e8f0;
      padding:10px 12px;
      text-align:center !important;
    }
    
    th:first-child, td:first-child{
      text-align:left !important;
    }
    
    th{
      background:#0033A0;
      color:#fff;
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }
    
    tr:nth-child(even){
      background:#f8fafd;
    }
    
    tfoot td{
      font-weight:700;
      background:#e7eef7;
      color:#0033A0;
    }
    
    .slide-no{
      position:absolute;
      bottom:30px;
      right:40px;
      width:50px;
      height:50px;
      background:#0033A0;
      color:#fff;
      font-weight:700;
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:50%;
    }

    /* –ö–∞—Ä–º–∞–Ω –¥–ª—è –∞–≤—Ç–æ-–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (—á—Ç–æ–±—ã –≤—Å—ë –≤–ª–µ–∑–ª–æ –Ω–∞ —Å–ª–∞–π–¥) */
    .fitbox{
      position:relative;
      width:100%;
      height:calc(100% - 160px); /* –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞/–ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –Ω–æ–º–µ—Ä–∞ —Å–ª–∞–π–¥–∞ */
      border:2px solid #e2e8f0;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      padding:0;
    }
    .fitbox .fit-inner{
      position:relative;
      transform-origin: top left;
      padding:20px;
      box-sizing:border-box;
    }
    
    /* –ú–∞—Ç—Ä–∏—Ü–∞/–ò—Ç–æ–≥–∏ –≤–Ω—É—Ç—Ä–∏ —Å–ª–∞–π–¥–∞ 5 ‚Äì –º–µ–ª–∫–∏–µ –æ–ø—Ü–∏–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ */
    .status-matrix th, .status-matrix td{white-space:nowrap}
    
    @media print{
      body{background:#fff}
      .slides-container{padding:0;gap:0}
      .slide{box-shadow:none;margin-bottom:0}
      .slide-no{background:#333}
    }
  </style>
</head>
<body>
  <div class="slides-container">
    <!-- –°–ª–∞–π–¥ 1 -->
    <div class="slide">
      <h1>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ë–ü<br>–ø–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é –í–û–õ–° –Ω–∞ –í–õ</h1>
      <div class="subline">–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª ‚Ä¢ –ü–µ—Ä–∏–æ–¥: ${prev.date} ‚Äî ${curr.date}</div>
      <div style="height:calc(100% - 160px); overflow:auto; border:2px solid #e2e8f0; border-radius:12px; padding:20px;">
        ${planfactHTML}
      </div>
      <div class="slide-no">1</div>
    </div>

    <!-- –°–ª–∞–π–¥ 2 -->
    <div class="slide">
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –≤—ã—è–≤–ª–µ–Ω–∏—è –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –í–û–õ–°<br>–≤ —Ä–∞–∑—Ä–µ–∑–µ —Ñ–∏–ª–∏–∞–ª–æ–≤ –≠–° (–∏—Ç–æ–≥–æ)</h2>
      <div class="grid2">
        <div class="imgbox">
          <img src="${imgS2}" alt="–ì—Ä–∞—Ñ–∏–∫ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)"/>
        </div>
        <div class="panel">
          ${tblS2HTML_sorted}
        </div>
      </div>
      <div class="slide-no">2</div>
    </div>

    <!-- –°–ª–∞–π–¥ 3 -->
    <div class="slide">
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425</h2>
      <div class="grid2">
        <div class="imgbox">
          <img src="${imgS3}" alt="–ì—Ä–∞—Ñ–∏–∫ –ø–æ –ü—Ä–∏–∫–∞–∑—É 425"/>
        </div>
        <div class="panel">
          ${tblS3HTML_sorted}
        </div>
      </div>
      <div class="slide-no">3</div>
    </div>

    <!-- –°–ª–∞–π–¥ 4 -->
    <div class="slide">
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
      <div class="grid2">
        <div class="imgbox">
          <img src="${imgS4}" alt="–ì—Ä–∞—Ñ–∏–∫ –ø–æ –ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º"/>
        </div>
        <div class="panel">
          ${tblS4HTML_sorted}
        </div>
      </div>
      <div class="slide-no">4</div>
    </div>

    <!-- –°–ª–∞–π–¥ 5: —Ñ–∏–∫—Å ‚Äî –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã –≤–º–µ—â–∞—é—Ç—Å—è –≤–∏–∑—É–∞–ª—å–Ω–æ -->
    <div class="slide">
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º —Ä–∞–±–æ—Ç</h2>
      <div class="subline">–ú–∞—Ç—Ä–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –∏—Ç–æ–≥–∏ ‚Äî –Ω–∞ –æ–¥–Ω–æ–º —Å–ª–∞–π–¥–µ</div>
      <div class="fitbox">
        <div class="fit-inner">
          ${stagesHTML_sorted}
        </div>
      </div>
      <div class="slide-no">5</div>
    </div>
  </div>

  <script>
    // –ê–≤—Ç–æ–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö .fitbox, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤–º–µ—â–∞–ª—Å—è –Ω–∞ —Å–ª–∞–π–¥ (–±–µ–∑ –ø–æ–ª–æ—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
    (function(){
      function scaleFit(box){
        const inner = box.querySelector('.fit-inner');
        if(!inner) return;
        // –°–±—Ä–æ—Å
        inner.style.transform = 'scale(1)';
        inner.style.left = '0px';
        inner.style.top = '0px';
        // –†–∞–∑–º–µ—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        const sw = box.clientWidth;
        const sh = box.clientHeight;
        const w = inner.scrollWidth;
        const h = inner.scrollHeight;
        const scale = Math.min(sw / w, sh / h, 1);
        inner.style.transform = 'scale(' + scale + ')';
        // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        const padX = Math.max(0, (sw - w*scale) / 2);
        const padY = Math.max(0, (sh - h*scale) / 2);
        inner.style.position = 'relative';
        inner.style.left = padX + 'px';
        inner.style.top = padY + 'px';
      }
      function scaleAll(){
        document.querySelectorAll('.fitbox').forEach(scaleFit);
      }
      window.addEventListener('load', ()=>setTimeout(scaleAll, 60));
      window.addEventListener('resize', scaleAll);
    })();
  </script>
</body>
</html>`;

    const blob = new Blob([presHTML], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${curr.date.replace(/\./g,'-')}.html`);
    document.getElementById("exportStatus").textContent = "‚úÖ HTML –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞";
    document.getElementById("exportStatus").style.display = "inline-block";
    setTimeout(()=>document.getElementById("exportStatus").style.display = "none", 3000);
  }

  /* ==================== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ==================== */
  function triggerDownload(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }
  function varGet(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || "#0033A0";
  }

  /* ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==================== */
  let DATA = null;

  document.getElementById("btnParse").addEventListener("click", async () => {
    const fPrev = document.getElementById("filePrev").files[0];
    const fCurr = document.getElementById("fileCurr").files[0];
    if(!fPrev || !fCurr){ 
      document.getElementById("errorMsg").textContent = "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ PDF: –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏ —Ç–µ–∫—É—â–∏–π."; 
      document.getElementById("errorMsg").style.display = "inline-block";
      return; 
    }

    try{
      document.getElementById("loadingMsg").style.display = "inline-flex";
      document.getElementById("errorMsg").textContent = "";
      document.getElementById("errorMsg").style.display = "none";

      const [pPrev, pCurr] = await Promise.all([pdfToPages(fPrev), pdfToPages(fCurr)]);
      const prev = parseReportByPages(pPrev);
      const curr = parseReportByPages(pCurr);
      const dyn = computeDynamics(curr, prev);
      DATA = {prev, curr, dyn};

      document.getElementById("dates").textContent = `üìÖ –ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${prev.date} ¬∑ –¢–µ–∫—É—â–∏–π: ${curr.date}`;
      renderKpis(curr, prev, dyn);
      renderBranchesTable(dyn.branchRows, "#tblBranches tbody", "sumPrev", "sumCurr", "sumDelta");
      renderBranchesTable(dyn.branchRowsS3, "#tblBranchesS3 tbody", "sumPrevS3", "sumCurrS3", "sumDeltaS3");
      renderBranchesTable(dyn.branchRowsS4, "#tblBranchesS4 tbody", "sumPrevS4", "sumCurrS4", "sumDeltaS4");
      renderCharts(curr, prev, dyn);
      renderStagesTables(dyn);
      buildPresentationHTML(curr, prev, dyn);
      document.getElementById("briefDates").textContent = `–ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${prev.date} ¬∑ –¢–µ–∫—É—â–∏–π: ${curr.date}`;
      // –î–ª—è –≤—ã–∂–∏–º–∫–∏
      (function buildSummaryBlocks(){
        const blocks = document.getElementById("briefBlocks");
        const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
        const listAll = rows => rows.map(r=>{
          const p=Number(r.p)||0,c=Number(r.c)||0,d=c-p;
          const arrow = d>0?'‚Üë':(d<0?'‚Üì':'‚Üí');
          const color = d>0?'#059669':(d<0?'#DC2626':'#64748B');
          return `<div style="padding:4px 0;display:flex;justify-content:space-between">
            <span>${r.b}:</span>
            <span style="font-weight:600">${fmt(p)} ‚Üí <b>${fmt(c)}</b> <span style="color:${color}">${arrow} ${d>0?'+':''}${fmt(d)}</span></span>
          </div>`;
        }).join("");

        blocks.innerHTML = `
          <div style="background:#F8FAFD;padding:20px;border-radius:12px;margin-bottom:16px">
            <h3 style="margin:0 0 16px;color:#0F172A">üìä –°—Ç—Ä. 1 ‚Äî –û–±—â–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ (–Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–º)</h3>
            <div style="display:grid;gap:8px">
              <div>‚Ä¢ –í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ: <b style="color:#0033A0">${fmt(curr.p1.totals.in_work_total)}</b> <span style="color:${dyn.in_work_total>0?'#059669':'#DC2626'}">(${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})</span></div>
              <div>‚Ä¢ –í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é: <b style="color:#0033A0">${fmt(dyn.found_week)}</b></div>
              <div>‚Ä¢ –ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é (—É–∑–∞–∫.+–¥–µ–º–æ–Ω—Ç.): <b style="color:#0033A0">${fmt(eff)}</b></div>
              <div>‚Ä¢ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª –≤ —Ä–∞–±–æ—Ç–µ: <b style="color:#0033A0">${fmt(curr.p1.totals.rtk_in_work)}</b> <span style="color:${dyn.rtk_in_work>0?'#059669':'#DC2626'}">(${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</span></div>
            </div>
          </div>
          
          <div style="background:#fff;border:1px solid #E2E8F0;padding:20px;border-radius:12px;margin-bottom:16px">
            <h3 style="margin:0 0 16px;color:#0F172A">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)</h3>
            ${listAll(dyn.branchRows)}
            <div style="margin-top:16px;padding-top:16px;border-top:2px solid #E2E8F0;font-weight:700">
              –ò—Ç–æ–≥–æ: ${document.getElementById("sumPrev").textContent} ‚Üí ${document.getElementById("sumCurr").textContent} 
              <span style="color:${document.getElementById("sumDelta").textContent.includes('+') ? '#059669' : '#DC2626'}">(${document.getElementById("sumDelta").textContent})</span>
            </div>
          </div>
          
          <div style="background:#fff;border:1px solid #E2E8F0;padding:20px;border-radius:12px;margin-bottom:16px">
            <h3 style="margin:0 0 16px;color:#0F172A">üìã –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425</h3>
            ${listAll(dyn.branchRowsS3 || [])}
            <div style="margin-top:16px;padding-top:16px;border-top:2px solid #E2E8F0;font-weight:700">
              –ò—Ç–æ–≥–æ: ${document.getElementById("sumPrevS3").textContent} ‚Üí ${document.getElementById("sumCurrS3").textContent}
              <span style="color:${document.getElementById("sumDeltaS3").textContent.includes('+') ? '#059669' : '#DC2626'}">(${document.getElementById("sumDeltaS3").textContent})</span>
            </div>
          </div>
          
          <div style="background:#fff;border:1px solid #E2E8F0;padding:20px;border-radius:12px">
            <h3 style="margin:0 0 16px;color:#0F172A">üìû –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h3>
            ${listAll(dyn.branchRowsS4 || [])}
            <div style="margin-top:16px;padding-top:16px;border-top:2px solid #E2E8F0;font-weight:700">
              –ò—Ç–æ–≥–æ: ${document.getElementById("sumPrevS4").textContent} ‚Üí ${document.getElementById("sumCurrS4").textContent}
              <span style="color:${document.getElementById("sumDeltaS4").textContent.includes('+') ? '#059669' : '#DC2626'}">(${document.getElementById("sumDeltaS4").textContent})</span>
            </div>
          </div>
        `;
      })();
      await injectPlanFactHTML();

      document.getElementById("loadingMsg").style.display = "none";
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
      document.querySelectorAll('.card').forEach((card, i) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
          card.style.transition = 'all 0.5s ease-out';
          card.style.opacity = '1';
          card.style.transform = 'translateY(0)';
        }, i * 100);
      });
      
    }catch(e){
      console.error(e);
      document.getElementById("loadingMsg").style.display = "none";
      document.getElementById("errorMsg").textContent = "‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ PDF. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –æ—Ç—á—ë—Ç–æ–≤.";
      document.getElementById("errorMsg").style.display = "inline-block";
    }
  });

  document.getElementById("exportPresPDF").addEventListener("click", async () => {
    if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
    await exportPresPDF();
  });
  document.getElementById("exportBriefPDF").addEventListener("click", async () => {
    if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
    await exportBriefPDF();
  });
  document.getElementById("exportWordHTML").addEventListener("click", () => {
    exportWordHTML();
  });
  document.getElementById("exportPresHTML").addEventListener("click", () => {
    exportPresHTML();
  });

  /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º */
  document.getElementById("btnCompact").addEventListener("click", ()=>{
    document.body.classList.toggle("compact");
    const btn = document.getElementById("btnCompact");
    if(document.body.classList.contains("compact")){
      btn.innerHTML = "üîç –û–±—ã—á–Ω—ã–π";
    } else {
      btn.innerHTML = "‚ö° –ö–æ–º–ø–∞–∫—Ç";
    }
  });
  
  /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ–∫—Ü–∏–∏ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
  window.addEventListener('scroll', () => {
    const sections = document.querySelectorAll('.card');
    const scrollPos = window.scrollY + 100;
    
    sections.forEach(section => {
      const top = section.offsetTop;
      const height = section.offsetHeight;
      
      if (scrollPos >= top && scrollPos < top + height) {
        section.style.borderColor = 'var(--rs-accent)';
      } else {
        section.style.borderColor = 'var(--border-light)';
      }
    });
  });
  </script>
</body>
</html>
