<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ВОЛС Аналитика | Россети Кубань</title>

  <!-- Шрифты -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== Глобальные переменные и токены дизайна ====== */
    :root{
      /* Основные цвета бренда */
      --primary: #1E3A8A;
      --primary-light: #3B82F6;
      --primary-dark: #1E293B;
      --accent: #06B6D4;
      --accent-glow: rgba(6, 182, 212, 0.3);
      
      /* Фоны и поверхности */
      --bg-main: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(59, 130, 246, 0.1);
      
      /* Стекломорфизм */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* Текст */
      --text-primary: #F1F5F9;
      --text-secondary: #94A3B8;
      --text-muted: #64748B;
      
      /* Статусы */
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      
      /* Эффекты */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.7);
      --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.3);
      
      /* Скругления */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* Анимации */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== Базовые стили ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* Фоновый градиент */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* ====== Шапка ====== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      transition: var(--transition);
    }

    header.scrolled {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      letter-spacing: -0.02em;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* ====== Главный контент ====== */
    main {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* ====== Сетка ====== */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .cols-4 { grid-template-columns: repeat(2, 1fr); }
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .cols-2, .cols-3, .cols-4 { grid-template-columns: 1fr; }
    }

    /* ====== Карточки ====== */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* ====== KPI карточки ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-delta {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .kpi-delta.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .kpi-delta.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .kpi-delta.neutral {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* ====== Кнопки ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px dashed var(--glass-border);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
      background: var(--glass);
    }

    /* ====== Формы ====== */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--glass);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-wrapper:hover {
      border-color: var(--primary-light);
      background: var(--bg-hover);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    /* ====== Таблицы ====== */
    .table-container {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-scroll {
      max-height: 400px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--glass-border) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 2px solid var(--glass-border);
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    tfoot td {
      background: var(--bg-secondary);
      font-weight: 700;
      color: var(--text-primary);
      padding: 1rem;
      border-top: 2px solid var(--glass-border);
    }

    /* ====== Графики ====== */
    .chart-container {
      height: 400px;
      padding: 1rem;
      background: var(--glass);
      border-radius: var(--radius-md);
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== Статусы и значки ====== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--success);
      font-weight: 600;
    }

    .value-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* ====== Анимация загрузки ====== */
    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== Сообщения ====== */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .message-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .message-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    /* ====== Секция экспорта ====== */
    .export-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    /* ====== Адаптивность ====== */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }

      .brand {
        font-size: 1rem;
      }

      .logo {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }

      main {
        margin-top: 70px;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 2rem;
      }

      .table-scroll {
        max-height: 300px;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
    }

    /* ====== Утилиты ====== */
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    /* ====== Печать ====== */
    @media print {
      body {
        background: white;
        color: black;
      }

      header {
        position: relative;
        background: white;
        border-bottom: 2px solid #000;
      }

      .card {
        background: white;
        border: 1px solid #ccc;
        box-shadow: none;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }

      .btn, .file-input-wrapper {
        display: none;
      }
    }

    /* ====== Компактный режим ====== */
    .compact .card {
      padding: 1rem;
    }

    .compact .kpi-card {
      padding: 0.75rem;
    }

    .compact .kpi-value {
      font-size: 1.75rem;
    }

    .compact table {
      font-size: 0.75rem;
    }

    .compact th, .compact td {
      padding: 0.5rem;
    }

    .compact .chart-container {
      height: 300px;
    }

    /* ====== Скрытые элементы для печати ====== */
    #presentationPrint, #summaryPrint {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Шапка -->
  <header id="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">РК</div>
        <span>ВОЛС Аналитика</span>
      </div>
      <div class="nav-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>Система активна</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Основной контент -->
  <main>
    <div class="container">
      <!-- Секция загрузки и экспорта -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">📊</div>
              Загрузка отчётов
            </h2>
          </div>
          <div class="form-group">
            <label class="file-input-wrapper">
              <div class="file-icon">📄</div>
              <span>Предыдущая неделя (PDF)</span>
              <input id="filePrev" type="file" accept="application/pdf">
            </label>
            <label class="file-input-wrapper">
              <div class="file-icon">📄</div>
              <span>Текущая неделя (PDF)</span>
              <input id="fileCurr" type="file" accept="application/pdf">
            </label>
          </div>
          <div class="form-group">
            <button id="btnParse" class="btn btn-primary">
              <span>🚀</span>
              Проанализировать
            </button>
            <button id="btnCompact" class="btn btn-ghost" title="Компактный режим">
              <span>📐</span>
              Компактный вид
            </button>
          </div>
          <div id="dates" class="message message-info" style="display:none"></div>
          <div id="loadingMsg" class="loading" style="display:none">
            <div class="loading-spinner"></div>
            <span>Обработка PDF файлов...</span>
          </div>
          <div id="errorMsg" class="message message-error" style="display:none"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">💾</div>
              Экспорт отчётов
            </h2>
          </div>
          <div class="export-section">
            <button class="btn btn-secondary" id="exportPresPDF">
              <span>📑</span>
              Презентация PDF
            </button>
            <button class="btn btn-secondary" id="exportBriefPDF">
              <span>📋</span>
              Выжимка PDF
            </button>
            <button class="btn btn-secondary" id="exportWordHTML">
              <span>📝</span>
              Отчет Word
            </button>
            <button class="btn btn-secondary" id="exportPresHTML">
              <span>🌐</span>
              Презентация HTML
            </button>
          </div>
          <div id="exportStatus" class="message message-success mt-1" style="display:none"></div>
        </div>
      </div>

      <!-- KPI секция -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">📈</div>
            Ключевые показатели
          </h2>
        </div>
        <div id="kpis" class="kpi-grid"></div>
      </div>

      <!-- Графики и таблицы стр. 2 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Динамика по филиалам</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranches"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranches">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrev">0</td>
                    <td id="sumCurr">0</td>
                    <td id="sumDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Графики и таблицы стр. 3 -->
      <div class="grid cols-2 mb-2">
/* ==================== Рендер на странице ==================== */
  let chartBranches, chartBranchesS3, chartBranchesS4, chartRTKDelta;

  function renderKpis(curr, prev, dyn){
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const items = [
      {title:"В работе всего", value:curr.p1.totals.in_work_total, delta:dyn.in_work_total, unit:"шт."},
      {title:"Выявлено за неделю", value:dyn.found_week, delta:dyn.found_week, unit:"шт."},
      {title:"Закрыто за неделю", value:eff, delta:eff, unit:"шт.", subtitle:"(узак. + демонт.)"},
      {title:"ПАО «Ростелеком»", value:curr.p1.totals.rtk_in_work, delta:dyn.rtk_in_work, unit:"шт.", subtitle:`доля ${rtkShare.toFixed(1)}%`},
    ];

    document.getElementById("kpis").innerHTML = items.map(it=>{
      const d = typeof it.delta==="number"?it.delta:0;
      const deltaClass = d>0?"positive":(d<0?"negative":"neutral");
      const sign=d>0?"+":"";
      const arrow = d>0?"↑":(d<0?"↓":"→");
      
      return `<div class="kpi-card">
        <div class="kpi-label">${it.title}</div>
        <div class="kpi-value">${fmt(it.value)} <span style="font-size:0.5em;font-weight:400;color:var(--text-secondary)">${it.unit}</span></div>
        ${it.subtitle ? `<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem">${it.subtitle}</div>` : ''}
        <div class="kpi-delta ${deltaClass}">
          <span>${arrow}</span>
          <span>${sign}${fmt(d)}</span>
        </div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(rows, tbodySel, sumPrevId, sumCurrId, sumDeltaId){
    const tbody = document.querySelector(tbodySel);
    tbody.innerHTML = "";
    let sP=0,sC=0,sD=0;
    const sorted = [...rows].sort((a,b)=>Math.abs((b.c-b.p)) - Math.abs((a.c-a.p)));
    for(const r0 of sorted){
      const p = Number(r0.p)||0, c = Number(r0.c)||0;
      const d = c - p;
      const cls = d>0?"value-positive":(d<0?"value-negative":"");
      sP+=p; sC+=c; sD+=d;
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r0.b}</td>
          <td>${fmt(p)}</td>
          <td>${fmt(c)}</td>
          <td class="${cls}">${d>0?"+":""}${fmt(d)}</td>
        </tr>`);
    }
    document.getElementById(sumPrevId).textContent = fmt(sP);
    document.getElementById(sumCurrId).textContent = fmt(sC);
    document.getElementById(sumDeltaId).textContent = (sD>0?"+":"")+fmt(sD);
    document.getElementById(sumDeltaId).className = sD>0?"value-positive":(sD<0?"value-negative":"");
  }

  function chartOpts(){
    Chart.defaults.color = '#94A3B8';
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
    
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:"top",
          labels:{
            boxWidth:12,
            usePointStyle:true,
            padding:20,
            font:{size:12}
          }
        },
        tooltip:{
          backgroundColor: 'rgba(30, 41, 59, 0.9)',
          titleColor: '#F1F5F9',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          boxWidth: 12,
          boxHeight: 12,
          usePointStyle: true
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid:{
            color:'rgba(255, 255, 255, 0.05)',
            drawBorder:false
          },
          ticks:{
            precision:0,
            padding:10
          }
        },
        x:{
          grid:{
            display:false,
            drawBorder:false
          },
          ticks:{
            padding:10
          }
        }
      },
    };
  }

  function renderCharts(curr, prev, dyn){
    const labels = BRANCHES;
    const prevS2 = labels.map(b=>prev.p2.branches.get(b)?.total||0);
    const currS2 = labels.map(b=>curr.p2.branches.get(b)?.total||0);

    if(chartBranches) chartBranches.destroy();
    chartBranches = new Chart(document.getElementById("chartBranches"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS2, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS2, backgroundColor:"rgba(59, 130, 246, 0.5)", borderColor:"rgba(59, 130, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS3 = labels.map(b=>prev.p3.branches.get(b)?.total||0);
    const currS3 = labels.map(b=>curr.p3.branches.get(b)?.total||0);
    if(chartBranchesS3) chartBranchesS3.destroy();
    chartBranchesS3 = new Chart(document.getElementById("chartBranchesS3"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS3, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS3, backgroundColor:"rgba(139, 92, 246, 0.5)", borderColor:"rgba(139, 92, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS4 = labels.map(b=>prev.p4.branches.get(b)?.total||0);
    const currS4 = labels.map(b=>curr.p4.branches.get(b)?.total||0);
    if(chartBranchesS4) chartBranchesS4.destroy();
    chartBranchesS4 = new Chart(document.getElementById("chartBranchesS4"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS4, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS4, backgroundColor:"rgba(6, 182, 212, 0.5)", borderColor:"rgba(6, 182, 212, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const rtkD = labels.map(b => (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).c - (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).p);
    if(chartRTKDelta) chartRTKDelta.destroy();
    chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
      type:"bar",
      data:{labels, datasets:[{
        label:"Изменение (тек. − пред.)", 
        data:rtkD, 
        backgroundColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.5)":"rgba(239, 68, 68, 0.<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ВОЛС Аналитика | Россети Кубань</title>

  <!-- Шрифты -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== Глобальные переменные и токены дизайна ====== */
    :root{
      /* Основные цвета бренда */
      --primary: #1E3A8A;
      --primary-light: #3B82F6;
      --primary-dark: #1E293B;
      --accent: #06B6D4;
      --accent-glow: rgba(6, 182, 212, 0.3);
      
      /* Фоны и поверхности */
      --bg-main: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(59, 130, 246, 0.1);
      
      /* Стекломорфизм */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* Текст */
      --text-primary: #F1F5F9;
      --text-secondary: #94A3B8;
      --text-muted: #64748B;
      
      /* Статусы */
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      
      /* Эффекты */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.7);
      --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.3);
      
      /* Скругления */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* Анимации */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== Базовые стили ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* Фоновый градиент */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* ====== Шапка ====== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      transition: var(--transition);
    }

    header.scrolled {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      letter-spacing: -0.02em;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* ====== Главный контент ====== */
    main {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* ====== Сетка ====== */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .cols-4 { grid-template-columns: repeat(2, 1fr); }
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .cols-2, .cols-3, .cols-4 { grid-template-columns: 1fr; }
    }

    /* ====== Карточки ====== */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* ====== KPI карточки ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-delta {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .kpi-delta.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .kpi-delta.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .kpi-delta.neutral {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* ====== Кнопки ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px dashed var(--glass-border);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
      background: var(--glass);
    }

    /* ====== Формы ====== */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--glass);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-wrapper:hover {
      border-color: var(--primary-light);
      background: var(--bg-hover);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    /* ====== Таблицы ====== */
    .table-container {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-scroll {
      max-height: 400px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--glass-border) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 2px solid var(--glass-border);
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    tfoot td {
      background: var(--bg-secondary);
      font-weight: 700;
      color: var(--text-primary);
      padding: 1rem;
      border-top: 2px solid var(--glass-border);
    }

    /* ====== Графики ====== */
    .chart-container {
      height: 400px;
      padding: 1rem;
      background: var(--glass);
      border-radius: var(--radius-md);
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== Статусы и значки ====== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--success);
      font-weight: 600;
    }

    .value-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* ====== Анимация загрузки ====== */
    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== Сообщения ====== */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .message-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .message-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    /* ====== Секция экспорта ====== */
    .export-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    /* ====== Адаптивность ====== */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }

      .brand {
        font-size: 1rem;
      }

      .logo {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }

      main {
        margin-top: 70px;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 2rem;
      }

      .table-scroll {
        max-height: 300px;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
    }

    /* ====== Утилиты ====== */
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    /* ====== Печать ====== */
    @media print {
      body {
        background: white;
        color: black;
      }

      header {
        position: relative;
        background: white;
        border-bottom: 2px solid #000;
      }

      .card {
        background: white;
        border: 1px solid #ccc;
        box-shadow: none;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }

      .btn, .file-input-wrapper {
        display: none;
      }
    }

    /* ====== Компактный режим ====== */
    .compact .card {
      padding: 1rem;
    }

    .compact .kpi-card {
      padding: 0.75rem;
    }

    .compact .kpi-value {
      font-size: 1.75rem;
    }

    .compact table {
      font-size: 0.75rem;
    }

    .compact th, .compact td {
      padding: 0.5rem;
    }

    .compact .chart-container {
      height: 300px;
    }

    /* ====== Скрытые элементы для печати ====== */
    #presentationPrint, #summaryPrint {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Шапка -->
  <header id="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">РК</div>
        <span>ВОЛС Аналитика</span>
      </div>
      <div class="nav-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>Система активна</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Основной контент -->
  <main>
    <div class="container">
      <!-- Секция загрузки и экспорта -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">📊</div>
              Загрузка отчётов
            </h2>
          </div>
          <div class="form-group">
            <label class="file-input-wrapper">
              <div class="file-icon">📄</div>
              <span>Предыдущая неделя (PDF)</span>
              <input id="filePrev" type="file" accept="application/pdf">
            </label>
            <label class="file-input-wrapper">
              <div class="file-icon">📄</div>
              <span>Текущая неделя (PDF)</span>
              <input id="fileCurr" type="file" accept="application/pdf">
            </label>
          </div>
          <div class="form-group">
            <button id="btnParse" class="btn btn-primary">
              <span>🚀</span>
              Проанализировать
            </button>
            <button id="btnCompact" class="btn btn-ghost" title="Компактный режим">
              <span>📐</span>
              Компактный вид
            </button>
          </div>
          <div id="dates" class="message message-info" style="display:none"></div>
          <div id="loadingMsg" class="loading" style="display:none">
            <div class="loading-spinner"></div>
            <span>Обработка PDF файлов...</span>
          </div>
          <div id="errorMsg" class="message message-error" style="display:none"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">💾</div>
              Экспорт отчётов
            </h2>
          </div>
          <div class="export-section">
            <button class="btn btn-secondary" id="exportPresPDF">
              <span>📑</span>
              Презентация PDF
            </button>
            <button class="btn btn-secondary" id="exportBriefPDF">
              <span>📋</span>
              Выжимка PDF
            </button>
            <button class="btn btn-secondary" id="exportWordHTML">
              <span>📝</span>
              Отчет Word
            </button>
            <button class="btn btn-secondary" id="exportPresHTML">
              <span>🌐</span>
              Презентация HTML
            </button>
          </div>
          <div id="exportStatus" class="message message-success mt-1" style="display:none"></div>
        </div>
      </div>

      <!-- KPI секция -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">📈</div>
            Ключевые показатели
          </h2>
        </div>
        <div id="kpis" class="kpi-grid"></div>
      </div>

      <!-- Графики и таблицы стр. 2 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Динамика по филиалам</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranches"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranches">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrev">0</td>
                    <td id="sumCurr">0</td>
                    <td id="sumDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Графики и таблицы стр. 3 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Приказ №425</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS3"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 3</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS3">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrevS3">0</td>
                    <td id="sumCurrS3">0</td>
                    <td id="sumDeltaS3">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Графики и таблицы стр. 4 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ПАО «Ростелеком»</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS4"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 4</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS4">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrevS4">0</td>
                    <td id="sumCurrS4">0</td>
                    <td id="sumDeltaS4">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- График изменений РТК -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">📊</div>
            Динамика изменений ПАО «Ростелеком»
          </h2>
        </div>
        <div class="chart-container">
          <canvas id="chartRTKDelta"></canvas>
        </div>
      </div>

      <!-- Стадии -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Стадии работ</h2>
            <span class="badge">Стр. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS2">
                <thead>
                  <tr>
                    <th>Стадия</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Стадии работ</h2>
            <span class="badge">Стр. 4 (РТК)</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS4">
                <thead>
                  <tr>
                    <th>Стадия</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Области для печати (скрытые) -->
  <div id="presentationPrint" style="display:none"></div>
  <div id="summaryPrint" style="display:none"></div>

  <!-- Библиотеки -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
  /* ==================== Константы и утилиты ==================== */
  const BRANCHES = [
    "Сочинские ЭС","Тимашевские ЭС","Тихорецкие ЭС","Усть-Лабинские ЭС","Юго-Западные ЭС",
    "Адыгейские ЭС","Армавирские ЭС","Краснодарские ЭС","Лабинские ЭС","Ленинградские ЭС","Славянские ЭС"
  ];
  const BRANCH_PATTERNS = [
    {name:"Сочинские ЭС", re:/Сочинские\s+ЭС/i},
    {name:"Тимашевские ЭС", re:/Тимашевские\s+ЭС/i},
    {name:"Тихорецкие ЭС", re:/Тихорецкие\s+ЭС/i},
    {name:"Усть-Лабинские ЭС", re:/Усть[\s\u00A0\u202F\-–—-]*Лабинские\s+ЭС/i},
    {name:"Юго-Западные ЭС", re:/Юго[\s\u00A0\u202F\-–—-]*Западные\s+ЭС/i},
    {name:"Адыгейские ЭС", re:/Адыгейские\s+ЭС/i},
    {name:"Армавирские ЭС", re:/Армавирские\s+ЭС/i},
    {name:"Краснодарские ЭС", re:/Краснодарские\s+ЭС/i},
    {name:"Лабинские ЭС", re:/Лабинские\s+ЭС/i},
    {name:"Ленинградские ЭС", re:/Ленинградские\s+ЭС/i},
    {name:"Славянские ЭС", re:/Славянские\s+ЭС/i},
  ];

  /* Стадии */
  const STATUS_PATTERNS = [
    {key:"work", title:"В работе у филиала", re:/В\s*работе\s*у\s*филиала/i},
    {key:"dismantled", title:"Демонтировано", re:/Демонтировано/i},
    {key:"rc_digit", title:"Договор на оформлении Россети Цифра", re:/Договор\s*на\s*оформлении\s*Россети\s*Цифра/i},
    {key:"op_sign", title:"Договор на подписании у оператора", re:/Договор\s*на\s*подписании\s*у\s*оператора/i},
    {key:"filial_appr",title:"Договор на согласовании в филиале", re:/Договор\s*на\s*согласовании\s*в\s*филиале/i},
    {key:"incl_next", title:"Будет включено в следующее доп. соглашение после подписания",
      re:/Будет\s*включено(?:[\s\S]{0,80})в(?:\s*следующее)?(?:[\s\S]{0,80})доп\.?\s*соглашение(?:[\s\S]{0,80}после\s*подписания)?/i
    },
  ];
  const STATUS_KEYS = STATUS_PATTERNS.map(s => s.key);
  const STAGE_TITLE = k => (STATUS_PATTERNS.find(s => s.key===k)||{}).title||k;

  const SHORT_STAGE_TITLES = {
    "work": "В работе",
    "dismantled": "Демонт.",
    "rc_digit": "Оформл. РЦ",
    "op_sign": "Подпись опер.",
    "filial_appr": "Согл. филиал",
    "incl_next": "В след. доп.согл."
  };
  const SHORT_STAGE_TITLE = k => SHORT_STAGE_TITLES[k] || STAGE_TITLE(k);

  const numberize = s => {
    const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
    const n = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
    if(!n) return 0;
    const val = Number(n.replace(",", "."));
    return isNaN(val) ? 0 : val;
  };
  const fmt = n => (typeof n === "number" ? n : Number(n||0)).toLocaleString("ru-RU");
  const normalize = txt => String(txt||"")
      .replace(/\u00A0|\u202F/g," ")
      .replace(/\u00AD/g,"")
      .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
      .replace(/[ \t]+/g," ")
      .trim();

  /* ==================== Чтение PDF ==================== */
  async function pdfToPages(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      let pageText = "", lastY = null;
      content.items.forEach(item => {
        const y = item.transform[5];
        if(lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
        pageText += item.str;
        lastY = y;
      });
      pages.push(normalize(pageText));
    }
    return pages;
  }

  /* ==================== Парсинг ==================== */
  function extractDateFromPages(pages){
    for(const pg of pages){
      const m = pg.match(/по состоянию на\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
    return "—";
  }

  function parseTotalsFromPage(page1){
    const find = (re) => {
      const m = page1.match(re);
      return m ? numberize(m[1]) : 0;
    };
    return {
      found_year: find(/выявлено[^0-9]*?(\d[\d\s]+)\s*шт/i),
      legalized: find(/Узаконено[^0-9]*?(\d[\d\s]+)/i),
      dismantled_ytd: find(/За\s*20\d{2}\s*год\s*демонтировано[^0-9]*?(\d[\d\s]+)/i),
      in_work_total: find(/В\s*работе[^0-9]*?всего[^0-9]*?(\d[\d\s]+)\s*шт/i),
      rtk_in_work: find(/в\s*том\s*числе\s*ПАО\s*«?Ростелеком»?[^0-9]*?(\d[\d\s]+)/i),
    };
  }

  function parseBranchTable(pageText){
    const text = normalize(pageText);
    const lines = text.split("\n").filter(Boolean);

    const idx = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      for(const bp of BRANCH_PATTERNS){
        if(bp.re.test(line)){ idx.push({i, name: bp.name}); break; }
      }
    }
    idx.push({i: lines.length, name:null});

    const branches = new Map();
    for(let k=0;k<idx.length-1;k++){
      const start = idx[k].i, end = idx[k+1].i, branchName = idx[k].name;
      if(!branchName) continue;
      const headLine = lines[start] || "";
      const segText = lines.slice(start+1, end).join(" ");

      let total = 0;
      const headNums = headLine.match(/\d[\d\s]*/g);
      if(headNums && headNums.length) total = numberize(headNums[headNums.length-1]);
      if(total===0 && lines[start+1]){
        const n2 = (lines[start+1]||"").match(/\d[\d\s]*/g);
        if(n2 && n2.length) total = numberize(n2[n2.length-1]);
      }

      const data = { total, statuses:{} };

      function numAfter(re, hay){
        const rx = new RegExp(re.source + "[^\\d]{0,200}(\\d[\\d\\s]*)", re.flags);
        const m = hay.match(rx);
        return m ? numberize(m[1]) : null;
      }

      for(const sp of STATUS_PATTERNS){
        let v = numAfter(sp.re, segText);
        if(v === null){
          for(let j=start+1;j<end;j++){
            const l0 = lines[j]||"", l1 = lines[j+1]||"";
            if(sp.re.test(l0) || sp.re.test(l1)){
              let cap = (l0.match(/(\d[\d\s]*)/g)||[]).pop();
              if(!cap) cap = (l1.match(/(\d[\d\s]*)/g)||[]).pop();
              if(cap){ v = numberize(cap); break; }
            }
          }
        }
        if(v !== null) data.statuses[sp.key] = v;
      }
      branches.set(branchName, data);
    }

    for(const b of BRANCHES){
      if(!branches.has(b)) branches.set(b, { total:0, statuses:{} });
    }

    const stages = {};
    for(const [_, obj] of branches){
      for(const [k,v] of Object.entries(obj.statuses)){
        stages[k] = (stages[k]||0) + (v||0);
      }
    }

    const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);
    return { branches, overall, stages };
  }

  function parseReportByPages(pages){
    return {
      date: extractDateFromPages(pages),
      p1: { totals: parseTotalsFromPage(pages[0] || "") },
      p2: parseBranchTable(pages[1] || ""),
      p3: parseBranchTable(pages[2] || ""),
      p4: parseBranchTable(pages[3] || ""),
    };
  }

  /* ==================== Динамика ==================== */
  function computeDynamics(curr, prev){
    const dyn = {
      in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
      rtk_in_work: (curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work) || 0,
      legalized: (curr.p1.totals.legalized - prev.p1.totals.legalized) || 0,
      dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
    };
    dyn.found_week = dyn.in_work_total;

    const makeRows = (cPage, pPage) => BRANCHES.map(b=>{
      const c = cPage.branches.get(b)?.total || 0;
      const p = pPage.branches.get(b)?.total || 0;
      return {b, p, c, d: (c - p)};
    });

    const branchRows = makeRows(curr.p2, prev.p2);
    const branchRowsS3 = makeRows(curr.p3, prev.p3);
    const branchRowsS4 = makeRows(curr.p4, prev.p4);

    const allKeys = Array.from(new Set([
      ...Object.keys(prev.p2.stages||{}), ...Object.keys(curr.p2.stages||{}),
      ...Object.keys(prev.p3.stages||{}), ...Object.keys(curr.p3.stages||{}),
      ...Object.keys(prev.p4.stages||{}), ...Object.keys(curr.p4.stages||{}),
      ...STATUS_KEYS
    ]));

    const diffStages = (cur, prv) => allKeys.map(k=>({
      stage: STAGE_TITLE(k), short: SHORT_STAGE_TITLE(k), key: k,
      p: prv[k] || 0, c: cur[k] || 0, d: (cur[k]||0) - (prv[k]||0)
    }));

    const stagesS2 = diffStages(curr.p2.stages||{}, prev.p2.stages||{});
    const stagesS4 = diffStages(curr.p4.stages||{}, prev.p4.stages||{});

    function perBranchStages(cPage, pPage){
      return BRANCHES.map(b=>{
        const cst = cPage.branches.get(b)?.statuses || {};
        const pst = pPage.branches.get(b)?.statuses || {};
        const by = {};
        STATUS_KEYS.forEach(k=>{
          const p = pst[k]||0, c = cst[k]||0;
          by[k] = {p,c,d:c-p};
        });
        return {b, by};
      });
    }
    const s2BranchStages = perBranchStages(curr.p2, prev.p2);

    return {
      ...dyn,
      branchRows,
      branchRowsS3,
      branchRowsS4,
      stagesS2,
      stagesS4,
      s2BranchStages,
      rtkRows: branchRowsS4
    };
  }pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
}]},
      options: chartOpts()
    });
  }

  function renderStagesTables(dyn){
    const fill = (id, rows) => {
      const tbody = document.querySelector(id + " tbody");
      tbody.innerHTML = rows.map(r=>{
        const p = Number(r.p)||0, c = Number(r.c)||0, d = c - p;
        const cls = d>0?"value-positive":(d<0?"value-negative":"");
        return `<tr>
          <td>${r.stage}</td>
          <td>${fmt(p)}</td>
          <td>${fmt(c)}</td>
          <td class="${cls}">${d>0?"+":""}${fmt(d)}</td>
        </tr>`;
      }).join("");
    };
    fill("#tblStagesS2", dyn.stagesS2);
    fill("#tblStagesS4", dyn.stagesS4);
  }

  /* ==================== Экспорт PDF с премиум дизайном ==================== */
  async function exportPresPDF(){
    const el = document.getElementById("presentationPrint");
    
    // Создаем премиум HTML для презентации
    el.innerHTML = `
      <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        body {
          font-family: 'Inter', Arial, sans-serif;
          color: #1E293B;
          line-height: 1.6;
        }
        
        .pres-page {
          padding: 40px;
          background: white;
          min-height: 100vh;
          page-break-after: always;
        }
        
        .pres-header {
          display: flex;
          align-items: center;
          gap: 20px;
          margin-bottom: 40px;
          padding-bottom: 20px;
          border-bottom: 3px solid #1E3A8A;
        }
        
        .pres-logo {
          width: 60px;
          height: 60px;
          background: linear-gradient(135deg, #3B82F6, #06B6D4);
          border-radius: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 900;
          font-size: 24px;
          color: white;
        }
        
        .pres-title {
          font-size: 28px;
          font-weight: 800;
          color: #1E3A8A;
        }
        
        .pres-date {
          font-size: 14px;
          color: #64748B;
          margin-top: 4px;
        }
        
        .kpi-section {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 20px;
          margin-bottom: 40px;
        }
        
        .kpi-box {
          background: #F8FAFC;
          border: 1px solid #E2E8F0;
          border-radius: 12px;
          padding: 20px;
          text-align: center;
        }
        
        .kpi-label {
          font-size: 12px;
          color: #64748B;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        
        .kpi-value {
          font-size: 32px;
          font-weight: 800;
          color: #1E293B;
          margin: 8px 0;
        }
        
        .kpi-delta {
          font-size: 14px;
          font-weight: 600;
        }
        
        .delta-positive { color: #10B981; }
        .delta-negative { color: #EF4444; }
        .delta-neutral { color: #64748B; }
        
        .table-section {
          margin-bottom: 40px;
        }
        
        .section-title {
          font-size: 20px;
          font-weight: 700;
          color: #1E293B;
          margin-bottom: 16px;
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .section-icon {
          width: 32px;
          height: 32px;
          background: linear-gradient(135deg, #3B82F6, #06B6D4);
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
        }
        
        table {
          width: 100%;
          border-collapse: collapse;
          background: white;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        th {
          background: #1E3A8A;
          color: white;
          padding: 12px 16px;
          text-align: left;
          font-weight: 600;
          font-size: 14px;
        }
        
        th:not(:first-child) {
          text-align: right;
        }
        
        td {
          padding: 12px 16px;
          border-bottom: 1px solid #F1F5F9;
          font-size: 14px;
        }
        
        td:not(:first-child) {
          text-align: right;
          font-variant-numeric: tabular-nums;
        }
        
        tr:nth-child(even) {
          background: #F8FAFC;
        }
        
        tfoot td {
          background: #E0E7FF;
          font-weight: 700;
          border-top: 2px solid #1E3A8A;
          color: #1E3A8A;
        }
        
        .chart-img {
          width: 100%;
          height: auto;
          border-radius: 12px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
      </style>
    `;
    
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    // Страница 1
    el.innerHTML += `
      <div class="pres-page">
        <div class="pres-header">
          <div class="pres-logo">РК</div>
          <div>
            <div class="pres-title">Динамика ВОЛС - Аналитический отчет</div>
            <div class="pres-date">Период: ${prev.date} — ${curr.date}</div>
          </div>
        </div>
        
        <div class="kpi-section">
          <div class="kpi-box">
            <div class="kpi-label">В работе всего</div>
            <div class="kpi-value">${fmt(curr.p1.totals.in_work_total)}</div>
            <div class="kpi-delta ${dyn.in_work_total >= 0 ? 'delta-positive' : 'delta-negative'}">
              ${dyn.in_work_total > 0 ? '+' : ''}${fmt(dyn.in_work_total)} шт.
            </div>
          </div>
          <div class="kpi-box">
            <div class="kpi-label">Выявлено за неделю</div>
            <div class="kpi-value">${fmt(dyn.found_week)}</div>
            <div class="kpi-delta delta-neutral">новые</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-label">Закрыто за неделю</div>
            <div class="kpi-value">${fmt(eff)}</div>
            <div class="kpi-delta delta-neutral">узак. + демонт.</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-label">ПАО Ростелеком</div>
            <div class="kpi-value">${fmt(curr.p1.totals.rtk_in_work)}</div>
            <div class="kpi-delta ${dyn.rtk_in_work >= 0 ? 'delta-positive' : 'delta-negative'}">
              ${dyn.rtk_in_work > 0 ? '+' : ''}${fmt(dyn.rtk_in_work)} (${rtkShare.toFixed(1)}%)
            </div>
          </div>
        </div>
        
        ${buildPresentationTables()}
      </div>
    `;
    
    el.style.display = "block";
    await html2pdf().from(el).set({
      margin: 0,
      filename: "Презентация_ВОЛС_" + new Date().toISOString().split('T')[0] + ".pdf",
      image: {type: 'jpeg', quality: 0.98},
      html2canvas: {scale: 2, useCORS: true},
      jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'},
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    }).save();
    el.style.display = "none";
    showExportMessage("PDF презентации сохранен");
  }

  async function exportBriefPDF(){
    const el = document.getElementById("summaryPrint");
    
    // Аналогичный премиум дизайн для выжимки
    el.innerHTML = `
      <style>
        /* Используем те же стили, что и для презентации */
        ${document.querySelector('#presentationPrint style').innerHTML}
        
        .brief-block {
          background: #F8FAFC;
          border: 1px solid #E2E8F0;
          border-radius: 12px;
          padding: 24px;
          margin-bottom: 20px;
        }
        
        .brief-title {
          font-size: 18px;
          font-weight: 700;
          color: #1E3A8A;
          margin-bottom: 12px;
        }
        
        .brief-content {
          font-size: 14px;
          line-height: 1.8;
        }
        
        .brief-item {
          padding: 4px 0;
        }
        
        .brief-value {
          font-weight: 700;
          color: #1E293B;
        }
      </style>
    `;
    
    const {curr, prev, dyn} = DATA;
    
    el.innerHTML += `
      <div class="pres-page">
        <div class="pres-header">
          <div class="pres-logo">РК</div>
          <div>
            <div class="pres-title">Краткая выжимка для руководителя</div>
            <div class="pres-date">Период: ${prev.date} — ${curr.date}</div>
          </div>
        </div>
        
        ${buildSummaryContent()}
      </div>
    `;
    
    el.style.display = "block";
    await html2pdf().from(el).set({
      margin: 0,
      filename: "Выжимка_ВОЛС_" + new Date().toISOString().split('T')[0] + ".pdf",
      image: {type: 'jpeg', quality: 0.98},
      html2canvas: {scale: 2, useCORS: true},
      jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'}
    }).save();
    el.style.display = "none";
    showExportMessage("PDF выжимки сохранен");
  }

  /* ==================== Вспомогательные функции для экспорта ==================== */
  function buildPresentationTables(){
    const {branchRows, branchRowsS3, branchRowsS4} = DATA.dyn;
    
    const makeTable = (title, icon, rows, sumIds) => {
      const sorted = [...rows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d));
      return `
        <div class="table-section">
          <div class="section-title">
            <div class="section-icon">${icon}</div>
            ${title}
          </div>
          <table>
            <thead>
              <tr>
                <th>Филиал</th>
                <th>Предыдущая</th>
                <th>Текущая</th>
                <th>Изменение</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map(r => `
                <tr>
                  <td>${r.b}</td>
                  <td>${fmt(r.p)}</td>
                  <td>${fmt(r.c)}</td>
                  <td class="${r.d > 0 ? 'delta-positive' : r.d < 0 ? 'delta-negative' : ''}">
                    ${r.d > 0 ? '+' : ''}${fmt(r.d)}
                  </td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr>
                <td>Итого</td>
                <td>${document.getElementById(sumIds[0]).textContent}</td>
                <td>${document.getElementById(sumIds[1]).textContent}</td>
                <td>${document.getElementById(sumIds[2]).textContent}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    };
    
    return makeTable("Динамика по филиалам (всего)", "📊", branchRows, ["sumPrev", "sumCurr", "sumDelta"]) +
           makeTable("Динамика по Приказу №425", "📋", branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"]) +
           makeTable("Динамика по ПАО «Ростелеком»", "🌐", branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"]);
  }

  function buildSummaryContent(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    
    const topChanges = [...dyn.branchRows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d)).slice(0, 3);
    
    return `
      <div class="brief-block">
        <div class="brief-title">Основные показатели</div>
        <div class="brief-content">
          <div class="brief-item">• В работе всего: <span class="brief-value">${fmt(curr.p1.totals.in_work_total)}</span> (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})</div>
          <div class="brief-item">• Выявлено за неделю: <span class="brief-value">${fmt(dyn.found_week)}</span></div>
          <div class="brief-item">• Закрыто за неделю: <span class="brief-value">${fmt(eff)}</span></div>
          <div class="brief-item">• ПАО «Ростелеком»: <span class="brief-value">${fmt(curr.p1.totals.rtk_in_work)}</span> (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</div>
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">Топ-3 филиала по изменениям</div>
        <div class="brief-content">
          ${topChanges.map((r, i) => `
            <div class="brief-item">${i+1}. <span class="brief-value">${r.b}</span>: ${fmt(r.p)} → ${fmt(r.c)} (${r.d>0?'+':''}${fmt(r.d)})</div>
          `).join('')}
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">Итоги по категориям</div>
        <div class="brief-content">
          <div class="brief-item">• Всего опор: ${document.getElementById("sumPrev").textContent} → <span class="brief-value">${document.getElementById("sumCurr").textContent}</span> (${document.getElementById("sumDelta").textContent})</div>
          <div class="brief-item">• Приказ №425: ${document.getElementById("sumPrevS3").textContent} → <span class="brief-value">${document.getElementById("sumCurrS3").textContent}</span> (${document.getElementById("sumDeltaS3").textContent})</div>
          <div class="brief-item">• ПАО Ростелеком: ${document.getElementById("sumPrevS4").textContent} → <span class="brief-value">${document.getElementById("sumCurrS4").textContent}</span> (${document.getElementById("sumDeltaS4").textContent})</div>
        </div>
      </div>
    `;
  }

  /* ==================== Экспорт Word HTML ==================== */
  function exportWordHTML(){
    if(!DATA) return alert("Сначала проанализируйте отчёты.");
    const {curr, prev, dyn} = DATA;
    
    const htmlDoc = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Отчет ВОЛС - ${curr.date}</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body { font-family: 'Calibri', Arial, sans-serif; line-height: 1.6; color: #333; }
    h1 { color: #1E3A8A; font-size: 24pt; border-bottom: 3pt solid #1E3A8A; padding-bottom: 10pt; }
    h2 { color: #1E3A8A; font-size: 18pt; margin-top: 20pt; }
    h3 { color: #333; font-size: 14pt; margin-top: 15pt; }
    table { width: 100%; border-collapse: collapse; margin: 15pt 0; }
    th, td { border: 1pt solid #ddd; padding: 8pt; text-align: center; }
    th { background-color: #1E3A8A; color: white; font-weight: bold; }
    th:first-child, td:first-child { text-align: left; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .info-box { background: #EBF4FF; border-left: 4pt solid #1E3A8A; padding: 10pt; margin: 10pt 0; }
    .positive { color: #10B981; font-weight: bold; }
    .negative { color: #EF4444; font-weight: bold; }
  </style>
</head>
<body>
  <h1>АО «Россети Кубань» — Отчет по ВОЛС</h1>
  
  <div class="info-box">
    <p><strong>Отчетный период:</strong><br>
    Предыдущая неделя: ${prev.date}<br>
    Текущая неделя: ${curr.date}</p>
  </div>
  
  ${generateWordContent()}
</body>
</html>`;

    const blob = new Blob([htmlDoc], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `Отчет_ВОЛС_${curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML отчет сохранен. Откройте в Word.");
  }

  /* ==================== Экспорт презентации HTML ==================== */
  function exportPresHTML(){
    if(!DATA) return alert("Сначала проанализируйте отчёты.");
    
    const presHTML = generatePresentationHTML();
    const blob = new Blob([presHTML], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `Презентация_ВОЛС_${DATA.curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML презентация сохранена");
  }

  function generatePresentationHTML(){
    const {curr, prev, dyn} = DATA;
    
    // Получаем изображения графиков
    const imgS2 = document.getElementById("chartBranches").toDataURL("image/png");
    const imgS3 = document.getElementById("chartBranchesS3").toDataURL("image/png");
    const imgS4 = document.getElementById("chartBranchesS4").toDataURL("image/png");
    const imgRTK = document.getElementById("chartRTKDelta").toDataURL("image/png");
    
    return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Презентация ВОЛС - ${curr.date}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #0F172A;
      color: #F1F5F9;
      overflow-x: hidden;
    }
    
    .slide {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px;
      position: relative;
      background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                  #0F172A;
    }
    
    .slide-header {
      position: absolute;
      top: 40px;
      left: 60px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 20px;
      color: white;
    }
    
    .slide-number {
      position: absolute;
      bottom: 40px;
      right: 60px;
      font-size: 18px;
      color: #64748B;
    }
    
    h1 {
      font-size: 48px;
      font-weight: 800;
      text-align: center;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h2 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 30px;
      color: #F1F5F9;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      max-width: 1400px;
    }
    
    .chart-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .chart-container img {
      width: 100%;
      height: auto;
      border-radius: 12px;
    }
    
    .table-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: rgba(59, 130, 246, 0.2);
      color: #F1F5F9;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    th:not(:first-child) { text-align: right; }
    
    td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: #94A3B8;
    }
    
    td:not(:first-child) { text-align: right; }
    
    tr:hover { background: rgba(255, 255, 255, 0.03); }
    
    tfoot td {
      background: rgba(59, 130, 246, 0.1);
      font-weight: 700;
      color: #F1F5F9;
      border-top: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 30px;
      width: 100%;
      max-width: 1200px;
    }
    
    .kpi-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
    }
    
    .kpi-label {
      font-size: 14px;
      color: #94A3B8;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .kpi-value {
      font-size: 48px;
      font-weight: 800;
      margin: 10px 0;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .kpi-delta {
      font-size: 18px;
      font-weight: 600;
    }
    
    .positive { color: #10B981; }
    .negative { color: #EF4444; }
    
    @media print {
      .slide { page-break-after: always; }
    }
  </style>
</head>
<body>
  <!-- Слайд 1: Титульный -->
  <div class="slide">
    <div class="slide-header">
      <div class="logo">РК</div>
      <span style="font-size: 20px; font-weight: 600;">Россети Кубань</span>
    </div>
    <h1>Динамика ВОЛС<br>Аналитический отчет</h1>
    <p style="font-size: 24px; color: #94A3B8;">Период: ${prev.date} — ${curr.date}</p>
    <div class="slide-number">1</div>
  </div>
  
  <!-- Слайд 2: KPI -->
  <div class="slide">
    <h2>Ключевые показатели</h2>
    <div class="kpi-grid">
      ${generateKPICards()}
    </div>
    <div class="slide-number">2</div>
  </div>
  
  <!-- Слайд 3: Динамика по филиалам -->
  <div class="slide">
    <h2>Динамика по филиалам (всего)</h2>
    <div class="content-grid">
      <div class="chart-container">  /* ==================== Рендер на странице ==================== */
  let chartBranches, chartBranchesS3, chartBranchesS4, chartRTKDelta;

  function renderKpis(curr, prev, dyn){
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const items = [
      {title:"В работе всего", value:curr.p1.totals.in_work_total, delta:dyn.in_work_total, unit:"шт."},
      {title:"Выявлено за неделю", value:dyn.found_week, delta:dyn.found_week, unit:"шт."},
      {title:"Закрыто за неделю", value:eff, delta:eff, unit:"шт.", subtitle:"(узак. + демонт.)"},
      {title:"ПАО «Ростелеком»", value:curr.p1.totals.rtk_in_work, delta:dyn.rtk_in_work, unit:"шт.", subtitle:`доля ${rtkShare.toFixed(1)}%`},
    ];

    document.getElementById("kpis").innerHTML = items.map(it=>{
      const d = typeof it.delta==="number"?it.delta:0;
      const deltaClass = d>0?"positive":(d<0?"negative":"neutral");
      const sign=d>0?"+":"";
      const arrow = d>0?"↑":(d<0?"↓":"→");
      
      return `<div class="kpi-card">
        <div class="kpi-label">${it.title}</div>
        <div class="kpi-value">${fmt(it.value)} <span style="font-size:0.5em;font-weight:400;color:var(--text-secondary)">${it.unit}</span></div>
        ${it.subtitle ? `<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem">${it.subtitle}</div>` : ''}
        <div class="kpi-delta ${deltaClass}">
          <span>${arrow}</span>
          <span>${sign}${fmt(d)}</span>
        </div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(rows, tbodySel, sumPrevId, sumCurrId, sumDeltaId){
    const tbody = document.querySelector(tbodySel);
    tbody.innerHTML = "";
    let sP=0,sC=0,sD=0;
    const sorted = [...rows].sort((a,b)=>Math.abs((b.c-b.p)) - Math.abs((a.c-a.p)));
    for(const r0 of sorted){
      const p = Number(r0.p)||0, c = Number(r0.c)||0;
      const d = c - p;
      const cls = d>0?"value-positive":(d<0?"value-negative":"");
      sP+=p; sC+=c; sD+=d;
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r0.b}</td>
          <td>${fmt(p)}</td>
          <td>${fmt(c)}</td>
          <td class="${cls}">${d>0?"+":""}${fmt(d)}</td>
        </tr>`);
    }
    document.getElementById(sumPrevId).textContent = fmt(sP);
    document.getElementById(sumCurrId).textContent = fmt(sC);
    document.getElementById(sumDeltaId).textContent = (sD>0?"+":"")+fmt(sD);
    document.getElementById(sumDeltaId).className = sD>0?"value-positive":(sD<0?"value-negative":"");
  }

  function chartOpts(){
    Chart.defaults.color = '#94A3B8';
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
    
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:"top",
          labels:{
            boxWidth:12,
            usePointStyle:true,
            padding:20,
            font:{size:12}
          }
        },
        tooltip:{
          backgroundColor: 'rgba(30, 41, 59, 0.9)',
          titleColor: '#F1F5F9',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          boxWidth: 12,
          boxHeight: 12,
          usePointStyle: true
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid:{
            color:'rgba(255, 255, 255, 0.05)',
            drawBorder:false
          },
          ticks:{
            precision:0,
            padding:10
          }
        },
        x:{
          grid:{
            display:false,
            drawBorder:false
          },
          ticks:{
            padding:10
          }
        }
      },
    };
  }

  function renderCharts(curr, prev, dyn){
    const labels = BRANCHES;
    const prevS2 = labels.map(b=>prev.p2.branches.get(b)?.total||0);
    const currS2 = labels.map(b=>curr.p2.branches.get(b)?.total||0);

    if(chartBranches) chartBranches.destroy();
    chartBranches = new Chart(document.getElementById("chartBranches"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS2, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS2, backgroundColor:"rgba(59, 130, 246, 0.5)", borderColor:"rgba(59, 130, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS3 = labels.map(b=>prev.p3.branches.get(b)?.total||0);
    const currS3 = labels.map(b=>curr.p3.branches.get(b)?.total||0);
    if(chartBranchesS3) chartBranchesS3.destroy();
    chartBranchesS3 = new Chart(document.getElementById("chartBranchesS3"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS3, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS3, backgroundColor:"rgba(139, 92, 246, 0.5)", borderColor:"rgba(139, 92, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS4 = labels.map(b=>prev.p4.branches.get(b)?.total||0);
    const currS4 = labels.map(b=>curr.p4.branches.get(b)?.total||0);
    if(chartBranchesS4) chartBranchesS4.destroy();
    chartBranchesS4 = new Chart(document.getElementById("chartBranchesS4"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS4, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS4, backgroundColor:"rgba(6, 182, 212, 0.5)", borderColor:"rgba(6, 182, 212, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const rtkD = labels.map(b => (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).c - (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).p);
    if(chartRTKDelta) chartRTKDelta.destroy();
    chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
      type:"bar",
      data:{labels, datasets:[{
        label:"Изменение (тек. − пред.)", 
        data:rtkD, 
        backgroundColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.5)":"rgba(239, 68, 68, 0.5)"),
        borderColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.8)":"rgba(239, 68, 68, 0.8)"),
        borderWidth: 1<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ВОЛС Аналитика | Россети Кубань</title>

  <!-- Шрифты -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== Глобальные переменные и токены дизайна ====== */
    :root{
      /* Основные цвета бренда */
      --primary: #1E3A8A;
      --primary-light: #3B82F6;
      --primary-dark: #1E293B;
      --accent: #06B6D4;
      --accent-glow: rgba(6, 182, 212, 0.3);
      
      /* Фоны и поверхности */
      --bg-main: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(59, 130, 246, 0.1);
      
      /* Стекломорфизм */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* Текст */
      --text-primary: #F1F5F9;
      --text-secondary: #94A3B8;
      --text-muted: #64748B;
      
      /* Статусы */
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      
      /* Эффекты */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.7);
      --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.3);
      
      /* Скругления */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* Анимации */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== Базовые стили ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* Фоновый градиент */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* ====== Шапка ====== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      transition: var(--transition);
    }

    header.scrolled {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      letter-spacing: -0.02em;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* ====== Главный контент ====== */
    main {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* ====== Сетка ====== */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .cols-4 { grid-template-columns: repeat(2, 1fr); }
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .cols-2, .cols-3, .cols-4 { grid-template-columns: 1fr; }
    }

    /* ====== Карточки ====== */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* ====== KPI карточки ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-delta {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .kpi-delta.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .kpi-delta.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .kpi-delta.neutral {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* ====== Кнопки ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px dashed var(--glass-border);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
      background: var(--glass);
    }

    /* ====== Формы ====== */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--glass);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-wrapper:hover {
      border-color: var(--primary-light);
      background: var(--bg-hover);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    /* ====== Таблицы ====== */
    .table-container {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-scroll {
      max-height: 400px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--glass-border) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 2px solid var(--glass-border);
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    tfoot td {
      background: var(--bg-secondary);
      font-weight: 700;
      color: var(--text-primary);
      padding: 1rem;
      border-top: 2px solid var(--glass-border);
    }

    /* ====== Графики ====== */
    .chart-container {
      height: 400px;
      padding: 1rem;
      background: var(--glass);
      border-radius: var(--radius-md);
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== Статусы и значки ====== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--success);
      font-weight: 600;
    }

    .value-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* ====== Анимация загрузки ====== */
    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== Сообщения ====== */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .message-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .message-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    /* ====== Секция экспорта ====== */
    .export-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    /* ====== Адаптивность ====== */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }

      .brand {
        font-size: 1rem;
      }

      .logo {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }

      main {
        margin-top: 70px;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 2rem;
      }

      .table-scroll {
        max-height: 300px;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
    }

    /* ====== Утилиты ====== */
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    /* ====== Печать ====== */
    @media print {
      body {
        background: white;
        color: black;
      }

      header {
        position: relative;
        background: white;
        border-bottom: 2px solid #000;
      }

      .card {
        background: white;
        border: 1px solid #ccc;
        box-shadow: none;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }

      .btn, .file-input-wrapper {
        display: none;
      }
    }

    /* ====== Компактный режим ====== */
    .compact .card {
      padding: 1rem;
    }

    .compact .kpi-card {
      padding: 0.75rem;
    }

    .compact .kpi-value {
      font-size: 1.75rem;
    }

    .compact table {
      font-size: 0.75rem;
    }

    .compact th, .compact td {
      padding: 0.5rem;
    }

    .compact .chart-container {
      height: 300px;
    }

    /* ====== Скрытые элементы для печати ====== */
    #presentationPrint, #summaryPrint {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Шапка -->
  <header id="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">РК</div>
        <span>ВОЛС Аналитика</span>
      </div>
      <div class="nav-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>Система активна</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Основной контент -->
  <main>
    <div class="container">
      <!-- Секция загрузки и экспорта -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">📊</div>
              Загрузка отчётов
            </h2>
          </div>
          <div class="form-group">
            <label class="file-input-wrapper">
              <div class="file-icon">📄</div>
              <span>Предыдущая неделя (PDF)</span>
              <input id="filePrev" type="file" accept="application/pdf">
            </label>
            <label class="file-input-wrapper">
              <div class="file-icon">📄</div>
              <span>Текущая неделя (PDF)</span>
              <input id="fileCurr" type="file" accept="application/pdf">
            </label>
          </div>
          <div class="form-group">
            <button id="btnParse" class="btn btn-primary">
              <span>🚀</span>
              Проанализировать
            </button>
            <button id="btnCompact" class="btn btn-ghost" title="Компактный режим">
              <span>📐</span>
              Компактный вид
            </button>
          </div>
          <div id="dates" class="message message-info" style="display:none"></div>
          <div id="loadingMsg" class="loading" style="display:none">
            <div class="loading-spinner"></div>
            <span>Обработка PDF файлов...</span>
          </div>
          <div id="errorMsg" class="message message-error" style="display:none"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">💾</div>
              Экспорт отчётов
            </h2>
          </div>
          <div class="export-section">
            <button class="btn btn-secondary" id="exportPresPDF">
              <span>📑</span>
              Презентация PDF
            </button>
            <button class="btn btn-secondary" id="exportBriefPDF">
              <span>📋</span>
              Выжимка PDF
            </button>
            <button class="btn btn-secondary" id="exportWordHTML">
              <span>📝</span>
              Отчет Word
            </button>
            <button class="btn btn-secondary" id="exportPresHTML">
              <span>🌐</span>
              Презентация HTML
            </button>
          </div>
          <div id="exportStatus" class="message message-success mt-1" style="display:none"></div>
        </div>
      </div>

      <!-- KPI секция -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">📈</div>
            Ключевые показатели
          </h2>
        </div>
        <div id="kpis" class="kpi-grid"></div>
      </div>

      <!-- Графики и таблицы стр. 2 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Динамика по филиалам</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranches"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranches">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrev">0</td>
                    <td id="sumCurr">0</td>
                    <td id="sumDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Графики и таблицы стр. 3 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Приказ №425</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS3"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 3</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS3">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrevS3">0</td>
                    <td id="sumCurrS3">0</td>
                    <td id="sumDeltaS3">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Графики и таблицы стр. 4 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ПАО «Ростелеком»</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS4"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 4</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS4">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrevS4">0</td>
                    <td id="sumCurrS4">0</td>
                    <td id="sumDeltaS4">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- График изменений РТК -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">📊</div>
            Динамика изменений ПАО «Ростелеком»
          </h2>
        </div>
        <div class="chart-container">
          <canvas id="chartRTKDelta"></canvas>
        </div>
      </div>

      <!-- Стадии -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Стадии работ</h2>
            <span class="badge">Стр. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS2">
                <thead>
                  <tr>
                    <th>Стадия</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Стадии работ</h2>
            <span class="badge">Стр. 4 (РТК)</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS4">
                <thead>
                  <tr>
                    <th>Стадия</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Области для печати (скрытые) -->
  <div id="presentationPrint" style="display:none"></div>
  <div id="summaryPrint" style="display:none"></div>

  <!-- Библиотеки -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
  /* ==================== Константы и утилиты ==================== */
  const BRANCHES = [
    "Сочинские ЭС","Тимашевские ЭС","Тихорецкие ЭС","Усть-Лабинские ЭС","Юго-Западные ЭС",
    "Адыгейские ЭС","Армавирские ЭС","Краснодарские ЭС","Лабинские ЭС","Ленинградские ЭС","Славянские ЭС"
  ];
  const BRANCH_PATTERNS = [
    {name:"Сочинские ЭС", re:/Сочинские\s+ЭС/i},
    {name:"Тимашевские ЭС", re:/Тимашевские\s+ЭС/i},
    {name:"Тихорецкие ЭС", re:/Тихорецкие\s+ЭС/i},
    {name:"Усть-Лабинские ЭС", re:/Усть[\s\u00A0\u202F\-–—-]*Лабинские\s+ЭС/i},
    {name:"Юго-Западные ЭС", re:/Юго[\s\u00A0\u202F\-–—-]*Западные\s+ЭС/i},
    {name:"Адыгейские ЭС", re:/Адыгейские\s+ЭС/i},
    {name:"Армавирские ЭС", re:/Армавирские\s+ЭС/i},
    {name:"Краснодарские ЭС", re:/Краснодарские\s+ЭС/i},
    {name:"Лабинские ЭС", re:/Лабинские\s+ЭС/i},
    {name:"Ленинградские ЭС", re:/Ленинградские\s+ЭС/i},
    {name:"Славянские ЭС", re:/Славянские\s+ЭС/i},
  ];

  /* Стадии */
  const STATUS_PATTERNS = [
    {key:"work", title:"В работе у филиала", re:/В\s*работе\s*у\s*филиала/i},
    {key:"dismantled", title:"Демонтировано", re:/Демонтировано/i},
    {key:"rc_digit", title:"Договор на оформлении Россети Цифра", re:/Договор\s*на\s*оформлении\s*Россети\s*Цифра/i},
    {key:"op_sign", title:"Договор на подписании у оператора", re:/Договор\s*на\s*подписании\s*у\s*оператора/i},
    {key:"filial_appr",title:"Договор на согласовании в филиале", re:/Договор\s*на\s*согласовании\s*в\s*филиале/i},
    {key:"incl_next", title:"Будет включено в следующее доп. соглашение после подписания",
      re:/Будет\s*включено(?:[\s\S]{0,80})в(?:\s*следующее)?(?:[\s\S]{0,80})доп\.?\s*соглашение(?:[\s\S]{0,80}после\s*подписания)?/i
    },
  ];
  const STATUS_KEYS = STATUS_PATTERNS.map(s => s.key);
  const STAGE_TITLE = k => (STATUS_PATTERNS.find(s => s.key===k)||{}).title||k;

  const SHORT_STAGE_TITLES = {
    "work": "В работе",
    "dismantled": "Демонт.",
    "rc_digit": "Оформл. РЦ",
    "op_sign": "Подпись опер.",
    "filial_appr": "Согл. филиал",
    "incl_next": "В след. доп.согл."
  };
  const SHORT_STAGE_TITLE = k => SHORT_STAGE_TITLES[k] || STAGE_TITLE(k);

  const numberize = s => {
    const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
    const n = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
    if(!n) return 0;
    const val = Number(n.replace(",", "."));
    return isNaN(val) ? 0 : val;
  };
  const fmt = n => (typeof n === "number" ? n : Number(n||0)).toLocaleString("ru-RU");
  const normalize = txt => String(txt||"")
      .replace(/\u00A0|\u202F/g," ")
      .replace(/\u00AD/g,"")
      .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
      .replace(/[ \t]+/g," ")
      .trim();

  /* ==================== Чтение PDF ==================== */
  async function pdfToPages(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      let pageText = "", lastY = null;
      content.items.forEach(item => {
        const y = item.transform[5];
        if(lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
        pageText += item.str;
        lastY = y;
      });
      pages.push(normalize(pageText));
    }
    return pages;
  }

  /* ==================== Парсинг ==================== */
  function extractDateFromPages(pages){
    for(const pg of pages){
      const m = pg.match(/по состоянию на\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
    return "—";
  }

  function parseTotalsFromPage(page1){
    const find = (re) => {
      const m = page1.match(re);
      return m ? numberize(m[1]) : 0;
    };
    return {
      found_year: find(/выявлено[^0-9]*?(\d[\d\s]+)\s*шт/i),
      legalized: find(/Узаконено[^0-9]*?(\d[\d\s]+)/i),
      dismantled_ytd: find(/За\s*20\d{2}\s*год\s*демонтировано[^0-9]*?(\d[\d\s]+)/i),
      in_work_total: find(/В\s*работе[^0-9]*?всего[^0-9]*?(\d[\d\s]+)\s*шт/i),
      rtk_in_work: find(/в\s*том\s*числе\s*ПАО\s*«?Ростелеком»?[^0-9]*?(\d[\d\s]+)/i),
    };
  }

  function parseBranchTable(pageText){
    const text = normalize(pageText);
    const lines = text.split("\n").filter(Boolean);

    const idx = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      for(const bp of BRANCH_PATTERNS){
        if(bp.re.test(line)){ idx.push({i, name: bp.name}); break; }
      }
    }
    idx.push({i: lines.length, name:null});

    const branches = new Map();
    for(let k=0;k<idx.length-1;k++){
      const start = idx[k].i, end = idx[k+1].i, branchName = idx[k].name;
      if(!branchName) continue;
      const headLine = lines[start] || "";
      const segText = lines.slice(start+1, end).join(" ");

      let total = 0;
      const headNums = headLine.match(/\d[\d\s]*/g);
      if(headNums && headNums.length) total = numberize(headNums[headNums.length-1]);
      if(total===0 && lines[start+1]){
        const n2 = (lines[start+1]||"").match(/\d[\d\s]*/g);
        if(n2 && n2.length) total = numberize(n2[n2.length-1]);
      }

      const data = { total, statuses:{} };

      function numAfter(re, hay){
        const rx = new RegExp(re.source + "[^\\d]{0,200}(\\d[\\d\\s]*)", re.flags);
        const m = hay.match(rx);
        return m ? numberize(m[1]) : null;
      }

      for(const sp of STATUS_PATTERNS){
        let v = numAfter(sp.re, segText);
        if(v === null){
          for(let j=start+1;j<end;j++){
            const l0 = lines[j]||"", l1 = lines[j+1]||"";
            if(sp.re.test(l0) || sp.re.test(l1)){
              let cap = (l0.match(/(\d[\d\s]*)/g)||[]).pop();
              if(!cap) cap = (l1.match(/(\d[\d\s]*)/g)||[]).pop();
              if(cap){ v = numberize(cap); break; }
            }
          }
        }
        if(v !== null) data.statuses[sp.key] = v;
      }
      branches.set(branchName, data);
    }

    for(const b of BRANCHES){
      if(!branches.has(b)) branches.set(b, { total:0, statuses:{} });
    }

    const stages = {};
    for(const [_, obj] of branches){
      for(const [k,v] of Object.entries(obj.statuses)){
        stages[k] = (stages[k]||0) + (v||0);
      }
    }

    const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);
    return { branches, overall, stages };
  }

  function parseReportByPages(pages){
    return {
      date: extractDateFromPages(pages),
      p1: { totals: parseTotalsFromPage(pages[0] || "") },
      p2: parseBranchTable(pages[1] || ""),
      p3: parseBranchTable(pages[2] || ""),
      p4: parseBranchTable(pages[3] || ""),
    };
  }

  /* ==================== Динамика ==================== */
  function computeDynamics(curr, prev){
    const dyn = {
      in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
      rtk_in_work: (curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work) || 0,
      legalized: (curr.p1.totals.legalized - prev.p1.totals.legalized) || 0,
      dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
    };
    dyn.found_week = dyn.in_work_total;

    const makeRows = (cPage, pPage) => BRANCHES.map(b=>{
      const c = cPage.branches.get(b)?.total || 0;
      const p = pPage.branches.get(b)?.total || 0;
      return {b, p, c, d: (c - p)};
    });

    const branchRows = makeRows(curr.p2, prev.p2);
    const branchRowsS3 = makeRows(curr.p3, prev.p3);
    const branchRowsS4 = makeRows(curr.p4, prev.p4);

    const allKeys = Array.from(new Set([
      ...Object.keys(prev.p2.stages||{}), ...Object.keys(curr.p2.stages||{}),
      ...Object.keys(prev.p3.stages||{}), ...Object.keys(curr.p3.stages||{}),
      ...Object.keys(prev.p4.stages||{}), ...Object.keys(curr.p4.stages||{}),
      ...STATUS_KEYS
    ]));

    const diffStages = (cur, prv) => allKeys.map(k=>({
      stage: STAGE_TITLE(k), short: SHORT_STAGE_TITLE(k), key: k,
      p: prv[k] || 0, c: cur[k] || 0, d: (cur[k]||0) - (prv[k]||0)
    }));

    const stagesS2 = diffStages(curr.p2.stages||{}, prev.p2.stages||{});
    const stagesS4 = diffStages(curr.p4.stages||{}, prev.p4.stages||{});

    function perBranchStages(cPage, pPage){
      return BRANCHES.map(b=>{
        const cst = cPage.branches.get(b)?.statuses || {};
        const pst = pPage.branches.get(b)?.statuses || {};
        const by = {};
        STATUS_KEYS.forEach(k=>{
          const p = pst[k]||0, c = cst[k]||0;
          by[k] = {p,c,d:c-p};
        });
        return {b, by};
      });
    }
    const s2BranchStages = perBranchStages(curr.p2, prev.p2);

    return {
      ...dyn,
      branchRows,
      branchRowsS3,
      branchRowsS4,
      stagesS2,
      stagesS4,
      s2BranchStages,
      rtkRows: branchRowsS4
    };
  }pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
<div class="chart-container">
        <img src="${imgS2}" alt="График динамики">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRows, ["sumPrev", "sumCurr", "sumDelta"])}
      </div>
    </div>
    <div class="slide-number">3</div>
  </div>
  
  <!-- Слайд 4: Приказ №425 -->
  <div class="slide">
    <h2>Динамика по Приказу №425</h2>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${imgS3}" alt="График Приказ 425">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"])}
      </div>
    </div>
    <div class="slide-number">4</div>
  </div>
  
  <!-- Слайд 5: ПАО Ростелеком -->
  <div class="slide">
    <h2>Динамика по ПАО «Ростелеком»</h2>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${imgS4}" alt="График Ростелеком">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"])}
      </div>
    </div>
    <div class="slide-number">5</div>
  </div>
  
  <!-- Слайд 6: Изменения РТК -->
  <div class="slide">
    <h2>Изменения по ПАО «Ростелеком» по филиалам</h2>
    <div class="chart-container" style="max-width: 1200px; width: 100%;">
      <img src="${imgRTK}" alt="График изменений РТК">
    </div>
    <div class="slide-number">6</div>
  </div>
</body>
</html>`;
  }

  function generateKPICards(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    const kpis = [
      {label: "В работе всего", value: curr.p1.totals.in_work_total, delta: dyn.in_work_total},
      {label: "Выявлено за неделю", value: dyn.found_week, delta: dyn.found_week},
      {label: "Закрыто за неделю", value: eff, delta: eff},
      {label: "ПАО Ростелеком", value: curr.p1.totals.rtk_in_work, delta: dyn.rtk_in_work, extra: `${rtkShare.toFixed(1)}%`}
    ];
    
    return kpis.map(kpi => `
      <div class="kpi-card">
        <div class="kpi-label">${kpi.label}</div>
        <div class="kpi-value">${fmt(kpi.value)}</div>
        <div class="kpi-delta ${kpi.delta >= 0 ? 'positive' : 'negative'}">
          ${kpi.delta > 0 ? '+' : ''}${fmt(kpi.delta)}
          ${kpi.extra ? ` (${kpi.extra})` : ''}
        </div>
      </div>
    `).join('');
  }

  function generateSlideTable(rows, sumIds){
    const sorted = [...rows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d));
    return `
      <table>
        <thead>
          <tr>
            <th>Филиал</th>
            <th>Предыдущая</th>
            <th>Текущая</th>
            <th>Изменение</th>
          </tr>
        </thead>
        <tbody>
          ${sorted.map(r => `
            <tr>
              <td>${r.b}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d > 0 ? 'positive' : r.d < 0 ? 'negative' : ''}">
                ${r.d > 0 ? '+' : ''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr>
            <td>Итого</td>
            <td>${document.getElementById(sumIds[0]).textContent}</td>
            <td>${document.getElementById(sumIds[1]).textContent}</td>
            <td>${document.getElementById(sumIds[2]).textContent}</td>
          </tr>
        </tfoot>
      </table>
    `;
  }

  function generateWordContent(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    return `
      <h2>Основные показатели</h2>
      <ul>
        <li>В работе всего: <strong>${fmt(curr.p1.totals.in_work_total)}</strong> 
            <span class="${dyn.in_work_total>=0?'positive':'negative'}">
              (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})
            </span>
        </li>
        <li>Выявлено за неделю: <strong>${fmt(dyn.found_week)}</strong></li>
        <li>Закрыто за неделю (узаконено + демонтировано): <strong>${fmt(eff)}</strong></li>
        <li>ПАО «Ростелеком» в работе: <strong>${fmt(curr.p1.totals.rtk_in_work)}</strong> 
            <span class="${dyn.rtk_in_work>=0?'positive':'negative'}">
              (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})
            </span>; 
            доля <strong>${rtkShare.toFixed(1)}%</strong>
        </li>
      </ul>
      
      <h2>Динамика по филиалам</h2>
      
      <h3>Общая динамика (все операторы)</h3>
      ${generateWordTable(dyn.branchRows, ["sumPrev", "sumCurr", "sumDelta"])}
      
      <h3>Приказ №425</h3>
      ${generateWordTable(dyn.branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"])}
      
      <h3>ПАО «Ростелеком»</h3>
      ${generateWordTable(dyn.branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"])}
      
      <h2>Динамика по статусам</h2>
      ${generateWordStagesTable(dyn.stagesS2)}
      
      <div class="info-box">
        <p><strong>Примечание:</strong> Отчет сформирован автоматически на основе загруженных PDF-файлов.<br>
        Дата формирования: ${new Date().toLocaleDateString('ru-RU')}</p>
      </div>
    `;
  }

  function generateWordTable(rows, sumIds){
    const sorted = [...rows].sort((a,b) => b.b.localeCompare(a.b, 'ru'));
    return `
      <table>
        <thead>
          <tr>
            <th>Филиал</th>
            <th>Предыдущая</th>
            <th>Текущая</th>
            <th>Изменение</th>
          </tr>
        </thead>
        <tbody>
          ${sorted.map(r => `
            <tr>
              <td>${r.b}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d>0?'positive':r.d<0?'negative':''}">
                ${r.d>0?'+':''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr style="font-weight:bold;background:#f0f0f0">
            <td>ИТОГО</td>
            <td>${document.getElementById(sumIds[0]).textContent}</td>
            <td>${document.getElementById(sumIds[1]).textContent}</td>
            <td>${document.getElementById(sumIds[2]).textContent}</td>
          </tr>
        </tfoot>
      </table>
    `;
  }

  function generateWordStagesTable(stages){
    return `
      <table>
        <thead>
          <tr>
            <th>Статус</th>
            <th>Пред.</th>
            <th>Тек.</th>
            <th>Δ</th>
          </tr>
        </thead>
        <tbody>
          ${stages.map(r => `
            <tr>
              <td>${r.stage}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d>0?'positive':r.d<0?'negative':''}">
                ${r.d>0?'+':''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  /* ==================== Вспомогательные функции ==================== */
  function triggerDownload(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = filename; 
    document.body.appendChild(a); 
    a.click();
    setTimeout(()=>{ 
      URL.revokeObjectURL(url); 
      a.remove(); 
    }, 0);
  }

  function showExportMessage(text){
    const el = document.getElementById("exportStatus");
    el.textContent = text;
    el.style.display = "flex";
    setTimeout(() => { el.style.display = "none"; }, 3000);
  }

  function showLoadingMessage(text){
    const el = document.getElementById("loadingMsg");
    if(text){
      el.style.display = "flex";
      el.querySelector("span").textContent = text;
    } else {
      el.style.display = "none";
    }
  }

  function showErrorMessage(text){
    const el = document.getElementById("errorMsg");
    if(text){
      el.textContent = text;
      el.style.display = "flex";
    } else {
      el.style.display = "none";
    }
  }

  function showDates(prev, curr){
    const el = document.getElementById("dates");
    el.innerHTML = `<strong>Период анализа:</strong> ${prev} — ${curr}`;
    el.style.display = "flex";
  }

  /* ==================== План-Факт из Google Sheets ==================== */
  const SHEET_HTML_URL = "https://docs.google.com/spreadsheets/d/1Y9bM7zLRf_gonMUgfQLl57Iu3NgPa78rBXnpxkKLvO0/gviz/tq?tqx=out:html";
  
  async function injectPlanFactHTML(){
    try{
      const res = await fetch(SHEET_HTML_URL, {cache:"no-store", mode:"cors"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const html = await res.text();
      
      // Стилизуем таблицу под наш дизайн
      const styledHTML = stylePlanFactTable(html);
      
      if(document.getElementById("presPlanFactInner")){
        document.getElementById("presPlanFactInner").innerHTML = styledHTML;
      }
      if(document.getElementById("briefPlanFactInner")){
        document.getElementById("briefPlanFactInner").innerHTML = styledHTML;
      }
    }catch(e){
      console.warn("Не удалось загрузить План-Факт:", e);
    }
  }

  function stylePlanFactTable(html){
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    const table = tmp.querySelector("table");
    
    if(!table) return '<div class="message message-error">Не удалось загрузить План-Факт</div>';
    
    // Применяем стили
    table.style.cssText = `
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    `;
    
    // Стилизуем заголовки
    table.querySelectorAll("th").forEach(th => {
      th.style.cssText = `
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 12px;
        font-weight: 600;
        border-bottom: 2px solid var(--glass-border);
      `;
    });
    
    // Стилизуем ячейки
    table.querySelectorAll("td").forEach(td => {
      td.style.cssText = `
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
      `;
    });
    
    return `
      <div class="table-container">
        <div class="table-scroll">
          ${table.outerHTML}
        </div>
      </div>
    `;
  }

  /* ==================== Инициализация ==================== */
  let DATA = null;

  // Эффект прокрутки для шапки
  window.addEventListener('scroll', () => {
    const header = document.getElementById('header');
    if (window.scrollY > 50) {
      header.classList.add('scrolled');
    } else {
      header.classList.remove('scrolled');
    }
  });

  // Обработчик анализа файлов
  document.getElementById("btnParse").addEventListener("click", async () => {
    const fPrev = document.getElementById("filePrev").files[0];
    const fCurr = document.getElementById("fileCurr").files[0];
    
    if(!fPrev || !fCurr){ 
      showErrorMessage("Загрузите оба PDF файла: предыдущий и текущий отчеты"); 
      return; 
    }

    try{
      showLoadingMessage("Обработка PDF файлов...");
      showErrorMessage("");

      const [pPrev, pCurr] = await Promise.all([pdfToPages(fPrev), pdfToPages(fCurr)]);
      
      showLoadingMessage("Анализ данных...");
      
      const prev = parseReportByPages(pPrev);
      const curr = parseReportByPages(pCurr);
      const dyn = computeDynamics(curr, prev);
      DATA = {prev, curr, dyn};

      showDates(prev.date, curr.date);
      renderKpis(curr, prev, dyn);
      renderBranchesTable(dyn.branchRows, "#tblBranches tbody", "sumPrev", "sumCurr", "sumDelta");
      renderBranchesTable(dyn.branchRowsS3, "#tblBranchesS3 tbody", "sumPrevS3", "sumCurrS3", "sumDeltaS3");
      renderBranchesTable(dyn.branchRowsS4, "#tblBranchesS4 tbody", "sumPrevS4", "sumCurrS4", "sumDeltaS4");
      renderCharts(curr, prev, dyn);
      renderStagesTables(dyn);
      
      await injectPlanFactHTML();

      showLoadingMessage("");
      showExportMessage("Анализ успешно завершен!");
      
    }catch(e){
      console.error(e);
      showLoadingMessage("");
      showErrorMessage("Ошибка при обработке PDF. Убедитесь, что файлы имеют правильный формат.");
    }
  });

  // Обработчики экспорта
  document.getElementById("exportPresPDF").addEventListener("click", async () => {
    if(!DATA) return showErrorMessage("Сначала проанализируйте отчеты");
    await exportPresPDF();
  });

  document.getElementById("exportBriefPDF").addEventListener("click", async () => {
    if(!DATA) return showErrorMessage("Сначала проанализируйте отчеты");
    await exportBriefPDF();
  });

  document.getElementById("exportWordHTML").addEventListener("click", () => {
    if(!DATA) return showErrorMessage("Сначала проанализируйте отчеты");
    exportWordHTML();
  });

  document.getElementById("exportPresHTML").addEventListener("click", () => {
    if(!DATA) return showErrorMessage("Сначала проанализируйте отчеты");
    exportPresHTML();
  });

  // Компактный режим
  document.getElementById("btnCompact").addEventListener("click", ()=>{
    document.body.classList.toggle("compact");
    const btn = document.getElementById("btnCompact");
    if(document.body.classList.contains("compact")){
      btn.innerHTML = '<span>📐</span> Обычный вид';
    } else {
      btn.innerHTML = '<span>📐</span> Компактный вид';
    }
  });

  </script>
</body>
</html>
      html2canvas: {scale: 2, useCORS: true},
      jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'}
    }).save();
    el.style.display = "none";
    showExportMessage("PDF выжимки сохранен");
  }

  /* ==================== Вспомогательные функции для экспорта ==================== */
  function buildPresentationTables(){
    const {branchRows, branchRowsS3, branchRowsS4} = DATA.dyn;
    
    const makeTable = (title, icon, rows, sumIds) => {
      const sorted = [...rows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d));
      return `
        <div class="table-section">
          <div class="section-title">
            <div class="section-icon">${icon}</div>
            ${title}
          </div>
          <table>
            <thead>
              <tr>
                <th>Филиал</th>
                <th>Предыдущая</th>
                <th>Текущая</th>
                <th>Изменение</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map(r => `
                <tr>
                  <td>${r.b}</td>
                  <td>${fmt(r.p)}</td>
                  <td>${fmt(r.c)}</td>
                  <td class="${r.d > 0 ? 'delta-positive' : r.d < 0 ? 'delta-negative' : ''}">
                    ${r.d > 0 ? '+' : ''}${fmt(r.d)}
                  </td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr>
                <td>Итого</td>
                <td>${document.getElementById(sumIds[0]).textContent}</td>
                <td>${document.getElementById(sumIds[1]).textContent}</td>
                <td>${document.getElementById(sumIds[2]).textContent}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    };
    
    return makeTable("Динамика по филиалам (всего)", "📊", branchRows, ["sumPrev", "sumCurr", "sumDelta"]) +
           makeTable("Динамика по Приказу №425", "📋", branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"]) +
           makeTable("Динамика по ПАО «Ростелеком»", "🌐", branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"]);
  }

  function buildSummaryContent(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    
    const topChanges = [...dyn.branchRows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d)).slice(0, 3);
    
    return `
      <div class="brief-block">
        <div class="brief-title">Основные показатели</div>
        <div class="brief-content">
          <div class="brief-item">• В работе всего: <span class="brief-value">${fmt(curr.p1.totals.in_work_total)}</span> (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})</div>
          <div class="brief-item">• Выявлено за неделю: <span class="brief-value">${fmt(dyn.found_week)}</span></div>
          <div class="brief-item">• Закрыто за неделю: <span class="brief-value">${fmt(eff)}</span></div>
          <div class="brief-item">• ПАО «Ростелеком»: <span class="brief-value">${fmt(curr.p1.totals.rtk_in_work)}</span> (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</div>
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">Топ-3 филиала по изменениям</div>
        <div class="brief-content">
          ${topChanges.map((r, i) => `
            <div class="brief-item">${i+1}. <span class="brief-value">${r.b}</span>: ${fmt(r.p)} → ${fmt(r.c)} (${r.d>0?'+':''}${fmt(r.d)})</div>
          `).join('')}
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">Итоги по категориям</div>
        <div class="brief-content">
          <div class="brief-item">• Всего опор: ${document.getElementById("sumPrev").textContent} → <span class="brief-value">${document.getElementById("sumCurr").textContent}</span> (${document.getElementById("sumDelta").textContent})</div>
          <div class="brief-item">• Приказ №425: ${document.getElementById("sumPrevS3").textContent} → <span class="brief-value">${document.getElementById("sumCurrS3").textContent}</span> (${document.getElementById("sumDeltaS3").textContent})</div>
          <div class="brief-item">• ПАО Ростелеком: ${document.getElementById("sumPrevS4").textContent} → <span class="brief-value">${document.getElementById("sumCurrS4").textContent}</span> (${document.getElementById("sumDeltaS4").textContent})</div>
        </div>
      </div>
    `;
  }

  /* ==================== Экспорт Word HTML ==================== */
  function exportWordHTML(){
    if(!DATA) return alert("Сначала проанализируйте отчёты.");
    const {curr, prev, dyn} = DATA;
    
    const htmlDoc = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Отчет ВОЛС - ${curr.date}</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body { font-family: 'Calibri', Arial, sans-serif; line-height: 1.6; color: #333; }
    h1 { color: #1E3A8A; font-size: 24pt; border-bottom: 3pt solid #1E3A8A; padding-bottom: 10pt; }
    h2 { color: #1E3A8A; font-size: 18pt; margin-top: 20pt; }
    h3 { color: #333; font-size: 14pt; margin-top: 15pt; }
    table { width: 100%; border-collapse: collapse; margin: 15pt 0; }
    th, td { border: 1pt solid #ddd; padding: 8pt; text-align: center; }
    th { background-color: #1E3A8A; color: white; font-weight: bold; }
    th:first-child, td:first-child { text-align: left; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .info-box { background: #EBF4FF; border-left: 4pt solid #1E3A8A; padding: 10pt; margin: 10pt 0; }
    .positive { color: #10B981; font-weight: bold; }
    .negative { color: #EF4444; font-weight: bold; }
  </style>
</head>
<body>
  <h1>АО «Россети Кубань» — Отчет по ВОЛС</h1>
  
  <div class="info-box">
    <p><strong>Отчетный период:</strong><br>
    Предыдущая неделя: ${prev.date}<br>
    Текущая неделя: ${curr.date}</p>
  </div>
  
  ${generateWordContent()}
</body>
</html>`;

    const blob = new Blob([htmlDoc], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `Отчет_ВОЛС_${curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML отчет сохранен. Откройте в Word.");
  }

  /* ==================== Экспорт презентации HTML ==================== */
  function exportPresHTML(){
    if(!DATA) return alert("Сначала проанализируйте отчёты.");
    
    const presHTML = generatePresentationHTML();
    const blob = new Blob([presHTML], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `Презентация_ВОЛС_${DATA.curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML презентация сохранена");
  }

  function generatePresentationHTML(){
    const {curr, prev, dyn} = DATA;
    
    // Получаем изображения графиков
    const imgS2 = document.getElementById("chartBranches").toDataURL("image/png");
    const imgS3 = document.getElementById("chartBranchesS3").toDataURL("image/png");
    const imgS4 = document.getElementById("chartBranchesS4").toDataURL("image/png");
    const imgRTK = document.getElementById("chartRTKDelta").toDataURL("image/png");
    
    return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Презентация ВОЛС - ${curr.date}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #0F172A;
      color: #F1F5F9;
      overflow-x: hidden;
    }
    
    .slide {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px;
      position: relative;
      background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                  #0F172A;
    }
    
    .slide-header {
      position: absolute;
      top: 40px;
      left: 60px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 20px;
      color: white;
    }
    
    .slide-number {
      position: absolute;
      bottom: 40px;
      right: 60px;
      font-size: 18px;
      color: #64748B;
    }
    
    h1 {
      font-size: 48px;
      font-weight: 800;
      text-align: center;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h2 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 30px;
      color: #F1F5F9;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      max-width: 1400px;
    }
    
    .chart-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .chart-container img {
      width: 100%;
      height: auto;
      border-radius: 12px;
    }
    
    .table-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: rgba(59, 130, 246, 0.2);
      color: #F1F5F9;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    th:not(:first-child) { text-align: right; }
    
    td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: #94A3B8;
    }
    
    td:not(:first-child) { text-align: right; }
    
    tr:hover { background: rgba(255, 255, 255, 0.03); }
    
    tfoot td {
      background: rgba(59, 130, 246, 0.1);
      font-weight: 700;
      color: #F1F5F9;
      border-top: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 30px;
      width: 100%;
      max-width: 1200px;
    }
    
    .kpi-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
    }
    
    .kpi-label {
      font-size: 14px;
      color: #94A3B8;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .kpi-value {
      font-size: 48px;
      font-weight: 800;
      margin: 10px 0;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .kpi-delta {
      font-size: 18px;
      font-weight: 600;
    }
    
    .positive { color: #10B981; }
    .negative { color: #EF4444; }
    
    @media print {
      .slide { page-break-after: always; }
    }
  </style>
</head>
<body>
  <!-- Слайд 1: Титульный -->
  <div class="slide">
    <div class="slide-header">
      <div class="logo">РК</div>
      <span style="font-size: 20px; font-weight: 600;">Россети Кубань</span>
    </div>
    <h1>Динамика ВОЛС<br>Аналитический отчет</h1>
    <p style="font-size: 24px; color: #94A3B8;">Период: ${prev.date} — ${curr.date}</p>
    <div class="slide-number">1</div>
  </div>
  
  <!-- Слайд 2: KPI -->
  <div class="slide">
    <h2>Ключевые показатели</h2>
    <div class="kpi-grid">
      ${generateKPICards()}
    </div>
    <div class="slide-number">2</div>
  </div>
  
  <!-- Слайд 3: Динамика по филиалам -->
  <div class="slide">
    <h2>Динамика по филиалам (всего)</h2>
    <div class="content-grid">
      <div class="chart-container">  /* ==================== Рендер на странице ==================== */
  let chartBranches, chartBranchesS3, chartBranchesS4, chartRTKDelta;

  function renderKpis(curr, prev, dyn){
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const items = [
      {title:"В работе всего", value:curr.p1.totals.in_work_total, delta:dyn.in_work_total, unit:"шт."},
      {title:"Выявлено за неделю", value:dyn.found_week, delta:dyn.found_week, unit:"шт."},
      {title:"Закрыто за неделю", value:eff, delta:eff, unit:"шт.", subtitle:"(узак. + демонт.)"},
      {title:"ПАО «Ростелеком»", value:curr.p1.totals.rtk_in_work, delta:dyn.rtk_in_work, unit:"шт.", subtitle:`доля ${rtkShare.toFixed(1)}%`},
    ];

    document.getElementById("kpis").innerHTML = items.map(it=>{
      const d = typeof it.delta==="number"?it.delta:0;
      const deltaClass = d>0?"positive":(d<0?"negative":"neutral");
      const sign=d>0?"+":"";
      const arrow = d>0?"↑":(d<0?"↓":"→");
      
      return `<div class="kpi-card">
        <div class="kpi-label">${it.title}</div>
        <div class="kpi-value">${fmt(it.value)} <span style="font-size:0.5em;font-weight:400;color:var(--text-secondary)">${it.unit}</span></div>
        ${it.subtitle ? `<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem">${it.subtitle}</div>` : ''}
        <div class="kpi-delta ${deltaClass}">
          <span>${arrow}</span>
          <span>${sign}${fmt(d)}</span>
        </div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(rows, tbodySel, sumPrevId, sumCurrId, sumDeltaId){
    const tbody = document.querySelector(tbodySel);
    tbody.innerHTML = "";
    let sP=0,sC=0,sD=0;
    const sorted = [...rows].sort((a,b)=>Math.abs((b.c-b.p)) - Math.abs((a.c-a.p)));
    for(const r0 of sorted){
      const p = Number(r0.p)||0, c = Number(r0.c)||0;
      const d = c - p;
      const cls = d>0?"value-positive":(d<0?"value-negative":"");
      sP+=p; sC+=c; sD+=d;
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r0.b}</td>
          <td>${fmt(p)}</td>
          <td>${fmt(c)}</td>
          <td class="${cls}">${d>0?"+":""}${fmt(d)}</td>
        </tr>`);
    }
    document.getElementById(sumPrevId).textContent = fmt(sP);
    document.getElementById(sumCurrId).textContent = fmt(sC);
    document.getElementById(sumDeltaId).textContent = (sD>0?"+":"")+fmt(sD);
    document.getElementById(sumDeltaId).className = sD>0?"value-positive":(sD<0?"value-negative":"");
  }

  function chartOpts(){
    Chart.defaults.color = '#94A3B8';
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
    
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:"top",
          labels:{
            boxWidth:12,
            usePointStyle:true,
            padding:20,
            font:{size:12}
          }
        },
        tooltip:{
          backgroundColor: 'rgba(30, 41, 59, 0.9)',
          titleColor: '#F1F5F9',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          boxWidth: 12,
          boxHeight: 12,
          usePointStyle: true
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid:{
            color:'rgba(255, 255, 255, 0.05)',
            drawBorder:false
          },
          ticks:{
            precision:0,
            padding:10
          }
        },
        x:{
          grid:{
            display:false,
            drawBorder:false
          },
          ticks:{
            padding:10
          }
        }
      },
    };
  }

  function renderCharts(curr, prev, dyn){
    const labels = BRANCHES;
    const prevS2 = labels.map(b=>prev.p2.branches.get(b)?.total||0);
    const currS2 = labels.map(b=>curr.p2.branches.get(b)?.total||0);

    if(chartBranches) chartBranches.destroy();
    chartBranches = new Chart(document.getElementById("chartBranches"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS2, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS2, backgroundColor:"rgba(59, 130, 246, 0.5)", borderColor:"rgba(59, 130, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS3 = labels.map(b=>prev.p3.branches.get(b)?.total||0);
    const currS3 = labels.map(b=>curr.p3.branches.get(b)?.total||0);
    if(chartBranchesS3) chartBranchesS3.destroy();
    chartBranchesS3 = new Chart(document.getElementById("chartBranchesS3"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS3, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS3, backgroundColor:"rgba(139, 92, 246, 0.5)", borderColor:"rgba(139, 92, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS4 = labels.map(b=>prev.p4.branches.get(b)?.total||0);
    const currS4 = labels.map(b=>curr.p4.branches.get(b)?.total||0);
    if(chartBranchesS4) chartBranchesS4.destroy();
    chartBranchesS4 = new Chart(document.getElementById("chartBranchesS4"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS4, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS4, backgroundColor:"rgba(6, 182, 212, 0.5)", borderColor:"rgba(6, 182, 212, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const rtkD = labels.map(b => (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).c - (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).p);
    if(chartRTKDelta) chartRTKDelta.destroy();
    chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
      type:"bar",
      data:{labels, datasets:[{
        label:"Изменение (тек. − пред.)", 
        data:rtkD, 
        backgroundColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.5)":"rgba(239, 68, 68, 0.5)"),
        borderColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.8)":"rgba(239, 68, 68, 0.8)"),
        borderWidth: 1<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ВОЛС Аналитика | Россети Кубань</title>

  <!-- Шрифты -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== Глобальные переменные и токены дизайна ====== */
    :root{
      /* Основные цвета бренда */
      --primary: #1E3A8A;
      --primary-light: #3B82F6;
      --primary-dark: #1E293B;
      --accent: #06B6D4;
      --accent-glow: rgba(6, 182, 212, 0.3);
      
      /* Фоны и поверхности */
      --bg-main: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(59, 130, 246, 0.1);
      
      /* Стекломорфизм */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* Текст */
      --text-primary: #F1F5F9;
      --text-secondary: #94A3B8;
      --text-muted: #64748B;
      
      /* Статусы */
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      
      /* Эффекты */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.7);
      --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.3);
      
      /* Скругления */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* Анимации */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== Базовые стили ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* Фоновый градиент */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* ====== Шапка ====== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      transition: var(--transition);
    }

    header.scrolled {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      letter-spacing: -0.02em;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* ====== Главный контент ====== */
    main {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* ====== Сетка ====== */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .cols-4 { grid-template-columns: repeat(2, 1fr); }
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .cols-2, .cols-3, .cols-4 { grid-template-columns: 1fr; }
    }

    /* ====== Карточки ====== */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* ====== KPI карточки ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-delta {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .kpi-delta.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .kpi-delta.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .kpi-delta.neutral {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* ====== Кнопки ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px dashed var(--glass-border);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
      background: var(--glass);
    }

    /* ====== Формы ====== */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--glass);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-wrapper:hover {
      border-color: var(--primary-light);
      background: var(--bg-hover);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    /* ====== Таблицы ====== */
    .table-container {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-scroll {
      max-height: 400px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--glass-border) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 2px solid var(--glass-border);
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    tfoot td {
      background: var(--bg-secondary);
      font-weight: 700;
      color: var(--text-primary);
      padding: 1rem;
      border-top: 2px solid var(--glass-border);
    }

    /* ====== Графики ====== */
    .chart-container {
      height: 400px;
      padding: 1rem;
      background: var(--glass);
      border-radius: var(--radius-md);
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== Статусы и значки ====== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--success);
      font-weight: 600;
    }

    .value-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* ====== Анимация загрузки ====== */
    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== Сообщения ====== */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .message-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .message-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    /* ====== Секция экспорта ====== */
    .export-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    /* ====== Адаптивность ====== */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }

      .brand {
        font-size: 1rem;
      }

      .logo {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }

      main {
        margin-top: 70px;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 2rem;
      }

      .table-scroll {
        max-height: 300px;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
    }

    /* ====== Утилиты ====== */
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    /* ====== Печать ====== */
    @media print {
      body {
        background: white;
        color: black;
      }

      header {
        position: relative;
        background: white;
        border-bottom: 2px solid #000;
      }

      .card {
        background: white;
        border: 1px solid #ccc;
        box-shadow: none;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }

      .btn, .file-input-wrapper {
        display: none;
      }
    }

    /* ====== Компактный режим ====== */
    .compact .card {
      padding: 1rem;
    }

    .compact .kpi-card {
      padding: 0.75rem;
    }

    .compact .kpi-value {
      font-size: 1.75rem;
    }

    .compact table {
      font-size: 0.75rem;
    }

    .compact th, .compact td {
      padding: 0.5rem;
    }

    .compact .chart-container {
      height: 300px;
    }

    /* ====== Скрытые элементы для печати ====== */
    #presentationPrint, #summaryPrint {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Шапка -->
  <header id="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">РК</div>
        <span>ВОЛС Аналитика</span>
      </div>
      <div class="nav-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>Система активна</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Основной контент -->
  <main>
    <div class="container">
      <!-- Секция загрузки и экспорта -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">📊</div>
              Загрузка отчётов
            </h2>
          </div>
          <div class="form-group">
            <label class="file-input-wrapper">
              <div class="file-icon">📄</div>
              <span>Предыдущая неделя (PDF)</span>
              <input id="filePrev" type="file" accept="application/pdf">
            </label>
            <label class="file-input-wrapper">
              <div class="file-icon">📄</div>
              <span>Текущая неделя (PDF)</span>
              <input id="fileCurr" type="file" accept="application/pdf">
            </label>
          </div>
          <div class="form-group">
            <button id="btnParse" class="btn btn-primary">
              <span>🚀</span>
              Проанализировать
            </button>
            <button id="btnCompact" class="btn btn-ghost" title="Компактный режим">
              <span>📐</span>
              Компактный вид
            </button>
          </div>
          <div id="dates" class="message message-info" style="display:none"></div>
          <div id="loadingMsg" class="loading" style="display:none">
            <div class="loading-spinner"></div>
            <span>Обработка PDF файлов...</span>
          </div>
          <div id="errorMsg" class="message message-error" style="display:none"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">💾</div>
              Экспорт отчётов
            </h2>
          </div>
          <div class="export-section">
            <button class="btn btn-secondary" id="exportPresPDF">
              <span>📑</span>
              Презентация PDF
            </button>
            <button class="btn btn-secondary" id="exportBriefPDF">
              <span>📋</span>
              Выжимка PDF
            </button>
            <button class="btn btn-secondary" id="exportWordHTML">
              <span>📝</span>
              Отчет Word
            </button>
            <button class="btn btn-secondary" id="exportPresHTML">
              <span>🌐</span>
              Презентация HTML
            </button>
          </div>
          <div id="exportStatus" class="message message-success mt-1" style="display:none"></div>
        </div>
      </div>

      <!-- KPI секция -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">📈</div>
            Ключевые показатели
          </h2>
        </div>
        <div id="kpis" class="kpi-grid"></div>
      </div>

      <!-- Графики и таблицы стр. 2 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Динамика по филиалам</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranches"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranches">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrev">0</td>
                    <td id="sumCurr">0</td>
                    <td id="sumDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Графики и таблицы стр. 3 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Приказ №425</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS3"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 3</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS3">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrevS3">0</td>
                    <td id="sumCurrS3">0</td>
                    <td id="sumDeltaS3">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Графики и таблицы стр. 4 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ПАО «Ростелеком»</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS4"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 4</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS4">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrevS4">0</td>
                    <td id="sumCurrS4">0</td>
                    <td id="sumDeltaS4">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- График изменений РТК -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">📊</div>
            Динамика изменений ПАО «Ростелеком»
          </h2>
        </div>
        <div class="chart-container">
          <canvas id="chartRTKDelta"></canvas>
        </div>
      </div>

      <!-- Стадии -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Стадии работ</h2>
            <span class="badge">Стр. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS2">
                <thead>
                  <tr>
                    <th>Стадия</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Стадии работ</h2>
            <span class="badge">Стр. 4 (РТК)</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS4">
                <thead>
                  <tr>
                    <th>Стадия</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Области для печати (скрытые) -->
  <div id="presentationPrint" style="display:none"></div>
  <div id="summaryPrint" style="display:none"></div>

  <!-- Библиотеки -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
  /* ==================== Константы и утилиты ==================== */
  const BRANCHES = [
    "Сочинские ЭС","Тимашевские ЭС","Тихорецкие ЭС","Усть-Лабинские ЭС","Юго-Западные ЭС",
    "Адыгейские ЭС","Армавирские ЭС","Краснодарские ЭС","Лабинские ЭС","Ленинградские ЭС","Славянские ЭС"
  ];
  const BRANCH_PATTERNS = [
    {name:"Сочинские ЭС", re:/Сочинские\s+ЭС/i},
    {name:"Тимашевские ЭС", re:/Тимашевские\s+ЭС/i},
    {name:"Тихорецкие ЭС", re:/Тихорецкие\s+ЭС/i},
    {name:"Усть-Лабинские ЭС", re:/Усть[\s\u00A0\u202F\-–—-]*Лабинские\s+ЭС/i},
    {name:"Юго-Западные ЭС", re:/Юго[\s\u00A0\u202F\-–—-]*Западные\s+ЭС/i},
    {name:"Адыгейские ЭС", re:/Адыгейские\s+ЭС/i},
    {name:"Армавирские ЭС", re:/Армавирские\s+ЭС/i},
    {name:"Краснодарские ЭС", re:/Краснодарские\s+ЭС/i},
    {name:"Лабинские ЭС", re:/Лабинские\s+ЭС/i},
    {name:"Ленинградские ЭС", re:/Ленинградские\s+ЭС/i},
    {name:"Славянские ЭС", re:/Славянские\s+ЭС/i},
  ];

  /* Стадии */
  const STATUS_PATTERNS = [
    {key:"work", title:"В работе у филиала", re:/В\s*работе\s*у\s*филиала/i},
    {key:"dismantled", title:"Демонтировано", re:/Демонтировано/i},
    {key:"rc_digit", title:"Договор на оформлении Россети Цифра", re:/Договор\s*на\s*оформлении\s*Россети\s*Цифра/i},
    {key:"op_sign", title:"Договор на подписании у оператора", re:/Договор\s*на\s*подписании\s*у\s*оператора/i},
    {key:"filial_appr",title:"Договор на согласовании в филиале", re:/Договор\s*на\s*согласовании\s*в\s*филиале/i},
    {key:"incl_next", title:"Будет включено в следующее доп. соглашение после подписания",
      re:/Будет\s*включено(?:[\s\S]{0,80})в(?:\s*следующее)?(?:[\s\S]{0,80})доп\.?\s*соглашение(?:[\s\S]{0,80}после\s*подписания)?/i
    },
  ];
  const STATUS_KEYS = STATUS_PATTERNS.map(s => s.key);
  const STAGE_TITLE = k => (STATUS_PATTERNS.find(s => s.key===k)||{}).title||k;

  const SHORT_STAGE_TITLES = {
    "work": "В работе",
    "dismantled": "Демонт.",
    "rc_digit": "Оформл. РЦ",
    "op_sign": "Подпись опер.",
    "filial_appr": "Согл. филиал",
    "incl_next": "В след. доп.согл."
  };
  const SHORT_STAGE_TITLE = k => SHORT_STAGE_TITLES[k] || STAGE_TITLE(k);

  const numberize = s => {
    const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
    const n = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
    if(!n) return 0;
    const val = Number(n.replace(",", "."));
    return isNaN(val) ? 0 : val;
  };
  const fmt = n => (typeof n === "number" ? n : Number(n||0)).toLocaleString("ru-RU");
  const normalize = txt => String(txt||"")
      .replace(/\u00A0|\u202F/g," ")
      .replace(/\u00AD/g,"")
      .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
      .replace(/[ \t]+/g," ")
      .trim();

  /* ==================== Чтение PDF ==================== */
  async function pdfToPages(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      let pageText = "", lastY = null;
      content.items.forEach(item => {
        const y = item.transform[5];
        if(lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
        pageText += item.str;
        lastY = y;
      });
      pages.push(normalize(pageText));
    }
    return pages;
  }

  /* ==================== Парсинг ==================== */
  function extractDateFromPages(pages){
    for(const pg of pages){
      const m = pg.match(/по состоянию на\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
    return "—";
  }

  function parseTotalsFromPage(page1){
    const find = (re) => {
      const m = page1.match(re);
      return m ? numberize(m[1]) : 0;
    };
    return {
      found_year: find(/выявлено[^0-9]*?(\d[\d\s]+)\s*шт/i),
      legalized: find(/Узаконено[^0-9]*?(\d[\d\s]+)/i),
      dismantled_ytd: find(/За\s*20\d{2}\s*год\s*демонтировано[^0-9]*?(\d[\d\s]+)/i),
      in_work_total: find(/В\s*работе[^0-9]*?всего[^0-9]*?(\d[\d\s]+)\s*шт/i),
      rtk_in_work: find(/в\s*том\s*числе\s*ПАО\s*«?Ростелеком»?[^0-9]*?(\d[\d\s]+)/i),
    };
  }

  function parseBranchTable(pageText){
    const text = normalize(pageText);
    const lines = text.split("\n").filter(Boolean);

    const idx = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      for(const bp of BRANCH_PATTERNS){
        if(bp.re.test(line)){ idx.push({i, name: bp.name}); break; }
      }
    }
    idx.push({i: lines.length, name:null});

    const branches = new Map();
    for(let k=0;k<idx.length-1;k++){
      const start = idx[k].i, end = idx[k+1].i, branchName = idx[k].name;
      if(!branchName) continue;
      const headLine = lines[start] || "";
      const segText = lines.slice(start+1, end).join(" ");

      let total = 0;
      const headNums = headLine.match(/\d[\d\s]*/g);
      if(headNums && headNums.length) total = numberize(headNums[headNums.length-1]);
      if(total===0 && lines[start+1]){
        const n2 = (lines[start+1]||"").match(/\d[\d\s]*/g);
        if(n2 && n2.length) total = numberize(n2[n2.length-1]);
      }

      const data = { total, statuses:{} };

      function numAfter(re, hay){
        const rx = new RegExp(re.source + "[^\\d]{0,200}(\\d[\\d\\s]*)", re.flags);
        const m = hay.match(rx);
        return m ? numberize(m[1]) : null;
      }

      for(const sp of STATUS_PATTERNS){
        let v = numAfter(sp.re, segText);
        if(v === null){
          for(let j=start+1;j<end;j++){
            const l0 = lines[j]||"", l1 = lines[j+1]||"";
            if(sp.re.test(l0) || sp.re.test(l1)){
              let cap = (l0.match(/(\d[\d\s]*)/g)||[]).pop();
              if(!cap) cap = (l1.match(/(\d[\d\s]*)/g)||[]).pop();
              if(cap){ v = numberize(cap); break; }
            }
          }
        }
        if(v !== null) data.statuses[sp.key] = v;
      }
      branches.set(branchName, data);
    }

    for(const b of BRANCHES){
      if(!branches.has(b)) branches.set(b, { total:0, statuses:{} });
    }

    const stages = {};
    for(const [_, obj] of branches){
      for(const [k,v] of Object.entries(obj.statuses)){
        stages[k] = (stages[k]||0) + (v||0);
      }
    }

    const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);
    return { branches, overall, stages };
  }

  function parseReportByPages(pages){
    return {
      date: extractDateFromPages(pages),
      p1: { totals: parseTotalsFromPage(pages[0] || "") },
      p2: parseBranchTable(pages[1] || ""),
      p3: parseBranchTable(pages[2] || ""),
      p4: parseBranchTable(pages[3] || ""),
    };
  }

  /* ==================== Динамика ==================== */
  function computeDynamics(curr, prev){
    const dyn = {
      in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
      rtk_in_work: (curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work) || 0,
      legalized: (curr.p1.totals.legalized - prev.p1.totals.legalized) || 0,
      dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
    };
    dyn.found_week = dyn.in_work_total;

    const makeRows = (cPage, pPage) => BRANCHES.map(b=>{
      const c = cPage.branches.get(b)?.total || 0;
      const p = pPage.branches.get(b)?.total || 0;
      return {b, p, c, d: (c - p)};
    });

    const branchRows = makeRows(curr.p2, prev.p2);
    const branchRowsS3 = makeRows(curr.p3, prev.p3);
    const branchRowsS4 = makeRows(curr.p4, prev.p4);

    const allKeys = Array.from(new Set([
      ...Object.keys(prev.p2.stages||{}), ...Object.keys(curr.p2.stages||{}),
      ...Object.keys(prev.p3.stages||{}), ...Object.keys(curr.p3.stages||{}),
      ...Object.keys(prev.p4.stages||{}), ...Object.keys(curr.p4.stages||{}),
      ...STATUS_KEYS
    ]));

    const diffStages = (cur, prv) => allKeys.map(k=>({
      stage: STAGE_TITLE(k), short: SHORT_STAGE_TITLE(k), key: k,
      p: prv[k] || 0, c: cur[k] || 0, d: (cur[k]||0) - (prv[k]||0)
    }));

    const stagesS2 = diffStages(curr.p2.stages||{}, prev.p2.stages||{});
    const stagesS4 = diffStages(curr.p4.stages||{}, prev.p4.stages||{});

    function perBranchStages(cPage, pPage){
      return BRANCHES.map(b=>{
        const cst = cPage.branches.get(b)?.statuses || {};
        const pst = pPage.branches.get(b)?.statuses || {};
        const by = {};
        STATUS_KEYS.forEach(k=>{
          const p = pst[k]||0, c = cst[k]||0;
          by[k] = {p,c,d:c-p};
        });
        return {b, by};
      });
    }
    const s2BranchStages = perBranchStages(curr.p2, prev.p2);

    return {
      ...dyn,
      branchRows,
      branchRowsS3,
      branchRowsS4,
      stagesS2,
      stagesS4,
      s2BranchStages,
      rtkRows: branchRowsS4
    };
  }pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
<div class="chart-container">
        <img src="${imgS2}" alt="График динамики">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRows, ["sumPrev", "sumCurr", "sumDelta"])}
      </div>
    </div>
    <div class="slide-number">3</div>
  </div>
  
  <!-- Слайд 4: Приказ №425 -->
  <div class="slide">
    <h2>Динамика по Приказу №425</h2>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${imgS3}" alt="График Приказ 425">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"])}
      </div>
    </div>
    <div class="slide-number">4</div>
  </div>
  
  <!-- Слайд 5: ПАО Ростелеком -->
  <div class="slide">
    <h2>Динамика по ПАО «Ростелеком»</h2>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${imgS4}" alt="График Ростелеком">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"])}
      </div>
    </div>
    <div class="slide-number">5</div>
  </div>
  
  <!-- Слайд 6: Изменения РТК -->
  <div class="slide">
    <h2>Изменения по ПАО «Ростелеком» по филиалам</h2>
    <div class="chart-container" style="max-width: 1200px; width: 100%;">
      <img src="${imgRTK}" alt="График изменений РТК">
    </div>
    <div class="slide-number">6</div>
  </div>
</body>
</html>`;
  }

  function generateKPICards(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    const kpis = [
      {label: "В работе всего", value: curr.p1.totals.in_work_total, delta: dyn.in_work_total},
      {label: "Выявлено за неделю", value: dyn.found_week, delta: dyn.found_week},
      {label: "Закрыто за неделю", value: eff, delta: eff},
      {label: "ПАО Ростелеком", value: curr.p1.totals.rtk_in_work, delta: dyn.rtk_in_work, extra: `${rtkShare.toFixed(1)}%`}
    ];
    
    return kpis.map(kpi => `
      <div class="kpi-card">
        <div class="kpi-label">${kpi.label}</div>
        <div class="kpi-value">${fmt(kpi.value)}</div>
        <div class="kpi-delta ${kpi.delta >= 0 ? 'positive' : 'negative'}">
          ${kpi.delta > 0 ? '+' : ''}${fmt(kpi.delta)}
          ${kpi.extra ? ` (${kpi.extra})` : ''}
        </div>
      </div>
    `).join('');
  }

  function generateSlideTable(rows, sumIds){
    const sorted = [...rows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d));
    return `
      <table>
        <thead>
          <tr>
            <th>Филиал</th>
            <th>Предыдущая</th>
            <th>Текущая</th>
            <th>Изменение</th>
          </tr>
        </thead>
        <tbody>
          ${sorted.map(r => `
            <tr>
              <td>${r.b}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d > 0 ? 'positive' : r.d < 0 ? 'negative' : ''}">
                ${r.d > 0 ? '+' : ''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr>
            <td>Итого</td>
            <td>${document.getElementById(sumIds[0]).textContent}</td>
            <td>${document.getElementById(sumIds[1]).textContent}</td>
            <td>${document.getElementById(sumIds[2]).textContent}</td>
          </tr>
        </tfoot>
      </table>
    `;
  }

  function generateWordContent(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    return `
      <h2>Основные показатели</h2>
      <ul>
        <li>В работе всего: <strong>${fmt(curr.p1.totals.in_work_total)}</strong> 
            <span class="${dyn.in_work_total>=0?'positive':'negative'}">
              (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})
            </span>
        </li>
        <li>Выявлено за неделю: <strong>${fmt(dyn.found_week)}</strong></li>
        <li>Закрыто за неделю (узаконено + демонтировано): <strong>${fmt(eff)}</strong></li>
        <li>ПАО «Ростелеком» в работе: <strong>${fmt(curr.p1.totals.rtk_in_work)}</strong> 
            <span class="${dyn.rtk_in_work>=0?'positive':'negative'}">
              (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})
            </span>; 
            доля <strong>${rtkShare.toFixed(1)}%</strong>
        </li>
      </ul>
      
      <h2>Динамика по филиалам</h2>
      
      <h3>Общая динамика (все операторы)</h3>
      ${generateWordTable(dyn.branchRows, ["sumPrev", "sumCurr", "sumDelta"])}
      
      <h3>Приказ №425</h3>
      ${generateWordTable(dyn.branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"])}
      
      <h3>ПАО «Ростелеком»</h3>
      ${generateWordTable(dyn.branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"])}
      
      <h2>Динамика по статусам</h2>
      ${generateWordStagesTable(dyn.stagesS2)}
      
      <div class="info-box">
        <p><strong>Примечание:</strong> Отчет сформирован автоматически на основе загруженных PDF-файлов.<br>
        Дата формирования: ${new Date().toLocaleDateString('ru-RU')}</p>
      </div>
    `;
  }

  function generateWordTable(rows, sumIds){
    const sorted = [...rows].sort((a,b) => b.b.localeCompare(a.b, 'ru'));
    return `
      <table>
        <thead>
          <tr>
            <th>Филиал</th>
            <th>Предыдущая</th>
            <th>Текущая</th>
            <th>Изменение</th>
          </tr>
        </thead>
        <tbody>
          ${sorted.map(r => `
            <tr>
              <td>${r.b}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d>0?'positive':r.d<0?'negative':''}">
                ${r.d>0?'+':''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr style="font-weight:bold;background:#f0f0f0">
            <td>ИТОГО</td>
            <td>${document.getElementById(sumIds[0]).textContent}</td>
            <td>${document.getElementById(sumIds[1]).textContent}</td>
            <td>${document.getElementById(sumIds[2]).textContent}</td>
          </tr>
        </tfoot>
      </table>
    `;
  }

  function generateWordStagesTable(stages){
    return `
      <table>
        <thead>
          <tr>
            <th>Статус</th>
            <th>Пред.</th>
            <th>Тек.</th>
            <th>Δ</th>
          </tr>
        </thead>
        <tbody>
          ${stages.map(r => `
            <tr>
              <td>${r.stage}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d>0?'positive':r.d<0?'negative':''}">
                ${r.d>0?'+':''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  /* ==================== Вспомогательные функции ==================== */
  function triggerDownload(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = filename; 
    document.body.appendChild(a); 
    a.click();
    setTimeout(()=>{ 
      URL.revokeObjectURL(url); 
      a.remove(); 
    }, 0);
  }

  function showExportMessage(text){
    const el = document.getElementById("exportStatus");
    el.textContent = text;
    el.style.display = "flex";
    setTimeout(() => { el.style.display = "none"; }, 3000);
  }

  function showLoadingMessage(text){
    const el = document.getElementById("loadingMsg");
    if(text){
      el.style.display = "flex";
      el.querySelector("span").textContent = text;
    } else {
      el.style.display = "none";
    }
  }

  function showErrorMessage(text){
    const el = document.getElementById("errorMsg");
    if(text){
      el.textContent = text;
      el.style.display = "flex";
    } else {
      el.style.display = "none";
    }
  }

  function showDates(prev, curr){
    const el = document.getElementById("dates");
    el.innerHTML = `<strong>Период анализа:</strong> ${prev} — ${curr}`;
    el.style.display = "flex";
  }

  /* ==================== План-Факт из Google Sheets ==================== */
  const SHEET_HTML_URL = "https://docs.google.com/spreadsheets/d/1Y9bM7zLRf_gonMUgfQLl57Iu3NgPa78rBXnpxkKLvO0/gviz/tq?tqx=out:html";
  
  async function injectPlanFactHTML(){
    try{
      const res = await fetch(SHEET_HTML_URL, {cache:"no-store", mode:"cors"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const html = await res.text();
      
      // Стилизуем таблицу под наш дизайн
      const styledHTML = stylePlanFactTable(html);
      
      if(document.getElementById("presPlanFactInner")){
        document.getElementById("presPlanFactInner").innerHTML = styledHTML;
      }
      if(document.getElementById("briefPlanFactInner")){
        document.getElementById("briefPlanFactInner").innerHTML = styledHTML;
      }
    }catch(e){
      console.warn("Не удалось загрузить План-Факт:", e);
    }
  }

  function stylePlanFactTable(html){
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    const table = tmp.querySelector("table");
    
    if(!table) return '<div class="message message-error">Не удалось загрузить План-Факт</div>';
    
    // Применяем стили
    table.style.cssText = `
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    `;
    
    // Стилизуем заголовки
    table.querySelectorAll("th").forEach(th => {
      th.style.cssText = `
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 12px;
        font-weight: 600;
        border-bottom: 2px solid var(--glass-border);
      `;
    });
    
    // Стилизуем ячейки
    table.querySelectorAll("td").forEach(td => {
      td.style.cssText = `
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
      `;
    });
    
    return `
      <div class="table-container">
        <div class="table-scroll">
          ${table.outerHTML}
        </div>
      </div>
    `;
  }

  /* ==================== Инициализация ==================== */
  let DATA = null;

  // Эффект прокрутки для шапки
  window.addEventListener('scroll', () => {
    const header = document.getElementById('header');
    if (window.scrollY > 50) {
      header.classList.add('scrolled');
    } else {
      header.classList.remove('scrolled');
    }
  });

  // Обработчик анализа файлов
  document.getElementById("btnParse").addEventListener("click", async () => {
    const fPrev = document.getElementById("filePrev").files[0];
    const fCurr = document.getElementById("fileCurr").files[0];
    
    if(!fPrev || !fCurr){ 
      showErrorMessage("Загрузите оба PDF файла: предыдущий и текущий отчеты"); 
      return; 
    }

    try{
      showLoadingMessage("Обработка PDF файлов...");
      showErrorMessage("");

      const [pPrev, pCurr] = await Promise.all([pdfToPages(fPrev), pdfToPages(fCurr)]);
      
      showLoadingMessage("Анализ данных...");
      
      const prev = parseReportByPages(pPrev);
      const curr = parseReportByPages(pCurr);
      const dyn = computeDynamics(curr, prev);
      DATA = {prev, curr, dyn};

      showDates(prev.date, curr.date);
      renderKpis(curr, prev, dyn);
      renderBranchesTable(dyn.branchRows, "#tblBranches tbody", "sumPrev", "sumCurr", "sumDelta");
      renderBranchesTable(dyn.branchRowsS3, "#tblBranchesS3 tbody", "sumPrevS3", "sumCurrS3", "sumDeltaS3");
      renderBranchesTable(dyn.branchRowsS4, "#tblBranchesS4 tbody", "sumPrevS4", "sumCurrS4", "sumDeltaS4");
      renderCharts(curr, prev, dyn);
      renderStagesTables(dyn);
      
      await injectPlanFactHTML();

      showLoadingMessage("");
      showExportMessage("Анализ успешно завершен!");
      
    }catch(e){
      console.error(e);
      showLoadingMessage("");
      showErrorMessage("Ошибка при обработке PDF. Убедитесь, что файлы имеют правильный формат.");
    }
  });

  // Обработчики экспорта
  document.getElementById("exportPresPDF").addEventListener("click", async () => {
    if(!DATA) return showErrorMessage("Сначала проанализируйте отчеты");
    await exportPresPDF();
  });

  document.getElementById("exportBriefPDF").addEventListener("click", async () => {
    if(!DATA) return showErrorMessage("Сначала проанализируйте отчеты");
    await exportBriefPDF();
  });

  document.getElementById("exportWordHTML").addEventListener("click", () => {
    if(!DATA) return showErrorMessage("Сначала проанализируйте отчеты");
    exportWordHTML();
  });

  document.getElementById("exportPresHTML").addEventListener("click", () => {
    if(!DATA) return showErrorMessage("Сначала проанализируйте отчеты");
    exportPresHTML();
  });

  // Компактный режим
  document.getElementById("btnCompact").addEventListener("click", ()=>{
    document.body.classList.toggle("compact");
    const btn = document.getElementById("btnCompact");
    if(document.body.classList.contains("compact")){
      btn.innerHTML = '<span>📐</span> Обычный вид';
    } else {
      btn.innerHTML = '<span>📐</span> Компактный вид';
    }
  });

  </script>
</body>
</html>
      html2canvas: {scale: 2, useCORS: true},
      jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'}
    }).save();
    el.style.display = "none";
    showExportMessage("PDF выжимки сохранен");
  }

  /* ==================== Вспомогательные функции для экспорта ==================== */
  function buildPresentationTables(){
    const {branchRows, branchRowsS3, branchRowsS4} = DATA.dyn;
    
    const makeTable = (title, icon, rows, sumIds) => {
      const sorted = [...rows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d));
      return `
        <div class="table-section">
          <div class="section-title">
            <div class="section-icon">${icon}</div>
            ${title}
          </div>
          <table>
            <thead>
              <tr>
                <th>Филиал</th>
                <th>Предыдущая</th>
                <th>Текущая</th>
                <th>Изменение</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map(r => `
                <tr>
                  <td>${r.b}</td>
                  <td>${fmt(r.p)}</td>
                  <td>${fmt(r.c)}</td>
                  <td class="${r.d > 0 ? 'delta-positive' : r.d < 0 ? 'delta-negative' : ''}">
                    ${r.d > 0 ? '+' : ''}${fmt(r.d)}
                  </td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr>
                <td>Итого</td>
                <td>${document.getElementById(sumIds[0]).textContent}</td>
                <td>${document.getElementById(sumIds[1]).textContent}</td>
                <td>${document.getElementById(sumIds[2]).textContent}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    };
    
    return makeTable("Динамика по филиалам (всего)", "📊", branchRows, ["sumPrev", "sumCurr", "sumDelta"]) +
           makeTable("Динамика по Приказу №425", "📋", branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"]) +
           makeTable("Динамика по ПАО «Ростелеком»", "🌐", branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"]);
  }

  function buildSummaryContent(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    
    const topChanges = [...dyn.branchRows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d)).slice(0, 3);
    
    return `
      <div class="brief-block">
        <div class="brief-title">Основные показатели</div>
        <div class="brief-content">
          <div class="brief-item">• В работе всего: <span class="brief-value">${fmt(curr.p1.totals.in_work_total)}</span> (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})</div>
          <div class="brief-item">• Выявлено за неделю: <span class="brief-value">${fmt(dyn.found_week)}</span></div>
          <div class="brief-item">• Закрыто за неделю: <span class="brief-value">${fmt(eff)}</span></div>
          <div class="brief-item">• ПАО «Ростелеком»: <span class="brief-value">${fmt(curr.p1.totals.rtk_in_work)}</span> (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</div>
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">Топ-3 филиала по изменениям</div>
        <div class="brief-content">
          ${topChanges.map((r, i) => `
            <div class="brief-item">${i+1}. <span class="brief-value">${r.b}</span>: ${fmt(r.p)} → ${fmt(r.c)} (${r.d>0?'+':''}${fmt(r.d)})</div>
          `).join('')}
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">Итоги по категориям</div>
        <div class="brief-content">
          <div class="brief-item">• Всего опор: ${document.getElementById("sumPrev").textContent} → <span class="brief-value">${document.getElementById("sumCurr").textContent}</span> (${document.getElementById("sumDelta").textContent})</div>
          <div class="brief-item">• Приказ №425: ${document.getElementById("sumPrevS3").textContent} → <span class="brief-value">${document.getElementById("sumCurrS3").textContent}</span> (${document.getElementById("sumDeltaS3").textContent})</div>
          <div class="brief-item">• ПАО Ростелеком: ${document.getElementById("sumPrevS4").textContent} → <span class="brief-value">${document.getElementById("sumCurrS4").textContent}</span> (${document.getElementById("sumDeltaS4").textContent})</div>
        </div>
      </div>
    `;
  }

  /* ==================== Экспорт Word HTML ==================== */
  function exportWordHTML(){
    if(!DATA) return alert("Сначала проанализируйте отчёты.");
    const {curr, prev, dyn} = DATA;
    
    const htmlDoc = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Отчет ВОЛС - ${curr.date}</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body { font-family: 'Calibri', Arial, sans-serif; line-height: 1.6; color: #333; }
    h1 { color: #1E3A8A; font-size: 24pt; border-bottom: 3pt solid #1E3A8A; padding-bottom: 10pt; }
    h2 { color: #1E3A8A; font-size: 18pt; margin-top: 20pt; }
    h3 { color: #333; font-size: 14pt; margin-top: 15pt; }
    table { width: 100%; border-collapse: collapse; margin: 15pt 0; }
    th, td { border: 1pt solid #ddd; padding: 8pt; text-align: center; }
    th { background-color: #1E3A8A; color: white; font-weight: bold; }
    th:first-child, td:first-child { text-align: left; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .info-box { background: #EBF4FF; border-left: 4pt solid #1E3A8A; padding: 10pt; margin: 10pt 0; }
    .positive { color: #10B981; font-weight: bold; }
    .negative { color: #EF4444; font-weight: bold; }
  </style>
</head>
<body>
  <h1>АО «Россети Кубань» — Отчет по ВОЛС</h1>
  
  <div class="info-box">
    <p><strong>Отчетный период:</strong><br>
    Предыдущая неделя: ${prev.date}<br>
    Текущая неделя: ${curr.date}</p>
  </div>
  
  ${generateWordContent()}
</body>
</html>`;

    const blob = new Blob([htmlDoc], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `Отчет_ВОЛС_${curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML отчет сохранен. Откройте в Word.");
  }

  /* ==================== Экспорт презентации HTML ==================== */
  function exportPresHTML(){
    if(!DATA) return alert("Сначала проанализируйте отчёты.");
    
    const presHTML = generatePresentationHTML();
    const blob = new Blob([presHTML], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `Презентация_ВОЛС_${DATA.curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML презентация сохранена");
  }

  function generatePresentationHTML(){
    const {curr, prev, dyn} = DATA;
    
    // Получаем изображения графиков
    const imgS2 = document.getElementById("chartBranches").toDataURL("image/png");
    const imgS3 = document.getElementById("chartBranchesS3").toDataURL("image/png");
    const imgS4 = document.getElementById("chartBranchesS4").toDataURL("image/png");
    const imgRTK = document.getElementById("chartRTKDelta").toDataURL("image/png");
    
    return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Презентация ВОЛС - ${curr.date}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #0F172A;
      color: #F1F5F9;
      overflow-x: hidden;
    }
    
    .slide {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px;
      position: relative;
      background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                  #0F172A;
    }
    
    .slide-header {
      position: absolute;
      top: 40px;
      left: 60px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 20px;
      color: white;
    }
    
    .slide-number {
      position: absolute;
      bottom: 40px;
      right: 60px;
      font-size: 18px;
      color: #64748B;
    }
    
    h1 {
      font-size: 48px;
      font-weight: 800;
      text-align: center;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h2 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 30px;
      color: #F1F5F9;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      max-width: 1400px;
    }
    
    .chart-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .chart-container img {
      width: 100%;
      height: auto;
      border-radius: 12px;
    }
    
    .table-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: rgba(59, 130, 246, 0.2);
      color: #F1F5F9;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    th:not(:first-child) { text-align: right; }
    
    td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: #94A3B8;
    }
    
    td:not(:first-child) { text-align: right; }
    
    tr:hover { background: rgba(255, 255, 255, 0.03); }
    
    tfoot td {
      background: rgba(59, 130, 246, 0.1);
      font-weight: 700;
      color: #F1F5F9;
      border-top: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 30px;
      width: 100%;
      max-width: 1200px;
    }
    
    .kpi-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
    }
    
    .kpi-label {
      font-size: 14px;
      color: #94A3B8;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .kpi-value {
      font-size: 48px;
      font-weight: 800;
      margin: 10px 0;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .kpi-delta {
      font-size: 18px;
      font-weight: 600;
    }
    
    .positive { color: #10B981; }
    .negative { color: #EF4444; }
    
    @media print {
      .slide { page-break-after: always; }
    }
  </style>
</head>
<body>
  <!-- Слайд 1: Титульный -->
  <div class="slide">
    <div class="slide-header">
      <div class="logo">РК</div>
      <span style="font-size: 20px; font-weight: 600;">Россети Кубань</span>
    </div>
    <h1>Динамика ВОЛС<br>Аналитический отчет</h1>
    <p style="font-size: 24px; color: #94A3B8;">Период: ${prev.date} — ${curr.date}</p>
    <div class="slide-number">1</div>
  </div>
  
  <!-- Слайд 2: KPI -->
  <div class="slide">
    <h2>Ключевые показатели</h2>
    <div class="kpi-grid">
      ${generateKPICards()}
    </div>
    <div class="slide-number">2</div>
  </div>
  
  <!-- Слайд 3: Динамика по филиалам -->
  <div class="slide">
    <h2>Динамика по филиалам (всего)</h2>
    <div class="content-grid">
      <div class="chart-container">  /* ==================== Рендер на странице ==================== */
  let chartBranches, chartBranchesS3, chartBranchesS4, chartRTKDelta;

  function renderKpis(curr, prev, dyn){
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const items = [
      {title:"В работе всего", value:curr.p1.totals.in_work_total, delta:dyn.in_work_total, unit:"шт."},
      {title:"Выявлено за неделю", value:dyn.found_week, delta:dyn.found_week, unit:"шт."},
      {title:"Закрыто за неделю", value:eff, delta:eff, unit:"шт.", subtitle:"(узак. + демонт.)"},
      {title:"ПАО «Ростелеком»", value:curr.p1.totals.rtk_in_work, delta:dyn.rtk_in_work, unit:"шт.", subtitle:`доля ${rtkShare.toFixed(1)}%`},
    ];

    document.getElementById("kpis").innerHTML = items.map(it=>{
      const d = typeof it.delta==="number"?it.delta:0;
      const deltaClass = d>0?"positive":(d<0?"negative":"neutral");
      const sign=d>0?"+":"";
      const arrow = d>0?"↑":(d<0?"↓":"→");
      
      return `<div class="kpi-card">
        <div class="kpi-label">${it.title}</div>
        <div class="kpi-value">${fmt(it.value)} <span style="font-size:0.5em;font-weight:400;color:var(--text-secondary)">${it.unit}</span></div>
        ${it.subtitle ? `<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem">${it.subtitle}</div>` : ''}
        <div class="kpi-delta ${deltaClass}">
          <span>${arrow}</span>
          <span>${sign}${fmt(d)}</span>
        </div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(rows, tbodySel, sumPrevId, sumCurrId, sumDeltaId){
    const tbody = document.querySelector(tbodySel);
    tbody.innerHTML = "";
    let sP=0,sC=0,sD=0;
    const sorted = [...rows].sort((a,b)=>Math.abs((b.c-b.p)) - Math.abs((a.c-a.p)));
    for(const r0 of sorted){
      const p = Number(r0.p)||0, c = Number(r0.c)||0;
      const d = c - p;
      const cls = d>0?"value-positive":(d<0?"value-negative":"");
      sP+=p; sC+=c; sD+=d;
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r0.b}</td>
          <td>${fmt(p)}</td>
          <td>${fmt(c)}</td>
          <td class="${cls}">${d>0?"+":""}${fmt(d)}</td>
        </tr>`);
    }
    document.getElementById(sumPrevId).textContent = fmt(sP);
    document.getElementById(sumCurrId).textContent = fmt(sC);
    document.getElementById(sumDeltaId).textContent = (sD>0?"+":"")+fmt(sD);
    document.getElementById(sumDeltaId).className = sD>0?"value-positive":(sD<0?"value-negative":"");
  }

  function chartOpts(){
    Chart.defaults.color = '#94A3B8';
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
    
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:"top",
          labels:{
            boxWidth:12,
            usePointStyle:true,
            padding:20,
            font:{size:12}
          }
        },
        tooltip:{
          backgroundColor: 'rgba(30, 41, 59, 0.9)',
          titleColor: '#F1F5F9',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          boxWidth: 12,
          boxHeight: 12,
          usePointStyle: true
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid:{
            color:'rgba(255, 255, 255, 0.05)',
            drawBorder:false
          },
          ticks:{
            precision:0,
            padding:10
          }
        },
        x:{
          grid:{
            display:false,
            drawBorder:false
          },
          ticks:{
            padding:10
          }
        }
      },
    };
  }

  function renderCharts(curr, prev, dyn){
    const labels = BRANCHES;
    const prevS2 = labels.map(b=>prev.p2.branches.get(b)?.total||0);
    const currS2 = labels.map(b=>curr.p2.branches.get(b)?.total||0);

    if(chartBranches) chartBranches.destroy();
    chartBranches = new Chart(document.getElementById("chartBranches"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS2, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS2, backgroundColor:"rgba(59, 130, 246, 0.5)", borderColor:"rgba(59, 130, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS3 = labels.map(b=>prev.p3.branches.get(b)?.total||0);
    const currS3 = labels.map(b=>curr.p3.branches.get(b)?.total||0);
    if(chartBranchesS3) chartBranchesS3.destroy();
    chartBranchesS3 = new Chart(document.getElementById("chartBranchesS3"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS3, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS3, backgroundColor:"rgba(139, 92, 246, 0.5)", borderColor:"rgba(139, 92, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS4 = labels.map(b=>prev.p4.branches.get(b)?.total||0);
    const currS4 = labels.map(b=>curr.p4.branches.get(b)?.total||0);
    if(chartBranchesS4) chartBranchesS4.destroy();
    chartBranchesS4 = new Chart(document.getElementById("chartBranchesS4"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая неделя", data:prevS4, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"Текущая неделя", data:currS4, backgroundColor:"rgba(6, 182, 212, 0.5)", borderColor:"rgba(6, 182, 212, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const rtkD = labels.map(b => (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).c - (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).p);
    if(chartRTKDelta) chartRTKDelta.destroy();
    chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
      type:"bar",
      data:{labels, datasets:[{
        label:"Изменение (тек. − пред.)", 
        data:rtkD, 
        backgroundColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.5)":"rgba(239, 68, 68, 0.5)"),
        borderColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.8)":"rgba(239, 68, 68, 0.8)"),
        borderWidth: 1<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ВОЛС Аналитика | Россети Кубань</title>

  <!-- Шрифты -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== Глобальные переменные и токены дизайна ====== */
    :root{
      /* Основные цвета бренда */
      --primary: #1E3A8A;
      --primary-light: #3B82F6;
      --primary-dark: #1E293B;
      --accent: #06B6D4;
      --accent-glow: rgba(6, 182, 212, 0.3);
      
      /* Фоны и поверхности */
      --bg-main: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(59, 130, 246, 0.1);
      
      /* Стекломорфизм */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* Текст */
      --text-primary: #F1F5F9;
      --text-secondary: #94A3B8;
      --text-muted: #64748B;
      
      /* Статусы */
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      
      /* Эффекты */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.7);
      --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.3);
      
      /* Скругления */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* Анимации */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== Базовые стили ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* Фоновый градиент */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* ====== Шапка ====== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      transition: var(--transition);
    }

    header.scrolled {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      letter-spacing: -0.02em;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* ====== Главный контент ====== */
    main {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* ====== Сетка ====== */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .cols-4 { grid-template-columns: repeat(2, 1fr); }
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .cols-2, .cols-3, .cols-4 { grid-template-columns: 1fr; }
    }

    /* ====== Карточки ====== */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* ====== KPI карточки ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-delta {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .kpi-delta.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .kpi-delta.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .kpi-delta.neutral {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* ====== Кнопки ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px dashed var(--glass-border);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
      background: var(--glass);
    }

    /* ====== Формы ====== */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--glass);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-wrapper:hover {
      border-color: var(--primary-light);
      background: var(--bg-hover);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    /* ====== Таблицы ====== */
    .table-container {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-scroll {
      max-height: 400px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--glass-border) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 2px solid var(--glass-border);
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    tfoot td {
      background: var(--bg-secondary);
      font-weight: 700;
      color: var(--text-primary);
      padding: 1rem;
      border-top: 2px solid var(--glass-border);
    }

    /* ====== Графики ====== */
    .chart-container {
      height: 400px;
      padding: 1rem;
      background: var(--glass);
      border-radius: var(--radius-md);
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== Статусы и значки ====== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--success);
      font-weight: 600;
    }

    .value-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* ====== Анимация загрузки ====== */
    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== Сообщения ====== */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .message-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .message-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    /* ====== Секция экспорта ====== */
    .export-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    /* ====== Адаптивность ====== */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }

      .brand {
        font-size: 1rem;
      }

      .logo {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }

      main {
        margin-top: 70px;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 2rem;
      }

      .table-scroll {
        max-height: 300px;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
    }

    /* ====== Утилиты ====== */
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    /* ====== Печать ====== */
    @media print {
      body {
        background: white;
        color: black;
      }

      header {
        position: relative;
        background: white;
        border-bottom: 2px solid #000;
      }

      .card {
        background: white;
        border: 1px solid #ccc;
        box-shadow: none;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }

      .btn, .file-input-wrapper {
        display: none;
      }
    }

    /* ====== Компактный режим ====== */
    .compact .card {
      padding: 1rem;
    }

    .compact .kpi-card {
      padding: 0.75rem;
    }

    .compact .kpi-value {
      font-size: 1.75rem;
    }

    .compact table {
      font-size: 0.75rem;
    }

    .compact th, .compact td {
      padding: 0.5rem;
    }

    .compact .chart-container {
      height: 300px;
    }

    /* ====== Скрытые элементы для печати ====== */
    #presentationPrint, #summaryPrint {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Шапка -->
  <header id="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">РК</div>
        <span>ВОЛС Аналитика</span>
      </div>
      <div class="nav-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>Система активна</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Основной контент -->
  <main>
    <div class="container">
      <!-- Секция загрузки и экспорта -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">📊</div>
              Загрузка отчётов
            </h2>
          </div>
          <div class="form-group">
            <label class="file-input-wrapper">
              <div class="file-icon">📄</div>
              <span>Предыдущая неделя (PDF)</span>
              <input id="filePrev" type="file" accept="application/pdf">
            </label>
            <label class="file-input-wrapper">
              <div class="file-icon">📄</div>
              <span>Текущая неделя (PDF)</span>
              <input id="fileCurr" type="file" accept="application/pdf">
            </label>
          </div>
          <div class="form-group">
            <button id="btnParse" class="btn btn-primary">
              <span>🚀</span>
              Проанализировать
            </button>
            <button id="btnCompact" class="btn btn-ghost" title="Компактный режим">
              <span>📐</span>
              Компактный вид
            </button>
          </div>
          <div id="dates" class="message message-info" style="display:none"></div>
          <div id="loadingMsg" class="loading" style="display:none">
            <div class="loading-spinner"></div>
            <span>Обработка PDF файлов...</span>
          </div>
          <div id="errorMsg" class="message message-error" style="display:none"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">💾</div>
              Экспорт отчётов
            </h2>
          </div>
          <div class="export-section">
            <button class="btn btn-secondary" id="exportPresPDF">
              <span>📑</span>
              Презентация PDF
            </button>
            <button class="btn btn-secondary" id="exportBriefPDF">
              <span>📋</span>
              Выжимка PDF
            </button>
            <button class="btn btn-secondary" id="exportWordHTML">
              <span>📝</span>
              Отчет Word
            </button>
            <button class="btn btn-secondary" id="exportPresHTML">
              <span>🌐</span>
              Презентация HTML
            </button>
          </div>
          <div id="exportStatus" class="message message-success mt-1" style="display:none"></div>
        </div>
      </div>

      <!-- KPI секция -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">📈</div>
            Ключевые показатели
          </h2>
        </div>
        <div id="kpis" class="kpi-grid"></div>
      </div>

      <!-- Графики и таблицы стр. 2 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Динамика по филиалам</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranches"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranches">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrev">0</td>
                    <td id="sumCurr">0</td>
                    <td id="sumDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Графики и таблицы стр. 3 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Приказ №425</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS3"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 3</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS3">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrevS3">0</td>
                    <td id="sumCurrS3">0</td>
                    <td id="sumDeltaS3">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Графики и таблицы стр. 4 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">ПАО «Ростелеком»</h2>
            <span class="badge">Всего опор</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS4"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Таблица изменений</h2>
            <span class="badge">Стр. 4</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS4">
                <thead>
                  <tr>
                    <th>Филиал</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>Итого</td>
                    <td id="sumPrevS4">0</td>
                    <td id="sumCurrS4">0</td>
                    <td id="sumDeltaS4">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- График изменений РТК -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">📊</div>
            Динамика изменений ПАО «Ростелеком»
          </h2>
        </div>
        <div class="chart-container">
          <canvas id="chartRTKDelta"></canvas>
        </div>
      </div>

      <!-- Стадии -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Стадии работ</h2>
            <span class="badge">Стр. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS2">
                <thead>
                  <tr>
                    <th>Стадия</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Стадии работ</h2>
            <span class="badge">Стр. 4 (РТК)</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS4">
                <thead>
                  <tr>
                    <th>Стадия</th>
                    <th>Пред., шт.</th>
                    <th>Тек., шт.</th>
                    <th>Δ, шт.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Области для печати (скрытые) -->
  <div id="presentationPrint" style="display:none"></div>
  <div id="summaryPrint" style="display:none"></div>

  <!-- Библиотеки -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
  /* ==================== Константы и утилиты ==================== */
  const BRANCHES = [
    "Сочинские ЭС","Тимашевские ЭС","Тихорецкие ЭС","Усть-Лабинские ЭС","Юго-Западные ЭС",
    "Адыгейские ЭС","Армавирские ЭС","Краснодарские ЭС","Лабинские ЭС","Ленинградские ЭС","Славянские ЭС"
  ];
  const BRANCH_PATTERNS = [
    {name:"Сочинские ЭС", re:/Сочинские\s+ЭС/i},
    {name:"Тимашевские ЭС", re:/Тимашевские\s+ЭС/i},
    {name:"Тихорецкие ЭС", re:/Тихорецкие\s+ЭС/i},
    {name:"Усть-Лабинские ЭС", re:/Усть[\s\u00A0\u202F\-–—-]*Лабинские\s+ЭС/i},
    {name:"Юго-Западные ЭС", re:/Юго[\s\u00A0\u202F\-–—-]*Западные\s+ЭС/i},
    {name:"Адыгейские ЭС", re:/Адыгейские\s+ЭС/i},
    {name:"Армавирские ЭС", re:/Армавирские\s+ЭС/i},
    {name:"Краснодарские ЭС", re:/Краснодарские\s+ЭС/i},
    {name:"Лабинские ЭС", re:/Лабинские\s+ЭС/i},
    {name:"Ленинградские ЭС", re:/Ленинградские\s+ЭС/i},
    {name:"Славянские ЭС", re:/Славянские\s+ЭС/i},
  ];

  /* Стадии */
  const STATUS_PATTERNS = [
    {key:"work", title:"В работе у филиала", re:/В\s*работе\s*у\s*филиала/i},
    {key:"dismantled", title:"Демонтировано", re:/Демонтировано/i},
    {key:"rc_digit", title:"Договор на оформлении Россети Цифра", re:/Договор\s*на\s*оформлении\s*Россети\s*Цифра/i},
    {key:"op_sign", title:"Договор на подписании у оператора", re:/Договор\s*на\s*подписании\s*у\s*оператора/i},
    {key:"filial_appr",title:"Договор на согласовании в филиале", re:/Договор\s*на\s*согласовании\s*в\s*филиале/i},
    {key:"incl_next", title:"Будет включено в следующее доп. соглашение после подписания",
      re:/Будет\s*включено(?:[\s\S]{0,80})в(?:\s*следующее)?(?:[\s\S]{0,80})доп\.?\s*соглашение(?:[\s\S]{0,80}после\s*подписания)?/i
    },
  ];
  const STATUS_KEYS = STATUS_PATTERNS.map(s => s.key);
  const STAGE_TITLE = k => (STATUS_PATTERNS.find(s => s.key===k)||{}).title||k;

  const SHORT_STAGE_TITLES = {
    "work": "В работе",
    "dismantled": "Демонт.",
    "rc_digit": "Оформл. РЦ",
    "op_sign": "Подпись опер.",
    "filial_appr": "Согл. филиал",
    "incl_next": "В след. доп.согл."
  };
  const SHORT_STAGE_TITLE = k => SHORT_STAGE_TITLES[k] || STAGE_TITLE(k);

  const numberize = s => {
    const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
    const n = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
    if(!n) return 0;
    const val = Number(n.replace(",", "."));
    return isNaN(val) ? 0 : val;
  };
  const fmt = n => (typeof n === "number" ? n : Number(n||0)).toLocaleString("ru-RU");
  const normalize = txt => String(txt||"")
      .replace(/\u00A0|\u202F/g," ")
      .replace(/\u00AD/g,"")
      .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
      .replace(/[ \t]+/g," ")
      .trim();

  /* ==================== Чтение PDF ==================== */
  async function pdfToPages(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      let pageText = "", lastY = null;
      content.items.forEach(item => {
        const y = item.transform[5];
        if(lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
        pageText += item.str;
        lastY = y;
      });
      pages.push(normalize(pageText));
    }
    return pages;
  }

  /* ==================== Парсинг ==================== */
  function extractDateFromPages(pages){
    for(const pg of pages){
      const m = pg.match(/по состоянию на\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
    return "—";
  }

  function parseTotalsFromPage(page1){
    const find = (re) => {
      const m = page1.match(re);
      return m ? numberize(m[1]) : 0;
    };
    return {
      found_year: find(/выявлено[^0-9]*?(\d[\d\s]+)\s*шт/i),
      legalized: find(/Узаконено[^0-9]*?(\d[\d\s]+)/i),
      dismantled_ytd: find(/За\s*20\d{2}\s*год\s*демонтировано[^0-9]*?(\d[\d\s]+)/i),
      in_work_total: find(/В\s*работе[^0-9]*?всего[^0-9]*?(\d[\d\s]+)\s*шт/i),
      rtk_in_work: find(/в\s*том\s*числе\s*ПАО\s*«?Ростелеком»?[^0-9]*?(\d[\d\s]+)/i),
    };
  }

  function parseBranchTable(pageText){
    const text = normalize(pageText);
    const lines = text.split("\n").filter(Boolean);

    const idx = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      for(const bp of BRANCH_PATTERNS){
        if(bp.re.test(line)){ idx.push({i, name: bp.name}); break; }
      }
    }
    idx.push({i: lines.length, name:null});

    const branches = new Map();
    for(let k=0;k<idx.length-1;k++){
      const start = idx[k].i, end = idx[k+1].i, branchName = idx[k].name;
      if(!branchName) continue;
      const headLine = lines[start] || "";
      const segText = lines.slice(start+1, end).join(" ");

      let total = 0;
      const headNums = headLine.match(/\d[\d\s]*/g);
      if(headNums && headNums.length) total = numberize(headNums[headNums.length-1]);
      if(total===0 && lines[start+1]){
        const n2 = (lines[start+1]||"").match(/\d[\d\s]*/g);
        if(n2 && n2.length) total = numberize(n2[n2.length-1]);
      }

      const data = { total, statuses:{} };

      function numAfter(re, hay){
        const rx = new RegExp(re.source + "[^\\d]{0,200}(\\d[\\d\\s]*)", re.flags);
        const m = hay.match(rx);
        return m ? numberize(m[1]) : null;
      }

      for(const sp of STATUS_PATTERNS){
        let v = numAfter(sp.re, segText);
        if(v === null){
          for(let j=start+1;j<end;j++){
            const l0 = lines[j]||"", l1 = lines[j+1]||"";
            if(sp.re.test(l0) || sp.re.test(l1)){
              let cap = (l0.match(/(\d[\d\s]*)/g)||[]).pop();
              if(!cap) cap = (l1.match(/(\d[\d\s]*)/g)||[]).pop();
              if(cap){ v = numberize(cap); break; }
            }
          }
        }
        if(v !== null) data.statuses[sp.key] = v;
      }
      branches.set(branchName, data);
    }

    for(const b of BRANCHES){
      if(!branches.has(b)) branches.set(b, { total:0, statuses:{} });
    }

    const stages = {};
    for(const [_, obj] of branches){
      for(const [k,v] of Object.entries(obj.statuses)){
        stages[k] = (stages[k]||0) + (v||0);
      }
    }

    const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);
    return { branches, overall, stages };
  }

  function parseReportByPages(pages){
    return {
      date: extractDateFromPages(pages),
      p1: { totals: parseTotalsFromPage(pages[0] || "") },
      p2: parseBranchTable(pages[1] || ""),
      p3: parseBranchTable(pages[2] || ""),
      p4: parseBranchTable(pages[3] || ""),
    };
  }

  /* ==================== Динамика ==================== */
  function computeDynamics(curr, prev){
    const dyn = {
      in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
      rtk_in_work: (curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work) || 0,
      legalized: (curr.p1.totals.legalized - prev.p1.totals.legalized) || 0,
      dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
    };
    dyn.found_week = dyn.in_work_total;

    const makeRows = (cPage, pPage) => BRANCHES.map(b=>{
      const c = cPage.branches.get(b)?.total || 0;
      const p = pPage.branches.get(b)?.total || 0;
      return {b, p, c, d: (c - p)};
    });

    const branchRows = makeRows(curr.p2, prev.p2);
    const branchRowsS3 = makeRows(curr.p3, prev.p3);
    const branchRowsS4 = makeRows(curr.p4, prev.p4);

    const allKeys = Array.from(new Set([
      ...Object.keys(prev.p2.stages||{}), ...Object.keys(curr.p2.stages||{}),
      ...Object.keys(prev.p3.stages||{}), ...Object.keys(curr.p3.stages||{}),
      ...Object.keys(prev.p4.stages||{}), ...Object.keys(curr.p4.stages||{}),
      ...STATUS_KEYS
    ]));

    const diffStages = (cur, prv) => allKeys.map(k=>({
      stage: STAGE_TITLE(k), short: SHORT_STAGE_TITLE(k), key: k,
      p: prv[k] || 0, c: cur[k] || 0, d: (cur[k]||0) - (prv[k]||0)
    }));

    const stagesS2 = diffStages(curr.p2.stages||{}, prev.p2.stages||{});
    const stagesS4 = diffStages(curr.p4.stages||{}, prev.p4.stages||{});

    function perBranchStages(cPage, pPage){
      return BRANCHES.map(b=>{
        const cst = cPage.branches.get(b)?.statuses || {};
        const pst = pPage.branches.get(b)?.statuses || {};
        const by = {};
        STATUS_KEYS.forEach(k=>{
          const p = pst[k]||0, c = cst[k]||0;
          by[k] = {p,c,d:c-p};
        });
        return {b, by};
      });
    }
    const s2BranchStages = perBranchStages(curr.p2, prev.p2);

    return {
      ...dyn,
      branchRows,
      branchRowsS3,
      branchRowsS4,
      stagesS2,
      stagesS4,
      s2BranchStages,
      rtkRows: branchRowsS4
    };
  }pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
