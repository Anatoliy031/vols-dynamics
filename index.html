<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–≤–µ—Å–∞ –í–û–õ–° ‚Äî –†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

  <!-- –°—Ç–∏–ª–∏ (–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∏–Ω–∏–π) -->
  <style>
    :root{
      --rs-blue:#0033A0; /* –†–æ—Å—Å–µ—Ç–∏ */
      --rs-blue-2:#0A47C6;
      --rs-bg:#F5F7FB;
      --rs-text:#101828;
      --rs-muted:#667085;
      --rs-accent:#00AEEF;
      --ok:#12B76A; --warn:#F79009; --bad:#D92D20;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--rs-bg); color:var(--rs-text); line-height:1.4;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:white; border-bottom:1px solid #E5E7EB;
    }
    .container{max-width:1100px; margin:0 auto; padding:20px}
    h1{margin:0; font-size:22px; color:var(--rs-blue); letter-spacing:.2px}
    .grid{display:grid; gap:16px}
    .grid-2{grid-template-columns:1fr 1fr}
    .card{
      background:white; border:1px solid #E5E7EB; border-radius:12px; padding:16px;
      box-shadow:0 1px 2px rgba(16,24,40,.04)
    }
    label{font-size:14px; color:#334155; display:block; margin-bottom:8px}
    input[type="file"], select, input[type="number"]{
      width:100%; padding:10px 12px; border:1px solid #CBD5E1; border-radius:10px; background:#fff; font:inherit
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:12px; border:1px solid transparent; font-weight:700; cursor:pointer;
      background:var(--rs-blue); color:#fff;
    }
    .btn.secondary{background:#fff; color:var(--rs-blue); border-color:var(--rs-blue)}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .muted{color:var(--rs-muted); font-size:13px}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#EEF2FF; color:var(--rs-blue-2)}
    .log{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; white-space:pre-wrap; max-height:180px; overflow:auto; background:#0A0F1A; color:#E3E8F4; border-radius:10px; padding:12px}
    footer{border-top:1px solid #E5E7EB; margin-top:24px; padding-top:16px; color:#64748B; font-size:12px}
  </style>

  <!-- –õ–∏–±—ã: XLSX (SheetJS), PPTXGenJS, FileSaver (–Ω–∞ –≤—Å—è–∫–∏–π) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.11.1/dist/pptxgen.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–≤–µ—Å–∞ –í–û–õ–° ‚Äî –†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</h1>
      <div class="muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ <b>—Ç–µ–∫—É—â–∏–π</b> –∏ <b>–ø—Ä–µ–¥—ã–¥—É—â–∏–π</b> –æ—Ç—á—ë—Ç—ã ‚Üí –°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é</div>
    </div>
  </header>

  <main class="container">
    <div class="grid grid-2">
      <div class="card">
        <label for="fileCurr">–¢–µ–∫—É—â–∏–π –æ—Ç—á—ë—Ç (.xlsx / .csv)</label>
        <input id="fileCurr" type="file" accept=".xlsx,.xls,.csv" />
        <div class="row">
          <span class="badge">–ê–≤—Ç–æ–¥–µ—Ç–µ–∫—Ç –∫–æ–ª–æ–Ω–æ–∫: ¬´–§–∏–ª–∏–∞–ª¬ª, ¬´–°—Ç–∞—Ç—É—Å¬ª, ¬´–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ¬ª</span>
        </div>
      </div>

      <div class="card">
        <label for="filePrev">–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á—ë—Ç (.xlsx / .csv)</label>
        <input id="filePrev" type="file" accept=".xlsx,.xls,.csv" />
        <div class="row">
          <span class="badge">–ï—Å–ª–∏ ¬´–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ¬ª –Ω–µ—Ç ‚Äî —Å—á–∏—Ç–∞–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ—à—Ç—É—á–Ω–æ</span>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <div class="row" style="align-items:flex-end">
          <div style="flex:1; min-width:220px">
            <label for="maxPerSlide">–§–∏–ª–∏–∞–ª–æ–≤ –Ω–∞ —Å–ª–∞–π–¥ (–∞–≤—Ç–æ–ø–∞–≥–∏–Ω–∞—Ü–∏—è)</label>
            <input id="maxPerSlide" type="number" min="4" max="15" step="1" value="8" />
          </div>
          <div style="flex:2; min-width:280px">
            <button id="btnGenPptx" class="btn" title="–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å PPTX">
              üìä –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é (PPTX)
            </button>
            <button id="btnTest" class="btn secondary" title="–¢–µ—Å—Ç –±–µ–∑ —Ñ–∞–π–ª–æ–≤">üß™ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div><b>–õ–æ–≥</b></div>
          <div class="muted">–ó–¥–µ—Å—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Å–±–æ—Ä–∫–∏</div>
        </div>
        <div id="log" class="log"></div>
      </div>
    </div>

    <footer>
      –°–¥–µ–ª–∞–Ω–æ –ø–æ–¥ –æ—Ç—á—ë—Ç—ã –í–û–õ–°. –ö–ª—é—á–µ–≤–æ–π —Ñ–∏–∫—Å: ¬´–î–∏–Ω–∞–º–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º¬ª ‚Äî –∞–≤—Ç–æ–ø–∞–≥–∏–Ω–∞—Ü–∏—è + –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã.
    </footer>
  </main>

  <script>
    // ========== –£—Ç–∏–ª–∏—Ç—ã ==========
    const $ = sel => document.querySelector(sel);
    const log = (...args) => {
      const s = args.map(a => typeof a === 'object' ? JSON.stringify(a,null,2) : String(a)).join(' ');
      const el = $('#log'); el.textContent += s + '\n'; el.scrollTop = el.scrollHeight;
      console.log(...args);
    };

    function readFileAsArrayBuffer(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsArrayBuffer(file);
      });
    }

    function parseWorkbookToRows(bufOrFileName, arrayBuffer){
      try{
        // CSV –Ω–∞–ø—Ä—è–º—É—é
        if (typeof bufOrFileName === 'string' && bufOrFileName.toLowerCase().endsWith('.csv')) {
          const text = new TextDecoder('utf-8').decode(new Uint8Array(arrayBuffer));
          const lines = text.split(/\r?\n/).filter(Boolean);
          const headers = lines.shift().split(',').map(h => h.trim());
          return lines.map(line=>{
            const cells = line.split(',');
            const row = {};
            headers.forEach((h,i)=> row[h] = (cells[i] ?? '').trim());
            return row;
          });
        }

        // XLSX/Excel
        const wb = XLSX.read(arrayBuffer, {type:'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {defval:null, raw:true});
        return rows;
      }catch(e){
        log('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:', e.message);
        return [];
      }
    }

    // –ê–≤—Ç–æ–¥–µ—Ç–µ–∫—Ç –∫–æ–ª–æ–Ω–æ–∫: –∏—â–µ–º –ø–æ —Ä—É—Å—Å–∫–∏–º –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    function autodetectColumns(rows){
      if (!rows.length) return {branch:null,status:null,count:null};

      const headers = Object.keys(rows[0] || {}).map(String);
      const norm = s => (s||'').toString().trim().toLowerCase();

      const byScore = (name)=> {
        const n = norm(name);
        let score = 0;
        if (n.includes('—Ñ–∏–ª–∏–∞–ª')) score += 5;
        if (n.includes('–ø–æ–¥—Ä–∞–∑–¥–µ–ª')) score += 1;
        if (n === '—Ñ–∏–ª–∏–∞–ª') score += 3;
        return score;
      };
      const byStatus = (name)=> {
        const n = norm(name);
        let score = 0;
        if (n.includes('—Å—Ç–∞—Ç—É—Å')) score += 5;
        if (n.includes('—Å–æ—Å—Ç–æ—è–Ω–∏–µ')) score += 2;
        return score;
      };
      const byCount = (name)=> {
        const n = norm(name);
        let score = 0;
        if (n.includes('–∫–æ–ª–∏—á')) score += 5;
        if (n.includes('—à—Ç')) score += 2;
        if (n.includes('–≤—Å–µ–≥–æ')) score += 1;
        return score;
      };

      const pick = (scorer) => headers
        .map(h=>({h,score:scorer(h)}))
        .sort((a,b)=>b.score - a.score)[0]?.h || null;

      const branch = pick(byScore);
      const status = pick(byStatus);
      const count  = pick(byCount);

      return {branch, status, count};
    }

    // –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä: {branch}->{status}->sum
    function aggregate(rows, cols){
      const {branch,status,count} = cols;
      const agg = {};
      for (const r of rows){
        const b = (r[branch] ?? '').toString().trim() || '‚Äî';
        const s = (r[status] ?? '').toString().trim()  || '‚Äî';
        let v   = count ? Number(r[count]) : 1;
        if (!Number.isFinite(v)) v = 0;
        agg[b] ??= {};
        agg[b][s] = (agg[b][s] ?? 0) + v;
      }
      return agg;
    }

    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤/—Å—Ç–∞—Ç—É—Å–æ–≤
    function unionKeys(objA, objB){
      const set = new Set([...Object.keys(objA||{}), ...Object.keys(objB||{})]);
      return Array.from(set);
    }

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ series –¥–ª—è pptxgenjs: series[] = {name, labels[], values[]}
    function buildSeriesDelta(aggCurr, aggPrev){
      const branches = unionKeys(aggCurr, aggPrev).sort((a,b)=>a.localeCompare(b,'ru'));
      const statusSet = new Set();
      for (const b of branches){
        Object.keys(aggCurr[b] || {}).forEach(s => statusSet.add(s));
        Object.keys(aggPrev[b] || {}).forEach(s => statusSet.add(s));
      }
      const statuses = Array.from(statusSet);

      // –£–ø–æ—Ä—è–¥–æ—á–∏–º —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã —à–ª–∏ –ø–µ—Ä–≤—ã–º–∏ (—ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –ø–æ —Å—É–º–º–µ —Ç–µ–∫—É—â–∏—Ö)
      const byTotalCurr = (s) => branches.reduce((acc,b)=>acc + (aggCurr[b]?.[s] ?? 0),0);
      statuses.sort((s1,s2)=>byTotalCurr(s2) - byTotalCurr(s1));

      const series = statuses.map(s => ({
        name: s,
        labels: branches,
        values: branches.map(b => (aggCurr[b]?.[s] ?? 0) - (aggPrev[b]?.[s] ?? 0))
      }));

      return {series, branches, statuses};
    }

    // ========== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PPTX ==========
    function addTitleSlide(pptx, title, subtitle){
      const slide = pptx.addSlide();
      slide.addText(title,   {x:0.5,y:0.8,w:12,h:1,fontSize:28,bold:true,color:'0033A0'});
      slide.addText(subtitle,{x:0.5,y:1.6,w:12,h:0.6,fontSize:16,color:'334155'});
      slide.addText('vols-dynamics', {x:0.5,y:6.5,w:12,h:0.4,fontSize:10,color:'667085'});
    }

    // *** –ì–õ–ê–í–ù–´–ô –§–ò–ö–°: –∞–≤—Ç–æ—Ä–∞–∑–±–∏–µ–Ω–∏–µ + –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã ***
    function addStatusByBranchSlides(pptx, chartData, titleBase = '–î–∏–Ω–∞–º–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º', maxPerSlide = 8) {
      if (!pptx || !chartData || !chartData.length) return;

      const labels = (chartData[0].labels || []).slice();
      if (!labels.length) return;

      const MAX_BRANCHES_PER_SLIDE = Math.max(4, Math.min(15, Number(maxPerSlide)||8));
      const totalPages = Math.ceil(labels.length / MAX_BRANCHES_PER_SLIDE);

      const statusesCount = chartData.length;
      const legendFont = Math.max(8, 12 - Math.floor((statusesCount - 4) / 2)); // 12..8
      const axisFont   = 10;
      const dataLblFont= 8;

      for (let page = 0; page < totalPages; page++) {
        const start = page * MAX_BRANCHES_PER_SLIDE;
        const end   = Math.min(start + MAX_BRANCHES_PER_SLIDE, labels.length);
        const labelsPart = labels.slice(start, end);

        const dataPart = chartData.map(s => ({
          name: s.name,
          labels: labelsPart,
          values: (s.values || []).slice(start, end)
        }));

        const slide = pptx.addSlide();
        slide.addText(`${titleBase} (—Å—Ç—Ä. ${page + 1} –∏–∑ ${totalPages})`, {
          x: 0.5, y: 0.25, w: 12.5, h: 0.5,
          fontSize: 16, bold: true, color: '0033A0'
        });

        slide.addChart(pptx.ChartType.bar, dataPart, {
          x: 0.4, y: 0.9, w: 12.2, h: 5.2,
          barDir: 'bar',               // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
          barGrouping: 'clustered',
          legendPos: 'b',
          legendFontSize: legendFont,
          catAxisLabelFontSize: axisFont,
          valAxisLabelFontSize: axisFont,
          dataLabelFontSize: dataLblFont,
          dataLabelFormatCode: '0',
          showLegend: true,
          showValue: true,
          barGapWidthPct: 75
        });
      }
    }

    async function generatePPTX({rowsCurr, rowsPrev, maxPerSlide=8}){
      const colsCurr = autodetectColumns(rowsCurr);
      const colsPrev = autodetectColumns(rowsPrev);
      log('–ö–æ–ª–æ–Ω–∫–∏ (—Ç–µ–∫—É—â–∏–π):', colsCurr);
      log('–ö–æ–ª–æ–Ω–∫–∏ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π):', colsPrev);

      if (!colsCurr.branch || !colsCurr.status){
        throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ ¬´–§–∏–ª–∏–∞–ª¬ª –∏/–∏–ª–∏ ¬´–°—Ç–∞—Ç—É—Å¬ª –≤ —Ç–µ–∫—É—â–µ–º –æ—Ç—á—ë—Ç–µ.');
      }
      if (!colsPrev.branch || !colsPrev.status){
        throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ ¬´–§–∏–ª–∏–∞–ª¬ª –∏/–∏–ª–∏ ¬´–°—Ç–∞—Ç—É—Å¬ª –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç—á—ë—Ç–µ.');
      }

      const aggCurr = aggregate(rowsCurr, colsCurr);
      const aggPrev = aggregate(rowsPrev, colsPrev);
      const {series} = buildSeriesDelta(aggCurr, aggPrev);

      // PPTX
      const pptx = new PptxGenJS();
      pptx.author = 'vols-dynamics';
      pptx.company = '–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å';
      pptx.layout = 'LAYOUT_WIDE'; // 16:9

      addTitleSlide(pptx, '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –í–û–õ–°', '–î–∏–Ω–∞–º–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (—Ç–µ–∫—É—â–∏–π vs –ø—Ä–µ–¥—ã–¥—É—â–∏–π)');

      // === –ù–ê–® –§–ò–ö–° ‚Äî –≤–º–µ—Å—Ç–æ –ø—Ä–µ–∂–Ω–µ–π ¬´–Ω–µ –≤–ª–µ–∑–∞–µ—Ç¬ª –¥–∏–∞–≥—Ä–∞–º–º—ã ===
      addStatusByBranchSlides(pptx, series, '–î–∏–Ω–∞–º–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º', maxPerSlide);

      const fileName = `vols-dynamics_${new Date().toISOString().slice(0,10)}.pptx`;
      await pptx.writeFile({fileName});
      log('–ì–æ—Ç–æ–≤–æ:', fileName);
    }

    // ========== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ UI ==========
    async function handleGenerate(useTest=false){
      try{
        $('#log').textContent = '';
        const maxPerSlide = Number($('#maxPerSlide').value) || 8;

        let rowsCurr = [], rowsPrev = [];
        if (useTest){
          // –¢–µ—Å—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä (–∏–º–µ–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –∞–≤—Ç–æ–¥–µ—Ç–µ–∫—Ç–æ–º)
          rowsPrev = [
            {–§–∏–ª–∏–∞–ª:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°', –°—Ç–∞—Ç—É—Å:'–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 300},
            {–§–∏–ª–∏–∞–ª:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°', –°—Ç–∞—Ç—É—Å:'–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 50},
            {–§–∏–ª–∏–∞–ª:'–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°',  –°—Ç–∞—Ç—É—Å:'–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 120},
            {–§–∏–ª–∏–∞–ª:'–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°',  –°—Ç–∞—Ç—É—Å:'–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 25},
            {–§–∏–ª–∏–∞–ª:'–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°',–°—Ç–∞—Ç—É—Å:'–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 90},
            {–§–∏–ª–∏–∞–ª:'–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°',–°—Ç–∞—Ç—É—Å:'–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 5},
          ];
          rowsCurr = [
            {–§–∏–ª–∏–∞–ª:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°', –°—Ç–∞—Ç—É—Å:'–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 320},
            {–§–∏–ª–∏–∞–ª:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°', –°—Ç–∞—Ç—É—Å:'–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 60},
            {–§–∏–ª–∏–∞–ª:'–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°',  –°—Ç–∞—Ç—É—Å:'–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 150},
            {–§–∏–ª–∏–∞–ª:'–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°',  –°—Ç–∞—Ç—É—Å:'–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 40},
            {–§–∏–ª–∏–∞–ª:'–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°',–°—Ç–∞—Ç—É—Å:'–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 110},
            {–§–∏–ª–∏–∞–ª:'–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°',–°—Ç–∞—Ç—É—Å:'–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 9},
          ];
        } else {
          const fCurr = $('#fileCurr').files[0];
          const fPrev = $('#filePrev').files[0];
          if (!fCurr || !fPrev) throw new Error('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ —Ñ–∞–π–ª–∞: —Ç–µ–∫—É—â–∏–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π.');

          const bufCurr = await readFileAsArrayBuffer(fCurr);
          const bufPrev = await readFileAsArrayBuffer(fPrev);
          rowsCurr = parseWorkbookToRows(fCurr.name, bufCurr);
          rowsPrev = parseWorkbookToRows(fPrev.name, bufPrev);

          log(`–¢–µ–∫—É—â–∏–π: ${fCurr.name}, —Å—Ç—Ä–æ–∫: ${rowsCurr.length}`);
          log(`–ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${fPrev.name}, —Å—Ç—Ä–æ–∫: ${rowsPrev.length}`);
        }

        await generatePPTX({rowsCurr, rowsPrev, maxPerSlide});

      }catch(e){
        log('‚ùå –û—à–∏–±–∫–∞:', e.message || e);
        alert(e.message || e);
      }
    }

    $('#btnGenPptx').addEventListener('click', ()=>handleGenerate(false));
    $('#btnTest').addEventListener('click', ()=>handleGenerate(true));
  </script>
</body>
</html>
