<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ВОЛС — Еженедельная динамика (АО «Россети Кубань»)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{--rs-blue:#0033A0;--rs-light:#f4f7fb;--border:#e7edf5;--ok:#0a7a2d;--bad:#b00020;--muted:#5f6b7a;--card:#fff}
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--rs-light);color:#0b1a2b;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--rs-blue),#0953d6);color:#fff;padding:18px 20px;box-shadow:0 4px 18px rgba(0,0,0,.08)}
  .brand{display:flex;gap:14px;align-items:center;font-weight:800}
  .dot{width:14px;height:14px;border-radius:50%;background:#fff;opacity:.9}
  .container{max-width:1200px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px 16px}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  @media(max-width:1024px){.grid.cols-3{grid-template-columns:1fr}}
  @media(max-width:720px){.grid.cols-2{grid-template-columns:1fr}}
  .inputs{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:10px;border:1px dashed var(--border);background:#fff;border-radius:12px;padding:12px}
  input[type=file]{border:none}
  button.primary{background:var(--rs-blue);color:#fff;border:none;border-radius:12px;padding:12px 14px;font-weight:700;letter-spacing:.2px;cursor:pointer}
  button.secondary{background:#fff;color:#0033A0;border:1px solid #0033A0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
  h2{margin:4px 0 10px 0;font-size:20px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#f8fafc;color:#334155}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media(max-width:1024px){.kpis{grid-template-columns:repeat(2,1fr)}}
  .kpi{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .kpi .title{color:var(--muted);font-size:12px;font-weight:600}
  .kpi .value{font-size:24px;font-weight:800;margin-top:6px}
  .delta{font-size:12px;margin-top:4px}
  .up{color:var(--ok)} .down{color:#b00020} .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:right;font-variant-numeric:tabular-nums}
  th:first-child,td:first-child{text-align:left}
  tfoot td{font-weight:800}
  .exports{display:flex;flex-wrap:wrap;gap:10px}
  .hr{height:1px;background:var(--border);margin:12px 0}
  #presentationPrint,#summaryPrint{background:#fff;padding:20px}
  .logoTitle{font-weight:800;color:#0033A0;font-size:22px;margin-bottom:6px}
  .note{font-size:12px;color:#5f6b7a}
  .loading{display:none;color:#0033A0;font-weight:600;margin-top:10px}
  .loading.active{display:block}
  .error{color:#b00020;font-weight:600;margin-top:10px}
</style>
</head>
<body>
<header><div class="brand"><span class="dot"></span><span>АО «Россети Кубань» — ВОЛС: аналитика и отчётность</span></div></header>

<div class="container grid cols-2">
  <section class="card">
    <h2>Загрузка отчётов (PDF)</h2>
    <div class="inputs">
      <label class="pill">Предыдущая неделя (PDF)<input id="filePrev" type="file" accept="application/pdf"></label>
      <label class="pill">Текущая неделя (PDF)<input id="fileCurr" type="file" accept="application/pdf"></label>
      <button id="btnParse" class="primary">Проанализировать</button>
    </div>
    <div class="loading" id="loadingMsg">Обработка PDF файлов...</div>
    <div class="error" id="errorMsg"></div>
    <div class="hr"></div>
    <div id="dates" class="note">Даты отчётов: —</div>
    <div class="note" style="margin-top:6px">«Выявлено за неделю» = «В работе всего, шт.» (текущая − предыдущая).</div>
  </section>
  <section class="card">
    <h2>Выгрузки (формат Россети)</h2>
    <div class="exports">
      <button class="secondary" id="exportPresPDF">Скачать презентацию (PDF)</button>
      <button class="secondary" id="exportPresPPTX">Скачать презентацию (PPTX)</button>
      <button class="secondary" id="exportBriefDOCX">Скачать выжимку (Word)</button>
      <button class="secondary" id="exportBriefPDF">Скачать выжимку (PDF)</button>
    </div>
    <div class="note" id="exportStatus" style="margin-top:6px"></div>
  </section>
</div>

<div class="container card">
  <h2>Ключевые показатели</h2>
  <div id="kpis" class="kpis"></div>
</div>

<!-- Страница 2 -->
<div class="container grid cols-2">
  <section class="card">
    <h2>Стр. 2 — «Всего опор, шт.» по филиалам</h2>
    <span class="badge">Динамика: текущий vs предыдущий</span>
    <canvas id="chartS2"></canvas>
  </section>
  <section class="card">
    <h2>Таблица (стр. 2) — Δ «Всего опор, шт.»</h2>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="tblS2">
        <thead><tr><th>Филиал</th><th>Пред., шт.</th><th>Тек., шт.</th><th>Δ, шт.</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td>Итого</td><td id="sumPrevS2">0</td><td id="sumCurrS2">0</td><td id="sumDeltaS2">0</td></tr></tfoot>
      </table>
    </div>
  </section>
</div>

<!-- Страница 3 -->
<div class="container grid cols-2">
  <section class="card">
    <h2>Стр. 3 — Приказ №425: «Всего опор, шт.» по филиалам</h2>
    <span class="badge">Динамика: текущий vs предыдущий</span>
    <canvas id="chartS3"></canvas>
  </section>
  <section class="card">
    <h2>Таблица (стр. 3) — Δ «Всего опор, шт.»</h2>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="tblS3">
        <thead><tr><th>Филиал</th><th>Пред., шт.</th><th>Тек., шт.</th><th>Δ, шт.</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td>Итого</td><td id="sumPrevS3">0</td><td id="sumCurrS3">0</td><td id="sumDeltaS3">0</td></tr></tfoot>
      </table>
    </div>
  </section>
</div>

<!-- Страница 4 -->
<div class="container grid cols-2">
  <section class="card">
    <h2>Стр. 4 — ПАО «Ростелеком»: «Всего опор, шт.» по филиалам</h2>
    <span class="badge">Динамика: текущий vs предыдущий</span>
    <canvas id="chartS4"></canvas>
  </section>
  <section class="card">
    <h2>Таблица (стр. 4) — Δ «Всего опор, шт.»</h2>
    <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="tblS4">
        <thead><tr><th>Филиал</th><th>Пред., шт.</th><th>Тек., шт.</th><th>Δ, шт.</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td>Итого</td><td id="sumPrevS4">0</td><td id="sumCurrS4">0</td><td id="sumDeltaS4">0</td></tr></tfoot>
      </table>
    </div>
  </section>
</div>

<!-- Таблицы стадий по 2,3,4 -->
<div class="container grid cols-3">
  <section class="card">
    <h2>Стр. 2 — Стадии (прирост, н/н)</h2>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="tblStagesS2">
        <thead><tr><th>Стадия</th><th>Пред., шт.</th><th>Тек., шт.</th><th>Δ, шт.</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
  <section class="card">
    <h2>Стр. 3 — Стадии (прирост, н/н)</h2>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="tblStagesS3">
        <thead><tr><th>Стадия</th><th>Пред., шт.</th><th>Тек., шт.</th><th>Δ, шт.</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
  <section class="card">
    <h2>Стр. 4 — Стадии (прирост, н/н)</h2>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="tblStagesS4">
        <thead><tr><th>Стадия</th><th>Пред., шт.</th><th>Тек., шт.</th><th>Δ, шт.</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<!-- Печатные области -->
<div id="presentationPrint" style="display:none">
  <div class="logoTitle">АО «Россети Кубань» — Презентация (еженедельная динамика ВОЛС)</div>
  <div id="presDates" class="note" style="margin-bottom:8px"></div>
  <div id="presKpis"></div>
  <div class="hr"></div>
  <div id="presS2"></div>
  <div class="hr"></div>
  <div id="presS3"></div>
  <div class="hr"></div>
  <div id="presS4"></div>
  <div class="hr"></div>
  <div id="presStages"></div>
</div>

<div id="summaryPrint" style="display:none">
  <div class="logoTitle">Краткая выжимка для руководителя</div>
  <div id="briefDates" class="note" style="margin-bottom:8px"></div>
  <div id="briefBlocks"></div>
</div>

<!-- Библиотеки -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.12.0/pptxgen.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
/* ===== Константы и утилиты ===== */
const BRANCHES = [
  "Сочинские ЭС","Тимашевские ЭС","Тихорецкие ЭС","Усть-Лабинские ЭС","Юго-Западные ЭС",
  "Адыгейские ЭС","Армавирские ЭС","Краснодарские ЭС","Лабинские ЭС","Ленинградские ЭС","Славянские ЭС"
];

const BRANCH_PATTERNS = [
  {name:"Сочинские ЭС",      re:/Сочинские\s+ЭС/i},
  {name:"Тимашевские ЭС",    re:/Тимашевские\s+ЭС/i},
  {name:"Тихорецкие ЭС",     re:/Тихорецкие\s+ЭС/i},
  {name:"Усть-Лабинские ЭС", re:/Усть[\s\u00A0\u202F\-–—-]*Лабинские\s+ЭС/i},
  {name:"Юго-Западные ЭС",   re:/Юго[\s\u00A0\u202F\-–—-]*Западные\s+ЭС/i},
  {name:"Адыгейские ЭС",     re:/Адыгейские\s+ЭС/i},
  {name:"Армавирские ЭС",    re:/Армавирские\s+ЭС/i},
  {name:"Краснодарские ЭС",  re:/Краснодарские\s+ЭС/i},
  {name:"Лабинские ЭС",      re:/Лабинские\s+ЭС/i},
  {name:"Ленинградские ЭС",  re:/Ленинградские\s+ЭС/i},
  {name:"Славянские ЭС",     re:/Славянские\s+ЭС/i},
];

const STATUS_PATTERNS = [
  {key:"work",       title:"В работе у филиала",         re:/В\s*работе\s*у\s*филиала/i},
  {key:"dismantled", title:"Демонтировано",              re:/Демонтировано/i},
  {key:"rc_digit",   title:"Договор на оформлении Россети Цифра", re:/Договор\s*на\s*оформлении\s*Россети\s*Цифра/i},
  {key:"op_sign",    title:"Договор на подписании у оператора",   re:/Договор\s*на\s*подписании\s*у\s*оператора/i},
  {key:"filial_appr",title:"Договор на согласовании в филиале",   re:/Договор\s*на\s*согласовании\s*в\s*филиале/i},
  {key:"incl_next",  title:"Будет включено в следующее доп. соглашение", re:/Будет\s*включено[\s\S]*?соглашение/i},
];

const numberize = s => Number(String(s||"").replace(/[^\d]/g,"")) || 0;
const fmt = n => n.toLocaleString("ru-RU");

function normalize(txt){
  return String(txt||"")
    .replace(/\u00A0/g," ").replace(/\u202F/g," ").replace(/\u00AD/g,"")
    .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
    .replace(/[ \t]+/g," ").trim();
}

/* ===== Чтение PDF ===== */
async function pdfToPages(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;
  const pages = [];
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    let pageText = "", lastY = null;
    content.items.forEach(item=>{
      if(lastY!==null && Math.abs(item.transform[5]-lastY)>5) pageText+="\n";
      pageText += item.str; lastY=item.transform[5];
    });
    pages.push(normalize(pageText));
  }
  return pages;
}

/* ===== Парсинг ===== */
function extractDateFromPages(pages){
  for(const pg of pages){
    const m = pg.match(/по состоянию на\s+(\d{2}\.\d{2}\.\d{4})/i);
    if(m) return m[1];
  }
  return "—";
}

function parseTotalsFromPage(page1){
  const find = re => { const m = page1.match(re); return m ? numberize(m[1]) : 0; };
  return {
    found_year:     find(/выявлено[^0-9]*?(\d[\d\s]+)\s*шт/i),
    legalized:      find(/Узаконено[^0-9]*?(\d[\d\s]+)/i),
    dismantled_ytd: find(/За\s*20\d{2}\s*год\s*демонтировано[^0-9]*?(\d[\d\s]+)/i),
    in_work_total:  find(/В\s*работе[^0-9]*?всего[^0-9]*?(\d[\d\s]+)\s*шт/i),
    rtk_in_work:    find(/в\s*том\s*числе\s*ПАО\s*«?Ростелеком»?[^0-9]*?(\d[\d\s]+)/i),
  };
}

/* Таблица филиалов + стадии на странице */
function parseBranchTable(pageText) {
  const text = normalize(pageText);
  const lines = text.split("\n").filter(Boolean);
  const branches = new Map();

  for(let i=0;i<lines.length;i++){
    const line = lines[i];

    let branchName = null;
    for(const bp of BRANCH_PATTERNS){ if(bp.re.test(line)){ branchName=bp.name; break; } }
    if(!branchName) continue;

    // «Всего опор» — последнее число в строке или в следующей
    const nums = line.match(/\d[\d\s]*/g);
    let total = 0;
    if(nums && nums.length) total = numberize(nums[nums.length-1]);
    if(total===0 && lines[i+1]){
      const nextNums = lines[i+1].match(/\d[\d\s]*/g);
      if(nextNums && nextNums.length) total = numberize(nextNums[0]);
    }

    if(!branches.has(branchName) || branches.get(branchName).total===0){
      branches.set(branchName,{total,statuses:{}});
    }

    // собираем стадии рядом
    let j=i+1;
    while(j<lines.length && j<i+12){
      const ln = lines[j];
      if(BRANCH_PATTERNS.some(bp=>bp.re.test(ln))) break;
      for(const sp of STATUS_PATTERNS){
        if(sp.re.test(ln)){
          const ns = ln.match(/\d[\d\s]*/g);
          if(ns && ns.length){
            branches.get(branchName).statuses[sp.key] = numberize(ns[ns.length-1]);
          }
        }
      }
      j++;
    }
  }

  for(const b of BRANCHES){ if(!branches.has(b)) branches.set(b,{total:0,statuses:{}}); }
  const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);

  // агрегаты стадий по странице (сумма по филиалам)
  const stages = {};
  for(const v of branches.values()){
    for(const [k,val] of Object.entries(v.statuses)){ stages[k]=(stages[k]||0)+val; }
  }
  return { branches, overall, stages };
}

/* Отчёт целиком */
function parseReportByPages(pages){
  return {
    date: extractDateFromPages(pages),
    p1: { totals: parseTotalsFromPage(pages[0]||"") },
    p2: parseBranchTable(pages[1]||""),
    p3: parseBranchTable(pages[2]||""),
    p4: parseBranchTable(pages[3]||""),
  };
}

/* ===== Вычисление динамики ===== */
function computeDynamics(curr, prev){
  const dyn = {
    in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
    rtk_in_work:   (curr.p1.totals.rtk_in_work   - prev.p1.totals.rtk_in_work)   || 0,
    legalized:     (curr.p1.totals.legalized     - prev.p1.totals.legalized)     || 0,
    dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
  };
  dyn.found_week = dyn.in_work_total;

  const makeRows = (cPage,pPage)=>BRANCHES.map(b=>{
    const c = cPage.branches.get(b)?.total||0;
    const p = pPage.branches.get(b)?.total||0;
    return {b,p,c,d:c-p};
  });

  const branchS2 = makeRows(curr.p2, prev.p2);
  const branchS3 = makeRows(curr.p3, prev.p3);
  const branchS4 = makeRows(curr.p4, prev.p4);

  const titleByKey = k => (STATUS_PATTERNS.find(s=>s.key===k)||{}).title || k;
  const keys = Array.from(new Set([
    ...Object.keys(prev.p2.stages||{}),...Object.keys(curr.p2.stages||{}),
    ...Object.keys(prev.p3.stages||{}),...Object.keys(curr.p3.stages||{}),
    ...Object.keys(prev.p4.stages||{}),...Object.keys(curr.p4.stages||{})
  ]));

  const stages = (cp,pp)=>keys.map(k=>({stage:titleByKey(k),key:k,p:(pp[k]||0),c:(cp[k]||0),d:(cp[k]||0)-(pp[k]||0)}))
                               .filter(x=>x.p>0||x.c>0);

  const stagesS2 = stages(curr.p2.stages||{}, prev.p2.stages||{});
  const stagesS3 = stages(curr.p3.stages||{}, prev.p3.stages||{});
  const stagesS4 = stages(curr.p4.stages||{}, prev.p4.stages||{});

  return {...dyn, branchS2, branchS3, branchS4, stagesS2, stagesS3, stagesS4};
}

/* ===== Рендер ===== */
let chartS2, chartS3, chartS4;

function renderKpis(curr, prev, dyn){
  const rtkShare = curr.p1.totals.in_work_total
      ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

  const items = [
    {title:"В работе всего, шт.", curr:curr.p1.totals.in_work_total, delta:dyn.in_work_total},
    {title:"Выявлено за неделю, шт.", curr:dyn.found_week, delta:dyn.found_week},
    {title:"Закрыто за неделю (узак.+демонт.), шт.", curr:(curr.p1.totals.legalized+curr.p1.totals.dismantled_ytd)-(prev.p1.totals.legalized+prev.p1.totals.dismantled_ytd), delta:(curr.p1.totals.legalized+curr.p1.totals.dismantled_ytd)-(prev.p1.totals.legalized+prev.p1.totals.dismantled_ytd)},
    {title:"ПАО «Ростелеком» в работе, шт. (доля, %)", curr:`${fmt(curr.p1.totals.rtk_in_work)} (${rtkShare.toFixed(1)}%)`, delta:dyn.rtk_in_work},
  ];

  document.getElementById("kpis").innerHTML = items.map(it=>{
    const d = typeof it.delta==="number"?it.delta:0, cls=d>0?"up":(d<0?"down":"muted"), sign=d>0?"+":"";
    return `<div class="kpi"><div class="title">${it.title}</div><div class="value">${typeof it.curr==="number"?fmt(it.curr):it.curr}</div><div class="delta ${cls}">${sign}${fmt(d)} н/н</div></div>`;
  }).join("");
}

function renderTable(rows, ids){
  const tbody = document.querySelector(ids.tbody);
  tbody.innerHTML = "";
  let sP=0,sC=0,sD=0;
  for(const r of rows){
    const cls = r.d>0?"up":(r.d<0?"down":"muted");
    sP+=r.p; sC+=r.c; sD+=r.d;
    tbody.insertAdjacentHTML("beforeend",
      `<tr><td>${r.b}</td><td>${fmt(r.p)}</td><td>${fmt(r.c)}</td><td class="${cls}">${r.d>0?"+":""}${fmt(r.d)}</td></tr>`);
  }
  document.getElementById(ids.sumPrev).textContent = fmt(sP);
  document.getElementById(ids.sumCurr).textContent = fmt(sC);
  document.getElementById(ids.sumDelta).textContent = (sD>0?"+":"")+fmt(sD);
}

function renderChart(canvasId, prevVals, currVals){
  const labels = BRANCHES;
  if(window[canvasId]) window[canvasId].destroy();
  window[canvasId] = new Chart(document.getElementById(canvasId), {
    type:"bar",
    data:{labels,datasets:[
      {label:"Пред. неделя", data:prevVals, backgroundColor:"#94a3b8"},
      {label:"Тек. неделя",  data:currVals, backgroundColor:"#0033A0"},
    ]},
    options:{responsive:true,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:true}}}
  });
}

function renderStagesTable(rows, tableSelector){
  const tbody = document.querySelector(tableSelector+" tbody");
  tbody.innerHTML = rows.map(r=>{
    const cls=r.d>0?"up":(r.d<0?"down":"muted");
    return `<tr><td>${r.stage}</td><td>${fmt(r.p)}</td><td>${fmt(r.c)}</td><td class="${cls}">${r.d>0?"+":""}${fmt(r.d)}</td></tr>`;
  }).join("");
}

/* ===== Презентация (HTML -> PDF) ===== */
function tblHTML(title, rows, sums){
  return `
    <div style="font-weight:700;margin:8px 0">${title}</div>
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead><tr><th style="text-align:left;border-bottom:1px solid #e7edf5;padding:6px 4px">Филиал</th>
      <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Пред.</th>
      <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Тек.</th>
      <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Δ</th></tr></thead>
      <tbody>
        ${rows.map(r=>`<tr><td style="padding:6px 4px">${r.b}</td><td style="padding:6px 4px;text-align:right">${fmt(r.p)}</td><td style="padding:6px 4px;text-align:right">${fmt(r.c)}</td><td style="padding:6px 4px;text-align:right;color:${r.d>0?'#0a7a2d':(r.d<0?'#b00020':'#5f6b7a')}">${r.d>0?'+':''}${fmt(r.d)}</td></tr>`).join("")}
      </tbody>
      <tfoot><tr><td style="padding:6px 4px;font-weight:800">Итого</td>
      <td style="padding:6px 4px;text-align:right;font-weight:800">${fmt(sums.prev)}</td>
      <td style="padding:6px 4px;text-align:right;font-weight:800">${fmt(sums.curr)}</td>
      <td style="padding:6px 4px;text-align:right;font-weight:800">${sums.delta>0?'+':''}${fmt(sums.delta)}</td></tr></tfoot>
    </table>`;
}

function stagesHTML(title, rows){
  return `
    <div style="font-weight:700;margin:8px 0">${title}</div>
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead><tr><th style="text-align:left;border-bottom:1px solid #e7edf5;padding:6px 4px">Стадия</th><th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Пред.</th><th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Тек.</th><th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Δ</th></tr></thead>
      <tbody>${rows.map(r=>`<tr><td style="padding:6px 4px">${r.stage}</td><td style="padding:6px 4px;text-align:right">${fmt(r.p)}</td><td style="padding:6px 4px;text-align:right">${fmt(r.c)}</td><td style="padding:6px 4px;text-align:right;color:${r.d>0?'#0a7a2d':(r.d<0?'#b00020':'#5f6b7a')}">${r.d>0?'+':''}${fmt(r.d)}</td></tr>`).join("")}</tbody>
    </table>`;
}

function buildPresentationHTML(curr, prev, dyn, sums){
  document.getElementById("presDates").textContent = `Пред.: ${prev.date} · Тек.: ${curr.date}`;
  const eff = (curr.p1.totals.legalized+curr.p1.totals.dismantled_ytd)-(prev.p1.totals.legalized+prev.p1.totals.dismantled_ytd);
  const rtkShare = curr.p1.totals.in_work_total?(curr.p1.totals.rtk_in_work/curr.p1.totals.in_work_total*100):0;

  const box=(t,val,delta)=>`<div style="border:1px solid #e7edf5;border-radius:10px;padding:10px;margin:6px 0">
      <div style="color:#5f6b7a;font-size:12px">${t}</div>
      <div style="font-weight:800;font-size:18px">${typeof val==="number"?fmt(val):val}</div>
      <div style="font-size:12px;color:${delta>0?'#0a7a2d':(delta<0?'#b00020':'#5f6b7a')}">${delta>0?'+':''}${fmt(delta)} н/н</div></div>`;

  document.getElementById("presKpis").innerHTML =
    box("В работе всего, шт.", curr.p1.totals.in_work_total, dyn.in_work_total) +
    box("Выявлено за неделю, шт.", dyn.found_week, dyn.found_week) +
    box("Закрыто за неделю (узак.+демонт.), шт.", eff, eff) +
    box("ПАО «Ростелеком» в работе, шт. (доля, %)", `${fmt(curr.p1.totals.rtk_in_work)} (${rtkShare.toFixed(1)}%)`, dyn.rtk_in_work);

  document.getElementById("presS2").innerHTML = tblHTML("Стр. 2 — Δ по филиалам", dyn.branchS2, sums.s2);
  document.getElementById("presS3").innerHTML = tblHTML("Стр. 3 — Δ по филиалам", dyn.branchS3, sums.s3);
  document.getElementById("presS4").innerHTML = tblHTML("Стр. 4 — Δ по филиалам", dyn.branchS4, sums.s4);

  document.getElementById("presStages").innerHTML =
    stagesHTML("Стр. 2 — Стадии (прирост)", dyn.stagesS2) +
    stagesHTML("Стр. 3 — Стадии (прирост)", dyn.stagesS3) +
    stagesHTML("Стр. 4 — Стадии (прирост)", dyn.stagesS4);
}

async function exportPresPDF(){
  const el = document.getElementById("presentationPrint");
  el.style.display="block";
  await html2pdf().from(el).set({margin:10,filename:"Презентация_ВОЛС.pdf",image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4'}}).save();
  el.style.display="none";
}

/* ===== Взаимодействие ===== */
let DATA=null;

document.getElementById("btnParse").addEventListener("click", async ()=>{
  const fPrev=document.getElementById("filePrev").files[0];
  const fCurr=document.getElementById("fileCurr").files[0];
  if(!fPrev||!fCurr){document.getElementById("errorMsg").textContent="Загрузите оба PDF: предыдущий и текущий.";return;}
  try{
    document.getElementById("loadingMsg").classList.add("active");
    document.getElementById("errorMsg").textContent="";
    const [pPrev,pCurr]=await Promise.all([pdfToPages(fPrev), pdfToPages(fCurr)]);
    const prev=parseReportByPages(pPrev), curr=parseReportByPages(pCurr);
    const dyn=computeDynamics(curr, prev); DATA={prev,curr,dyn};

    document.getElementById("dates").textContent = `Предыдущий: ${prev.date} · Текущий: ${curr.date}`;
    renderKpis(curr, prev, dyn);

    // Таблицы и графики по всем страницам
    renderTable(dyn.branchS2, {tbody:"#tblS2 tbody", sumPrev:"sumPrevS2", sumCurr:"sumCurrS2", sumDelta:"sumDeltaS2"});
    renderChart("chartS2", BRANCHES.map(b=>prev.p2.branches.get(b)?.total||0), BRANCHES.map(b=>curr.p2.branches.get(b)?.total||0));

    renderTable(dyn.branchS3, {tbody:"#tblS3 tbody", sumPrev:"sumPrevS3", sumCurr:"sumCurrS3", sumDelta:"sumDeltaS3"});
    renderChart("chartS3", BRANCHES.map(b=>prev.p3.branches.get(b)?.total||0), BRANCHES.map(b=>curr.p3.branches.get(b)?.total||0));

    renderTable(dyn.branchS4, {tbody:"#tblS4 tbody", sumPrev:"sumPrevS4", sumCurr:"sumCurrS4", sumDelta:"sumDeltaS4"});
    renderChart("chartS4", BRANCHES.map(b=>prev.p4.branches.get(b)?.total||0), BRANCHES.map(b=>curr.p4.branches.get(b)?.total||0));

    // Стадии
    renderStagesTable(dyn.stagesS2, "#tblStagesS2");
    renderStagesTable(dyn.stagesS3, "#tblStagesS3");
    renderStagesTable(dyn.stagesS4, "#tblStagesS4");

    // Для презентации подготовим суммы
    const sums = (rows)=>rows.reduce((a,r)=>({prev:a.prev+r.p,curr:a.curr+r.c,delta:a.delta+r.d}),{prev:0,curr:0,delta:0});
    const sumPack = { s2: sums(dyn.branchS2), s3: sums(dyn.branchS3), s4: sums(dyn.branchS4) };
    buildPresentationHTML(curr, prev, dyn, sumPack);

    // Выжимка (всё по филиалам, без «ТОП-3» и без коэффициента)
    const blocks=document.getElementById("briefBlocks");
    document.getElementById("briefDates").textContent=`Предыдущий: ${prev.date} · Текущий: ${curr.date}`;
    const eff=(curr.p1.totals.legalized+curr.p1.totals.dismantled_ytd)-(prev.p1.totals.legalized+prev.p1.totals.dismantled_ytd);
    blocks.innerHTML = `
      <h3>Стр. 1 — Общая (нарастающим)</h3>
      <div>• В работе всего: <b>${fmt(curr.p1.totals.in_work_total)}</b> (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)} н/н)</div>
      <div>• Выявлено за неделю: <b>${fmt(dyn.found_week)}</b> (расчёт от «в работе всего»)</div>
      <div>• Закрыто за неделю (узак.+демонт.): <b>${fmt(eff)}</b></div>
      <div>• ПАО «Ростелеком» в работе: <b>${fmt(curr.p1.totals.rtk_in_work)}</b> (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</div>
      <hr/>
      <h3>Стр. 2 — Δ по филиалам</h3>
      ${dyn.branchS2.map(r=>`<div>• ${r.b}: ${fmt(r.p)} → <b>${fmt(r.c)}</b> (${r.d>0?'+':''}${fmt(r.d)})</div>`).join("")}
      <div style="margin-top:6px"><b>Итого:</b> пред. ${document.getElementById("sumPrevS2").textContent}; тек. ${document.getElementById("sumCurrS2").textContent}; Δ ${document.getElementById("sumDeltaS2").textContent}</div>
      <hr/>
      <h3>Стр. 3 — Δ по филиалам</h3>
      ${dyn.branchS3.map(r=>`<div>• ${r.b}: ${fmt(r.p)} → <b>${fmt(r.c)}</b> (${r.d>0?'+':''}${fmt(r.d)})</div>`).join("")}
      <div style="margin-top:6px"><b>Итого:</b> пред. ${document.getElementById("sumPrevS3").textContent}; тек. ${document.getElementById("sumCurrS3").textContent}; Δ ${document.getElementById("sumDeltaS3").textContent}</div>
      <hr/>
      <h3>Стр. 4 — Δ по филиалам (ПАО «Ростелеком»)</h3>
      ${dyn.branchS4.map(r=>`<div>• ${r.b}: ${fmt(r.p)} → <b>${fmt(r.c)}</b> (${r.d>0?'+':''}${fmt(r.d)})</div>`).join("")}
      <div style="margin-top:6px"><b>Итого:</b> пред. ${document.getElementById("sumPrevS4").textContent}; тек. ${document.getElementById("sumCurrS4").textContent}; Δ ${document.getElementById("sumDeltaS4").textContent}</div>
      <hr/>
      <h3>Стадии (прирост, н/н)</h3>
      <div><b>Стр. 2:</b><br/>${dyn.stagesS2.map(s=>`• ${s.stage}: ${fmt(s.p)} → <b>${fmt(s.c)}</b> (${s.d>0?'+':''}${fmt(s.d)})`).join("<br/>")||"—"}</div>
      <div style="margin-top:6px"><b>Стр. 3:</b><br/>${dyn.stagesS3.map(s=>`• ${s.stage}: ${fmt(s.p)} → <b>${fmt(s.c)}</b> (${s.d>0?'+':''}${fmt(s.d)})`).join("<br/>")||"—"}</div>
      <div style="margin-top:6px"><b>Стр. 4:</b><br/>${dyn.stagesS4.map(s=>`• ${s.stage}: ${fmt(s.p)} → <b>${fmt(s.c)}</b> (${s.d>0?'+':''}${fmt(s.d)})`).join("<br/>")||"—"}</div>
    `;

    document.getElementById("loadingMsg").classList.remove("active");
  }catch(e){
    console.error(e);
    document.getElementById("loadingMsg").classList.remove("active");
    document.getElementById("errorMsg").textContent="Ошибка разбора PDF. Проверьте формат отчётов.";
  }
});

/* Экспортеры: без изменений по просьбе */
document.getElementById("exportPresPDF").addEventListener("click", async ()=>{
  if(!DATA){alert("Сначала проанализируйте отчёты.");return;}
  await exportPresPDF();
});
document.getElementById("exportPresPPTX").addEventListener("click", async ()=>{
  if(!DATA){alert("Сначала проанализируйте отчёты.");return;}
  // оставлено без изменений (будет доработано позже)
});
document.getElementById("exportBriefDOCX").addEventListener("click", async ()=>{
  if(!DATA){alert("Сначала проанализируйте отчёты.");return;}
  // оставлено без изменений (будет доработано позже)
});
document.getElementById("exportBriefPDF").addEventListener("click", async ()=>{
  if(!DATA){alert("Сначала проанализируйте отчёты.");return;}
  const el=document.getElementById("summaryPrint");
  el.style.display="block";
  await html2pdf().from(el).set({margin:10,filename:"Выжимка_ВОЛС.pdf",image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4'}}).save();
  el.style.display="none";
});
</script>
</body>
</html>
