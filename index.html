<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–û–õ–° –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | –†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ç–æ–∫–µ–Ω—ã –¥–∏–∑–∞–π–Ω–∞ ====== */
    :root{
      /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ –±—Ä–µ–Ω–¥–∞ */
      --primary: #1E3A8A;
      --primary-light: #3B82F6;
      --primary-dark: #1E293B;
      --accent: #06B6D4;
      --accent-glow: rgba(6, 182, 212, 0.3);
      
      /* –§–æ–Ω—ã –∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ */
      --bg-main: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(59, 130, 246, 0.1);
      
      /* –°—Ç–µ–∫–ª–æ–º–æ—Ä—Ñ–∏–∑–º */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* –¢–µ–∫—Å—Ç */
      --text-primary: #F1F5F9;
      --text-secondary: #94A3B8;
      --text-muted: #64748B;
      
      /* –°—Ç–∞—Ç—É—Å—ã */
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      
      /* –≠—Ñ—Ñ–µ–∫—Ç—ã */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.7);
      --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.3);
      
      /* –°–∫—Ä—É–≥–ª–µ–Ω–∏—è */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* –§–æ–Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* ====== –®–∞–ø–∫–∞ ====== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      transition: var(--transition);
    }

    header.scrolled {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      letter-spacing: -0.02em;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* ====== –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç ====== */
    main {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* ====== –°–µ—Ç–∫–∞ ====== */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .cols-4 { grid-template-columns: repeat(2, 1fr); }
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .cols-2, .cols-3, .cols-4 { grid-template-columns: 1fr; }
    }

    /* ====== –ö–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* ====== KPI –∫–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-delta {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .kpi-delta.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .kpi-delta.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .kpi-delta.neutral {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* ====== –ö–Ω–æ–ø–∫–∏ ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px dashed var(--glass-border);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
      background: var(--glass);
    }

    /* ====== –§–æ—Ä–º—ã ====== */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--glass);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-wrapper:hover {
      border-color: var(--primary-light);
      background: var(--bg-hover);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    /* ====== –¢–∞–±–ª–∏—Ü—ã ====== */
    .table-container {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-scroll {
      max-height: 400px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--glass-border) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 2px solid var(--glass-border);
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    tfoot td {
      background: var(--bg-secondary);
      font-weight: 700;
      color: var(--text-primary);
      padding: 1rem;
      border-top: 2px solid var(--glass-border);
    }

    /* ====== –ì—Ä–∞—Ñ–∏–∫–∏ ====== */
    .chart-container {
      height: 400px;
      padding: 1rem;
      background: var(--glass);
      border-radius: var(--radius-md);
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== –°—Ç–∞—Ç—É—Å—ã –∏ –∑–Ω–∞—á–∫–∏ ====== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--success);
      font-weight: 600;
    }

    .value-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* ====== –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ ====== */
    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== –°–æ–æ–±—â–µ–Ω–∏—è ====== */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .message-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .message-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    /* ====== –°–µ–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ====== */
    .export-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    /* ====== –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å ====== */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }

      .brand {
        font-size: 1rem;
      }

      .logo {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }

      main {
        margin-top: 70px;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 2rem;
      }

      .table-scroll {
        max-height: 300px;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
    }

    /* ====== –£—Ç–∏–ª–∏—Ç—ã ====== */
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    /* ====== –ü–µ—á–∞—Ç—å ====== */
    @media print {
      body {
        background: white;
        color: black;
      }

      header {
        position: relative;
        background: white;
        border-bottom: 2px solid #000;
      }

      .card {
        background: white;
        border: 1px solid #ccc;
        box-shadow: none;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }

      .btn, .file-input-wrapper {
        display: none;
      }
    }

    /* ====== –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º ====== */
    .compact .card {
      padding: 1rem;
    }

    .compact .kpi-card {
      padding: 0.75rem;
    }

    .compact .kpi-value {
      font-size: 1.75rem;
    }

    .compact table {
      font-size: 0.75rem;
    }

    .compact th, .compact td {
      padding: 0.5rem;
    }

    .compact .chart-container {
      height: 300px;
    }

    /* ====== –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–µ—á–∞—Ç–∏ ====== */
    #presentationPrint, #summaryPrint {
      display: none;
    }
  </style>
</head>
<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header id="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">–†–ö</div>
        <span>–í–û–õ–° –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
      </div>
      <div class="nav-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
        </div>
      </div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main>
    <div class="container">
      <!-- –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">üìä</div>
              –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤
            </h2>
          </div>
          <div class="form-group">
            <label class="file-input-wrapper">
              <div class="file-icon">üìÑ</div>
              <span>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)</span>
              <input id="filePrev" type="file" accept="application/pdf">
            </label>
            <label class="file-input-wrapper">
              <div class="file-icon">üìÑ</div>
              <span>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)</span>
              <input id="fileCurr" type="file" accept="application/pdf">
            </label>
          </div>
          <div class="form-group">
            <button id="btnParse" class="btn btn-primary">
              <span>üöÄ</span>
              –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button id="btnCompact" class="btn btn-ghost" title="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º">
              <span>üìê</span>
              –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥
            </button>
          </div>
          <div id="dates" class="message message-info" style="display:none"></div>
          <div id="loadingMsg" class="loading" style="display:none">
            <div class="loading-spinner"></div>
            <span>–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF —Ñ–∞–π–ª–æ–≤...</span>
          </div>
          <div id="errorMsg" class="message message-error" style="display:none"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">üíæ</div>
              –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤
            </h2>
          </div>
          <div class="export-section">
            <button class="btn btn-secondary" id="exportPresPDF">
              <span>üìë</span>
              –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è PDF
            </button>
            <button class="btn btn-secondary" id="exportBriefPDF">
              <span>üìã</span>
              –í—ã–∂–∏–º–∫–∞ PDF
            </button>
            <button class="btn btn-secondary" id="exportWordHTML">
              <span>üìù</span>
              –û—Ç—á–µ—Ç Word
            </button>
            <button class="btn btn-secondary" id="exportPresHTML">
              <span>üåê</span>
              –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è HTML
            </button>
          </div>
          <div id="exportStatus" class="message message-success mt-1" style="display:none"></div>
        </div>
      </div>

      <!-- KPI —Å–µ–∫—Ü–∏—è -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">üìà</div>
            –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
          </h2>
        </div>
        <div id="kpis" class="kpi-grid"></div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 2 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranches"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranches">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrev">0</td>
                    <td id="sumCurr">0</td>
                    <td id="sumDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 3 -->
      <div class="grid cols-2 mb-2">
/* ==================== –†–µ–Ω–¥–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ==================== */
  let chartBranches, chartBranchesS3, chartBranchesS4, chartRTKDelta;

  function renderKpis(curr, prev, dyn){
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const items = [
      {title:"–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ", value:curr.p1.totals.in_work_total, delta:dyn.in_work_total, unit:"—à—Ç."},
      {title:"–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value:dyn.found_week, delta:dyn.found_week, unit:"—à—Ç."},
      {title:"–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value:eff, delta:eff, unit:"—à—Ç.", subtitle:"(—É–∑–∞–∫. + –¥–µ–º–æ–Ω—Ç.)"},
      {title:"–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", value:curr.p1.totals.rtk_in_work, delta:dyn.rtk_in_work, unit:"—à—Ç.", subtitle:`–¥–æ–ª—è ${rtkShare.toFixed(1)}%`},
    ];

    document.getElementById("kpis").innerHTML = items.map(it=>{
      const d = typeof it.delta==="number"?it.delta:0;
      const deltaClass = d>0?"positive":(d<0?"negative":"neutral");
      const sign=d>0?"+":"";
      const arrow = d>0?"‚Üë":(d<0?"‚Üì":"‚Üí");
      
      return `<div class="kpi-card">
        <div class="kpi-label">${it.title}</div>
        <div class="kpi-value">${fmt(it.value)} <span style="font-size:0.5em;font-weight:400;color:var(--text-secondary)">${it.unit}</span></div>
        ${it.subtitle ? `<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem">${it.subtitle}</div>` : ''}
        <div class="kpi-delta ${deltaClass}">
          <span>${arrow}</span>
          <span>${sign}${fmt(d)}</span>
        </div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(rows, tbodySel, sumPrevId, sumCurrId, sumDeltaId){
    const tbody = document.querySelector(tbodySel);
    tbody.innerHTML = "";
    let sP=0,sC=0,sD=0;
    const sorted = [...rows].sort((a,b)=>Math.abs((b.c-b.p)) - Math.abs((a.c-a.p)));
    for(const r0 of sorted){
      const p = Number(r0.p)||0, c = Number(r0.c)||0;
      const d = c - p;
      const cls = d>0?"value-positive":(d<0?"value-negative":"");
      sP+=p; sC+=c; sD+=d;
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r0.b}</td>
          <td>${fmt(p)}</td>
          <td>${fmt(c)}</td>
          <td class="${cls}">${d>0?"+":""}${fmt(d)}</td>
        </tr>`);
    }
    document.getElementById(sumPrevId).textContent = fmt(sP);
    document.getElementById(sumCurrId).textContent = fmt(sC);
    document.getElementById(sumDeltaId).textContent = (sD>0?"+":"")+fmt(sD);
    document.getElementById(sumDeltaId).className = sD>0?"value-positive":(sD<0?"value-negative":"");
  }

  function chartOpts(){
    Chart.defaults.color = '#94A3B8';
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
    
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:"top",
          labels:{
            boxWidth:12,
            usePointStyle:true,
            padding:20,
            font:{size:12}
          }
        },
        tooltip:{
          backgroundColor: 'rgba(30, 41, 59, 0.9)',
          titleColor: '#F1F5F9',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          boxWidth: 12,
          boxHeight: 12,
          usePointStyle: true
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid:{
            color:'rgba(255, 255, 255, 0.05)',
            drawBorder:false
          },
          ticks:{
            precision:0,
            padding:10
          }
        },
        x:{
          grid:{
            display:false,
            drawBorder:false
          },
          ticks:{
            padding:10
          }
        }
      },
    };
  }

  function renderCharts(curr, prev, dyn){
    const labels = BRANCHES;
    const prevS2 = labels.map(b=>prev.p2.branches.get(b)?.total||0);
    const currS2 = labels.map(b=>curr.p2.branches.get(b)?.total||0);

    if(chartBranches) chartBranches.destroy();
    chartBranches = new Chart(document.getElementById("chartBranches"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS2, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS2, backgroundColor:"rgba(59, 130, 246, 0.5)", borderColor:"rgba(59, 130, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS3 = labels.map(b=>prev.p3.branches.get(b)?.total||0);
    const currS3 = labels.map(b=>curr.p3.branches.get(b)?.total||0);
    if(chartBranchesS3) chartBranchesS3.destroy();
    chartBranchesS3 = new Chart(document.getElementById("chartBranchesS3"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS3, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS3, backgroundColor:"rgba(139, 92, 246, 0.5)", borderColor:"rgba(139, 92, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS4 = labels.map(b=>prev.p4.branches.get(b)?.total||0);
    const currS4 = labels.map(b=>curr.p4.branches.get(b)?.total||0);
    if(chartBranchesS4) chartBranchesS4.destroy();
    chartBranchesS4 = new Chart(document.getElementById("chartBranchesS4"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS4, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS4, backgroundColor:"rgba(6, 182, 212, 0.5)", borderColor:"rgba(6, 182, 212, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const rtkD = labels.map(b => (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).c - (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).p);
    if(chartRTKDelta) chartRTKDelta.destroy();
    chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
      type:"bar",
      data:{labels, datasets:[{
        label:"–ò–∑–º–µ–Ω–µ–Ω–∏–µ (—Ç–µ–∫. ‚àí –ø—Ä–µ–¥.)", 
        data:rtkD, 
        backgroundColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.5)":"rgba(239, 68, 68, 0.<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–û–õ–° –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | –†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ç–æ–∫–µ–Ω—ã –¥–∏–∑–∞–π–Ω–∞ ====== */
    :root{
      /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ –±—Ä–µ–Ω–¥–∞ */
      --primary: #1E3A8A;
      --primary-light: #3B82F6;
      --primary-dark: #1E293B;
      --accent: #06B6D4;
      --accent-glow: rgba(6, 182, 212, 0.3);
      
      /* –§–æ–Ω—ã –∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ */
      --bg-main: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(59, 130, 246, 0.1);
      
      /* –°—Ç–µ–∫–ª–æ–º–æ—Ä—Ñ–∏–∑–º */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* –¢–µ–∫—Å—Ç */
      --text-primary: #F1F5F9;
      --text-secondary: #94A3B8;
      --text-muted: #64748B;
      
      /* –°—Ç–∞—Ç—É—Å—ã */
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      
      /* –≠—Ñ—Ñ–µ–∫—Ç—ã */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.7);
      --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.3);
      
      /* –°–∫—Ä—É–≥–ª–µ–Ω–∏—è */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* –§–æ–Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* ====== –®–∞–ø–∫–∞ ====== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      transition: var(--transition);
    }

    header.scrolled {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      letter-spacing: -0.02em;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* ====== –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç ====== */
    main {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* ====== –°–µ—Ç–∫–∞ ====== */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .cols-4 { grid-template-columns: repeat(2, 1fr); }
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .cols-2, .cols-3, .cols-4 { grid-template-columns: 1fr; }
    }

    /* ====== –ö–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* ====== KPI –∫–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-delta {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .kpi-delta.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .kpi-delta.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .kpi-delta.neutral {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* ====== –ö–Ω–æ–ø–∫–∏ ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px dashed var(--glass-border);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
      background: var(--glass);
    }

    /* ====== –§–æ—Ä–º—ã ====== */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--glass);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-wrapper:hover {
      border-color: var(--primary-light);
      background: var(--bg-hover);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    /* ====== –¢–∞–±–ª–∏—Ü—ã ====== */
    .table-container {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-scroll {
      max-height: 400px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--glass-border) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 2px solid var(--glass-border);
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    tfoot td {
      background: var(--bg-secondary);
      font-weight: 700;
      color: var(--text-primary);
      padding: 1rem;
      border-top: 2px solid var(--glass-border);
    }

    /* ====== –ì—Ä–∞—Ñ–∏–∫–∏ ====== */
    .chart-container {
      height: 400px;
      padding: 1rem;
      background: var(--glass);
      border-radius: var(--radius-md);
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== –°—Ç–∞—Ç—É—Å—ã –∏ –∑–Ω–∞—á–∫–∏ ====== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--success);
      font-weight: 600;
    }

    .value-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* ====== –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ ====== */
    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== –°–æ–æ–±—â–µ–Ω–∏—è ====== */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .message-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .message-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    /* ====== –°–µ–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ====== */
    .export-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    /* ====== –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å ====== */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }

      .brand {
        font-size: 1rem;
      }

      .logo {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }

      main {
        margin-top: 70px;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 2rem;
      }

      .table-scroll {
        max-height: 300px;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
    }

    /* ====== –£—Ç–∏–ª–∏—Ç—ã ====== */
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    /* ====== –ü–µ—á–∞—Ç—å ====== */
    @media print {
      body {
        background: white;
        color: black;
      }

      header {
        position: relative;
        background: white;
        border-bottom: 2px solid #000;
      }

      .card {
        background: white;
        border: 1px solid #ccc;
        box-shadow: none;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }

      .btn, .file-input-wrapper {
        display: none;
      }
    }

    /* ====== –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º ====== */
    .compact .card {
      padding: 1rem;
    }

    .compact .kpi-card {
      padding: 0.75rem;
    }

    .compact .kpi-value {
      font-size: 1.75rem;
    }

    .compact table {
      font-size: 0.75rem;
    }

    .compact th, .compact td {
      padding: 0.5rem;
    }

    .compact .chart-container {
      height: 300px;
    }

    /* ====== –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–µ—á–∞—Ç–∏ ====== */
    #presentationPrint, #summaryPrint {
      display: none;
    }
  </style>
</head>
<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header id="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">–†–ö</div>
        <span>–í–û–õ–° –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
      </div>
      <div class="nav-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
        </div>
      </div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main>
    <div class="container">
      <!-- –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">üìä</div>
              –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤
            </h2>
          </div>
          <div class="form-group">
            <label class="file-input-wrapper">
              <div class="file-icon">üìÑ</div>
              <span>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)</span>
              <input id="filePrev" type="file" accept="application/pdf">
            </label>
            <label class="file-input-wrapper">
              <div class="file-icon">üìÑ</div>
              <span>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)</span>
              <input id="fileCurr" type="file" accept="application/pdf">
            </label>
          </div>
          <div class="form-group">
            <button id="btnParse" class="btn btn-primary">
              <span>üöÄ</span>
              –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button id="btnCompact" class="btn btn-ghost" title="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º">
              <span>üìê</span>
              –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥
            </button>
          </div>
          <div id="dates" class="message message-info" style="display:none"></div>
          <div id="loadingMsg" class="loading" style="display:none">
            <div class="loading-spinner"></div>
            <span>–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF —Ñ–∞–π–ª–æ–≤...</span>
          </div>
          <div id="errorMsg" class="message message-error" style="display:none"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">üíæ</div>
              –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤
            </h2>
          </div>
          <div class="export-section">
            <button class="btn btn-secondary" id="exportPresPDF">
              <span>üìë</span>
              –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è PDF
            </button>
            <button class="btn btn-secondary" id="exportBriefPDF">
              <span>üìã</span>
              –í—ã–∂–∏–º–∫–∞ PDF
            </button>
            <button class="btn btn-secondary" id="exportWordHTML">
              <span>üìù</span>
              –û—Ç—á–µ—Ç Word
            </button>
            <button class="btn btn-secondary" id="exportPresHTML">
              <span>üåê</span>
              –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è HTML
            </button>
          </div>
          <div id="exportStatus" class="message message-success mt-1" style="display:none"></div>
        </div>
      </div>

      <!-- KPI —Å–µ–∫—Ü–∏—è -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">üìà</div>
            –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
          </h2>
        </div>
        <div id="kpis" class="kpi-grid"></div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 2 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranches"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranches">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrev">0</td>
                    <td id="sumCurr">0</td>
                    <td id="sumDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 3 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–ü—Ä–∏–∫–∞–∑ ‚Ññ425</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS3"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 3</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS3">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrevS3">0</td>
                    <td id="sumCurrS3">0</td>
                    <td id="sumDeltaS3">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 4 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS4"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 4</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS4">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrevS4">0</td>
                    <td id="sumCurrS4">0</td>
                    <td id="sumDeltaS4">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –†–¢–ö -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">üìä</div>
            –î–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª
          </h2>
        </div>
        <div class="chart-container">
          <canvas id="chartRTKDelta"></canvas>
        </div>
      </div>

      <!-- –°—Ç–∞–¥–∏–∏ -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–°—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç</h2>
            <span class="badge">–°—Ç—Ä. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS2">
                <thead>
                  <tr>
                    <th>–°—Ç–∞–¥–∏—è</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–°—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç</h2>
            <span class="badge">–°—Ç—Ä. 4 (–†–¢–ö)</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS4">
                <thead>
                  <tr>
                    <th>–°—Ç–∞–¥–∏—è</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- –û–±–ª–∞—Å—Ç–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ (—Å–∫—Ä—ã—Ç—ã–µ) -->
  <div id="presentationPrint" style="display:none"></div>
  <div id="summaryPrint" style="display:none"></div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
  /* ==================== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã ==================== */
  const BRANCHES = [
    "–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°","–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°","–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°","–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°",
    "–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°","–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°","–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°","–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°","–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°"
  ];
  const BRANCH_PATTERNS = [
    {name:"–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°", re:/–°–æ—á–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°", re:/–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°", re:/–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ\s+–≠–°/i},
    {name:"–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–£—Å—Ç—å[\s\u00A0\u202F\-‚Äì‚Äî-]*–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°", re:/–Æ–≥–æ[\s\u00A0\u202F\-‚Äì‚Äî-]*–ó–∞–ø–∞–¥–Ω—ã–µ\s+–≠–°/i},
    {name:"–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°", re:/–ê–¥—ã–≥–µ–π—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°", re:/–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°", re:/–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°", re:/–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°", re:/–°–ª–∞–≤—è–Ω—Å–∫–∏–µ\s+–≠–°/i},
  ];

  /* –°—Ç–∞–¥–∏–∏ */
  const STATUS_PATTERNS = [
    {key:"work", title:"–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞", re:/–í\s*—Ä–∞–±–æ—Ç–µ\s*—É\s*—Ñ–∏–ª–∏–∞–ª–∞/i},
    {key:"dismantled", title:"–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ", re:/–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ/i},
    {key:"rc_digit", title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –†–æ—Å—Å–µ—Ç–∏ –¶–∏—Ñ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏\s*–†–æ—Å—Å–µ—Ç–∏\s*–¶–∏—Ñ—Ä–∞/i},
    {key:"op_sign", title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏\s*—É\s*–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞/i},
    {key:"filial_appr",title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –≤ —Ñ–∏–ª–∏–∞–ª–µ", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏\s*–≤\s*—Ñ–∏–ª–∏–∞–ª–µ/i},
    {key:"incl_next", title:"–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è",
      re:/–ë—É–¥–µ—Ç\s*–≤–∫–ª—é—á–µ–Ω–æ(?:[\s\S]{0,80})–≤(?:\s*—Å–ª–µ–¥—É—é—â–µ–µ)?(?:[\s\S]{0,80})–¥–æ–ø\.?\s*—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ(?:[\s\S]{0,80}–ø–æ—Å–ª–µ\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏—è)?/i
    },
  ];
  const STATUS_KEYS = STATUS_PATTERNS.map(s => s.key);
  const STAGE_TITLE = k => (STATUS_PATTERNS.find(s => s.key===k)||{}).title||k;

  const SHORT_STAGE_TITLES = {
    "work": "–í —Ä–∞–±–æ—Ç–µ",
    "dismantled": "–î–µ–º–æ–Ω—Ç.",
    "rc_digit": "–û—Ñ–æ—Ä–º–ª. –†–¶",
    "op_sign": "–ü–æ–¥–ø–∏—Å—å –æ–ø–µ—Ä.",
    "filial_appr": "–°–æ–≥–ª. —Ñ–∏–ª–∏–∞–ª",
    "incl_next": "–í —Å–ª–µ–¥. –¥–æ–ø.—Å–æ–≥–ª."
  };
  const SHORT_STAGE_TITLE = k => SHORT_STAGE_TITLES[k] || STAGE_TITLE(k);

  const numberize = s => {
    const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
    const n = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
    if(!n) return 0;
    const val = Number(n.replace(",", "."));
    return isNaN(val) ? 0 : val;
  };
  const fmt = n => (typeof n === "number" ? n : Number(n||0)).toLocaleString("ru-RU");
  const normalize = txt => String(txt||"")
      .replace(/\u00A0|\u202F/g," ")
      .replace(/\u00AD/g,"")
      .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
      .replace(/[ \t]+/g," ")
      .trim();

  /* ==================== –ß—Ç–µ–Ω–∏–µ PDF ==================== */
  async function pdfToPages(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      let pageText = "", lastY = null;
      content.items.forEach(item => {
        const y = item.transform[5];
        if(lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
        pageText += item.str;
        lastY = y;
      });
      pages.push(normalize(pageText));
    }
    return pages;
  }

  /* ==================== –ü–∞—Ä—Å–∏–Ω–≥ ==================== */
  function extractDateFromPages(pages){
    for(const pg of pages){
      const m = pg.match(/–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
    return "‚Äî";
  }

  function parseTotalsFromPage(page1){
    const find = (re) => {
      const m = page1.match(re);
      return m ? numberize(m[1]) : 0;
    };
    return {
      found_year: find(/–≤—ã—è–≤–ª–µ–Ω–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
      legalized: find(/–£–∑–∞–∫–æ–Ω–µ–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
      dismantled_ytd: find(/–ó–∞\s*20\d{2}\s*–≥–æ–¥\s*–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
      in_work_total: find(/–í\s*—Ä–∞–±–æ—Ç–µ[^0-9]*?–≤—Å–µ–≥–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
      rtk_in_work: find(/–≤\s*—Ç–æ–º\s*—á–∏—Å–ª–µ\s*–ü–ê–û\s*¬´?–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª?[^0-9]*?(\d[\d\s]+)/i),
    };
  }

  function parseBranchTable(pageText){
    const text = normalize(pageText);
    const lines = text.split("\n").filter(Boolean);

    const idx = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      for(const bp of BRANCH_PATTERNS){
        if(bp.re.test(line)){ idx.push({i, name: bp.name}); break; }
      }
    }
    idx.push({i: lines.length, name:null});

    const branches = new Map();
    for(let k=0;k<idx.length-1;k++){
      const start = idx[k].i, end = idx[k+1].i, branchName = idx[k].name;
      if(!branchName) continue;
      const headLine = lines[start] || "";
      const segText = lines.slice(start+1, end).join(" ");

      let total = 0;
      const headNums = headLine.match(/\d[\d\s]*/g);
      if(headNums && headNums.length) total = numberize(headNums[headNums.length-1]);
      if(total===0 && lines[start+1]){
        const n2 = (lines[start+1]||"").match(/\d[\d\s]*/g);
        if(n2 && n2.length) total = numberize(n2[n2.length-1]);
      }

      const data = { total, statuses:{} };

      function numAfter(re, hay){
        const rx = new RegExp(re.source + "[^\\d]{0,200}(\\d[\\d\\s]*)", re.flags);
        const m = hay.match(rx);
        return m ? numberize(m[1]) : null;
      }

      for(const sp of STATUS_PATTERNS){
        let v = numAfter(sp.re, segText);
        if(v === null){
          for(let j=start+1;j<end;j++){
            const l0 = lines[j]||"", l1 = lines[j+1]||"";
            if(sp.re.test(l0) || sp.re.test(l1)){
              let cap = (l0.match(/(\d[\d\s]*)/g)||[]).pop();
              if(!cap) cap = (l1.match(/(\d[\d\s]*)/g)||[]).pop();
              if(cap){ v = numberize(cap); break; }
            }
          }
        }
        if(v !== null) data.statuses[sp.key] = v;
      }
      branches.set(branchName, data);
    }

    for(const b of BRANCHES){
      if(!branches.has(b)) branches.set(b, { total:0, statuses:{} });
    }

    const stages = {};
    for(const [_, obj] of branches){
      for(const [k,v] of Object.entries(obj.statuses)){
        stages[k] = (stages[k]||0) + (v||0);
      }
    }

    const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);
    return { branches, overall, stages };
  }

  function parseReportByPages(pages){
    return {
      date: extractDateFromPages(pages),
      p1: { totals: parseTotalsFromPage(pages[0] || "") },
      p2: parseBranchTable(pages[1] || ""),
      p3: parseBranchTable(pages[2] || ""),
      p4: parseBranchTable(pages[3] || ""),
    };
  }

  /* ==================== –î–∏–Ω–∞–º–∏–∫–∞ ==================== */
  function computeDynamics(curr, prev){
    const dyn = {
      in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
      rtk_in_work: (curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work) || 0,
      legalized: (curr.p1.totals.legalized - prev.p1.totals.legalized) || 0,
      dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
    };
    dyn.found_week = dyn.in_work_total;

    const makeRows = (cPage, pPage) => BRANCHES.map(b=>{
      const c = cPage.branches.get(b)?.total || 0;
      const p = pPage.branches.get(b)?.total || 0;
      return {b, p, c, d: (c - p)};
    });

    const branchRows = makeRows(curr.p2, prev.p2);
    const branchRowsS3 = makeRows(curr.p3, prev.p3);
    const branchRowsS4 = makeRows(curr.p4, prev.p4);

    const allKeys = Array.from(new Set([
      ...Object.keys(prev.p2.stages||{}), ...Object.keys(curr.p2.stages||{}),
      ...Object.keys(prev.p3.stages||{}), ...Object.keys(curr.p3.stages||{}),
      ...Object.keys(prev.p4.stages||{}), ...Object.keys(curr.p4.stages||{}),
      ...STATUS_KEYS
    ]));

    const diffStages = (cur, prv) => allKeys.map(k=>({
      stage: STAGE_TITLE(k), short: SHORT_STAGE_TITLE(k), key: k,
      p: prv[k] || 0, c: cur[k] || 0, d: (cur[k]||0) - (prv[k]||0)
    }));

    const stagesS2 = diffStages(curr.p2.stages||{}, prev.p2.stages||{});
    const stagesS4 = diffStages(curr.p4.stages||{}, prev.p4.stages||{});

    function perBranchStages(cPage, pPage){
      return BRANCHES.map(b=>{
        const cst = cPage.branches.get(b)?.statuses || {};
        const pst = pPage.branches.get(b)?.statuses || {};
        const by = {};
        STATUS_KEYS.forEach(k=>{
          const p = pst[k]||0, c = cst[k]||0;
          by[k] = {p,c,d:c-p};
        });
        return {b, by};
      });
    }
    const s2BranchStages = perBranchStages(curr.p2, prev.p2);

    return {
      ...dyn,
      branchRows,
      branchRowsS3,
      branchRowsS4,
      stagesS2,
      stagesS4,
      s2BranchStages,
      rtkRows: branchRowsS4
    };
  }pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
}]},
      options: chartOpts()
    });
  }

  function renderStagesTables(dyn){
    const fill = (id, rows) => {
      const tbody = document.querySelector(id + " tbody");
      tbody.innerHTML = rows.map(r=>{
        const p = Number(r.p)||0, c = Number(r.c)||0, d = c - p;
        const cls = d>0?"value-positive":(d<0?"value-negative":"");
        return `<tr>
          <td>${r.stage}</td>
          <td>${fmt(p)}</td>
          <td>${fmt(c)}</td>
          <td class="${cls}">${d>0?"+":""}${fmt(d)}</td>
        </tr>`;
      }).join("");
    };
    fill("#tblStagesS2", dyn.stagesS2);
    fill("#tblStagesS4", dyn.stagesS4);
  }

  /* ==================== –≠–∫—Å–ø–æ—Ä—Ç PDF —Å –ø—Ä–µ–º–∏—É–º –¥–∏–∑–∞–π–Ω–æ–º ==================== */
  async function exportPresPDF(){
    const el = document.getElementById("presentationPrint");
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–º–∏—É–º HTML –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
    el.innerHTML = `
      <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        body {
          font-family: 'Inter', Arial, sans-serif;
          color: #1E293B;
          line-height: 1.6;
        }
        
        .pres-page {
          padding: 40px;
          background: white;
          min-height: 100vh;
          page-break-after: always;
        }
        
        .pres-header {
          display: flex;
          align-items: center;
          gap: 20px;
          margin-bottom: 40px;
          padding-bottom: 20px;
          border-bottom: 3px solid #1E3A8A;
        }
        
        .pres-logo {
          width: 60px;
          height: 60px;
          background: linear-gradient(135deg, #3B82F6, #06B6D4);
          border-radius: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 900;
          font-size: 24px;
          color: white;
        }
        
        .pres-title {
          font-size: 28px;
          font-weight: 800;
          color: #1E3A8A;
        }
        
        .pres-date {
          font-size: 14px;
          color: #64748B;
          margin-top: 4px;
        }
        
        .kpi-section {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 20px;
          margin-bottom: 40px;
        }
        
        .kpi-box {
          background: #F8FAFC;
          border: 1px solid #E2E8F0;
          border-radius: 12px;
          padding: 20px;
          text-align: center;
        }
        
        .kpi-label {
          font-size: 12px;
          color: #64748B;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        
        .kpi-value {
          font-size: 32px;
          font-weight: 800;
          color: #1E293B;
          margin: 8px 0;
        }
        
        .kpi-delta {
          font-size: 14px;
          font-weight: 600;
        }
        
        .delta-positive { color: #10B981; }
        .delta-negative { color: #EF4444; }
        .delta-neutral { color: #64748B; }
        
        .table-section {
          margin-bottom: 40px;
        }
        
        .section-title {
          font-size: 20px;
          font-weight: 700;
          color: #1E293B;
          margin-bottom: 16px;
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .section-icon {
          width: 32px;
          height: 32px;
          background: linear-gradient(135deg, #3B82F6, #06B6D4);
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
        }
        
        table {
          width: 100%;
          border-collapse: collapse;
          background: white;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        th {
          background: #1E3A8A;
          color: white;
          padding: 12px 16px;
          text-align: left;
          font-weight: 600;
          font-size: 14px;
        }
        
        th:not(:first-child) {
          text-align: right;
        }
        
        td {
          padding: 12px 16px;
          border-bottom: 1px solid #F1F5F9;
          font-size: 14px;
        }
        
        td:not(:first-child) {
          text-align: right;
          font-variant-numeric: tabular-nums;
        }
        
        tr:nth-child(even) {
          background: #F8FAFC;
        }
        
        tfoot td {
          background: #E0E7FF;
          font-weight: 700;
          border-top: 2px solid #1E3A8A;
          color: #1E3A8A;
        }
        
        .chart-img {
          width: 100%;
          height: auto;
          border-radius: 12px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
      </style>
    `;
    
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    // –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1
    el.innerHTML += `
      <div class="pres-page">
        <div class="pres-header">
          <div class="pres-logo">–†–ö</div>
          <div>
            <div class="pres-title">–î–∏–Ω–∞–º–∏–∫–∞ –í–û–õ–° - –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç</div>
            <div class="pres-date">–ü–µ—Ä–∏–æ–¥: ${prev.date} ‚Äî ${curr.date}</div>
          </div>
        </div>
        
        <div class="kpi-section">
          <div class="kpi-box">
            <div class="kpi-label">–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ</div>
            <div class="kpi-value">${fmt(curr.p1.totals.in_work_total)}</div>
            <div class="kpi-delta ${dyn.in_work_total >= 0 ? 'delta-positive' : 'delta-negative'}">
              ${dyn.in_work_total > 0 ? '+' : ''}${fmt(dyn.in_work_total)} —à—Ç.
            </div>
          </div>
          <div class="kpi-box">
            <div class="kpi-label">–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            <div class="kpi-value">${fmt(dyn.found_week)}</div>
            <div class="kpi-delta delta-neutral">–Ω–æ–≤—ã–µ</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-label">–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            <div class="kpi-value">${fmt(eff)}</div>
            <div class="kpi-delta delta-neutral">—É–∑–∞–∫. + –¥–µ–º–æ–Ω—Ç.</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-label">–ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º</div>
            <div class="kpi-value">${fmt(curr.p1.totals.rtk_in_work)}</div>
            <div class="kpi-delta ${dyn.rtk_in_work >= 0 ? 'delta-positive' : 'delta-negative'}">
              ${dyn.rtk_in_work > 0 ? '+' : ''}${fmt(dyn.rtk_in_work)} (${rtkShare.toFixed(1)}%)
            </div>
          </div>
        </div>
        
        ${buildPresentationTables()}
      </div>
    `;
    
    el.style.display = "block";
    await html2pdf().from(el).set({
      margin: 0,
      filename: "–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_" + new Date().toISOString().split('T')[0] + ".pdf",
      image: {type: 'jpeg', quality: 0.98},
      html2canvas: {scale: 2, useCORS: true},
      jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'},
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    }).save();
    el.style.display = "none";
    showExportMessage("PDF –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω");
  }

  async function exportBriefPDF(){
    const el = document.getElementById("summaryPrint");
    
    // –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø—Ä–µ–º–∏—É–º –¥–∏–∑–∞–π–Ω –¥–ª—è –≤—ã–∂–∏–º–∫–∏
    el.innerHTML = `
      <style>
        /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ —Å—Ç–∏–ª–∏, —á—Ç–æ –∏ –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ */
        ${document.querySelector('#presentationPrint style').innerHTML}
        
        .brief-block {
          background: #F8FAFC;
          border: 1px solid #E2E8F0;
          border-radius: 12px;
          padding: 24px;
          margin-bottom: 20px;
        }
        
        .brief-title {
          font-size: 18px;
          font-weight: 700;
          color: #1E3A8A;
          margin-bottom: 12px;
        }
        
        .brief-content {
          font-size: 14px;
          line-height: 1.8;
        }
        
        .brief-item {
          padding: 4px 0;
        }
        
        .brief-value {
          font-weight: 700;
          color: #1E293B;
        }
      </style>
    `;
    
    const {curr, prev, dyn} = DATA;
    
    el.innerHTML += `
      <div class="pres-page">
        <div class="pres-header">
          <div class="pres-logo">–†–ö</div>
          <div>
            <div class="pres-title">–ö—Ä–∞—Ç–∫–∞—è –≤—ã–∂–∏–º–∫–∞ –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è</div>
            <div class="pres-date">–ü–µ—Ä–∏–æ–¥: ${prev.date} ‚Äî ${curr.date}</div>
          </div>
        </div>
        
        ${buildSummaryContent()}
      </div>
    `;
    
    el.style.display = "block";
    await html2pdf().from(el).set({
      margin: 0,
      filename: "–í—ã–∂–∏–º–∫–∞_–í–û–õ–°_" + new Date().toISOString().split('T')[0] + ".pdf",
      image: {type: 'jpeg', quality: 0.98},
      html2canvas: {scale: 2, useCORS: true},
      jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'}
    }).save();
    el.style.display = "none";
    showExportMessage("PDF –≤—ã–∂–∏–º–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω");
  }

  /* ==================== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ==================== */
  function buildPresentationTables(){
    const {branchRows, branchRowsS3, branchRowsS4} = DATA.dyn;
    
    const makeTable = (title, icon, rows, sumIds) => {
      const sorted = [...rows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d));
      return `
        <div class="table-section">
          <div class="section-title">
            <div class="section-icon">${icon}</div>
            ${title}
          </div>
          <table>
            <thead>
              <tr>
                <th>–§–∏–ª–∏–∞–ª</th>
                <th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</th>
                <th>–¢–µ–∫—É—â–∞—è</th>
                <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map(r => `
                <tr>
                  <td>${r.b}</td>
                  <td>${fmt(r.p)}</td>
                  <td>${fmt(r.c)}</td>
                  <td class="${r.d > 0 ? 'delta-positive' : r.d < 0 ? 'delta-negative' : ''}">
                    ${r.d > 0 ? '+' : ''}${fmt(r.d)}
                  </td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr>
                <td>–ò—Ç–æ–≥–æ</td>
                <td>${document.getElementById(sumIds[0]).textContent}</td>
                <td>${document.getElementById(sumIds[1]).textContent}</td>
                <td>${document.getElementById(sumIds[2]).textContent}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    };
    
    return makeTable("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)", "üìä", branchRows, ["sumPrev", "sumCurr", "sumDelta"]) +
           makeTable("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425", "üìã", branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"]) +
           makeTable("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", "üåê", branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"]);
  }

  function buildSummaryContent(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    
    const topChanges = [...dyn.branchRows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d)).slice(0, 3);
    
    return `
      <div class="brief-block">
        <div class="brief-title">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
        <div class="brief-content">
          <div class="brief-item">‚Ä¢ –í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ: <span class="brief-value">${fmt(curr.p1.totals.in_work_total)}</span> (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})</div>
          <div class="brief-item">‚Ä¢ –í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é: <span class="brief-value">${fmt(dyn.found_week)}</span></div>
          <div class="brief-item">‚Ä¢ –ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é: <span class="brief-value">${fmt(eff)}</span></div>
          <div class="brief-item">‚Ä¢ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª: <span class="brief-value">${fmt(curr.p1.totals.rtk_in_work)}</span> (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</div>
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">–¢–æ–ø-3 —Ñ–∏–ª–∏–∞–ª–∞ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º</div>
        <div class="brief-content">
          ${topChanges.map((r, i) => `
            <div class="brief-item">${i+1}. <span class="brief-value">${r.b}</span>: ${fmt(r.p)} ‚Üí ${fmt(r.c)} (${r.d>0?'+':''}${fmt(r.d)})</div>
          `).join('')}
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">–ò—Ç–æ–≥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
        <div class="brief-content">
          <div class="brief-item">‚Ä¢ –í—Å–µ–≥–æ –æ–ø–æ—Ä: ${document.getElementById("sumPrev").textContent} ‚Üí <span class="brief-value">${document.getElementById("sumCurr").textContent}</span> (${document.getElementById("sumDelta").textContent})</div>
          <div class="brief-item">‚Ä¢ –ü—Ä–∏–∫–∞–∑ ‚Ññ425: ${document.getElementById("sumPrevS3").textContent} ‚Üí <span class="brief-value">${document.getElementById("sumCurrS3").textContent}</span> (${document.getElementById("sumDeltaS3").textContent})</div>
          <div class="brief-item">‚Ä¢ –ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º: ${document.getElementById("sumPrevS4").textContent} ‚Üí <span class="brief-value">${document.getElementById("sumCurrS4").textContent}</span> (${document.getElementById("sumDeltaS4").textContent})</div>
        </div>
      </div>
    `;
  }

  /* ==================== –≠–∫—Å–ø–æ—Ä—Ç Word HTML ==================== */
  function exportWordHTML(){
    if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
    const {curr, prev, dyn} = DATA;
    
    const htmlDoc = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–û—Ç—á–µ—Ç –í–û–õ–° - ${curr.date}</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body { font-family: 'Calibri', Arial, sans-serif; line-height: 1.6; color: #333; }
    h1 { color: #1E3A8A; font-size: 24pt; border-bottom: 3pt solid #1E3A8A; padding-bottom: 10pt; }
    h2 { color: #1E3A8A; font-size: 18pt; margin-top: 20pt; }
    h3 { color: #333; font-size: 14pt; margin-top: 15pt; }
    table { width: 100%; border-collapse: collapse; margin: 15pt 0; }
    th, td { border: 1pt solid #ddd; padding: 8pt; text-align: center; }
    th { background-color: #1E3A8A; color: white; font-weight: bold; }
    th:first-child, td:first-child { text-align: left; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .info-box { background: #EBF4FF; border-left: 4pt solid #1E3A8A; padding: 10pt; margin: 10pt 0; }
    .positive { color: #10B981; font-weight: bold; }
    .negative { color: #EF4444; font-weight: bold; }
  </style>
</head>
<body>
  <h1>–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª ‚Äî –û—Ç—á–µ—Ç –ø–æ –í–û–õ–°</h1>
  
  <div class="info-box">
    <p><strong>–û—Ç—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥:</strong><br>
    –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è: ${prev.date}<br>
    –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è: ${curr.date}</p>
  </div>
  
  ${generateWordContent()}
</body>
</html>`;

    const blob = new Blob([htmlDoc], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `–û—Ç—á–µ—Ç_–í–û–õ–°_${curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Word.");
  }

  /* ==================== –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ HTML ==================== */
  function exportPresHTML(){
    if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
    
    const presHTML = generatePresentationHTML();
    const blob = new Blob([presHTML], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${DATA.curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
  }

  function generatePresentationHTML(){
    const {curr, prev, dyn} = DATA;
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const imgS2 = document.getElementById("chartBranches").toDataURL("image/png");
    const imgS3 = document.getElementById("chartBranchesS3").toDataURL("image/png");
    const imgS4 = document.getElementById("chartBranchesS4").toDataURL("image/png");
    const imgRTK = document.getElementById("chartRTKDelta").toDataURL("image/png");
    
    return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –í–û–õ–° - ${curr.date}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #0F172A;
      color: #F1F5F9;
      overflow-x: hidden;
    }
    
    .slide {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px;
      position: relative;
      background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                  #0F172A;
    }
    
    .slide-header {
      position: absolute;
      top: 40px;
      left: 60px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 20px;
      color: white;
    }
    
    .slide-number {
      position: absolute;
      bottom: 40px;
      right: 60px;
      font-size: 18px;
      color: #64748B;
    }
    
    h1 {
      font-size: 48px;
      font-weight: 800;
      text-align: center;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h2 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 30px;
      color: #F1F5F9;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      max-width: 1400px;
    }
    
    .chart-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .chart-container img {
      width: 100%;
      height: auto;
      border-radius: 12px;
    }
    
    .table-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: rgba(59, 130, 246, 0.2);
      color: #F1F5F9;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    th:not(:first-child) { text-align: right; }
    
    td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: #94A3B8;
    }
    
    td:not(:first-child) { text-align: right; }
    
    tr:hover { background: rgba(255, 255, 255, 0.03); }
    
    tfoot td {
      background: rgba(59, 130, 246, 0.1);
      font-weight: 700;
      color: #F1F5F9;
      border-top: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 30px;
      width: 100%;
      max-width: 1200px;
    }
    
    .kpi-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
    }
    
    .kpi-label {
      font-size: 14px;
      color: #94A3B8;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .kpi-value {
      font-size: 48px;
      font-weight: 800;
      margin: 10px 0;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .kpi-delta {
      font-size: 18px;
      font-weight: 600;
    }
    
    .positive { color: #10B981; }
    .negative { color: #EF4444; }
    
    @media print {
      .slide { page-break-after: always; }
    }
  </style>
</head>
<body>
  <!-- –°–ª–∞–π–¥ 1: –¢–∏—Ç—É–ª—å–Ω—ã–π -->
  <div class="slide">
    <div class="slide-header">
      <div class="logo">–†–ö</div>
      <span style="font-size: 20px; font-weight: 600;">–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</span>
    </div>
    <h1>–î–∏–Ω–∞–º–∏–∫–∞ –í–û–õ–°<br>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç</h1>
    <p style="font-size: 24px; color: #94A3B8;">–ü–µ—Ä–∏–æ–¥: ${prev.date} ‚Äî ${curr.date}</p>
    <div class="slide-number">1</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 2: KPI -->
  <div class="slide">
    <h2>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
    <div class="kpi-grid">
      ${generateKPICards()}
    </div>
    <div class="slide-number">2</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 3: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º -->
  <div class="slide">
    <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)</h2>
    <div class="content-grid">
      <div class="chart-container">  /* ==================== –†–µ–Ω–¥–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ==================== */
  let chartBranches, chartBranchesS3, chartBranchesS4, chartRTKDelta;

  function renderKpis(curr, prev, dyn){
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const items = [
      {title:"–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ", value:curr.p1.totals.in_work_total, delta:dyn.in_work_total, unit:"—à—Ç."},
      {title:"–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value:dyn.found_week, delta:dyn.found_week, unit:"—à—Ç."},
      {title:"–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value:eff, delta:eff, unit:"—à—Ç.", subtitle:"(—É–∑–∞–∫. + –¥–µ–º–æ–Ω—Ç.)"},
      {title:"–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", value:curr.p1.totals.rtk_in_work, delta:dyn.rtk_in_work, unit:"—à—Ç.", subtitle:`–¥–æ–ª—è ${rtkShare.toFixed(1)}%`},
    ];

    document.getElementById("kpis").innerHTML = items.map(it=>{
      const d = typeof it.delta==="number"?it.delta:0;
      const deltaClass = d>0?"positive":(d<0?"negative":"neutral");
      const sign=d>0?"+":"";
      const arrow = d>0?"‚Üë":(d<0?"‚Üì":"‚Üí");
      
      return `<div class="kpi-card">
        <div class="kpi-label">${it.title}</div>
        <div class="kpi-value">${fmt(it.value)} <span style="font-size:0.5em;font-weight:400;color:var(--text-secondary)">${it.unit}</span></div>
        ${it.subtitle ? `<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem">${it.subtitle}</div>` : ''}
        <div class="kpi-delta ${deltaClass}">
          <span>${arrow}</span>
          <span>${sign}${fmt(d)}</span>
        </div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(rows, tbodySel, sumPrevId, sumCurrId, sumDeltaId){
    const tbody = document.querySelector(tbodySel);
    tbody.innerHTML = "";
    let sP=0,sC=0,sD=0;
    const sorted = [...rows].sort((a,b)=>Math.abs((b.c-b.p)) - Math.abs((a.c-a.p)));
    for(const r0 of sorted){
      const p = Number(r0.p)||0, c = Number(r0.c)||0;
      const d = c - p;
      const cls = d>0?"value-positive":(d<0?"value-negative":"");
      sP+=p; sC+=c; sD+=d;
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r0.b}</td>
          <td>${fmt(p)}</td>
          <td>${fmt(c)}</td>
          <td class="${cls}">${d>0?"+":""}${fmt(d)}</td>
        </tr>`);
    }
    document.getElementById(sumPrevId).textContent = fmt(sP);
    document.getElementById(sumCurrId).textContent = fmt(sC);
    document.getElementById(sumDeltaId).textContent = (sD>0?"+":"")+fmt(sD);
    document.getElementById(sumDeltaId).className = sD>0?"value-positive":(sD<0?"value-negative":"");
  }

  function chartOpts(){
    Chart.defaults.color = '#94A3B8';
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
    
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:"top",
          labels:{
            boxWidth:12,
            usePointStyle:true,
            padding:20,
            font:{size:12}
          }
        },
        tooltip:{
          backgroundColor: 'rgba(30, 41, 59, 0.9)',
          titleColor: '#F1F5F9',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          boxWidth: 12,
          boxHeight: 12,
          usePointStyle: true
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid:{
            color:'rgba(255, 255, 255, 0.05)',
            drawBorder:false
          },
          ticks:{
            precision:0,
            padding:10
          }
        },
        x:{
          grid:{
            display:false,
            drawBorder:false
          },
          ticks:{
            padding:10
          }
        }
      },
    };
  }

  function renderCharts(curr, prev, dyn){
    const labels = BRANCHES;
    const prevS2 = labels.map(b=>prev.p2.branches.get(b)?.total||0);
    const currS2 = labels.map(b=>curr.p2.branches.get(b)?.total||0);

    if(chartBranches) chartBranches.destroy();
    chartBranches = new Chart(document.getElementById("chartBranches"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS2, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS2, backgroundColor:"rgba(59, 130, 246, 0.5)", borderColor:"rgba(59, 130, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS3 = labels.map(b=>prev.p3.branches.get(b)?.total||0);
    const currS3 = labels.map(b=>curr.p3.branches.get(b)?.total||0);
    if(chartBranchesS3) chartBranchesS3.destroy();
    chartBranchesS3 = new Chart(document.getElementById("chartBranchesS3"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS3, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS3, backgroundColor:"rgba(139, 92, 246, 0.5)", borderColor:"rgba(139, 92, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS4 = labels.map(b=>prev.p4.branches.get(b)?.total||0);
    const currS4 = labels.map(b=>curr.p4.branches.get(b)?.total||0);
    if(chartBranchesS4) chartBranchesS4.destroy();
    chartBranchesS4 = new Chart(document.getElementById("chartBranchesS4"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS4, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS4, backgroundColor:"rgba(6, 182, 212, 0.5)", borderColor:"rgba(6, 182, 212, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const rtkD = labels.map(b => (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).c - (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).p);
    if(chartRTKDelta) chartRTKDelta.destroy();
    chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
      type:"bar",
      data:{labels, datasets:[{
        label:"–ò–∑–º–µ–Ω–µ–Ω–∏–µ (—Ç–µ–∫. ‚àí –ø—Ä–µ–¥.)", 
        data:rtkD, 
        backgroundColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.5)":"rgba(239, 68, 68, 0.5)"),
        borderColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.8)":"rgba(239, 68, 68, 0.8)"),
        borderWidth: 1<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–û–õ–° –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | –†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ç–æ–∫–µ–Ω—ã –¥–∏–∑–∞–π–Ω–∞ ====== */
    :root{
      /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ –±—Ä–µ–Ω–¥–∞ */
      --primary: #1E3A8A;
      --primary-light: #3B82F6;
      --primary-dark: #1E293B;
      --accent: #06B6D4;
      --accent-glow: rgba(6, 182, 212, 0.3);
      
      /* –§–æ–Ω—ã –∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ */
      --bg-main: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(59, 130, 246, 0.1);
      
      /* –°—Ç–µ–∫–ª–æ–º–æ—Ä—Ñ–∏–∑–º */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* –¢–µ–∫—Å—Ç */
      --text-primary: #F1F5F9;
      --text-secondary: #94A3B8;
      --text-muted: #64748B;
      
      /* –°—Ç–∞—Ç—É—Å—ã */
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      
      /* –≠—Ñ—Ñ–µ–∫—Ç—ã */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.7);
      --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.3);
      
      /* –°–∫—Ä—É–≥–ª–µ–Ω–∏—è */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* –§–æ–Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* ====== –®–∞–ø–∫–∞ ====== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      transition: var(--transition);
    }

    header.scrolled {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      letter-spacing: -0.02em;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* ====== –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç ====== */
    main {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* ====== –°–µ—Ç–∫–∞ ====== */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .cols-4 { grid-template-columns: repeat(2, 1fr); }
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .cols-2, .cols-3, .cols-4 { grid-template-columns: 1fr; }
    }

    /* ====== –ö–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* ====== KPI –∫–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-delta {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .kpi-delta.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .kpi-delta.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .kpi-delta.neutral {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* ====== –ö–Ω–æ–ø–∫–∏ ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px dashed var(--glass-border);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
      background: var(--glass);
    }

    /* ====== –§–æ—Ä–º—ã ====== */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--glass);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-wrapper:hover {
      border-color: var(--primary-light);
      background: var(--bg-hover);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    /* ====== –¢–∞–±–ª–∏—Ü—ã ====== */
    .table-container {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-scroll {
      max-height: 400px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--glass-border) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 2px solid var(--glass-border);
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    tfoot td {
      background: var(--bg-secondary);
      font-weight: 700;
      color: var(--text-primary);
      padding: 1rem;
      border-top: 2px solid var(--glass-border);
    }

    /* ====== –ì—Ä–∞—Ñ–∏–∫–∏ ====== */
    .chart-container {
      height: 400px;
      padding: 1rem;
      background: var(--glass);
      border-radius: var(--radius-md);
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== –°—Ç–∞—Ç—É—Å—ã –∏ –∑–Ω–∞—á–∫–∏ ====== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--success);
      font-weight: 600;
    }

    .value-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* ====== –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ ====== */
    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== –°–æ–æ–±—â–µ–Ω–∏—è ====== */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .message-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .message-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    /* ====== –°–µ–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ====== */
    .export-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    /* ====== –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å ====== */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }

      .brand {
        font-size: 1rem;
      }

      .logo {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }

      main {
        margin-top: 70px;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 2rem;
      }

      .table-scroll {
        max-height: 300px;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
    }

    /* ====== –£—Ç–∏–ª–∏—Ç—ã ====== */
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    /* ====== –ü–µ—á–∞—Ç—å ====== */
    @media print {
      body {
        background: white;
        color: black;
      }

      header {
        position: relative;
        background: white;
        border-bottom: 2px solid #000;
      }

      .card {
        background: white;
        border: 1px solid #ccc;
        box-shadow: none;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }

      .btn, .file-input-wrapper {
        display: none;
      }
    }

    /* ====== –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º ====== */
    .compact .card {
      padding: 1rem;
    }

    .compact .kpi-card {
      padding: 0.75rem;
    }

    .compact .kpi-value {
      font-size: 1.75rem;
    }

    .compact table {
      font-size: 0.75rem;
    }

    .compact th, .compact td {
      padding: 0.5rem;
    }

    .compact .chart-container {
      height: 300px;
    }

    /* ====== –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–µ—á–∞—Ç–∏ ====== */
    #presentationPrint, #summaryPrint {
      display: none;
    }
  </style>
</head>
<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header id="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">–†–ö</div>
        <span>–í–û–õ–° –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
      </div>
      <div class="nav-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
        </div>
      </div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main>
    <div class="container">
      <!-- –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">üìä</div>
              –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤
            </h2>
          </div>
          <div class="form-group">
            <label class="file-input-wrapper">
              <div class="file-icon">üìÑ</div>
              <span>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)</span>
              <input id="filePrev" type="file" accept="application/pdf">
            </label>
            <label class="file-input-wrapper">
              <div class="file-icon">üìÑ</div>
              <span>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)</span>
              <input id="fileCurr" type="file" accept="application/pdf">
            </label>
          </div>
          <div class="form-group">
            <button id="btnParse" class="btn btn-primary">
              <span>üöÄ</span>
              –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button id="btnCompact" class="btn btn-ghost" title="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º">
              <span>üìê</span>
              –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥
            </button>
          </div>
          <div id="dates" class="message message-info" style="display:none"></div>
          <div id="loadingMsg" class="loading" style="display:none">
            <div class="loading-spinner"></div>
            <span>–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF —Ñ–∞–π–ª–æ–≤...</span>
          </div>
          <div id="errorMsg" class="message message-error" style="display:none"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">üíæ</div>
              –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤
            </h2>
          </div>
          <div class="export-section">
            <button class="btn btn-secondary" id="exportPresPDF">
              <span>üìë</span>
              –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è PDF
            </button>
            <button class="btn btn-secondary" id="exportBriefPDF">
              <span>üìã</span>
              –í—ã–∂–∏–º–∫–∞ PDF
            </button>
            <button class="btn btn-secondary" id="exportWordHTML">
              <span>üìù</span>
              –û—Ç—á–µ—Ç Word
            </button>
            <button class="btn btn-secondary" id="exportPresHTML">
              <span>üåê</span>
              –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è HTML
            </button>
          </div>
          <div id="exportStatus" class="message message-success mt-1" style="display:none"></div>
        </div>
      </div>

      <!-- KPI —Å–µ–∫—Ü–∏—è -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">üìà</div>
            –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
          </h2>
        </div>
        <div id="kpis" class="kpi-grid"></div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 2 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranches"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranches">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrev">0</td>
                    <td id="sumCurr">0</td>
                    <td id="sumDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 3 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–ü—Ä–∏–∫–∞–∑ ‚Ññ425</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS3"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 3</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS3">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrevS3">0</td>
                    <td id="sumCurrS3">0</td>
                    <td id="sumDeltaS3">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 4 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS4"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 4</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS4">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrevS4">0</td>
                    <td id="sumCurrS4">0</td>
                    <td id="sumDeltaS4">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –†–¢–ö -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">üìä</div>
            –î–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª
          </h2>
        </div>
        <div class="chart-container">
          <canvas id="chartRTKDelta"></canvas>
        </div>
      </div>

      <!-- –°—Ç–∞–¥–∏–∏ -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–°—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç</h2>
            <span class="badge">–°—Ç—Ä. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS2">
                <thead>
                  <tr>
                    <th>–°—Ç–∞–¥–∏—è</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–°—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç</h2>
            <span class="badge">–°—Ç—Ä. 4 (–†–¢–ö)</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS4">
                <thead>
                  <tr>
                    <th>–°—Ç–∞–¥–∏—è</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- –û–±–ª–∞—Å—Ç–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ (—Å–∫—Ä—ã—Ç—ã–µ) -->
  <div id="presentationPrint" style="display:none"></div>
  <div id="summaryPrint" style="display:none"></div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
  /* ==================== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã ==================== */
  const BRANCHES = [
    "–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°","–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°","–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°","–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°",
    "–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°","–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°","–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°","–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°","–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°"
  ];
  const BRANCH_PATTERNS = [
    {name:"–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°", re:/–°–æ—á–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°", re:/–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°", re:/–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ\s+–≠–°/i},
    {name:"–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–£—Å—Ç—å[\s\u00A0\u202F\-‚Äì‚Äî-]*–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°", re:/–Æ–≥–æ[\s\u00A0\u202F\-‚Äì‚Äî-]*–ó–∞–ø–∞–¥–Ω—ã–µ\s+–≠–°/i},
    {name:"–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°", re:/–ê–¥—ã–≥–µ–π—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°", re:/–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°", re:/–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°", re:/–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°", re:/–°–ª–∞–≤—è–Ω—Å–∫–∏–µ\s+–≠–°/i},
  ];

  /* –°—Ç–∞–¥–∏–∏ */
  const STATUS_PATTERNS = [
    {key:"work", title:"–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞", re:/–í\s*—Ä–∞–±–æ—Ç–µ\s*—É\s*—Ñ–∏–ª–∏–∞–ª–∞/i},
    {key:"dismantled", title:"–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ", re:/–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ/i},
    {key:"rc_digit", title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –†–æ—Å—Å–µ—Ç–∏ –¶–∏—Ñ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏\s*–†–æ—Å—Å–µ—Ç–∏\s*–¶–∏—Ñ—Ä–∞/i},
    {key:"op_sign", title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏\s*—É\s*–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞/i},
    {key:"filial_appr",title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –≤ —Ñ–∏–ª–∏–∞–ª–µ", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏\s*–≤\s*—Ñ–∏–ª–∏–∞–ª–µ/i},
    {key:"incl_next", title:"–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è",
      re:/–ë—É–¥–µ—Ç\s*–≤–∫–ª—é—á–µ–Ω–æ(?:[\s\S]{0,80})–≤(?:\s*—Å–ª–µ–¥—É—é—â–µ–µ)?(?:[\s\S]{0,80})–¥–æ–ø\.?\s*—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ(?:[\s\S]{0,80}–ø–æ—Å–ª–µ\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏—è)?/i
    },
  ];
  const STATUS_KEYS = STATUS_PATTERNS.map(s => s.key);
  const STAGE_TITLE = k => (STATUS_PATTERNS.find(s => s.key===k)||{}).title||k;

  const SHORT_STAGE_TITLES = {
    "work": "–í —Ä–∞–±–æ—Ç–µ",
    "dismantled": "–î–µ–º–æ–Ω—Ç.",
    "rc_digit": "–û—Ñ–æ—Ä–º–ª. –†–¶",
    "op_sign": "–ü–æ–¥–ø–∏—Å—å –æ–ø–µ—Ä.",
    "filial_appr": "–°–æ–≥–ª. —Ñ–∏–ª–∏–∞–ª",
    "incl_next": "–í —Å–ª–µ–¥. –¥–æ–ø.—Å–æ–≥–ª."
  };
  const SHORT_STAGE_TITLE = k => SHORT_STAGE_TITLES[k] || STAGE_TITLE(k);

  const numberize = s => {
    const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
    const n = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
    if(!n) return 0;
    const val = Number(n.replace(",", "."));
    return isNaN(val) ? 0 : val;
  };
  const fmt = n => (typeof n === "number" ? n : Number(n||0)).toLocaleString("ru-RU");
  const normalize = txt => String(txt||"")
      .replace(/\u00A0|\u202F/g," ")
      .replace(/\u00AD/g,"")
      .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
      .replace(/[ \t]+/g," ")
      .trim();

  /* ==================== –ß—Ç–µ–Ω–∏–µ PDF ==================== */
  async function pdfToPages(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      let pageText = "", lastY = null;
      content.items.forEach(item => {
        const y = item.transform[5];
        if(lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
        pageText += item.str;
        lastY = y;
      });
      pages.push(normalize(pageText));
    }
    return pages;
  }

  /* ==================== –ü–∞—Ä—Å–∏–Ω–≥ ==================== */
  function extractDateFromPages(pages){
    for(const pg of pages){
      const m = pg.match(/–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
    return "‚Äî";
  }

  function parseTotalsFromPage(page1){
    const find = (re) => {
      const m = page1.match(re);
      return m ? numberize(m[1]) : 0;
    };
    return {
      found_year: find(/–≤—ã—è–≤–ª–µ–Ω–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
      legalized: find(/–£–∑–∞–∫–æ–Ω–µ–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
      dismantled_ytd: find(/–ó–∞\s*20\d{2}\s*–≥–æ–¥\s*–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
      in_work_total: find(/–í\s*—Ä–∞–±–æ—Ç–µ[^0-9]*?–≤—Å–µ–≥–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
      rtk_in_work: find(/–≤\s*—Ç–æ–º\s*—á–∏—Å–ª–µ\s*–ü–ê–û\s*¬´?–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª?[^0-9]*?(\d[\d\s]+)/i),
    };
  }

  function parseBranchTable(pageText){
    const text = normalize(pageText);
    const lines = text.split("\n").filter(Boolean);

    const idx = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      for(const bp of BRANCH_PATTERNS){
        if(bp.re.test(line)){ idx.push({i, name: bp.name}); break; }
      }
    }
    idx.push({i: lines.length, name:null});

    const branches = new Map();
    for(let k=0;k<idx.length-1;k++){
      const start = idx[k].i, end = idx[k+1].i, branchName = idx[k].name;
      if(!branchName) continue;
      const headLine = lines[start] || "";
      const segText = lines.slice(start+1, end).join(" ");

      let total = 0;
      const headNums = headLine.match(/\d[\d\s]*/g);
      if(headNums && headNums.length) total = numberize(headNums[headNums.length-1]);
      if(total===0 && lines[start+1]){
        const n2 = (lines[start+1]||"").match(/\d[\d\s]*/g);
        if(n2 && n2.length) total = numberize(n2[n2.length-1]);
      }

      const data = { total, statuses:{} };

      function numAfter(re, hay){
        const rx = new RegExp(re.source + "[^\\d]{0,200}(\\d[\\d\\s]*)", re.flags);
        const m = hay.match(rx);
        return m ? numberize(m[1]) : null;
      }

      for(const sp of STATUS_PATTERNS){
        let v = numAfter(sp.re, segText);
        if(v === null){
          for(let j=start+1;j<end;j++){
            const l0 = lines[j]||"", l1 = lines[j+1]||"";
            if(sp.re.test(l0) || sp.re.test(l1)){
              let cap = (l0.match(/(\d[\d\s]*)/g)||[]).pop();
              if(!cap) cap = (l1.match(/(\d[\d\s]*)/g)||[]).pop();
              if(cap){ v = numberize(cap); break; }
            }
          }
        }
        if(v !== null) data.statuses[sp.key] = v;
      }
      branches.set(branchName, data);
    }

    for(const b of BRANCHES){
      if(!branches.has(b)) branches.set(b, { total:0, statuses:{} });
    }

    const stages = {};
    for(const [_, obj] of branches){
      for(const [k,v] of Object.entries(obj.statuses)){
        stages[k] = (stages[k]||0) + (v||0);
      }
    }

    const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);
    return { branches, overall, stages };
  }

  function parseReportByPages(pages){
    return {
      date: extractDateFromPages(pages),
      p1: { totals: parseTotalsFromPage(pages[0] || "") },
      p2: parseBranchTable(pages[1] || ""),
      p3: parseBranchTable(pages[2] || ""),
      p4: parseBranchTable(pages[3] || ""),
    };
  }

  /* ==================== –î–∏–Ω–∞–º–∏–∫–∞ ==================== */
  function computeDynamics(curr, prev){
    const dyn = {
      in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
      rtk_in_work: (curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work) || 0,
      legalized: (curr.p1.totals.legalized - prev.p1.totals.legalized) || 0,
      dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
    };
    dyn.found_week = dyn.in_work_total;

    const makeRows = (cPage, pPage) => BRANCHES.map(b=>{
      const c = cPage.branches.get(b)?.total || 0;
      const p = pPage.branches.get(b)?.total || 0;
      return {b, p, c, d: (c - p)};
    });

    const branchRows = makeRows(curr.p2, prev.p2);
    const branchRowsS3 = makeRows(curr.p3, prev.p3);
    const branchRowsS4 = makeRows(curr.p4, prev.p4);

    const allKeys = Array.from(new Set([
      ...Object.keys(prev.p2.stages||{}), ...Object.keys(curr.p2.stages||{}),
      ...Object.keys(prev.p3.stages||{}), ...Object.keys(curr.p3.stages||{}),
      ...Object.keys(prev.p4.stages||{}), ...Object.keys(curr.p4.stages||{}),
      ...STATUS_KEYS
    ]));

    const diffStages = (cur, prv) => allKeys.map(k=>({
      stage: STAGE_TITLE(k), short: SHORT_STAGE_TITLE(k), key: k,
      p: prv[k] || 0, c: cur[k] || 0, d: (cur[k]||0) - (prv[k]||0)
    }));

    const stagesS2 = diffStages(curr.p2.stages||{}, prev.p2.stages||{});
    const stagesS4 = diffStages(curr.p4.stages||{}, prev.p4.stages||{});

    function perBranchStages(cPage, pPage){
      return BRANCHES.map(b=>{
        const cst = cPage.branches.get(b)?.statuses || {};
        const pst = pPage.branches.get(b)?.statuses || {};
        const by = {};
        STATUS_KEYS.forEach(k=>{
          const p = pst[k]||0, c = cst[k]||0;
          by[k] = {p,c,d:c-p};
        });
        return {b, by};
      });
    }
    const s2BranchStages = perBranchStages(curr.p2, prev.p2);

    return {
      ...dyn,
      branchRows,
      branchRowsS3,
      branchRowsS4,
      stagesS2,
      stagesS4,
      s2BranchStages,
      rtkRows: branchRowsS4
    };
  }pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
<div class="chart-container">
        <img src="${imgS2}" alt="–ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRows, ["sumPrev", "sumCurr", "sumDelta"])}
      </div>
    </div>
    <div class="slide-number">3</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 4: –ü—Ä–∏–∫–∞–∑ ‚Ññ425 -->
  <div class="slide">
    <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425</h2>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${imgS3}" alt="–ì—Ä–∞—Ñ–∏–∫ –ü—Ä–∏–∫–∞–∑ 425">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"])}
      </div>
    </div>
    <div class="slide-number">4</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 5: –ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º -->
  <div class="slide">
    <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${imgS4}" alt="–ì—Ä–∞—Ñ–∏–∫ –†–æ—Å—Ç–µ–ª–µ–∫–æ–º">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"])}
      </div>
    </div>
    <div class="slide-number">5</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 6: –ò–∑–º–µ–Ω–µ–Ω–∏—è –†–¢–ö -->
  <div class="slide">
    <h2>–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
    <div class="chart-container" style="max-width: 1200px; width: 100%;">
      <img src="${imgRTK}" alt="–ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –†–¢–ö">
    </div>
    <div class="slide-number">6</div>
  </div>
</body>
</html>`;
  }

  function generateKPICards(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    const kpis = [
      {label: "–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ", value: curr.p1.totals.in_work_total, delta: dyn.in_work_total},
      {label: "–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value: dyn.found_week, delta: dyn.found_week},
      {label: "–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value: eff, delta: eff},
      {label: "–ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º", value: curr.p1.totals.rtk_in_work, delta: dyn.rtk_in_work, extra: `${rtkShare.toFixed(1)}%`}
    ];
    
    return kpis.map(kpi => `
      <div class="kpi-card">
        <div class="kpi-label">${kpi.label}</div>
        <div class="kpi-value">${fmt(kpi.value)}</div>
        <div class="kpi-delta ${kpi.delta >= 0 ? 'positive' : 'negative'}">
          ${kpi.delta > 0 ? '+' : ''}${fmt(kpi.delta)}
          ${kpi.extra ? ` (${kpi.extra})` : ''}
        </div>
      </div>
    `).join('');
  }

  function generateSlideTable(rows, sumIds){
    const sorted = [...rows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d));
    return `
      <table>
        <thead>
          <tr>
            <th>–§–∏–ª–∏–∞–ª</th>
            <th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</th>
            <th>–¢–µ–∫—É—â–∞—è</th>
            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody>
          ${sorted.map(r => `
            <tr>
              <td>${r.b}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d > 0 ? 'positive' : r.d < 0 ? 'negative' : ''}">
                ${r.d > 0 ? '+' : ''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr>
            <td>–ò—Ç–æ–≥–æ</td>
            <td>${document.getElementById(sumIds[0]).textContent}</td>
            <td>${document.getElementById(sumIds[1]).textContent}</td>
            <td>${document.getElementById(sumIds[2]).textContent}</td>
          </tr>
        </tfoot>
      </table>
    `;
  }

  function generateWordContent(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    return `
      <h2>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
      <ul>
        <li>–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ: <strong>${fmt(curr.p1.totals.in_work_total)}</strong> 
            <span class="${dyn.in_work_total>=0?'positive':'negative'}">
              (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})
            </span>
        </li>
        <li>–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é: <strong>${fmt(dyn.found_week)}</strong></li>
        <li>–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é (—É–∑–∞–∫–æ–Ω–µ–Ω–æ + –¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ): <strong>${fmt(eff)}</strong></li>
        <li>–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª –≤ —Ä–∞–±–æ—Ç–µ: <strong>${fmt(curr.p1.totals.rtk_in_work)}</strong> 
            <span class="${dyn.rtk_in_work>=0?'positive':'negative'}">
              (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})
            </span>; 
            –¥–æ–ª—è <strong>${rtkShare.toFixed(1)}%</strong>
        </li>
      </ul>
      
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
      
      <h3>–û–±—â–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ (–≤—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã)</h3>
      ${generateWordTable(dyn.branchRows, ["sumPrev", "sumCurr", "sumDelta"])}
      
      <h3>–ü—Ä–∏–∫–∞–∑ ‚Ññ425</h3>
      ${generateWordTable(dyn.branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"])}
      
      <h3>–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h3>
      ${generateWordTable(dyn.branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"])}
      
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h2>
      ${generateWordStagesTable(dyn.stagesS2)}
      
      <div class="info-box">
        <p><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö PDF-—Ñ–∞–π–ª–æ–≤.<br>
        –î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}</p>
      </div>
    `;
  }

  function generateWordTable(rows, sumIds){
    const sorted = [...rows].sort((a,b) => b.b.localeCompare(a.b, 'ru'));
    return `
      <table>
        <thead>
          <tr>
            <th>–§–∏–ª–∏–∞–ª</th>
            <th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</th>
            <th>–¢–µ–∫—É—â–∞—è</th>
            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody>
          ${sorted.map(r => `
            <tr>
              <td>${r.b}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d>0?'positive':r.d<0?'negative':''}">
                ${r.d>0?'+':''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr style="font-weight:bold;background:#f0f0f0">
            <td>–ò–¢–û–ì–û</td>
            <td>${document.getElementById(sumIds[0]).textContent}</td>
            <td>${document.getElementById(sumIds[1]).textContent}</td>
            <td>${document.getElementById(sumIds[2]).textContent}</td>
          </tr>
        </tfoot>
      </table>
    `;
  }

  function generateWordStagesTable(stages){
    return `
      <table>
        <thead>
          <tr>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ü—Ä–µ–¥.</th>
            <th>–¢–µ–∫.</th>
            <th>Œî</th>
          </tr>
        </thead>
        <tbody>
          ${stages.map(r => `
            <tr>
              <td>${r.stage}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d>0?'positive':r.d<0?'negative':''}">
                ${r.d>0?'+':''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  /* ==================== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ==================== */
  function triggerDownload(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = filename; 
    document.body.appendChild(a); 
    a.click();
    setTimeout(()=>{ 
      URL.revokeObjectURL(url); 
      a.remove(); 
    }, 0);
  }

  function showExportMessage(text){
    const el = document.getElementById("exportStatus");
    el.textContent = text;
    el.style.display = "flex";
    setTimeout(() => { el.style.display = "none"; }, 3000);
  }

  function showLoadingMessage(text){
    const el = document.getElementById("loadingMsg");
    if(text){
      el.style.display = "flex";
      el.querySelector("span").textContent = text;
    } else {
      el.style.display = "none";
    }
  }

  function showErrorMessage(text){
    const el = document.getElementById("errorMsg");
    if(text){
      el.textContent = text;
      el.style.display = "flex";
    } else {
      el.style.display = "none";
    }
  }

  function showDates(prev, curr){
    const el = document.getElementById("dates");
    el.innerHTML = `<strong>–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞:</strong> ${prev} ‚Äî ${curr}`;
    el.style.display = "flex";
  }

  /* ==================== –ü–ª–∞–Ω-–§–∞–∫—Ç –∏–∑ Google Sheets ==================== */
  const SHEET_HTML_URL = "https://docs.google.com/spreadsheets/d/1Y9bM7zLRf_gonMUgfQLl57Iu3NgPa78rBXnpxkKLvO0/gviz/tq?tqx=out:html";
  
  async function injectPlanFactHTML(){
    try{
      const res = await fetch(SHEET_HTML_URL, {cache:"no-store", mode:"cors"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const html = await res.text();
      
      // –°—Ç–∏–ª–∏–∑—É–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–¥ –Ω–∞—à –¥–∏–∑–∞–π–Ω
      const styledHTML = stylePlanFactTable(html);
      
      if(document.getElementById("presPlanFactInner")){
        document.getElementById("presPlanFactInner").innerHTML = styledHTML;
      }
      if(document.getElementById("briefPlanFactInner")){
        document.getElementById("briefPlanFactInner").innerHTML = styledHTML;
      }
    }catch(e){
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ü–ª–∞–Ω-–§–∞–∫—Ç:", e);
    }
  }

  function stylePlanFactTable(html){
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    const table = tmp.querySelector("table");
    
    if(!table) return '<div class="message message-error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ü–ª–∞–Ω-–§–∞–∫—Ç</div>';
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏
    table.style.cssText = `
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    `;
    
    // –°—Ç–∏–ª–∏–∑—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    table.querySelectorAll("th").forEach(th => {
      th.style.cssText = `
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 12px;
        font-weight: 600;
        border-bottom: 2px solid var(--glass-border);
      `;
    });
    
    // –°—Ç–∏–ª–∏–∑—É–µ–º —è—á–µ–π–∫–∏
    table.querySelectorAll("td").forEach(td => {
      td.style.cssText = `
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
      `;
    });
    
    return `
      <div class="table-container">
        <div class="table-scroll">
          ${table.outerHTML}
        </div>
      </div>
    `;
  }

  /* ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==================== */
  let DATA = null;

  // –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è —à–∞–ø–∫–∏
  window.addEventListener('scroll', () => {
    const header = document.getElementById('header');
    if (window.scrollY > 50) {
      header.classList.add('scrolled');
    } else {
      header.classList.remove('scrolled');
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤
  document.getElementById("btnParse").addEventListener("click", async () => {
    const fPrev = document.getElementById("filePrev").files[0];
    const fCurr = document.getElementById("fileCurr").files[0];
    
    if(!fPrev || !fCurr){ 
      showErrorMessage("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ PDF —Ñ–∞–π–ª–∞: –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏ —Ç–µ–∫—É—â–∏–π –æ—Ç—á–µ—Ç—ã"); 
      return; 
    }

    try{
      showLoadingMessage("–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF —Ñ–∞–π–ª–æ–≤...");
      showErrorMessage("");

      const [pPrev, pCurr] = await Promise.all([pdfToPages(fPrev), pdfToPages(fCurr)]);
      
      showLoadingMessage("–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...");
      
      const prev = parseReportByPages(pPrev);
      const curr = parseReportByPages(pCurr);
      const dyn = computeDynamics(curr, prev);
      DATA = {prev, curr, dyn};

      showDates(prev.date, curr.date);
      renderKpis(curr, prev, dyn);
      renderBranchesTable(dyn.branchRows, "#tblBranches tbody", "sumPrev", "sumCurr", "sumDelta");
      renderBranchesTable(dyn.branchRowsS3, "#tblBranchesS3 tbody", "sumPrevS3", "sumCurrS3", "sumDeltaS3");
      renderBranchesTable(dyn.branchRowsS4, "#tblBranchesS4 tbody", "sumPrevS4", "sumCurrS4", "sumDeltaS4");
      renderCharts(curr, prev, dyn);
      renderStagesTables(dyn);
      
      await injectPlanFactHTML();

      showLoadingMessage("");
      showExportMessage("–ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!");
      
    }catch(e){
      console.error(e);
      showLoadingMessage("");
      showErrorMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ PDF. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
  document.getElementById("exportPresPDF").addEventListener("click", async () => {
    if(!DATA) return showErrorMessage("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç—ã");
    await exportPresPDF();
  });

  document.getElementById("exportBriefPDF").addEventListener("click", async () => {
    if(!DATA) return showErrorMessage("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç—ã");
    await exportBriefPDF();
  });

  document.getElementById("exportWordHTML").addEventListener("click", () => {
    if(!DATA) return showErrorMessage("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç—ã");
    exportWordHTML();
  });

  document.getElementById("exportPresHTML").addEventListener("click", () => {
    if(!DATA) return showErrorMessage("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç—ã");
    exportPresHTML();
  });

  // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
  document.getElementById("btnCompact").addEventListener("click", ()=>{
    document.body.classList.toggle("compact");
    const btn = document.getElementById("btnCompact");
    if(document.body.classList.contains("compact")){
      btn.innerHTML = '<span>üìê</span> –û–±—ã—á–Ω—ã–π –≤–∏–¥';
    } else {
      btn.innerHTML = '<span>üìê</span> –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥';
    }
  });

  </script>
</body>
</html>
      html2canvas: {scale: 2, useCORS: true},
      jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'}
    }).save();
    el.style.display = "none";
    showExportMessage("PDF –≤—ã–∂–∏–º–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω");
  }

  /* ==================== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ==================== */
  function buildPresentationTables(){
    const {branchRows, branchRowsS3, branchRowsS4} = DATA.dyn;
    
    const makeTable = (title, icon, rows, sumIds) => {
      const sorted = [...rows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d));
      return `
        <div class="table-section">
          <div class="section-title">
            <div class="section-icon">${icon}</div>
            ${title}
          </div>
          <table>
            <thead>
              <tr>
                <th>–§–∏–ª–∏–∞–ª</th>
                <th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</th>
                <th>–¢–µ–∫—É—â–∞—è</th>
                <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map(r => `
                <tr>
                  <td>${r.b}</td>
                  <td>${fmt(r.p)}</td>
                  <td>${fmt(r.c)}</td>
                  <td class="${r.d > 0 ? 'delta-positive' : r.d < 0 ? 'delta-negative' : ''}">
                    ${r.d > 0 ? '+' : ''}${fmt(r.d)}
                  </td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr>
                <td>–ò—Ç–æ–≥–æ</td>
                <td>${document.getElementById(sumIds[0]).textContent}</td>
                <td>${document.getElementById(sumIds[1]).textContent}</td>
                <td>${document.getElementById(sumIds[2]).textContent}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    };
    
    return makeTable("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)", "üìä", branchRows, ["sumPrev", "sumCurr", "sumDelta"]) +
           makeTable("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425", "üìã", branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"]) +
           makeTable("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", "üåê", branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"]);
  }

  function buildSummaryContent(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    
    const topChanges = [...dyn.branchRows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d)).slice(0, 3);
    
    return `
      <div class="brief-block">
        <div class="brief-title">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
        <div class="brief-content">
          <div class="brief-item">‚Ä¢ –í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ: <span class="brief-value">${fmt(curr.p1.totals.in_work_total)}</span> (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})</div>
          <div class="brief-item">‚Ä¢ –í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é: <span class="brief-value">${fmt(dyn.found_week)}</span></div>
          <div class="brief-item">‚Ä¢ –ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é: <span class="brief-value">${fmt(eff)}</span></div>
          <div class="brief-item">‚Ä¢ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª: <span class="brief-value">${fmt(curr.p1.totals.rtk_in_work)}</span> (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</div>
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">–¢–æ–ø-3 —Ñ–∏–ª–∏–∞–ª–∞ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º</div>
        <div class="brief-content">
          ${topChanges.map((r, i) => `
            <div class="brief-item">${i+1}. <span class="brief-value">${r.b}</span>: ${fmt(r.p)} ‚Üí ${fmt(r.c)} (${r.d>0?'+':''}${fmt(r.d)})</div>
          `).join('')}
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">–ò—Ç–æ–≥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
        <div class="brief-content">
          <div class="brief-item">‚Ä¢ –í—Å–µ–≥–æ –æ–ø–æ—Ä: ${document.getElementById("sumPrev").textContent} ‚Üí <span class="brief-value">${document.getElementById("sumCurr").textContent}</span> (${document.getElementById("sumDelta").textContent})</div>
          <div class="brief-item">‚Ä¢ –ü—Ä–∏–∫–∞–∑ ‚Ññ425: ${document.getElementById("sumPrevS3").textContent} ‚Üí <span class="brief-value">${document.getElementById("sumCurrS3").textContent}</span> (${document.getElementById("sumDeltaS3").textContent})</div>
          <div class="brief-item">‚Ä¢ –ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º: ${document.getElementById("sumPrevS4").textContent} ‚Üí <span class="brief-value">${document.getElementById("sumCurrS4").textContent}</span> (${document.getElementById("sumDeltaS4").textContent})</div>
        </div>
      </div>
    `;
  }

  /* ==================== –≠–∫—Å–ø–æ—Ä—Ç Word HTML ==================== */
  function exportWordHTML(){
    if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
    const {curr, prev, dyn} = DATA;
    
    const htmlDoc = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–û—Ç—á–µ—Ç –í–û–õ–° - ${curr.date}</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body { font-family: 'Calibri', Arial, sans-serif; line-height: 1.6; color: #333; }
    h1 { color: #1E3A8A; font-size: 24pt; border-bottom: 3pt solid #1E3A8A; padding-bottom: 10pt; }
    h2 { color: #1E3A8A; font-size: 18pt; margin-top: 20pt; }
    h3 { color: #333; font-size: 14pt; margin-top: 15pt; }
    table { width: 100%; border-collapse: collapse; margin: 15pt 0; }
    th, td { border: 1pt solid #ddd; padding: 8pt; text-align: center; }
    th { background-color: #1E3A8A; color: white; font-weight: bold; }
    th:first-child, td:first-child { text-align: left; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .info-box { background: #EBF4FF; border-left: 4pt solid #1E3A8A; padding: 10pt; margin: 10pt 0; }
    .positive { color: #10B981; font-weight: bold; }
    .negative { color: #EF4444; font-weight: bold; }
  </style>
</head>
<body>
  <h1>–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª ‚Äî –û—Ç—á–µ—Ç –ø–æ –í–û–õ–°</h1>
  
  <div class="info-box">
    <p><strong>–û—Ç—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥:</strong><br>
    –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è: ${prev.date}<br>
    –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è: ${curr.date}</p>
  </div>
  
  ${generateWordContent()}
</body>
</html>`;

    const blob = new Blob([htmlDoc], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `–û—Ç—á–µ—Ç_–í–û–õ–°_${curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Word.");
  }

  /* ==================== –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ HTML ==================== */
  function exportPresHTML(){
    if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
    
    const presHTML = generatePresentationHTML();
    const blob = new Blob([presHTML], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${DATA.curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
  }

  function generatePresentationHTML(){
    const {curr, prev, dyn} = DATA;
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const imgS2 = document.getElementById("chartBranches").toDataURL("image/png");
    const imgS3 = document.getElementById("chartBranchesS3").toDataURL("image/png");
    const imgS4 = document.getElementById("chartBranchesS4").toDataURL("image/png");
    const imgRTK = document.getElementById("chartRTKDelta").toDataURL("image/png");
    
    return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –í–û–õ–° - ${curr.date}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #0F172A;
      color: #F1F5F9;
      overflow-x: hidden;
    }
    
    .slide {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px;
      position: relative;
      background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                  #0F172A;
    }
    
    .slide-header {
      position: absolute;
      top: 40px;
      left: 60px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 20px;
      color: white;
    }
    
    .slide-number {
      position: absolute;
      bottom: 40px;
      right: 60px;
      font-size: 18px;
      color: #64748B;
    }
    
    h1 {
      font-size: 48px;
      font-weight: 800;
      text-align: center;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h2 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 30px;
      color: #F1F5F9;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      max-width: 1400px;
    }
    
    .chart-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .chart-container img {
      width: 100%;
      height: auto;
      border-radius: 12px;
    }
    
    .table-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: rgba(59, 130, 246, 0.2);
      color: #F1F5F9;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    th:not(:first-child) { text-align: right; }
    
    td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: #94A3B8;
    }
    
    td:not(:first-child) { text-align: right; }
    
    tr:hover { background: rgba(255, 255, 255, 0.03); }
    
    tfoot td {
      background: rgba(59, 130, 246, 0.1);
      font-weight: 700;
      color: #F1F5F9;
      border-top: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 30px;
      width: 100%;
      max-width: 1200px;
    }
    
    .kpi-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
    }
    
    .kpi-label {
      font-size: 14px;
      color: #94A3B8;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .kpi-value {
      font-size: 48px;
      font-weight: 800;
      margin: 10px 0;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .kpi-delta {
      font-size: 18px;
      font-weight: 600;
    }
    
    .positive { color: #10B981; }
    .negative { color: #EF4444; }
    
    @media print {
      .slide { page-break-after: always; }
    }
  </style>
</head>
<body>
  <!-- –°–ª–∞–π–¥ 1: –¢–∏—Ç—É–ª—å–Ω—ã–π -->
  <div class="slide">
    <div class="slide-header">
      <div class="logo">–†–ö</div>
      <span style="font-size: 20px; font-weight: 600;">–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</span>
    </div>
    <h1>–î–∏–Ω–∞–º–∏–∫–∞ –í–û–õ–°<br>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç</h1>
    <p style="font-size: 24px; color: #94A3B8;">–ü–µ—Ä–∏–æ–¥: ${prev.date} ‚Äî ${curr.date}</p>
    <div class="slide-number">1</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 2: KPI -->
  <div class="slide">
    <h2>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
    <div class="kpi-grid">
      ${generateKPICards()}
    </div>
    <div class="slide-number">2</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 3: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º -->
  <div class="slide">
    <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)</h2>
    <div class="content-grid">
      <div class="chart-container">  /* ==================== –†–µ–Ω–¥–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ==================== */
  let chartBranches, chartBranchesS3, chartBranchesS4, chartRTKDelta;

  function renderKpis(curr, prev, dyn){
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const items = [
      {title:"–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ", value:curr.p1.totals.in_work_total, delta:dyn.in_work_total, unit:"—à—Ç."},
      {title:"–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value:dyn.found_week, delta:dyn.found_week, unit:"—à—Ç."},
      {title:"–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value:eff, delta:eff, unit:"—à—Ç.", subtitle:"(—É–∑–∞–∫. + –¥–µ–º–æ–Ω—Ç.)"},
      {title:"–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", value:curr.p1.totals.rtk_in_work, delta:dyn.rtk_in_work, unit:"—à—Ç.", subtitle:`–¥–æ–ª—è ${rtkShare.toFixed(1)}%`},
    ];

    document.getElementById("kpis").innerHTML = items.map(it=>{
      const d = typeof it.delta==="number"?it.delta:0;
      const deltaClass = d>0?"positive":(d<0?"negative":"neutral");
      const sign=d>0?"+":"";
      const arrow = d>0?"‚Üë":(d<0?"‚Üì":"‚Üí");
      
      return `<div class="kpi-card">
        <div class="kpi-label">${it.title}</div>
        <div class="kpi-value">${fmt(it.value)} <span style="font-size:0.5em;font-weight:400;color:var(--text-secondary)">${it.unit}</span></div>
        ${it.subtitle ? `<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem">${it.subtitle}</div>` : ''}
        <div class="kpi-delta ${deltaClass}">
          <span>${arrow}</span>
          <span>${sign}${fmt(d)}</span>
        </div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(rows, tbodySel, sumPrevId, sumCurrId, sumDeltaId){
    const tbody = document.querySelector(tbodySel);
    tbody.innerHTML = "";
    let sP=0,sC=0,sD=0;
    const sorted = [...rows].sort((a,b)=>Math.abs((b.c-b.p)) - Math.abs((a.c-a.p)));
    for(const r0 of sorted){
      const p = Number(r0.p)||0, c = Number(r0.c)||0;
      const d = c - p;
      const cls = d>0?"value-positive":(d<0?"value-negative":"");
      sP+=p; sC+=c; sD+=d;
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r0.b}</td>
          <td>${fmt(p)}</td>
          <td>${fmt(c)}</td>
          <td class="${cls}">${d>0?"+":""}${fmt(d)}</td>
        </tr>`);
    }
    document.getElementById(sumPrevId).textContent = fmt(sP);
    document.getElementById(sumCurrId).textContent = fmt(sC);
    document.getElementById(sumDeltaId).textContent = (sD>0?"+":"")+fmt(sD);
    document.getElementById(sumDeltaId).className = sD>0?"value-positive":(sD<0?"value-negative":"");
  }

  function chartOpts(){
    Chart.defaults.color = '#94A3B8';
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
    
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:"top",
          labels:{
            boxWidth:12,
            usePointStyle:true,
            padding:20,
            font:{size:12}
          }
        },
        tooltip:{
          backgroundColor: 'rgba(30, 41, 59, 0.9)',
          titleColor: '#F1F5F9',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          boxWidth: 12,
          boxHeight: 12,
          usePointStyle: true
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid:{
            color:'rgba(255, 255, 255, 0.05)',
            drawBorder:false
          },
          ticks:{
            precision:0,
            padding:10
          }
        },
        x:{
          grid:{
            display:false,
            drawBorder:false
          },
          ticks:{
            padding:10
          }
        }
      },
    };
  }

  function renderCharts(curr, prev, dyn){
    const labels = BRANCHES;
    const prevS2 = labels.map(b=>prev.p2.branches.get(b)?.total||0);
    const currS2 = labels.map(b=>curr.p2.branches.get(b)?.total||0);

    if(chartBranches) chartBranches.destroy();
    chartBranches = new Chart(document.getElementById("chartBranches"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS2, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS2, backgroundColor:"rgba(59, 130, 246, 0.5)", borderColor:"rgba(59, 130, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS3 = labels.map(b=>prev.p3.branches.get(b)?.total||0);
    const currS3 = labels.map(b=>curr.p3.branches.get(b)?.total||0);
    if(chartBranchesS3) chartBranchesS3.destroy();
    chartBranchesS3 = new Chart(document.getElementById("chartBranchesS3"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS3, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS3, backgroundColor:"rgba(139, 92, 246, 0.5)", borderColor:"rgba(139, 92, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS4 = labels.map(b=>prev.p4.branches.get(b)?.total||0);
    const currS4 = labels.map(b=>curr.p4.branches.get(b)?.total||0);
    if(chartBranchesS4) chartBranchesS4.destroy();
    chartBranchesS4 = new Chart(document.getElementById("chartBranchesS4"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS4, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS4, backgroundColor:"rgba(6, 182, 212, 0.5)", borderColor:"rgba(6, 182, 212, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const rtkD = labels.map(b => (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).c - (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).p);
    if(chartRTKDelta) chartRTKDelta.destroy();
    chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
      type:"bar",
      data:{labels, datasets:[{
        label:"–ò–∑–º–µ–Ω–µ–Ω–∏–µ (—Ç–µ–∫. ‚àí –ø—Ä–µ–¥.)", 
        data:rtkD, 
        backgroundColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.5)":"rgba(239, 68, 68, 0.5)"),
        borderColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.8)":"rgba(239, 68, 68, 0.8)"),
        borderWidth: 1<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–û–õ–° –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | –†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ç–æ–∫–µ–Ω—ã –¥–∏–∑–∞–π–Ω–∞ ====== */
    :root{
      /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ –±—Ä–µ–Ω–¥–∞ */
      --primary: #1E3A8A;
      --primary-light: #3B82F6;
      --primary-dark: #1E293B;
      --accent: #06B6D4;
      --accent-glow: rgba(6, 182, 212, 0.3);
      
      /* –§–æ–Ω—ã –∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ */
      --bg-main: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(59, 130, 246, 0.1);
      
      /* –°—Ç–µ–∫–ª–æ–º–æ—Ä—Ñ–∏–∑–º */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* –¢–µ–∫—Å—Ç */
      --text-primary: #F1F5F9;
      --text-secondary: #94A3B8;
      --text-muted: #64748B;
      
      /* –°—Ç–∞—Ç—É—Å—ã */
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      
      /* –≠—Ñ—Ñ–µ–∫—Ç—ã */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.7);
      --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.3);
      
      /* –°–∫—Ä—É–≥–ª–µ–Ω–∏—è */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* –§–æ–Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* ====== –®–∞–ø–∫–∞ ====== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      transition: var(--transition);
    }

    header.scrolled {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      letter-spacing: -0.02em;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* ====== –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç ====== */
    main {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* ====== –°–µ—Ç–∫–∞ ====== */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .cols-4 { grid-template-columns: repeat(2, 1fr); }
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .cols-2, .cols-3, .cols-4 { grid-template-columns: 1fr; }
    }

    /* ====== –ö–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* ====== KPI –∫–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-delta {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .kpi-delta.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .kpi-delta.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .kpi-delta.neutral {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* ====== –ö–Ω–æ–ø–∫–∏ ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px dashed var(--glass-border);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
      background: var(--glass);
    }

    /* ====== –§–æ—Ä–º—ã ====== */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--glass);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-wrapper:hover {
      border-color: var(--primary-light);
      background: var(--bg-hover);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    /* ====== –¢–∞–±–ª–∏—Ü—ã ====== */
    .table-container {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-scroll {
      max-height: 400px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--glass-border) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 2px solid var(--glass-border);
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    tfoot td {
      background: var(--bg-secondary);
      font-weight: 700;
      color: var(--text-primary);
      padding: 1rem;
      border-top: 2px solid var(--glass-border);
    }

    /* ====== –ì—Ä–∞—Ñ–∏–∫–∏ ====== */
    .chart-container {
      height: 400px;
      padding: 1rem;
      background: var(--glass);
      border-radius: var(--radius-md);
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== –°—Ç–∞—Ç—É—Å—ã –∏ –∑–Ω–∞—á–∫–∏ ====== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--success);
      font-weight: 600;
    }

    .value-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* ====== –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ ====== */
    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== –°–æ–æ–±—â–µ–Ω–∏—è ====== */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .message-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .message-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    /* ====== –°–µ–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ====== */
    .export-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    /* ====== –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å ====== */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }

      .brand {
        font-size: 1rem;
      }

      .logo {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }

      main {
        margin-top: 70px;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 2rem;
      }

      .table-scroll {
        max-height: 300px;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
    }

    /* ====== –£—Ç–∏–ª–∏—Ç—ã ====== */
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    /* ====== –ü–µ—á–∞—Ç—å ====== */
    @media print {
      body {
        background: white;
        color: black;
      }

      header {
        position: relative;
        background: white;
        border-bottom: 2px solid #000;
      }

      .card {
        background: white;
        border: 1px solid #ccc;
        box-shadow: none;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }

      .btn, .file-input-wrapper {
        display: none;
      }
    }

    /* ====== –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º ====== */
    .compact .card {
      padding: 1rem;
    }

    .compact .kpi-card {
      padding: 0.75rem;
    }

    .compact .kpi-value {
      font-size: 1.75rem;
    }

    .compact table {
      font-size: 0.75rem;
    }

    .compact th, .compact td {
      padding: 0.5rem;
    }

    .compact .chart-container {
      height: 300px;
    }

    /* ====== –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–µ—á–∞—Ç–∏ ====== */
    #presentationPrint, #summaryPrint {
      display: none;
    }
  </style>
</head>
<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header id="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">–†–ö</div>
        <span>–í–û–õ–° –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
      </div>
      <div class="nav-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
        </div>
      </div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main>
    <div class="container">
      <!-- –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">üìä</div>
              –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤
            </h2>
          </div>
          <div class="form-group">
            <label class="file-input-wrapper">
              <div class="file-icon">üìÑ</div>
              <span>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)</span>
              <input id="filePrev" type="file" accept="application/pdf">
            </label>
            <label class="file-input-wrapper">
              <div class="file-icon">üìÑ</div>
              <span>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)</span>
              <input id="fileCurr" type="file" accept="application/pdf">
            </label>
          </div>
          <div class="form-group">
            <button id="btnParse" class="btn btn-primary">
              <span>üöÄ</span>
              –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button id="btnCompact" class="btn btn-ghost" title="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º">
              <span>üìê</span>
              –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥
            </button>
          </div>
          <div id="dates" class="message message-info" style="display:none"></div>
          <div id="loadingMsg" class="loading" style="display:none">
            <div class="loading-spinner"></div>
            <span>–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF —Ñ–∞–π–ª–æ–≤...</span>
          </div>
          <div id="errorMsg" class="message message-error" style="display:none"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">üíæ</div>
              –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤
            </h2>
          </div>
          <div class="export-section">
            <button class="btn btn-secondary" id="exportPresPDF">
              <span>üìë</span>
              –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è PDF
            </button>
            <button class="btn btn-secondary" id="exportBriefPDF">
              <span>üìã</span>
              –í—ã–∂–∏–º–∫–∞ PDF
            </button>
            <button class="btn btn-secondary" id="exportWordHTML">
              <span>üìù</span>
              –û—Ç—á–µ—Ç Word
            </button>
            <button class="btn btn-secondary" id="exportPresHTML">
              <span>üåê</span>
              –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è HTML
            </button>
          </div>
          <div id="exportStatus" class="message message-success mt-1" style="display:none"></div>
        </div>
      </div>

      <!-- KPI —Å–µ–∫—Ü–∏—è -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">üìà</div>
            –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
          </h2>
        </div>
        <div id="kpis" class="kpi-grid"></div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 2 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranches"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranches">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrev">0</td>
                    <td id="sumCurr">0</td>
                    <td id="sumDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 3 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–ü—Ä–∏–∫–∞–∑ ‚Ññ425</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS3"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 3</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS3">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrevS3">0</td>
                    <td id="sumCurrS3">0</td>
                    <td id="sumDeltaS3">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 4 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS4"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 4</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS4">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrevS4">0</td>
                    <td id="sumCurrS4">0</td>
                    <td id="sumDeltaS4">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –†–¢–ö -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">üìä</div>
            –î–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª
          </h2>
        </div>
        <div class="chart-container">
          <canvas id="chartRTKDelta"></canvas>
        </div>
      </div>

      <!-- –°—Ç–∞–¥–∏–∏ -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–°—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç</h2>
            <span class="badge">–°—Ç—Ä. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS2">
                <thead>
                  <tr>
                    <th>–°—Ç–∞–¥–∏—è</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–°—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç</h2>
            <span class="badge">–°—Ç—Ä. 4 (–†–¢–ö)</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS4">
                <thead>
                  <tr>
                    <th>–°—Ç–∞–¥–∏—è</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- –û–±–ª–∞—Å—Ç–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ (—Å–∫—Ä—ã—Ç—ã–µ) -->
  <div id="presentationPrint" style="display:none"></div>
  <div id="summaryPrint" style="display:none"></div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
  /* ==================== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã ==================== */
  const BRANCHES = [
    "–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°","–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°","–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°","–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°",
    "–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°","–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°","–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°","–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°","–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°"
  ];
  const BRANCH_PATTERNS = [
    {name:"–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°", re:/–°–æ—á–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°", re:/–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°", re:/–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ\s+–≠–°/i},
    {name:"–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–£—Å—Ç—å[\s\u00A0\u202F\-‚Äì‚Äî-]*–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°", re:/–Æ–≥–æ[\s\u00A0\u202F\-‚Äì‚Äî-]*–ó–∞–ø–∞–¥–Ω—ã–µ\s+–≠–°/i},
    {name:"–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°", re:/–ê–¥—ã–≥–µ–π—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°", re:/–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°", re:/–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°", re:/–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°", re:/–°–ª–∞–≤—è–Ω—Å–∫–∏–µ\s+–≠–°/i},
  ];

  /* –°—Ç–∞–¥–∏–∏ */
  const STATUS_PATTERNS = [
    {key:"work", title:"–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞", re:/–í\s*—Ä–∞–±–æ—Ç–µ\s*—É\s*—Ñ–∏–ª–∏–∞–ª–∞/i},
    {key:"dismantled", title:"–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ", re:/–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ/i},
    {key:"rc_digit", title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –†–æ—Å—Å–µ—Ç–∏ –¶–∏—Ñ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏\s*–†–æ—Å—Å–µ—Ç–∏\s*–¶–∏—Ñ—Ä–∞/i},
    {key:"op_sign", title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏\s*—É\s*–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞/i},
    {key:"filial_appr",title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –≤ —Ñ–∏–ª–∏–∞–ª–µ", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏\s*–≤\s*—Ñ–∏–ª–∏–∞–ª–µ/i},
    {key:"incl_next", title:"–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è",
      re:/–ë—É–¥–µ—Ç\s*–≤–∫–ª—é—á–µ–Ω–æ(?:[\s\S]{0,80})–≤(?:\s*—Å–ª–µ–¥—É—é—â–µ–µ)?(?:[\s\S]{0,80})–¥–æ–ø\.?\s*—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ(?:[\s\S]{0,80}–ø–æ—Å–ª–µ\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏—è)?/i
    },
  ];
  const STATUS_KEYS = STATUS_PATTERNS.map(s => s.key);
  const STAGE_TITLE = k => (STATUS_PATTERNS.find(s => s.key===k)||{}).title||k;

  const SHORT_STAGE_TITLES = {
    "work": "–í —Ä–∞–±–æ—Ç–µ",
    "dismantled": "–î–µ–º–æ–Ω—Ç.",
    "rc_digit": "–û—Ñ–æ—Ä–º–ª. –†–¶",
    "op_sign": "–ü–æ–¥–ø–∏—Å—å –æ–ø–µ—Ä.",
    "filial_appr": "–°–æ–≥–ª. —Ñ–∏–ª–∏–∞–ª",
    "incl_next": "–í —Å–ª–µ–¥. –¥–æ–ø.—Å–æ–≥–ª."
  };
  const SHORT_STAGE_TITLE = k => SHORT_STAGE_TITLES[k] || STAGE_TITLE(k);

  const numberize = s => {
    const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
    const n = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
    if(!n) return 0;
    const val = Number(n.replace(",", "."));
    return isNaN(val) ? 0 : val;
  };
  const fmt = n => (typeof n === "number" ? n : Number(n||0)).toLocaleString("ru-RU");
  const normalize = txt => String(txt||"")
      .replace(/\u00A0|\u202F/g," ")
      .replace(/\u00AD/g,"")
      .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
      .replace(/[ \t]+/g," ")
      .trim();

  /* ==================== –ß—Ç–µ–Ω–∏–µ PDF ==================== */
  async function pdfToPages(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      let pageText = "", lastY = null;
      content.items.forEach(item => {
        const y = item.transform[5];
        if(lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
        pageText += item.str;
        lastY = y;
      });
      pages.push(normalize(pageText));
    }
    return pages;
  }

  /* ==================== –ü–∞—Ä—Å–∏–Ω–≥ ==================== */
  function extractDateFromPages(pages){
    for(const pg of pages){
      const m = pg.match(/–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
    return "‚Äî";
  }

  function parseTotalsFromPage(page1){
    const find = (re) => {
      const m = page1.match(re);
      return m ? numberize(m[1]) : 0;
    };
    return {
      found_year: find(/–≤—ã—è–≤–ª–µ–Ω–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
      legalized: find(/–£–∑–∞–∫–æ–Ω–µ–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
      dismantled_ytd: find(/–ó–∞\s*20\d{2}\s*–≥–æ–¥\s*–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
      in_work_total: find(/–í\s*—Ä–∞–±–æ—Ç–µ[^0-9]*?–≤—Å–µ–≥–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
      rtk_in_work: find(/–≤\s*—Ç–æ–º\s*—á–∏—Å–ª–µ\s*–ü–ê–û\s*¬´?–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª?[^0-9]*?(\d[\d\s]+)/i),
    };
  }

  function parseBranchTable(pageText){
    const text = normalize(pageText);
    const lines = text.split("\n").filter(Boolean);

    const idx = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      for(const bp of BRANCH_PATTERNS){
        if(bp.re.test(line)){ idx.push({i, name: bp.name}); break; }
      }
    }
    idx.push({i: lines.length, name:null});

    const branches = new Map();
    for(let k=0;k<idx.length-1;k++){
      const start = idx[k].i, end = idx[k+1].i, branchName = idx[k].name;
      if(!branchName) continue;
      const headLine = lines[start] || "";
      const segText = lines.slice(start+1, end).join(" ");

      let total = 0;
      const headNums = headLine.match(/\d[\d\s]*/g);
      if(headNums && headNums.length) total = numberize(headNums[headNums.length-1]);
      if(total===0 && lines[start+1]){
        const n2 = (lines[start+1]||"").match(/\d[\d\s]*/g);
        if(n2 && n2.length) total = numberize(n2[n2.length-1]);
      }

      const data = { total, statuses:{} };

      function numAfter(re, hay){
        const rx = new RegExp(re.source + "[^\\d]{0,200}(\\d[\\d\\s]*)", re.flags);
        const m = hay.match(rx);
        return m ? numberize(m[1]) : null;
      }

      for(const sp of STATUS_PATTERNS){
        let v = numAfter(sp.re, segText);
        if(v === null){
          for(let j=start+1;j<end;j++){
            const l0 = lines[j]||"", l1 = lines[j+1]||"";
            if(sp.re.test(l0) || sp.re.test(l1)){
              let cap = (l0.match(/(\d[\d\s]*)/g)||[]).pop();
              if(!cap) cap = (l1.match(/(\d[\d\s]*)/g)||[]).pop();
              if(cap){ v = numberize(cap); break; }
            }
          }
        }
        if(v !== null) data.statuses[sp.key] = v;
      }
      branches.set(branchName, data);
    }

    for(const b of BRANCHES){
      if(!branches.has(b)) branches.set(b, { total:0, statuses:{} });
    }

    const stages = {};
    for(const [_, obj] of branches){
      for(const [k,v] of Object.entries(obj.statuses)){
        stages[k] = (stages[k]||0) + (v||0);
      }
    }

    const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);
    return { branches, overall, stages };
  }

  function parseReportByPages(pages){
    return {
      date: extractDateFromPages(pages),
      p1: { totals: parseTotalsFromPage(pages[0] || "") },
      p2: parseBranchTable(pages[1] || ""),
      p3: parseBranchTable(pages[2] || ""),
      p4: parseBranchTable(pages[3] || ""),
    };
  }

  /* ==================== –î–∏–Ω–∞–º–∏–∫–∞ ==================== */
  function computeDynamics(curr, prev){
    const dyn = {
      in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
      rtk_in_work: (curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work) || 0,
      legalized: (curr.p1.totals.legalized - prev.p1.totals.legalized) || 0,
      dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
    };
    dyn.found_week = dyn.in_work_total;

    const makeRows = (cPage, pPage) => BRANCHES.map(b=>{
      const c = cPage.branches.get(b)?.total || 0;
      const p = pPage.branches.get(b)?.total || 0;
      return {b, p, c, d: (c - p)};
    });

    const branchRows = makeRows(curr.p2, prev.p2);
    const branchRowsS3 = makeRows(curr.p3, prev.p3);
    const branchRowsS4 = makeRows(curr.p4, prev.p4);

    const allKeys = Array.from(new Set([
      ...Object.keys(prev.p2.stages||{}), ...Object.keys(curr.p2.stages||{}),
      ...Object.keys(prev.p3.stages||{}), ...Object.keys(curr.p3.stages||{}),
      ...Object.keys(prev.p4.stages||{}), ...Object.keys(curr.p4.stages||{}),
      ...STATUS_KEYS
    ]));

    const diffStages = (cur, prv) => allKeys.map(k=>({
      stage: STAGE_TITLE(k), short: SHORT_STAGE_TITLE(k), key: k,
      p: prv[k] || 0, c: cur[k] || 0, d: (cur[k]||0) - (prv[k]||0)
    }));

    const stagesS2 = diffStages(curr.p2.stages||{}, prev.p2.stages||{});
    const stagesS4 = diffStages(curr.p4.stages||{}, prev.p4.stages||{});

    function perBranchStages(cPage, pPage){
      return BRANCHES.map(b=>{
        const cst = cPage.branches.get(b)?.statuses || {};
        const pst = pPage.branches.get(b)?.statuses || {};
        const by = {};
        STATUS_KEYS.forEach(k=>{
          const p = pst[k]||0, c = cst[k]||0;
          by[k] = {p,c,d:c-p};
        });
        return {b, by};
      });
    }
    const s2BranchStages = perBranchStages(curr.p2, prev.p2);

    return {
      ...dyn,
      branchRows,
      branchRowsS3,
      branchRowsS4,
      stagesS2,
      stagesS4,
      s2BranchStages,
      rtkRows: branchRowsS4
    };
  }pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
<div class="chart-container">
        <img src="${imgS2}" alt="–ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRows, ["sumPrev", "sumCurr", "sumDelta"])}
      </div>
    </div>
    <div class="slide-number">3</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 4: –ü—Ä–∏–∫–∞–∑ ‚Ññ425 -->
  <div class="slide">
    <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425</h2>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${imgS3}" alt="–ì—Ä–∞—Ñ–∏–∫ –ü—Ä–∏–∫–∞–∑ 425">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"])}
      </div>
    </div>
    <div class="slide-number">4</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 5: –ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º -->
  <div class="slide">
    <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${imgS4}" alt="–ì—Ä–∞—Ñ–∏–∫ –†–æ—Å—Ç–µ–ª–µ–∫–æ–º">
      </div>
      <div class="table-container">
        ${generateSlideTable(dyn.branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"])}
      </div>
    </div>
    <div class="slide-number">5</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 6: –ò–∑–º–µ–Ω–µ–Ω–∏—è –†–¢–ö -->
  <div class="slide">
    <h2>–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
    <div class="chart-container" style="max-width: 1200px; width: 100%;">
      <img src="${imgRTK}" alt="–ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –†–¢–ö">
    </div>
    <div class="slide-number">6</div>
  </div>
</body>
</html>`;
  }

  function generateKPICards(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    const kpis = [
      {label: "–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ", value: curr.p1.totals.in_work_total, delta: dyn.in_work_total},
      {label: "–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value: dyn.found_week, delta: dyn.found_week},
      {label: "–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value: eff, delta: eff},
      {label: "–ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º", value: curr.p1.totals.rtk_in_work, delta: dyn.rtk_in_work, extra: `${rtkShare.toFixed(1)}%`}
    ];
    
    return kpis.map(kpi => `
      <div class="kpi-card">
        <div class="kpi-label">${kpi.label}</div>
        <div class="kpi-value">${fmt(kpi.value)}</div>
        <div class="kpi-delta ${kpi.delta >= 0 ? 'positive' : 'negative'}">
          ${kpi.delta > 0 ? '+' : ''}${fmt(kpi.delta)}
          ${kpi.extra ? ` (${kpi.extra})` : ''}
        </div>
      </div>
    `).join('');
  }

  function generateSlideTable(rows, sumIds){
    const sorted = [...rows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d));
    return `
      <table>
        <thead>
          <tr>
            <th>–§–∏–ª–∏–∞–ª</th>
            <th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</th>
            <th>–¢–µ–∫—É—â–∞—è</th>
            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody>
          ${sorted.map(r => `
            <tr>
              <td>${r.b}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d > 0 ? 'positive' : r.d < 0 ? 'negative' : ''}">
                ${r.d > 0 ? '+' : ''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr>
            <td>–ò—Ç–æ–≥–æ</td>
            <td>${document.getElementById(sumIds[0]).textContent}</td>
            <td>${document.getElementById(sumIds[1]).textContent}</td>
            <td>${document.getElementById(sumIds[2]).textContent}</td>
          </tr>
        </tfoot>
      </table>
    `;
  }

  function generateWordContent(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
    
    return `
      <h2>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
      <ul>
        <li>–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ: <strong>${fmt(curr.p1.totals.in_work_total)}</strong> 
            <span class="${dyn.in_work_total>=0?'positive':'negative'}">
              (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})
            </span>
        </li>
        <li>–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é: <strong>${fmt(dyn.found_week)}</strong></li>
        <li>–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é (—É–∑–∞–∫–æ–Ω–µ–Ω–æ + –¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ): <strong>${fmt(eff)}</strong></li>
        <li>–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª –≤ —Ä–∞–±–æ—Ç–µ: <strong>${fmt(curr.p1.totals.rtk_in_work)}</strong> 
            <span class="${dyn.rtk_in_work>=0?'positive':'negative'}">
              (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})
            </span>; 
            –¥–æ–ª—è <strong>${rtkShare.toFixed(1)}%</strong>
        </li>
      </ul>
      
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
      
      <h3>–û–±—â–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ (–≤—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã)</h3>
      ${generateWordTable(dyn.branchRows, ["sumPrev", "sumCurr", "sumDelta"])}
      
      <h3>–ü—Ä–∏–∫–∞–∑ ‚Ññ425</h3>
      ${generateWordTable(dyn.branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"])}
      
      <h3>–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h3>
      ${generateWordTable(dyn.branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"])}
      
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h2>
      ${generateWordStagesTable(dyn.stagesS2)}
      
      <div class="info-box">
        <p><strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö PDF-—Ñ–∞–π–ª–æ–≤.<br>
        –î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}</p>
      </div>
    `;
  }

  function generateWordTable(rows, sumIds){
    const sorted = [...rows].sort((a,b) => b.b.localeCompare(a.b, 'ru'));
    return `
      <table>
        <thead>
          <tr>
            <th>–§–∏–ª–∏–∞–ª</th>
            <th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</th>
            <th>–¢–µ–∫—É—â–∞—è</th>
            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody>
          ${sorted.map(r => `
            <tr>
              <td>${r.b}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d>0?'positive':r.d<0?'negative':''}">
                ${r.d>0?'+':''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr style="font-weight:bold;background:#f0f0f0">
            <td>–ò–¢–û–ì–û</td>
            <td>${document.getElementById(sumIds[0]).textContent}</td>
            <td>${document.getElementById(sumIds[1]).textContent}</td>
            <td>${document.getElementById(sumIds[2]).textContent}</td>
          </tr>
        </tfoot>
      </table>
    `;
  }

  function generateWordStagesTable(stages){
    return `
      <table>
        <thead>
          <tr>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ü—Ä–µ–¥.</th>
            <th>–¢–µ–∫.</th>
            <th>Œî</th>
          </tr>
        </thead>
        <tbody>
          ${stages.map(r => `
            <tr>
              <td>${r.stage}</td>
              <td>${fmt(r.p)}</td>
              <td>${fmt(r.c)}</td>
              <td class="${r.d>0?'positive':r.d<0?'negative':''}">
                ${r.d>0?'+':''}${fmt(r.d)}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  /* ==================== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ==================== */
  function triggerDownload(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = filename; 
    document.body.appendChild(a); 
    a.click();
    setTimeout(()=>{ 
      URL.revokeObjectURL(url); 
      a.remove(); 
    }, 0);
  }

  function showExportMessage(text){
    const el = document.getElementById("exportStatus");
    el.textContent = text;
    el.style.display = "flex";
    setTimeout(() => { el.style.display = "none"; }, 3000);
  }

  function showLoadingMessage(text){
    const el = document.getElementById("loadingMsg");
    if(text){
      el.style.display = "flex";
      el.querySelector("span").textContent = text;
    } else {
      el.style.display = "none";
    }
  }

  function showErrorMessage(text){
    const el = document.getElementById("errorMsg");
    if(text){
      el.textContent = text;
      el.style.display = "flex";
    } else {
      el.style.display = "none";
    }
  }

  function showDates(prev, curr){
    const el = document.getElementById("dates");
    el.innerHTML = `<strong>–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞:</strong> ${prev} ‚Äî ${curr}`;
    el.style.display = "flex";
  }

  /* ==================== –ü–ª–∞–Ω-–§–∞–∫—Ç –∏–∑ Google Sheets ==================== */
  const SHEET_HTML_URL = "https://docs.google.com/spreadsheets/d/1Y9bM7zLRf_gonMUgfQLl57Iu3NgPa78rBXnpxkKLvO0/gviz/tq?tqx=out:html";
  
  async function injectPlanFactHTML(){
    try{
      const res = await fetch(SHEET_HTML_URL, {cache:"no-store", mode:"cors"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const html = await res.text();
      
      // –°—Ç–∏–ª–∏–∑—É–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–¥ –Ω–∞—à –¥–∏–∑–∞–π–Ω
      const styledHTML = stylePlanFactTable(html);
      
      if(document.getElementById("presPlanFactInner")){
        document.getElementById("presPlanFactInner").innerHTML = styledHTML;
      }
      if(document.getElementById("briefPlanFactInner")){
        document.getElementById("briefPlanFactInner").innerHTML = styledHTML;
      }
    }catch(e){
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ü–ª–∞–Ω-–§–∞–∫—Ç:", e);
    }
  }

  function stylePlanFactTable(html){
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    const table = tmp.querySelector("table");
    
    if(!table) return '<div class="message message-error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ü–ª–∞–Ω-–§–∞–∫—Ç</div>';
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏
    table.style.cssText = `
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    `;
    
    // –°—Ç–∏–ª–∏–∑—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    table.querySelectorAll("th").forEach(th => {
      th.style.cssText = `
        background: var(--bg-secondary);
        color: var(--text-primary);
        padding: 12px;
        font-weight: 600;
        border-bottom: 2px solid var(--glass-border);
      `;
    });
    
    // –°—Ç–∏–ª–∏–∑—É–µ–º —è—á–µ–π–∫–∏
    table.querySelectorAll("td").forEach(td => {
      td.style.cssText = `
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
      `;
    });
    
    return `
      <div class="table-container">
        <div class="table-scroll">
          ${table.outerHTML}
        </div>
      </div>
    `;
  }

  /* ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==================== */
  let DATA = null;

  // –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è —à–∞–ø–∫–∏
  window.addEventListener('scroll', () => {
    const header = document.getElementById('header');
    if (window.scrollY > 50) {
      header.classList.add('scrolled');
    } else {
      header.classList.remove('scrolled');
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤
  document.getElementById("btnParse").addEventListener("click", async () => {
    const fPrev = document.getElementById("filePrev").files[0];
    const fCurr = document.getElementById("fileCurr").files[0];
    
    if(!fPrev || !fCurr){ 
      showErrorMessage("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ PDF —Ñ–∞–π–ª–∞: –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏ —Ç–µ–∫—É—â–∏–π –æ—Ç—á–µ—Ç—ã"); 
      return; 
    }

    try{
      showLoadingMessage("–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF —Ñ–∞–π–ª–æ–≤...");
      showErrorMessage("");

      const [pPrev, pCurr] = await Promise.all([pdfToPages(fPrev), pdfToPages(fCurr)]);
      
      showLoadingMessage("–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...");
      
      const prev = parseReportByPages(pPrev);
      const curr = parseReportByPages(pCurr);
      const dyn = computeDynamics(curr, prev);
      DATA = {prev, curr, dyn};

      showDates(prev.date, curr.date);
      renderKpis(curr, prev, dyn);
      renderBranchesTable(dyn.branchRows, "#tblBranches tbody", "sumPrev", "sumCurr", "sumDelta");
      renderBranchesTable(dyn.branchRowsS3, "#tblBranchesS3 tbody", "sumPrevS3", "sumCurrS3", "sumDeltaS3");
      renderBranchesTable(dyn.branchRowsS4, "#tblBranchesS4 tbody", "sumPrevS4", "sumCurrS4", "sumDeltaS4");
      renderCharts(curr, prev, dyn);
      renderStagesTables(dyn);
      
      await injectPlanFactHTML();

      showLoadingMessage("");
      showExportMessage("–ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!");
      
    }catch(e){
      console.error(e);
      showLoadingMessage("");
      showErrorMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ PDF. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.");
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
  document.getElementById("exportPresPDF").addEventListener("click", async () => {
    if(!DATA) return showErrorMessage("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç—ã");
    await exportPresPDF();
  });

  document.getElementById("exportBriefPDF").addEventListener("click", async () => {
    if(!DATA) return showErrorMessage("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç—ã");
    await exportBriefPDF();
  });

  document.getElementById("exportWordHTML").addEventListener("click", () => {
    if(!DATA) return showErrorMessage("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç—ã");
    exportWordHTML();
  });

  document.getElementById("exportPresHTML").addEventListener("click", () => {
    if(!DATA) return showErrorMessage("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á–µ—Ç—ã");
    exportPresHTML();
  });

  // –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
  document.getElementById("btnCompact").addEventListener("click", ()=>{
    document.body.classList.toggle("compact");
    const btn = document.getElementById("btnCompact");
    if(document.body.classList.contains("compact")){
      btn.innerHTML = '<span>üìê</span> –û–±—ã—á–Ω—ã–π –≤–∏–¥';
    } else {
      btn.innerHTML = '<span>üìê</span> –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥';
    }
  });

  </script>
</body>
</html>
      html2canvas: {scale: 2, useCORS: true},
      jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'}
    }).save();
    el.style.display = "none";
    showExportMessage("PDF –≤—ã–∂–∏–º–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω");
  }

  /* ==================== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ==================== */
  function buildPresentationTables(){
    const {branchRows, branchRowsS3, branchRowsS4} = DATA.dyn;
    
    const makeTable = (title, icon, rows, sumIds) => {
      const sorted = [...rows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d));
      return `
        <div class="table-section">
          <div class="section-title">
            <div class="section-icon">${icon}</div>
            ${title}
          </div>
          <table>
            <thead>
              <tr>
                <th>–§–∏–ª–∏–∞–ª</th>
                <th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</th>
                <th>–¢–µ–∫—É—â–∞—è</th>
                <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
              </tr>
            </thead>
            <tbody>
              ${sorted.map(r => `
                <tr>
                  <td>${r.b}</td>
                  <td>${fmt(r.p)}</td>
                  <td>${fmt(r.c)}</td>
                  <td class="${r.d > 0 ? 'delta-positive' : r.d < 0 ? 'delta-negative' : ''}">
                    ${r.d > 0 ? '+' : ''}${fmt(r.d)}
                  </td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr>
                <td>–ò—Ç–æ–≥–æ</td>
                <td>${document.getElementById(sumIds[0]).textContent}</td>
                <td>${document.getElementById(sumIds[1]).textContent}</td>
                <td>${document.getElementById(sumIds[2]).textContent}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    };
    
    return makeTable("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)", "üìä", branchRows, ["sumPrev", "sumCurr", "sumDelta"]) +
           makeTable("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425", "üìã", branchRowsS3, ["sumPrevS3", "sumCurrS3", "sumDeltaS3"]) +
           makeTable("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", "üåê", branchRowsS4, ["sumPrevS4", "sumCurrS4", "sumDeltaS4"]);
  }

  function buildSummaryContent(){
    const {curr, prev, dyn} = DATA;
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    
    const topChanges = [...dyn.branchRows].sort((a,b) => Math.abs(b.d) - Math.abs(a.d)).slice(0, 3);
    
    return `
      <div class="brief-block">
        <div class="brief-title">–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
        <div class="brief-content">
          <div class="brief-item">‚Ä¢ –í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ: <span class="brief-value">${fmt(curr.p1.totals.in_work_total)}</span> (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})</div>
          <div class="brief-item">‚Ä¢ –í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é: <span class="brief-value">${fmt(dyn.found_week)}</span></div>
          <div class="brief-item">‚Ä¢ –ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é: <span class="brief-value">${fmt(eff)}</span></div>
          <div class="brief-item">‚Ä¢ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª: <span class="brief-value">${fmt(curr.p1.totals.rtk_in_work)}</span> (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</div>
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">–¢–æ–ø-3 —Ñ–∏–ª–∏–∞–ª–∞ –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º</div>
        <div class="brief-content">
          ${topChanges.map((r, i) => `
            <div class="brief-item">${i+1}. <span class="brief-value">${r.b}</span>: ${fmt(r.p)} ‚Üí ${fmt(r.c)} (${r.d>0?'+':''}${fmt(r.d)})</div>
          `).join('')}
        </div>
      </div>
      
      <div class="brief-block">
        <div class="brief-title">–ò—Ç–æ–≥–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
        <div class="brief-content">
          <div class="brief-item">‚Ä¢ –í—Å–µ–≥–æ –æ–ø–æ—Ä: ${document.getElementById("sumPrev").textContent} ‚Üí <span class="brief-value">${document.getElementById("sumCurr").textContent}</span> (${document.getElementById("sumDelta").textContent})</div>
          <div class="brief-item">‚Ä¢ –ü—Ä–∏–∫–∞–∑ ‚Ññ425: ${document.getElementById("sumPrevS3").textContent} ‚Üí <span class="brief-value">${document.getElementById("sumCurrS3").textContent}</span> (${document.getElementById("sumDeltaS3").textContent})</div>
          <div class="brief-item">‚Ä¢ –ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º: ${document.getElementById("sumPrevS4").textContent} ‚Üí <span class="brief-value">${document.getElementById("sumCurrS4").textContent}</span> (${document.getElementById("sumDeltaS4").textContent})</div>
        </div>
      </div>
    `;
  }

  /* ==================== –≠–∫—Å–ø–æ—Ä—Ç Word HTML ==================== */
  function exportWordHTML(){
    if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
    const {curr, prev, dyn} = DATA;
    
    const htmlDoc = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–û—Ç—á–µ—Ç –í–û–õ–° - ${curr.date}</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body { font-family: 'Calibri', Arial, sans-serif; line-height: 1.6; color: #333; }
    h1 { color: #1E3A8A; font-size: 24pt; border-bottom: 3pt solid #1E3A8A; padding-bottom: 10pt; }
    h2 { color: #1E3A8A; font-size: 18pt; margin-top: 20pt; }
    h3 { color: #333; font-size: 14pt; margin-top: 15pt; }
    table { width: 100%; border-collapse: collapse; margin: 15pt 0; }
    th, td { border: 1pt solid #ddd; padding: 8pt; text-align: center; }
    th { background-color: #1E3A8A; color: white; font-weight: bold; }
    th:first-child, td:first-child { text-align: left; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .info-box { background: #EBF4FF; border-left: 4pt solid #1E3A8A; padding: 10pt; margin: 10pt 0; }
    .positive { color: #10B981; font-weight: bold; }
    .negative { color: #EF4444; font-weight: bold; }
  </style>
</head>
<body>
  <h1>–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª ‚Äî –û—Ç—á–µ—Ç –ø–æ –í–û–õ–°</h1>
  
  <div class="info-box">
    <p><strong>–û—Ç—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥:</strong><br>
    –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è: ${prev.date}<br>
    –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è: ${curr.date}</p>
  </div>
  
  ${generateWordContent()}
</body>
</html>`;

    const blob = new Blob([htmlDoc], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `–û—Ç—á–µ—Ç_–í–û–õ–°_${curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ Word.");
  }

  /* ==================== –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ HTML ==================== */
  function exportPresHTML(){
    if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
    
    const presHTML = generatePresentationHTML();
    const blob = new Blob([presHTML], {type: 'text/html; charset=utf-8'});
    triggerDownload(blob, `–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${DATA.curr.date.replace(/\./g,'-')}.html`);
    showExportMessage("HTML –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
  }

  function generatePresentationHTML(){
    const {curr, prev, dyn} = DATA;
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const imgS2 = document.getElementById("chartBranches").toDataURL("image/png");
    const imgS3 = document.getElementById("chartBranchesS3").toDataURL("image/png");
    const imgS4 = document.getElementById("chartBranchesS4").toDataURL("image/png");
    const imgRTK = document.getElementById("chartRTKDelta").toDataURL("image/png");
    
    return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –í–û–õ–° - ${curr.date}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #0F172A;
      color: #F1F5F9;
      overflow-x: hidden;
    }
    
    .slide {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px;
      position: relative;
      background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                  #0F172A;
    }
    
    .slide-header {
      position: absolute;
      top: 40px;
      left: 60px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .logo {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3B82F6, #06B6D4);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 20px;
      color: white;
    }
    
    .slide-number {
      position: absolute;
      bottom: 40px;
      right: 60px;
      font-size: 18px;
      color: #64748B;
    }
    
    h1 {
      font-size: 48px;
      font-weight: 800;
      text-align: center;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h2 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 30px;
      color: #F1F5F9;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      width: 100%;
      max-width: 1400px;
    }
    
    .chart-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .chart-container img {
      width: 100%;
      height: auto;
      border-radius: 12px;
    }
    
    .table-container {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: rgba(59, 130, 246, 0.2);
      color: #F1F5F9;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    th:not(:first-child) { text-align: right; }
    
    td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: #94A3B8;
    }
    
    td:not(:first-child) { text-align: right; }
    
    tr:hover { background: rgba(255, 255, 255, 0.03); }
    
    tfoot td {
      background: rgba(59, 130, 246, 0.1);
      font-weight: 700;
      color: #F1F5F9;
      border-top: 2px solid rgba(59, 130, 246, 0.3);
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 30px;
      width: 100%;
      max-width: 1200px;
    }
    
    .kpi-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
    }
    
    .kpi-label {
      font-size: 14px;
      color: #94A3B8;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .kpi-value {
      font-size: 48px;
      font-weight: 800;
      margin: 10px 0;
      background: linear-gradient(135deg, #F1F5F9, #06B6D4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .kpi-delta {
      font-size: 18px;
      font-weight: 600;
    }
    
    .positive { color: #10B981; }
    .negative { color: #EF4444; }
    
    @media print {
      .slide { page-break-after: always; }
    }
  </style>
</head>
<body>
  <!-- –°–ª–∞–π–¥ 1: –¢–∏—Ç—É–ª—å–Ω—ã–π -->
  <div class="slide">
    <div class="slide-header">
      <div class="logo">–†–ö</div>
      <span style="font-size: 20px; font-weight: 600;">–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</span>
    </div>
    <h1>–î–∏–Ω–∞–º–∏–∫–∞ –í–û–õ–°<br>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç</h1>
    <p style="font-size: 24px; color: #94A3B8;">–ü–µ—Ä–∏–æ–¥: ${prev.date} ‚Äî ${curr.date}</p>
    <div class="slide-number">1</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 2: KPI -->
  <div class="slide">
    <h2>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
    <div class="kpi-grid">
      ${generateKPICards()}
    </div>
    <div class="slide-number">2</div>
  </div>
  
  <!-- –°–ª–∞–π–¥ 3: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º -->
  <div class="slide">
    <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)</h2>
    <div class="content-grid">
      <div class="chart-container">  /* ==================== –†–µ–Ω–¥–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ==================== */
  let chartBranches, chartBranchesS3, chartBranchesS4, chartRTKDelta;

  function renderKpis(curr, prev, dyn){
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const items = [
      {title:"–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ", value:curr.p1.totals.in_work_total, delta:dyn.in_work_total, unit:"—à—Ç."},
      {title:"–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value:dyn.found_week, delta:dyn.found_week, unit:"—à—Ç."},
      {title:"–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é", value:eff, delta:eff, unit:"—à—Ç.", subtitle:"(—É–∑–∞–∫. + –¥–µ–º–æ–Ω—Ç.)"},
      {title:"–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", value:curr.p1.totals.rtk_in_work, delta:dyn.rtk_in_work, unit:"—à—Ç.", subtitle:`–¥–æ–ª—è ${rtkShare.toFixed(1)}%`},
    ];

    document.getElementById("kpis").innerHTML = items.map(it=>{
      const d = typeof it.delta==="number"?it.delta:0;
      const deltaClass = d>0?"positive":(d<0?"negative":"neutral");
      const sign=d>0?"+":"";
      const arrow = d>0?"‚Üë":(d<0?"‚Üì":"‚Üí");
      
      return `<div class="kpi-card">
        <div class="kpi-label">${it.title}</div>
        <div class="kpi-value">${fmt(it.value)} <span style="font-size:0.5em;font-weight:400;color:var(--text-secondary)">${it.unit}</span></div>
        ${it.subtitle ? `<div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem">${it.subtitle}</div>` : ''}
        <div class="kpi-delta ${deltaClass}">
          <span>${arrow}</span>
          <span>${sign}${fmt(d)}</span>
        </div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(rows, tbodySel, sumPrevId, sumCurrId, sumDeltaId){
    const tbody = document.querySelector(tbodySel);
    tbody.innerHTML = "";
    let sP=0,sC=0,sD=0;
    const sorted = [...rows].sort((a,b)=>Math.abs((b.c-b.p)) - Math.abs((a.c-a.p)));
    for(const r0 of sorted){
      const p = Number(r0.p)||0, c = Number(r0.c)||0;
      const d = c - p;
      const cls = d>0?"value-positive":(d<0?"value-negative":"");
      sP+=p; sC+=c; sD+=d;
      tbody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${r0.b}</td>
          <td>${fmt(p)}</td>
          <td>${fmt(c)}</td>
          <td class="${cls}">${d>0?"+":""}${fmt(d)}</td>
        </tr>`);
    }
    document.getElementById(sumPrevId).textContent = fmt(sP);
    document.getElementById(sumCurrId).textContent = fmt(sC);
    document.getElementById(sumDeltaId).textContent = (sD>0?"+":"")+fmt(sD);
    document.getElementById(sumDeltaId).className = sD>0?"value-positive":(sD<0?"value-negative":"");
  }

  function chartOpts(){
    Chart.defaults.color = '#94A3B8';
    Chart.defaults.font.family = "'Inter', system-ui, -apple-system, sans-serif";
    
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:"top",
          labels:{
            boxWidth:12,
            usePointStyle:true,
            padding:20,
            font:{size:12}
          }
        },
        tooltip:{
          backgroundColor: 'rgba(30, 41, 59, 0.9)',
          titleColor: '#F1F5F9',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          boxWidth: 12,
          boxHeight: 12,
          usePointStyle: true
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          grid:{
            color:'rgba(255, 255, 255, 0.05)',
            drawBorder:false
          },
          ticks:{
            precision:0,
            padding:10
          }
        },
        x:{
          grid:{
            display:false,
            drawBorder:false
          },
          ticks:{
            padding:10
          }
        }
      },
    };
  }

  function renderCharts(curr, prev, dyn){
    const labels = BRANCHES;
    const prevS2 = labels.map(b=>prev.p2.branches.get(b)?.total||0);
    const currS2 = labels.map(b=>curr.p2.branches.get(b)?.total||0);

    if(chartBranches) chartBranches.destroy();
    chartBranches = new Chart(document.getElementById("chartBranches"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS2, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS2, backgroundColor:"rgba(59, 130, 246, 0.5)", borderColor:"rgba(59, 130, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS3 = labels.map(b=>prev.p3.branches.get(b)?.total||0);
    const currS3 = labels.map(b=>curr.p3.branches.get(b)?.total||0);
    if(chartBranchesS3) chartBranchesS3.destroy();
    chartBranchesS3 = new Chart(document.getElementById("chartBranchesS3"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS3, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS3, backgroundColor:"rgba(139, 92, 246, 0.5)", borderColor:"rgba(139, 92, 246, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const prevS4 = labels.map(b=>prev.p4.branches.get(b)?.total||0);
    const currS4 = labels.map(b=>curr.p4.branches.get(b)?.total||0);
    if(chartBranchesS4) chartBranchesS4.destroy();
    chartBranchesS4 = new Chart(document.getElementById("chartBranchesS4"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:prevS4, backgroundColor:"rgba(148, 163, 184, 0.5)", borderColor:"rgba(148, 163, 184, 0.8)", borderWidth:1},
        {label:"–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è", data:currS4, backgroundColor:"rgba(6, 182, 212, 0.5)", borderColor:"rgba(6, 182, 212, 0.8)", borderWidth:1}
      ]},
      options: chartOpts()
    });

    const rtkD = labels.map(b => (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).c - (dyn.rtkRows.find(x => x.b === b) || {c:0,p:0}).p);
    if(chartRTKDelta) chartRTKDelta.destroy();
    chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
      type:"bar",
      data:{labels, datasets:[{
        label:"–ò–∑–º–µ–Ω–µ–Ω–∏–µ (—Ç–µ–∫. ‚àí –ø—Ä–µ–¥.)", 
        data:rtkD, 
        backgroundColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.5)":"rgba(239, 68, 68, 0.5)"),
        borderColor: rtkD.map(v=>v>0?"rgba(16, 185, 129, 0.8)":"rgba(239, 68, 68, 0.8)"),
        borderWidth: 1<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–û–õ–° –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | –†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ç–æ–∫–µ–Ω—ã –¥–∏–∑–∞–π–Ω–∞ ====== */
    :root{
      /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ –±—Ä–µ–Ω–¥–∞ */
      --primary: #1E3A8A;
      --primary-light: #3B82F6;
      --primary-dark: #1E293B;
      --accent: #06B6D4;
      --accent-glow: rgba(6, 182, 212, 0.3);
      
      /* –§–æ–Ω—ã –∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ */
      --bg-main: #0F172A;
      --bg-secondary: #1E293B;
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-hover: rgba(59, 130, 246, 0.1);
      
      /* –°—Ç–µ–∫–ª–æ–º–æ—Ä—Ñ–∏–∑–º */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      
      /* –¢–µ–∫—Å—Ç */
      --text-primary: #F1F5F9;
      --text-secondary: #94A3B8;
      --text-muted: #64748B;
      
      /* –°—Ç–∞—Ç—É—Å—ã */
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      
      /* –≠—Ñ—Ñ–µ–∫—Ç—ã */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.7);
      --shadow-glow: 0 0 40px rgba(59, 130, 246, 0.3);
      
      /* –°–∫—Ä—É–≥–ª–µ–Ω–∏—è */
      --radius-sm: 8px;
      --radius-md: 16px;
      --radius-lg: 24px;
      
      /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ ====== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg-main);
      color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* –§–æ–Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* ====== –®–∞–ø–∫–∞ ====== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      transition: var(--transition);
    }

    header.scrolled {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      letter-spacing: -0.02em;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1.5rem;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .nav-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    /* ====== –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç ====== */
    main {
      margin-top: 80px;
      padding: 2rem 0;
      min-height: calc(100vh - 80px);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    /* ====== –°–µ—Ç–∫–∞ ====== */
    .grid {
      display: grid;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    .cols-4 { grid-template-columns: repeat(4, 1fr); }

    @media (max-width: 1200px) {
      .cols-4 { grid-template-columns: repeat(2, 1fr); }
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .cols-2, .cols-3, .cols-4 { grid-template-columns: 1fr; }
    }

    /* ====== –ö–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .card {
      background: var(--bg-card);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      transform: translateX(-100%);
      transition: transform 0.5s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .card:hover::before {
      transform: translateX(0);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    /* ====== KPI –∫–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .kpi-card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
      opacity: 0.3;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 2.5rem;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-delta {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      font-weight: 600;
    }

    .kpi-delta.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .kpi-delta.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .kpi-delta.neutral {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    /* ====== –ö–Ω–æ–ø–∫–∏ ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--primary-light);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px dashed var(--glass-border);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      border-color: var(--text-secondary);
      background: var(--glass);
    }

    /* ====== –§–æ—Ä–º—ã ====== */
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      background: var(--glass);
      border: 2px dashed var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-wrapper:hover {
      border-color: var(--primary-light);
      background: var(--bg-hover);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      background: var(--primary-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
    }

    /* ====== –¢–∞–±–ª–∏—Ü—ã ====== */
    .table-container {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-scroll {
      max-height: 400px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--glass-border) transparent;
    }

    .table-scroll::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-weight: 600;
      text-align: left;
      padding: 1rem;
      border-bottom: 2px solid var(--glass-border);
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      transition: var(--transition);
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: var(--transition);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tbody tr:hover td {
      color: var(--text-primary);
    }

    tfoot td {
      background: var(--bg-secondary);
      font-weight: 700;
      color: var(--text-primary);
      padding: 1rem;
      border-top: 2px solid var(--glass-border);
    }

    /* ====== –ì—Ä–∞—Ñ–∏–∫–∏ ====== */
    .chart-container {
      height: 400px;
      padding: 1rem;
      background: var(--glass);
      border-radius: var(--radius-md);
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== –°—Ç–∞—Ç—É—Å—ã –∏ –∑–Ω–∞—á–∫–∏ ====== */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .value-positive {
      color: var(--success);
      font-weight: 600;
    }

    .value-negative {
      color: var(--danger);
      font-weight: 600;
    }

    /* ====== –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ ====== */
    .loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-light);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== –°–æ–æ–±—â–µ–Ω–∏—è ====== */
    .message {
      padding: 1rem 1.5rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .message-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .message-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .message-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--primary-light);
    }

    /* ====== –°–µ–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ ====== */
    .export-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    /* ====== –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å ====== */
    @media (max-width: 768px) {
      .header-content {
        padding: 1rem;
      }

      .brand {
        font-size: 1rem;
      }

      .logo {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
      }

      main {
        margin-top: 70px;
      }

      .container {
        padding: 0 1rem;
      }

      .card {
        padding: 1rem;
      }

      .kpi-value {
        font-size: 2rem;
      }

      .table-scroll {
        max-height: 300px;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.8125rem;
      }
    }

    /* ====== –£—Ç–∏–ª–∏—Ç—ã ====== */
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .mt-1 { margin-top: 0.5rem; }
    .mt-2 { margin-top: 1rem; }
    .mb-1 { margin-bottom: 0.5rem; }
    .mb-2 { margin-bottom: 1rem; }

    /* ====== –ü–µ—á–∞—Ç—å ====== */
    @media print {
      body {
        background: white;
        color: black;
      }

      header {
        position: relative;
        background: white;
        border-bottom: 2px solid #000;
      }

      .card {
        background: white;
        border: 1px solid #ccc;
        box-shadow: none;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }

      .btn, .file-input-wrapper {
        display: none;
      }
    }

    /* ====== –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º ====== */
    .compact .card {
      padding: 1rem;
    }

    .compact .kpi-card {
      padding: 0.75rem;
    }

    .compact .kpi-value {
      font-size: 1.75rem;
    }

    .compact table {
      font-size: 0.75rem;
    }

    .compact th, .compact td {
      padding: 0.5rem;
    }

    .compact .chart-container {
      height: 300px;
    }

    /* ====== –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–µ—á–∞—Ç–∏ ====== */
    #presentationPrint, #summaryPrint {
      display: none;
    }
  </style>
</head>
<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header id="header">
    <div class="header-content">
      <div class="brand">
        <div class="logo">–†–ö</div>
        <span>–í–û–õ–° –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
      </div>
      <div class="nav-actions">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
        </div>
      </div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main>
    <div class="container">
      <!-- –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">üìä</div>
              –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤
            </h2>
          </div>
          <div class="form-group">
            <label class="file-input-wrapper">
              <div class="file-icon">üìÑ</div>
              <span>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)</span>
              <input id="filePrev" type="file" accept="application/pdf">
            </label>
            <label class="file-input-wrapper">
              <div class="file-icon">üìÑ</div>
              <span>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)</span>
              <input id="fileCurr" type="file" accept="application/pdf">
            </label>
          </div>
          <div class="form-group">
            <button id="btnParse" class="btn btn-primary">
              <span>üöÄ</span>
              –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button id="btnCompact" class="btn btn-ghost" title="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º">
              <span>üìê</span>
              –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥
            </button>
          </div>
          <div id="dates" class="message message-info" style="display:none"></div>
          <div id="loadingMsg" class="loading" style="display:none">
            <div class="loading-spinner"></div>
            <span>–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF —Ñ–∞–π–ª–æ–≤...</span>
          </div>
          <div id="errorMsg" class="message message-error" style="display:none"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <div class="card-icon">üíæ</div>
              –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤
            </h2>
          </div>
          <div class="export-section">
            <button class="btn btn-secondary" id="exportPresPDF">
              <span>üìë</span>
              –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è PDF
            </button>
            <button class="btn btn-secondary" id="exportBriefPDF">
              <span>üìã</span>
              –í—ã–∂–∏–º–∫–∞ PDF
            </button>
            <button class="btn btn-secondary" id="exportWordHTML">
              <span>üìù</span>
              –û—Ç—á–µ—Ç Word
            </button>
            <button class="btn btn-secondary" id="exportPresHTML">
              <span>üåê</span>
              –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è HTML
            </button>
          </div>
          <div id="exportStatus" class="message message-success mt-1" style="display:none"></div>
        </div>
      </div>

      <!-- KPI —Å–µ–∫—Ü–∏—è -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">üìà</div>
            –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
          </h2>
        </div>
        <div id="kpis" class="kpi-grid"></div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 2 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranches"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranches">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrev">0</td>
                    <td id="sumCurr">0</td>
                    <td id="sumDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 3 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–ü—Ä–∏–∫–∞–∑ ‚Ññ425</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS3"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 3</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS3">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrevS3">0</td>
                    <td id="sumCurrS3">0</td>
                    <td id="sumDeltaS3">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä. 4 -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
            <span class="badge">–í—Å–µ–≥–æ –æ–ø–æ—Ä</span>
          </div>
          <div class="chart-container">
            <canvas id="chartBranchesS4"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–¢–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <span class="badge">–°—Ç—Ä. 4</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblBranchesS4">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="sumPrevS4">0</td>
                    <td id="sumCurrS4">0</td>
                    <td id="sumDeltaS4">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –†–¢–ö -->
      <div class="card mb-2">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon">üìä</div>
            –î–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª
          </h2>
        </div>
        <div class="chart-container">
          <canvas id="chartRTKDelta"></canvas>
        </div>
      </div>

      <!-- –°—Ç–∞–¥–∏–∏ -->
      <div class="grid cols-2 mb-2">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–°—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç</h2>
            <span class="badge">–°—Ç—Ä. 2</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS2">
                <thead>
                  <tr>
                    <th>–°—Ç–∞–¥–∏—è</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">–°—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç</h2>
            <span class="badge">–°—Ç—Ä. 4 (–†–¢–ö)</span>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblStagesS4">
                <thead>
                  <tr>
                    <th>–°—Ç–∞–¥–∏—è</th>
                    <th>–ü—Ä–µ–¥., —à—Ç.</th>
                    <th>–¢–µ–∫., —à—Ç.</th>
                    <th>Œî, —à—Ç.</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- –û–±–ª–∞—Å—Ç–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ (—Å–∫—Ä—ã—Ç—ã–µ) -->
  <div id="presentationPrint" style="display:none"></div>
  <div id="summaryPrint" style="display:none"></div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
  /* ==================== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã ==================== */
  const BRANCHES = [
    "–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°","–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°","–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°","–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°",
    "–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°","–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°","–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°","–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°","–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°"
  ];
  const BRANCH_PATTERNS = [
    {name:"–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°", re:/–°–æ—á–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°", re:/–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°", re:/–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ\s+–≠–°/i},
    {name:"–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–£—Å—Ç—å[\s\u00A0\u202F\-‚Äì‚Äî-]*–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°", re:/–Æ–≥–æ[\s\u00A0\u202F\-‚Äì‚Äî-]*–ó–∞–ø–∞–¥–Ω—ã–µ\s+–≠–°/i},
    {name:"–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°", re:/–ê–¥—ã–≥–µ–π—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°", re:/–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°", re:/–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°", re:/–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ\s+–≠–°/i},
    {name:"–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°", re:/–°–ª–∞–≤—è–Ω—Å–∫–∏–µ\s+–≠–°/i},
  ];

  /* –°—Ç–∞–¥–∏–∏ */
  const STATUS_PATTERNS = [
    {key:"work", title:"–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞", re:/–í\s*—Ä–∞–±–æ—Ç–µ\s*—É\s*—Ñ–∏–ª–∏–∞–ª–∞/i},
    {key:"dismantled", title:"–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ", re:/–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ/i},
    {key:"rc_digit", title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –†–æ—Å—Å–µ—Ç–∏ –¶–∏—Ñ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏\s*–†–æ—Å—Å–µ—Ç–∏\s*–¶–∏—Ñ—Ä–∞/i},
    {key:"op_sign", title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏\s*—É\s*–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞/i},
    {key:"filial_appr",title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –≤ —Ñ–∏–ª–∏–∞–ª–µ", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏\s*–≤\s*—Ñ–∏–ª–∏–∞–ª–µ/i},
    {key:"incl_next", title:"–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è",
      re:/–ë—É–¥–µ—Ç\s*–≤–∫–ª—é—á–µ–Ω–æ(?:[\s\S]{0,80})–≤(?:\s*—Å–ª–µ–¥—É—é—â–µ–µ)?(?:[\s\S]{0,80})–¥–æ–ø\.?\s*—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ(?:[\s\S]{0,80}–ø–æ—Å–ª–µ\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏—è)?/i
    },
  ];
  const STATUS_KEYS = STATUS_PATTERNS.map(s => s.key);
  const STAGE_TITLE = k => (STATUS_PATTERNS.find(s => s.key===k)||{}).title||k;

  const SHORT_STAGE_TITLES = {
    "work": "–í —Ä–∞–±–æ—Ç–µ",
    "dismantled": "–î–µ–º–æ–Ω—Ç.",
    "rc_digit": "–û—Ñ–æ—Ä–º–ª. –†–¶",
    "op_sign": "–ü–æ–¥–ø–∏—Å—å –æ–ø–µ—Ä.",
    "filial_appr": "–°–æ–≥–ª. —Ñ–∏–ª–∏–∞–ª",
    "incl_next": "–í —Å–ª–µ–¥. –¥–æ–ø.—Å–æ–≥–ª."
  };
  const SHORT_STAGE_TITLE = k => SHORT_STAGE_TITLES[k] || STAGE_TITLE(k);

  const numberize = s => {
    const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
    const n = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
    if(!n) return 0;
    const val = Number(n.replace(",", "."));
    return isNaN(val) ? 0 : val;
  };
  const fmt = n => (typeof n === "number" ? n : Number(n||0)).toLocaleString("ru-RU");
  const normalize = txt => String(txt||"")
      .replace(/\u00A0|\u202F/g," ")
      .replace(/\u00AD/g,"")
      .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
      .replace(/[ \t]+/g," ")
      .trim();

  /* ==================== –ß—Ç–µ–Ω–∏–µ PDF ==================== */
  async function pdfToPages(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      let pageText = "", lastY = null;
      content.items.forEach(item => {
        const y = item.transform[5];
        if(lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
        pageText += item.str;
        lastY = y;
      });
      pages.push(normalize(pageText));
    }
    return pages;
  }

  /* ==================== –ü–∞—Ä—Å–∏–Ω–≥ ==================== */
  function extractDateFromPages(pages){
    for(const pg of pages){
      const m = pg.match(/–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
    return "‚Äî";
  }

  function parseTotalsFromPage(page1){
    const find = (re) => {
      const m = page1.match(re);
      return m ? numberize(m[1]) : 0;
    };
    return {
      found_year: find(/–≤—ã—è–≤–ª–µ–Ω–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
      legalized: find(/–£–∑–∞–∫–æ–Ω–µ–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
      dismantled_ytd: find(/–ó–∞\s*20\d{2}\s*–≥–æ–¥\s*–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
      in_work_total: find(/–í\s*—Ä–∞–±–æ—Ç–µ[^0-9]*?–≤—Å–µ–≥–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
      rtk_in_work: find(/–≤\s*—Ç–æ–º\s*—á–∏—Å–ª–µ\s*–ü–ê–û\s*¬´?–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª?[^0-9]*?(\d[\d\s]+)/i),
    };
  }

  function parseBranchTable(pageText){
    const text = normalize(pageText);
    const lines = text.split("\n").filter(Boolean);

    const idx = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      for(const bp of BRANCH_PATTERNS){
        if(bp.re.test(line)){ idx.push({i, name: bp.name}); break; }
      }
    }
    idx.push({i: lines.length, name:null});

    const branches = new Map();
    for(let k=0;k<idx.length-1;k++){
      const start = idx[k].i, end = idx[k+1].i, branchName = idx[k].name;
      if(!branchName) continue;
      const headLine = lines[start] || "";
      const segText = lines.slice(start+1, end).join(" ");

      let total = 0;
      const headNums = headLine.match(/\d[\d\s]*/g);
      if(headNums && headNums.length) total = numberize(headNums[headNums.length-1]);
      if(total===0 && lines[start+1]){
        const n2 = (lines[start+1]||"").match(/\d[\d\s]*/g);
        if(n2 && n2.length) total = numberize(n2[n2.length-1]);
      }

      const data = { total, statuses:{} };

      function numAfter(re, hay){
        const rx = new RegExp(re.source + "[^\\d]{0,200}(\\d[\\d\\s]*)", re.flags);
        const m = hay.match(rx);
        return m ? numberize(m[1]) : null;
      }

      for(const sp of STATUS_PATTERNS){
        let v = numAfter(sp.re, segText);
        if(v === null){
          for(let j=start+1;j<end;j++){
            const l0 = lines[j]||"", l1 = lines[j+1]||"";
            if(sp.re.test(l0) || sp.re.test(l1)){
              let cap = (l0.match(/(\d[\d\s]*)/g)||[]).pop();
              if(!cap) cap = (l1.match(/(\d[\d\s]*)/g)||[]).pop();
              if(cap){ v = numberize(cap); break; }
            }
          }
        }
        if(v !== null) data.statuses[sp.key] = v;
      }
      branches.set(branchName, data);
    }

    for(const b of BRANCHES){
      if(!branches.has(b)) branches.set(b, { total:0, statuses:{} });
    }

    const stages = {};
    for(const [_, obj] of branches){
      for(const [k,v] of Object.entries(obj.statuses)){
        stages[k] = (stages[k]||0) + (v||0);
      }
    }

    const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);
    return { branches, overall, stages };
  }

  function parseReportByPages(pages){
    return {
      date: extractDateFromPages(pages),
      p1: { totals: parseTotalsFromPage(pages[0] || "") },
      p2: parseBranchTable(pages[1] || ""),
      p3: parseBranchTable(pages[2] || ""),
      p4: parseBranchTable(pages[3] || ""),
    };
  }

  /* ==================== –î–∏–Ω–∞–º–∏–∫–∞ ==================== */
  function computeDynamics(curr, prev){
    const dyn = {
      in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
      rtk_in_work: (curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work) || 0,
      legalized: (curr.p1.totals.legalized - prev.p1.totals.legalized) || 0,
      dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
    };
    dyn.found_week = dyn.in_work_total;

    const makeRows = (cPage, pPage) => BRANCHES.map(b=>{
      const c = cPage.branches.get(b)?.total || 0;
      const p = pPage.branches.get(b)?.total || 0;
      return {b, p, c, d: (c - p)};
    });

    const branchRows = makeRows(curr.p2, prev.p2);
    const branchRowsS3 = makeRows(curr.p3, prev.p3);
    const branchRowsS4 = makeRows(curr.p4, prev.p4);

    const allKeys = Array.from(new Set([
      ...Object.keys(prev.p2.stages||{}), ...Object.keys(curr.p2.stages||{}),
      ...Object.keys(prev.p3.stages||{}), ...Object.keys(curr.p3.stages||{}),
      ...Object.keys(prev.p4.stages||{}), ...Object.keys(curr.p4.stages||{}),
      ...STATUS_KEYS
    ]));

    const diffStages = (cur, prv) => allKeys.map(k=>({
      stage: STAGE_TITLE(k), short: SHORT_STAGE_TITLE(k), key: k,
      p: prv[k] || 0, c: cur[k] || 0, d: (cur[k]||0) - (prv[k]||0)
    }));

    const stagesS2 = diffStages(curr.p2.stages||{}, prev.p2.stages||{});
    const stagesS4 = diffStages(curr.p4.stages||{}, prev.p4.stages||{});

    function perBranchStages(cPage, pPage){
      return BRANCHES.map(b=>{
        const cst = cPage.branches.get(b)?.statuses || {};
        const pst = pPage.branches.get(b)?.statuses || {};
        const by = {};
        STATUS_KEYS.forEach(k=>{
          const p = pst[k]||0, c = cst[k]||0;
          by[k] = {p,c,d:c-p};
        });
        return {b, by};
      });
    }
    const s2BranchStages = perBranchStages(curr.p2, prev.p2);

    return {
      ...dyn,
      branchRows,
      branchRowsS3,
      branchRowsS4,
      stagesS2,
      stagesS4,
      s2BranchStages,
      rtkRows: branchRowsS4
    };
  }pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
