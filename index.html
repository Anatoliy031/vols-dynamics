<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>vols-dynamics ‚Äî –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f7f7fb;color:#111}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    h1{margin:0 0 6px;font-size:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;flex:1;min-width:280px}
    label{display:block;font-size:14px;margin-bottom:8px;color:#334155}
    input[type="file"]{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px}
    button{padding:12px 16px;border-radius:12px;border:1px solid transparent;background:#0033a0;color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#fff;color:#0033a0;border-color:#0033a0}
    .muted{color:#64748b;font-size:12px}
    pre{background:#0b1220;color:#e6edf6;padding:12px;border-radius:10px;max-height:220px;overflow:auto;font-size:12px}
  </style>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.11.1/dist/pptxgen.bundle.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>vols-dynamics ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏</h1>
    <div class="muted">–ó–∞–≥—Ä—É–∑–∏ <b>—Ç–µ–∫—É—â–∏–π</b> –∏ <b>–ø—Ä–µ–¥—ã–¥—É—â–∏–π</b> –æ—Ç—á—ë—Ç—ã ‚Üí –Ω–∞–∂–º–∏ ¬´–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å PPTX¬ª.</div>

    <div class="row">
      <div class="card">
        <label for="curr">–¢–µ–∫—É—â–∏–π –æ—Ç—á—ë—Ç (.xlsx/.xls/.csv)</label>
        <input id="curr" type="file" accept=".xlsx,.xls,.csv" />
      </div>
      <div class="card">
        <label for="prev">–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á—ë—Ç (.xlsx/.xls/.csv)</label>
        <input id="prev" type="file" accept=".xlsx,.xls,.csv" />
      </div>
    </div>

    <div class="row">
      <div class="card" style="flex:0 0 auto">
        <button id="go">üìä –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å PPTX</button>
        <button id="demo" class="secondary">üß™ –¢–µ—Å—Ç –±–µ–∑ —Ñ–∞–π–ª–æ–≤</button>
      </div>
      <div class="card" style="flex:1 1 520px">
        <div class="muted" style="margin-bottom:6px">–õ–æ–≥</div>
        <pre id="log"></pre>
      </div>
    </div>
  </div>

  <script>
    // ---------- –£—Ç–∏–ª–∏—Ç—ã ----------
    const $ = s => document.querySelector(s);
    const log = (...a) => { $('#log').textContent += a.map(x => typeof x==='object'?JSON.stringify(x,null,2):String(x)).join(' ') + '\n'; };

    function readAsArrayBuffer(file){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsArrayBuffer(file);
      });
    }

    function parseTable(fileName, arrayBuffer){
      // CSV
      const lower = (fileName||'').toLowerCase();
      if (lower.endsWith('.csv')){
        const text = new TextDecoder('utf-8').decode(new Uint8Array(arrayBuffer));
        const lines = text.split(/\r?\n/).filter(Boolean);
        if (!lines.length) return [];
        const headers = lines.shift().split(',').map(h=>h.trim());
        return lines.map(line=>{
          const cells = line.split(','); const row = {};
          headers.forEach((h,i)=> row[h]= (cells[i]??'').trim());
          return row;
        });
      }
      // XLSX
      const wb = XLSX.read(arrayBuffer, {type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      return XLSX.utils.sheet_to_json(sheet, {defval:null, raw:true});
    }

    function autodetectCols(rows){
      if (!rows.length) return {branch:null,status:null,count:null};
      const keys = Object.keys(rows[0]||{});
      const norm = s => (s||'').toString().trim().toLowerCase();

      const score = (name, pats) => pats.reduce((acc,p)=>acc+(norm(name).includes(p)?1:0),0);
      let branch = null, status = null, count = null, bestB=-1, bestS=-1, bestC=-1;
      for (const k of keys){
        const sb = score(k, ['—Ñ–∏–ª–∏–∞–ª','–ø–æ–¥—Ä–∞–∑–¥–µ–ª']);
        if (sb>bestB){bestB=sb; branch=k;}
        const ss = score(k, ['—Å—Ç–∞—Ç—É—Å','—Å–æ—Å—Ç–æ—è–Ω']);
        if (ss>bestS){bestS=ss; status=k;}
        const sc = score(k, ['–∫–æ–ª–∏—á','—à—Ç','–≤—Å–µ–≥–æ','count','qty','–∫–æ–ª-–≤–æ']);
        if (sc>bestC){bestC=sc; count=k;}
      }
      return {branch,status,count};
    }

    function aggregate(rows, cols){
      const {branch,status,count} = cols;
      const out = {};
      for (const r of rows){
        const b = (r[branch]??'').toString().trim() || '‚Äî';
        const s = (r[status]??'').toString().trim() || '‚Äî';
        let v = count ? Number(r[count]) : 1;
        if (!Number.isFinite(v)) v = 0;
        (out[b] ||= {}); out[b][s] = (out[b][s]||0) + v;
      }
      return out;
    }

    function unionKeys(a,b){
      const set = new Set([...Object.keys(a||{}), ...Object.keys(b||{})]);
      return [...set];
    }

    // series: { name:'–°—Ç–∞—Ç—É—Å', labels:[–§–∏–ª–∏–∞–ª—ã], values:[–¥–µ–ª—å—Ç—ã] }
    function buildDeltaSeries(aggCurr, aggPrev){
      const branches = unionKeys(aggCurr, aggPrev).sort((x,y)=>x.localeCompare(y,'ru'));
      const statuses = new Set();
      for (const b of branches){
        Object.keys(aggCurr[b]||{}).forEach(s=>statuses.add(s));
        Object.keys(aggPrev[b]||{}).forEach(s=>statuses.add(s));
      }
      const stats = [...statuses];
      // —É–ø–æ—Ä—è–¥–æ—á–∏–º —Å—Ç–∞—Ç—É—Å—ã –ø–æ —Å—É–º–º–µ —Ç–µ–∫—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π (–≤–∏–∑—É–∞–ª—å–Ω–æ —É–¥–æ–±–Ω–µ–µ)
      const sumCurr = s => branches.reduce((acc,b)=>acc+(aggCurr[b]?.[s]??0),0);
      stats.sort((a,b)=>sumCurr(b)-sumCurr(a));

      const series = stats.map(s=>({
        name: s,
        labels: branches,
        values: branches.map(b => (aggCurr[b]?.[s]??0) - (aggPrev[b]?.[s]??0))
      }));
      return series;
    }

    // ---------- PPTX ----------
    function addTitle(pptx){
      const slide = pptx.addSlide();
      slide.addText('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –í–û–õ–°', {x:0.5,y:0.8,w:12.5,h:1,fontSize:28,bold:true,color:'0033A0'});
      slide.addText('–î–∏–Ω–∞–º–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º', {x:0.5,y:1.7,w:12.5,h:0.6,fontSize:16,color:'334155'});
    }

    function addStatusByBranchHorizontal(pptx, series){
      // –¢–û–õ–¨–ö–û –≠–¢–û ‚Äî —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã –∏ —à–∏—Ä–µ –æ–±–ª–∞—Å—Ç—å
      const slide = pptx.addSlide();
      slide.addText('–î–∏–Ω–∞–º–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º', {
        x:0.5,y:0.25,w:12.5,h:0.5,fontSize:16,bold:true,color:'0033A0'
      });
      slide.addChart(pptx.ChartType.bar, series, {
        x:0.2, y:0.9, w:13.0, h:5.3,         // –º–∞–∫—Å–∏–º—É–º —à–∏—Ä–∏–Ω—ã —Å–ª–∞–π–¥–∞
        barDir:'bar',                        // –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–û
        barGrouping:'clustered',
        legendPos:'b',                       // –ª–µ–≥–µ–Ω–¥–∞ —Å–Ω–∏–∑—É ‚Äî —à–∏—Ä–∏–Ω–∞ —Å–≤–æ–±–æ–¥–Ω–∞
        legendFontSize:10,
        catAxisLabelFontSize:10,             // –ø–æ–¥–ø–∏—Å–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤
        valAxisLabelFontSize:10,             // –æ—Å—å –∑–Ω–∞—á–µ–Ω–∏–π
        dataLabelFontSize:8,
        dataLabelFormatCode:'0',
        showLegend:true,
        showValue:true,
        barGapWidthPct:75
      });
    }

    async function generatePPTX(rowsCurr, rowsPrev){
      const colsCurr = autodetectCols(rowsCurr);
      const colsPrev = autodetectCols(rowsPrev);
      log('–ö–æ–ª–æ–Ω–∫–∏ (—Ç–µ–∫—É—â–∏–π):', colsCurr);
      log('–ö–æ–ª–æ–Ω–∫–∏ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π):', colsPrev);

      if (!colsCurr.branch || !colsCurr.status) throw new Error('–í —Ç–µ–∫—É—â–µ–º –æ—Ç—á—ë—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ¬´–§–∏–ª–∏–∞–ª/–°—Ç–∞—Ç—É—Å¬ª.');
      if (!colsPrev.branch || !colsPrev.status) throw new Error('–í –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç—á—ë—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ¬´–§–∏–ª–∏–∞–ª/–°—Ç–∞—Ç—É—Å¬ª.');

      const aggCurr = aggregate(rowsCurr, colsCurr);
      const aggPrev = aggregate(rowsPrev, colsPrev);
      const series = buildDeltaSeries(aggCurr, aggPrev);

      const pptx = new PptxGenJS();
      pptx.author = 'vols-dynamics';
      pptx.layout = 'LAYOUT_WIDE'; // 16:9

      addTitle(pptx);
      // === –¢–í–û–Ø –ü–†–û–°–¨–ë–ê: —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Å–ª–∞–π–¥ –º–µ–Ω—è–µ–º –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π ===
      addStatusByBranchHorizontal(pptx, series);

      const name = `vols-dynamics_${new Date().toISOString().slice(0,10)}.pptx`;
      await pptx.writeFile({fileName:name});
      log('–ì–æ—Ç–æ–≤–æ:', name);
    }

    // ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ----------
    async function run(useDemo=false){
      try{
        $('#log').textContent = '';
        let rowsCurr = [], rowsPrev = [];

        if (useDemo){
          // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–µ–º–æ-–Ω–∞–±–æ—Ä
          rowsPrev = [
            {–§–∏–ª–∏–∞–ª:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°', –°—Ç–∞—Ç—É—Å:'–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:300},
            {–§–∏–ª–∏–∞–ª:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°', –°—Ç–∞—Ç—É—Å:'–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:50},
            {–§–∏–ª–∏–∞–ª:'–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°',  –°—Ç–∞—Ç—É—Å:'–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:120},
            {–§–∏–ª–∏–∞–ª:'–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°',  –°—Ç–∞—Ç—É—Å:'–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:25},
            {–§–∏–ª–∏–∞–ª:'–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°',–°—Ç–∞—Ç—É—Å:'–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:5},
          ];
          rowsCurr = [
            {–§–∏–ª–∏–∞–ª:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°', –°—Ç–∞—Ç—É—Å:'–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:320},
            {–§–∏–ª–∏–∞–ª:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°', –°—Ç–∞—Ç—É—Å:'–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:60},
            {–§–∏–ª–∏–∞–ª:'–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°',  –°—Ç–∞—Ç—É—Å:'–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:150},
            {–§–∏–ª–∏–∞–ª:'–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°',  –°—Ç–∞—Ç—É—Å:'–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:40},
            {–§–∏–ª–∏–∞–ª:'–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°',–°—Ç–∞—Ç—É—Å:'–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è', –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:9},
          ];
        } else {
          const f1 = $('#curr').files[0], f2 = $('#prev').files[0];
          if (!f1 || !f2) throw new Error('–ó–∞–≥—Ä—É–∑–∏ –æ–±–∞ —Ñ–∞–π–ª–∞: —Ç–µ–∫—É—â–∏–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π.');
          const [b1,b2] = await Promise.all([readAsArrayBuffer(f1), readAsArrayBuffer(f2)]);
          rowsCurr = parseTable(f1.name, b1);
          rowsPrev = parseTable(f2.name, b2);
          log(`–¢–µ–∫—É—â–∏–π: ${f1.name}, —Å—Ç—Ä–æ–∫: ${rowsCurr.length}`);
          log(`–ü—Ä–µ–¥—ã–¥—É—â–∏–π: ${f2.name}, —Å—Ç—Ä–æ–∫: ${rowsPrev.length}`);
        }

        await generatePPTX(rowsCurr, rowsPrev);
      }catch(e){
        log('–û—à–∏–±–∫–∞:', e.message||e);
        alert(e.message||e);
      }
    }

    $('#go').addEventListener('click', ()=>run(false));
    $('#demo').addEventListener('click', ()=>run(true));
  </script>
</body>
</html>
