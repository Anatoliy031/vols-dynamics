<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–í–û–õ–° ‚Ä¢ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å</title>

<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --blue:#0033A0; --blue-600:#0a2a7a; --accent:#00B4F0;
    --bg:#F7FAFC; --card:#fff; --muted:#64748B; --border:#E2E8F0;
    --ok:#059669; --bad:#DC2626; --mid:#64748B;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#0F172A}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(90deg,var(--blue),#00236b);color:#fff;padding:14px 18px}
  header b{font-size:16px}
  main{max-width:1200px;margin:20px auto;padding:0 16px}
  .row{display:grid;gap:16px}
  .cols-2{grid-template-columns:1fr 1fr}
  @media (max-width:1000px){.cols-2{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
  h2{margin:0 0 10px;font-size:18px}
  .pill{display:inline-block;border:1px dashed var(--border);padding:10px 12px;border-radius:10px;background:#fff;margin-right:8px}
  input[type=file]{display:none}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--blue);background:#fff;color:var(--blue);cursor:pointer;font-weight:600}
  .btn.primary{background:var(--blue);color:#fff}
  .note{color:var(--muted)}
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media (max-width:900px){.grid4{grid-template-columns:repeat(2,1fr)}}
  .kpi{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
  .kpi .t{color:var(--muted);font-size:12px;text-transform:uppercase}
  .kpi .v{font-weight:800;font-size:22px}
  .kpi .d{font-weight:700}
  .up{color:var(--ok)} .down{color:var(--bad)} .muted{color:var(--mid)}
  .table-wrap{border:1px solid var(--border);border-radius:10px;overflow:auto;background:#fff;max-height:420px}
  table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
  thead th{position:sticky;top:0;background:#EEF2F7;border-bottom:1px solid var(--border);padding:10px;text-align:right;font-size:12px}
  thead th:first-child{text-align:left}
  tbody td{padding:10px;border-bottom:1px solid var(--border);text-align:right}
  tbody td:first-child{text-align:left;font-weight:600}
  tfoot td{padding:10px;font-weight:800;background:#F1F5FB}
  .chart-box{height:360px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--muted);font-size:11px}

  /* –û–±–ª–∞—Å—Ç—å –ø–µ—á–∞—Ç–∏ (–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è / –≤—ã–∂–∏–º–∫–∞) */
  #presentationPrint,#summaryPrint{display:none;background:#fff;border:1px solid var(--border);border-radius:12px;padding:18px}

  /* –°–ª–∞–π–¥—ã –≤ HTML-—ç–∫—Å–ø–æ—Ä—Ç–µ */
  .slides{width:100vw;min-height:100vh;background:#1e293b;margin:0;padding:40px 0}
  .slide{width:1280px;height:720px;background:#fff;margin:0 auto 8px;border-radius:6px;box-shadow:0 20px 40px rgba(0,0,0,.25);padding:56px 56px 48px;position:relative;box-sizing:border-box}
  .slide::before{content:"";position:absolute;left:0;right:0;top:0;height:6px;background:linear-gradient(90deg,var(--blue),var(--accent))}
  .slide h1{color:var(--blue);font-size:42px;margin:0 0 6px}
  .slide h2{color:var(--blue);font-size:32px;margin:0 0 10px}
  .sub{color:#6b7280;margin:0 0 12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:20px;height:calc(100% - 140px)}
  .panel{border:1px solid var(--border);border-radius:12px;padding:14px;overflow:auto}
  .imgbox{border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;justify-content:center}
  .imgbox img{max-width:100%;max-height:100%}
  .num{position:absolute;right:22px;bottom:22px;width:44px;height:44px;border-radius:50%;background:var(--blue);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}

  /* –§–∏–∫—Å —Å–ª–∞–π–¥–∞ 5: –∫–∞—Ä–º–∞–Ω-—Ä–µ–∑–∞–π–∑–µ—Ä */
  .fitbox{height:calc(100% - 140px);border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  .fit-inner{transform-origin:top left;padding:14px}

  /* –ö—Ä–æ—à–µ—á–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –¥–ª—è —Å–ª–∞–π–¥–∞ */
  .status-matrix th,.status-matrix td{white-space:nowrap}
</style>
</head>
<body>
<header><b>–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª ‚Äî –í–û–õ–°: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å</b></header>
<main>
  <section class="card">
    <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤</h2>
    <label class="pill">üìÑ –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)<input id="filePrev" type="file" accept="application/pdf"></label>
    <label class="pill">üìÑ –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è (PDF)<input id="fileCurr" type="file" accept="application/pdf"></label>
    <button id="btnParse" class="btn primary">–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
    <span id="dates" class="note" style="margin-left:8px">–î–∞—Ç—ã: ‚Äî</span>
    <div style="margin-top:10px">
      <button id="exportPresPDF" class="btn">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (PDF)</button>
      <button id="exportBriefPDF" class="btn">–í—ã–∂–∏–º–∫–∞ (PDF)</button>
      <button id="exportDocHTML" class="btn">–û—Ç—á—ë—Ç (Word HTML)</button>
      <button id="exportPresHTML" class="btn">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (HTML)</button>
    </div>
    <div id="msg" class="note" style="margin-top:8px"></div>
  </section>

  <section class="card">
    <h2>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ <span class="badge">Œî: —Ç–µ–∫ ‚àí –ø—Ä–µ–¥</span></h2>
    <div id="kpis" class="grid4"></div>
  </section>

  <div class="row cols-2">
    <section class="card">
      <h2>–°—Ç—Ä. 2 ‚Äî ¬´–í—Å–µ–≥–æ –æ–ø–æ—Ä, —à—Ç.¬ª –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
      <div class="chart-box"><canvas id="c2"></canvas></div>
    </section>
    <section class="card">
      <h2>–¢–∞–±–ª–∏—Ü–∞ (—Å—Ç—Ä. 2)</h2>
      <div class="table-wrap"><table id="t2">
        <thead><tr><th>–§–∏–ª–∏–∞–ª</th><th>–ü—Ä–µ–¥.</th><th>–¢–µ–∫.</th><th>Œî</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td>–ò—Ç–æ–≥–æ</td><td id="p2">0</td><td id="c2s">0</td><td id="d2">0</td></tr></tfoot>
      </table></div>
    </section>
  </div>

  <div class="row cols-2">
    <section class="card">
      <h2>–°—Ç—Ä. 3 ‚Äî –ü—Ä–∏–∫–∞–∑ ‚Ññ425</h2>
      <div class="chart-box"><canvas id="c3"></canvas></div>
    </section>
    <section class="card">
      <h2>–¢–∞–±–ª–∏—Ü–∞ (—Å—Ç—Ä. 3)</h2>
      <div class="table-wrap"><table id="t3">
        <thead><tr><th>–§–∏–ª–∏–∞–ª</th><th>–ü—Ä–µ–¥.</th><th>–¢–µ–∫.</th><th>Œî</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td>–ò—Ç–æ–≥–æ</td><td id="p3">0</td><td id="c3s">0</td><td id="d3">0</td></tr></tfoot>
      </table></div>
    </section>
  </div>

  <div class="row cols-2">
    <section class="card">
      <h2>–°—Ç—Ä. 4 ‚Äî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
      <div class="chart-box"><canvas id="c4"></canvas></div>
    </section>
    <section class="card">
      <h2>–¢–∞–±–ª–∏—Ü–∞ (—Å—Ç—Ä. 4)</h2>
      <div class="table-wrap"><table id="t4">
        <thead><tr><th>–§–∏–ª–∏–∞–ª</th><th>–ü—Ä–µ–¥.</th><th>–¢–µ–∫.</th><th>Œî</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td>–ò—Ç–æ–≥–æ</td><td id="p4">0</td><td id="c4s">0</td><td id="d4">0</td></tr></tfoot>
      </table></div>
    </section>
  </div>

  <div class="row cols-2">
    <section class="card">
      <h2>–°—Ç—Ä. 2 ‚Äî –°—Ç–∞–¥–∏–∏ (–∏—Ç–æ–≥–∏)</h2>
      <div class="table-wrap"><table id="st2">
        <thead><tr><th>–°—Ç–∞–¥–∏—è</th><th>–ü—Ä–µ–¥.</th><th>–¢–µ–∫.</th><th>Œî</th></tr></thead>
        <tbody></tbody>
      </table></div>
    </section>
    <section class="card">
      <h2>–°—Ç—Ä. 4 (–†–¢–ö) ‚Äî –°—Ç–∞–¥–∏–∏ (–∏—Ç–æ–≥–∏)</h2>
      <div class="table-wrap"><table id="st4">
        <thead><tr><th>–°—Ç–∞–¥–∏—è</th><th>–ü—Ä–µ–¥.</th><th>–¢–µ–∫.</th><th>Œî</th></tr></thead>
        <tbody></tbody>
      </table></div>
    </section>
  </div>

  <!-- –ü–µ—á–∞—Ç–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ -->
  <section id="presentationPrint" class="card">
    <h2 style="margin:0 0 6px">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (–ø–µ—á–∞—Ç—å)</h2>
    <div id="pres_dates" class="note"></div>
    <div id="pres_kpi"></div>
    <hr>
    <div id="pres_t2"></div><hr>
    <div id="pres_t3"></div><hr>
    <div id="pres_t4"></div><hr>
    <div id="pres_stages"></div>
  </section>

  <section id="summaryPrint" class="card">
    <h2 style="margin:0 0 6px">–í—ã–∂–∏–º–∫–∞ (–ø–µ—á–∞—Ç—å)</h2>
    <div id="brief_dates" class="note"></div>
    <div id="brief_body"></div>
  </section>
</main>

<script>
/* ----------------------- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ----------------------- */
const BRANCHES = [
 "–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°","–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°","–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°","–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°",
 "–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°","–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°","–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°","–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°","–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°","–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°"
];
const BRANCH_PATTERNS = [
  {name:"–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°", re:/–°–æ—á–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
  {name:"–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°", re:/–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ\s+–≠–°/i},
  {name:"–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°", re:/–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ\s+–≠–°/i},
  {name:"–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–£—Å—Ç—å[\s\u00A0\u202F\-‚Äì‚Äî-]*–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
  {name:"–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°", re:/–Æ–≥–æ[\s\u00A0\u202F\-‚Äì‚Äî-]*–ó–∞–ø–∞–¥–Ω—ã–µ\s+–≠–°/i},
  {name:"–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°", re:/–ê–¥—ã–≥–µ–π—Å–∫–∏–µ\s+–≠–°/i},
  {name:"–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°", re:/–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ\s+–≠–°/i},
  {name:"–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°", re:/–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ\s+–≠–°/i},
  {name:"–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", re:/–õ–∞–±–∏–Ω—Å–∫–∏–µ\s+–≠–°/i},
  {name:"–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°", re:/–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ\s+–≠–°/i},
  {name:"–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°", re:/–°–ª–∞–≤—è–Ω—Å–∫–∏–µ\s+–≠–°/i},
];

const STATUS_PATTERNS = [
  {key:"work",       title:"–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞", re:/–í\s*—Ä–∞–±–æ—Ç–µ\s*—É\s*—Ñ–∏–ª–∏–∞–ª–∞/i},
  {key:"dismantled", title:"–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ", re:/–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ/i},
  {key:"rc_digit",   title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –†–æ—Å—Å–µ—Ç–∏ –¶–∏—Ñ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏\s*–†–æ—Å—Å–µ—Ç–∏\s*–¶–∏—Ñ—Ä–∞/i},
  {key:"op_sign",    title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏\s*—É\s*–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞/i},
  {key:"filial_appr",title:"–î–æ–≥–æ–≤–æ—Ä –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏ –≤ —Ñ–∏–ª–∏–∞–ª–µ", re:/–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏\s*–≤\s*—Ñ–∏–ª–∏–∞–ª–µ/i},
  {key:"incl_next",  title:"–ë—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ–ø. —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è",
   re:/–ë—É–¥–µ—Ç\s*–≤–∫–ª—é—á–µ–Ω–æ(?:[\s\S]{0,80})–¥–æ–ø\.?\s*—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ/i}
];
const STATUS_KEYS = STATUS_PATTERNS.map(s=>s.key);
const SHORT_STAGE = {
  work:"–í —Ä–∞–±–æ—Ç–µ", dismantled:"–î–µ–º–æ–Ω—Ç.", rc_digit:"–û—Ñ–æ—Ä–º–ª. –†–¶",
  op_sign:"–ü–æ–¥–ø–∏—Å—å –æ–ø–µ—Ä.", filial_appr:"–°–æ–≥–ª. —Ñ–∏–ª.", incl_next:"–°–ª–µ–¥. –¥–æ–ø."
};
const stTitle = k => (STATUS_PATTERNS.find(s=>s.key===k)||{}).title || k;

/* ----------------------- –£—Ç–∏–ª–∏—Ç—ã ----------------------- */
const fmt = n => Number(n||0).toLocaleString("ru-RU");
const num = s => {
  const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
  const v = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
  if(!v) return 0;
  const x = Number(v.replace(",", "."));
  return isNaN(x)?0:x;
};
const norm = s => String(s||"")
 .replace(/\u00A0|\u202F/g," ")
 .replace(/\u00AD/g,"")
 .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
 .replace(/[ \t]+/g," ")
 .trim();

function msg(m, ok=false){ const el=document.getElementById("msg"); el.textContent=m; el.style.color=ok?"#059669":"#0F172A"; }

/* ----------------------- –ß—Ç–µ–Ω–∏–µ PDF ----------------------- */
async function pdfToPages(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;
  const pages = [];
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    let s="", y=null;
    for(const it of content.items){
      const ny = it.transform[5];
      if(y!==null && Math.abs(ny-y)>5) s+="\n";
      s+=it.str; y=ny;
    }
    pages.push(norm(s));
  }
  return pages;
}

/* ----------------------- –ü–∞—Ä—Å–∏–Ω–≥ ----------------------- */
function extractDate(pages){
  for(const t of pages){
    const m = t.match(/–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞\s+(\d{2}\.\d{2}\.\d{4})/i);
    if(m) return m[1];
  }
  return "‚Äî";
}

function parseTotalsPage1(t){
  const f = re => { const m = t.match(re); return m?num(m[1]):0; };
  return {
    in_work_total: f(/–í\s*—Ä–∞–±–æ—Ç–µ[^0-9]*?–≤—Å–µ–≥–æ[^0-9]*?(\d[\d\s]+)/i),
    rtk_in_work:   f(/–≤\s*—Ç–æ–º\s*—á–∏—Å–ª–µ\s*–ü–ê–û\s*¬´?–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª?[^0-9]*?(\d[\d\s]+)/i),
    legalized:     f(/–£–∑–∞–∫–æ–Ω–µ–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
    dismantled_ytd:f(/–ó–∞\s*20\d{2}\s*–≥–æ–¥\s*–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
    found_year:    f(/–≤—ã—è–≤–ª–µ–Ω–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i)
  };
}

function parseBranchPage(t){
  const lines = norm(t).split("\n").filter(Boolean);
  const marks = [];
  for(let i=0;i<lines.length;i++){
    for(const bp of BRANCH_PATTERNS){
      if(bp.re.test(lines[i])){ marks.push({i,name:bp.name}); break; }
    }
  }
  marks.push({i:lines.length,name:null});
  const branches=new Map();

  for(let k=0;k<marks.length-1;k++){
    const a=marks[k].i, b=marks[k+1].i, name=marks[k].name;
    if(!name) continue;
    const head=lines[a]||"", seg=lines.slice(a+1,b).join(" ");
    // total
    let total=0;
    const hn=head.match(/\d[\d\s]*/g);
    if(hn && hn.length) total=num(hn[hn.length-1]);
    if(!total && lines[a+1]){
      const nn=(lines[a+1]||"").match(/\d[\d\s]*/g);
      if(nn && nn.length) total=num(nn[nn.length-1]);
    }
    const statuses={};
    const capAfter = (re, hay) => {
      const rx = new RegExp(re.source+"[^\\d]{0,120}(\\d[\\d\\s]*)", re.flags);
      const m = hay.match(rx); return m?num(m[1]):null;
    };
    for(const sp of STATUS_PATTERNS){
      let v = capAfter(sp.re, seg);
      if(v===null){
        for(let j=a+1;j<b;j++){
          const l=lines[j]||"", l2=lines[j+1]||"";
          if(sp.re.test(l)||sp.re.test(l2)){
            let cap=(l.match(/(\d[\d\s]*)/g)||[]).pop();
            if(!cap) cap=(l2.match(/(\d[\d\s]*)/g)||[]).pop();
            if(cap){ v=num(cap); break; }
          }
        }
      }
      if(v!==null) statuses[sp.key]=v;
    }
    branches.set(name,{total, statuses});
  }
  for(const b of BRANCHES){ if(!branches.has(b)) branches.set(b,{total:0,statuses:{}}); }

  const stages={};
  for(const [,v] of branches){
    for(const [k,val] of Object.entries(v.statuses)) stages[k]=(stages[k]||0)+(val||0);
  }
  const overall=[...branches.values()].reduce((s,v)=>s+(v.total||0),0);
  return {branches, stages, overall};
}

function parseReport(pages){
  return {
    date: extractDate(pages),
    p1: { totals: parseTotalsPage1(pages[0]||"") },
    p2: parseBranchPage(pages[1]||""),
    p3: parseBranchPage(pages[2]||""),
    p4: parseBranchPage(pages[3]||"")
  };
}

/* ----------------------- –î–∏–Ω–∞–º–∏–∫–∞ ----------------------- */
function computeDynamics(curr, prev){
  const dyn = {
    in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total)||0,
    rtk_in_work:   (curr.p1.totals.rtk_in_work   - prev.p1.totals.rtk_in_work)||0,
    legalized:     (curr.p1.totals.legalized     - prev.p1.totals.legalized)||0,
    dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)||0
  };
  dyn.found_week = dyn.in_work_total;

  const mkRows = (c,p) => BRANCHES.map(b=>{
    const c0=c.branches.get(b)?.total||0, p0=p.branches.get(b)?.total||0;
    return {b, p:p0, c:c0, d:c0-p0};
  });

  const allKeys = Array.from(new Set([...STATUS_KEYS,
    ...Object.keys(curr.p2.stages||{}), ...Object.keys(prev.p2.stages||{})]));

  const diffStages = (c,p) => allKeys.map(k=>({
    key:k, stage:stTitle(k), short:SHORT_STAGE[k]||stTitle(k),
    p: p[k]||0, c: c[k]||0, d: (c[k]||0)-(p[k]||0)
  }));

  // –ü–µ—Ä-branch –º–∞—Ç—Ä–∏—Ü–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (—Å—Ç—Ä.2)
  const s2BranchStages = BRANCHES.map(b=>{
    const cst = curr.p2.branches.get(b)?.statuses||{};
    const pst = prev.p2.branches.get(b)?.statuses||{};
    const by={};
    STATUS_KEYS.forEach(k=>{ by[k]={p:pst[k]||0, c:cst[k]||0, d:(cst[k]||0)-(pst[k]||0)}; });
    return {b, by};
  });

  return {
    ...dyn,
    branchRows:   mkRows(curr.p2, prev.p2),
    branchRowsS3: mkRows(curr.p3, prev.p3),
    branchRowsS4: mkRows(curr.p4, prev.p4),
    stagesS2: diffStages(curr.p2.stages||{}, prev.p2.stages||{}),
    stagesS4: diffStages(curr.p4.stages||{}, prev.p4.stages||{}),
    s2BranchStages
  };
}

/* ----------------------- –†–µ–Ω–¥–µ—Ä ----------------------- */
let DATA=null, ch2=null, ch3=null, ch4=null;

function renderKPIs(curr, prev, dyn){
  const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) -
              (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
  const rtkShare = curr.p1.totals.in_work_total ?
    (curr.p1.totals.rtk_in_work/curr.p1.totals.in_work_total*100) : 0;

  const items = [
    {t:"–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ", v:fmt(curr.p1.totals.in_work_total), d:dyn.in_work_total},
    {t:"–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é", v:fmt(dyn.found_week), d:dyn.found_week},
    {t:"–ó–∞–∫—Ä—ã—Ç–æ (—É–∑–∞–∫.+–¥–µ–º–æ–Ω—Ç.)", v:fmt(eff), d:eff},
    {t:"–†–¢–ö –≤ —Ä–∞–±–æ—Ç–µ (–¥–æ–ª—è, %)", v:`${fmt(curr.p1.totals.rtk_in_work)} (${rtkShare.toFixed(1)}%)`, d:dyn.rtk_in_work},
  ];
  document.getElementById("kpis").innerHTML = items.map(x=>{
    const cls = typeof x.d==="number" ? (x.d>0?"up":x.d<0?"down":"muted") : "muted";
    const sign = x.d>0?"+":"";
    return `<div class="kpi">
      <div class="t">${x.t}</div>
      <div class="v">${x.v}</div>
      <div class="d ${cls}">${sign}${fmt(x.d||0)}</div>
    </div>`;
  }).join("");
}

function fillBranchTable(rows, tblId, sumIds){
  const tb = document.querySelector(`#${tblId} tbody`);
  tb.innerHTML="";
  let sp=0, sc=0, sd=0;
  rows.forEach(r=>{
    const d=r.c-r.p, cls=d>0?"up":d<0?"down":"muted", sign=d>0?"+":"";
    sp+=r.p; sc+=r.c; sd+=d;
    tb.insertAdjacentHTML("beforeend",
      `<tr><td>${r.b}</td><td>${fmt(r.p)}</td><td>${fmt(r.c)}</td><td class="${cls}">${sign}${fmt(d)}</td></tr>`);
  });
  document.getElementById(sumIds.p).textContent=fmt(sp);
  document.getElementById(sumIds.c).textContent=fmt(sc);
  document.getElementById(sumIds.d).textContent=(sd>0?"+":"")+fmt(sd);
}

function chartOpts(){ return {
  responsive:true, maintainAspectRatio:false,
  plugins:{legend:{position:"top",labels:{boxWidth:14,usePointStyle:true}}},
  scales:{y:{beginAtZero:true,ticks:{precision:0}}}
};}

function renderCharts(curr, prev){
  const labels=BRANCHES;
  const d2p=labels.map(b=>prev.p2.branches.get(b)?.total||0);
  const d2c=labels.map(b=>curr.p2.branches.get(b)?.total||0);
  const d3p=labels.map(b=>prev.p3.branches.get(b)?.total||0);
  const d3c=labels.map(b=>curr.p3.branches.get(b)?.total||0);
  const d4p=labels.map(b=>prev.p4.branches.get(b)?.total||0);
  const d4c=labels.map(b=>curr.p4.branches.get(b)?.total||0);

  if(ch2) ch2.destroy(); if(ch3) ch3.destroy(); if(ch4) ch4.destroy();

  ch2 = new Chart(document.getElementById("c2"), {type:"bar", data:{
    labels, datasets:[
      {label:"–ü—Ä–µ–¥. –Ω–µ–¥–µ–ª—è", data:d2p, backgroundColor:"#CBD5E1"},
      {label:"–¢–µ–∫. –Ω–µ–¥–µ–ª—è",  data:d2c, backgroundColor:"#3B82F6"}
    ]}, options:chartOpts()
  });

  ch3 = new Chart(document.getElementById("c3"), {type:"bar", data:{
    labels, datasets:[
      {label:"–ü—Ä–µ–¥. –Ω–µ–¥–µ–ª—è", data:d3p, backgroundColor:"#CBD5E1"},
      {label:"–¢–µ–∫. –Ω–µ–¥–µ–ª—è",  data:d3c, backgroundColor:"#3B82F6"}
    ]}, options:chartOpts()
  });

  ch4 = new Chart(document.getElementById("c4"), {type:"bar", data:{
    labels, datasets:[
      {label:"–ü—Ä–µ–¥. –Ω–µ–¥–µ–ª—è", data:d4p, backgroundColor:"#CBD5E1"},
      {label:"–¢–µ–∫. –Ω–µ–¥–µ–ª—è",  data:d4c, backgroundColor:"#3B82F6"}
    ]}, options:chartOpts()
  });
}

function renderStagesTable(rows, id){
  const tb=document.querySelector(`#${id} tbody`);
  tb.innerHTML=rows.map(r=>{
    const d=r.c-r.p, cls=d>0?"up":d<0?"down":"muted", sign=d>0?"+":"";
    return `<tr><td>${r.stage}</td><td>${fmt(r.p)}</td><td>${fmt(r.c)}</td><td class="${cls}">${sign}${fmt(d)}</td></tr>`;
  }).join("");
}

/* ----------------------- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–µ—á–∞—Ç–Ω—ã—Ö HTML-–±–ª–æ–∫–æ–≤ ----------------------- */
function tableHTML(title, rows, sums){
  return `<div style="font-weight:700;margin:6px 0">${title}</div>
  <table style="width:100%;border-collapse:collapse;font-size:12px">
    <thead><tr style="background:#EEF2F7">
      <th style="text-align:left;padding:8px">–§–∏–ª–∏–∞–ª</th>
      <th style="text-align:right;padding:8px">–ü—Ä–µ–¥.</th>
      <th style="text-align:right;padding:8px">–¢–µ–∫.</th>
      <th style="text-align:right;padding:8px">Œî</th>
    </tr></thead>
    <tbody>
      ${rows.map(r=>{
        const d=r.c-r.p, col=d>0?"#059669":d<0?"#DC2626":"#64748B", sign=d>0?"+":"";
        return `<tr>
          <td style="padding:8px;border-top:1px solid #E2E8F0">${r.b}</td>
          <td style="padding:8px;border-top:1px solid #E2E8F0;text-align:right">${fmt(r.p)}</td>
          <td style="padding:8px;border-top:1px solid #E2E8F0;text-align:right">${fmt(r.c)}</td>
          <td style="padding:8px;border-top:1px solid #E2E8F0;text-align:right;color:${col};font-weight:700">${sign}${fmt(d)}</td>
        </tr>`;
      }).join("")}
    </tbody>
    <tfoot><tr style="background:#F1F5FB;font-weight:800">
      <td style="padding:8px;border-top:2px solid #CBD5E1">–ò—Ç–æ–≥–æ</td>
      <td style="padding:8px;border-top:2px solid #CBD5E1;text-align:right">${document.getElementById(sums.p).textContent}</td>
      <td style="padding:8px;border-top:2px solid #CBD5E1;text-align:right">${document.getElementById(sums.c).textContent}</td>
      <td style="padding:8px;border-top:2px solid #CBD5E1;text-align:right">${document.getElementById(sums.d).textContent}</td>
    </tr></tfoot>
  </table>`;
}

function stageTotalsHTML(title, totals){
  return `<div style="font-weight:700;margin:6px 0">${title}</div>
  <table style="width:100%;border-collapse:collapse;font-size:12px">
    <thead><tr style="background:#EEF2F7">
      <th style="text-align:left;padding:8px">–°—Ç–∞–¥–∏—è</th>
      <th style="text-align:right;padding:8px">–ü—Ä–µ–¥.</th>
      <th style="text-align:right;padding:8px">–¢–µ–∫.</th>
      <th style="text-align:right;padding:8px">Œî</th>
    </tr></thead>
    <tbody>
      ${totals.map(r=>{
        const d=r.c-r.p, col=d>0?"#059669":d<0?"#DC2626":"#64748B", sign=d>0?"+":"";
        return `<tr>
          <td style="padding:8px;border-top:1px solid #E2E8F0">${r.stage}</td>
          <td style="padding:8px;border-top:1px solid #E2E8F0;text-align:right">${fmt(r.p)}</td>
          <td style="padding:8px;border-top:1px solid #E2E8F0;text-align:right">${fmt(r.c)}</td>
          <td style="padding:8px;border-top:1px solid #E2E8F0;text-align:right;color:${col};font-weight:700">${sign}${fmt(d)}</td>
        </tr>`;
      }).join("")}
    </tbody>
  </table>`;
}

function stageMatrixHTML(title, branchStages){
  const cols = STATUS_KEYS;
  let totals={}; cols.forEach(k=>totals[k]=0);
  const head = cols.map(k=>`<th style="padding:6px 8px;text-align:right">${SHORT_STAGE[k]||k}</th>`).join("");
  const body = branchStages.map(r=>{
    const cells = cols.map(k=>{
      const d=r.by[k]?.d||0; totals[k]+=d;
      const col=d>0?"#059669":d<0?"#DC2626":"#64748B", sign=d>0?"+":"";
      return `<td style="padding:6px 8px;text-align:right;color:${col};font-weight:700">${sign}${fmt(d)}</td>`;
    }).join("");
    return `<tr>
      <td style="padding:6px 8px;border-top:1px solid #E2E8F0">${r.b}</td>${cells}
    </tr>`;
  }).join("");
  const foot = `<tr style="background:#F1F5FB;font-weight:800">
    <td style="padding:8px;border-top:2px solid #CBD5E1">–ò—Ç–æ–≥–æ Œî</td>
    ${cols.map(k=>{
      const d=totals[k]; const col=d>0?"#059669":d<0?"#DC2626":"#64748B"; const sign=d>0?"+":"";
      return `<td style="padding:8px;text-align:right;border-top:2px solid #CBD5E1;color:${col}">${sign}${fmt(d)}</td>`;
    }).join("")}
  </tr>`;
  return `<div style="font-weight:700;margin:6px 0">${title}</div>
  <div style="overflow:auto;border:1px solid #E2E8F0;border-radius:10px">
    <table class="status-matrix" style="width:100%;border-collapse:collapse;font-size:11px">
      <thead><tr style="background:#EEF2F7"><th style="text-align:left;padding:6px 8px">–§–∏–ª–∏–∞–ª</th>${head}</tr></thead>
      <tbody>${body}</tbody>
      <tfoot>${foot}</tfoot>
    </table>
  </div>`;
}

function buildPrintable(curr, prev, dyn){
  document.getElementById("pres_dates").textContent = `–ü—Ä–µ–¥.: ${prev.date} ‚Ä¢ –¢–µ–∫.: ${curr.date}`;
  document.getElementById("brief_dates").textContent = `–ü—Ä–µ–¥.: ${prev.date} ‚Ä¢ –¢–µ–∫.: ${curr.date}`;

  // KPI (–∫–æ—Ä–æ—Ç–∫–∏–π –±–ª–æ–∫)
  const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
  document.getElementById("pres_kpi").innerHTML =
    `<div>–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ: <b>${fmt(curr.p1.totals.in_work_total)}</b> (${dyn.in_work_total>0?"+":""}${fmt(dyn.in_work_total)}) |
     –í—ã—è–≤–ª–µ–Ω–æ: <b>${fmt(dyn.found_week)}</b> |
     –ó–∞–∫—Ä—ã—Ç–æ: <b>${fmt(eff)}</b> |
     –†–¢–ö: <b>${fmt(curr.p1.totals.rtk_in_work)}</b> (${dyn.rtk_in_work>0?"+":""}${fmt(dyn.rtk_in_work)})</div>`;

  // –¢–∞–±–ª–∏—Ü—ã
  const s2 = tableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)",    DATA.dyn.branchRows,   {p:"p2", c:"c2s", d:"d2"});
  const s3 = tableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425",        DATA.dyn.branchRowsS3, {p:"p3", c:"c3s", d:"d3"});
  const s4 = tableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª",    DATA.dyn.branchRowsS4, {p:"p4", c:"c4s", d:"d4"});
  document.getElementById("pres_t2").innerHTML=s2;
  document.getElementById("pres_t3").innerHTML=s3;
  document.getElementById("pres_t4").innerHTML=s4;

  // –°—Ç–∞—Ç—É—Å—ã –¥–ª—è –ø–µ—á–∞—Ç–∏/–≤—ã–∂–∏–º–∫–∏
  const totalsS2 = stageTotalsHTML("–ò—Ç–æ–≥–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (—Å—Ç—Ä.2)", DATA.dyn.stagesS2);
  const matrixS2 = stageMatrixHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (—Å—Ç—Ä.2, Œî)", DATA.dyn.s2BranchStages);
  document.getElementById("pres_stages").innerHTML = matrixS2 + "<br>" + totalsS2;

  // –í—ã–∂–∏–º–∫–∞
  document.getElementById("brief_body").innerHTML = s2 + "<br>" + s3 + "<br>" + s4 + "<br>" + totalsS2;
}

/* ----------------------- –≠–∫—Å–ø–æ—Ä—Ç—ã ----------------------- */
async function exportPDF(elId, filename){
  const el=document.getElementById(elId);
  el.style.display="block";
  await html2pdf().from(el).set({
    margin:10, filename, image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2, useCORS:true},
    jsPDF:{unit:'mm',format:'a4',compress:true},
    pagebreak:{mode:['css','legacy'], avoid:['tr']}
  }).save();
  el.style.display="none";
}

function exportWordHTML(){
  if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
  const {curr, prev} = DATA;
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>–û—Ç—á—ë—Ç –í–û–õ–°</title>
  <style>body{font:14px/1.5 Segoe UI,Arial,sans-serif;max-width:900px;margin:0 auto;padding:24px}
  table{width:100%;border-collapse:collapse;margin:16px 0}th,td{border:1px solid #ddd;padding:8px}th{background:#0033A0;color:#fff}
  </style></head><body>
  <h1>–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª ‚Äî –û—Ç—á—ë—Ç –ø–æ –¥–∏–Ω–∞–º–∏–∫–µ –í–û–õ–°</h1>
  <p>–ü–µ—Ä–∏–æ–¥: –ø—Ä–µ–¥. ${prev.date} ‚Ä¢ —Ç–µ–∫. ${curr.date}</p>
  ${document.getElementById("pres_kpi").innerHTML}
  ${document.getElementById("pres_t2").innerHTML}
  ${document.getElementById("pres_t3").innerHTML}
  ${document.getElementById("pres_t4").innerHTML}
  ${document.getElementById("pres_stages").innerHTML}
  </body></html>`;
  const blob = new Blob([html], {type:"text/html;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
  a.download=`–û—Ç—á—ë—Ç_–í–û–õ–°_${curr.date.replace(/\./g,'-')}.html`; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}

/* --- –≠–∫—Å–ø–æ—Ä—Ç ¬´–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (HTML)¬ª —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º 5 —Å–ª–∞–π–¥–æ–º --- */
function exportPresentationHTML(){
  if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã.");
  const {curr, prev, dyn} = DATA;
  const img2 = document.getElementById("c2").toDataURL("image/png",1.0);
  const img3 = document.getElementById("c3").toDataURL("image/png",1.0);
  const img4 = document.getElementById("c4").toDataURL("image/png",1.0);

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
  const coll = new Intl.Collator("ru",{sensitivity:"base"});
  const s2 = [...dyn.branchRows].sort((a,b)=>coll.compare(a.b,b.b));
  const s3 = [...dyn.branchRowsS3].sort((a,b)=>coll.compare(a.b,b.b));
  const s4 = [...dyn.branchRowsS4].sort((a,b)=>coll.compare(a.b,b.b));
  const t2 = tableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)", s2, {p:"p2",c:"c2s",d:"d2"});
  const t3 = tableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425",     s3, {p:"p3",c:"c3s",d:"d3"});
  const t4 = tableHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª", s4, {p:"p4",c:"c4s",d:"d4"});

  // –ë–ª–æ–∫ —Å–ª–∞–π–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ (—Ñ–∏–∫—Å: fitbox –∞–≤—Ç–æ-–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ)
  const stagesMatrix = stageMatrixHTML("–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (Œî)", dyn.s2BranchStages);
  const stagesTotals = stageTotalsHTML("–ò—Ç–æ–≥–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º", dyn.stagesS2);

  const html = `<!doctype html><html><head><meta charset="utf-8"><title>–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –í–û–õ–°</title>
  <style>${document.querySelector("style").innerHTML}</style></head><body>
  <div class="slides">
    <section class="slide">
      <h1>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ë–ü<br>–ø–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é –í–û–õ–° –Ω–∞ –í–õ</h1>
      <div class="sub">–ü–µ—Ä–∏–æ–¥: ${prev.date} ‚Äî ${curr.date}</div>
      <div class="panel" style="height:calc(100% - 140px);overflow:auto">
        ${document.getElementById("pres_kpi").innerHTML}
      </div>
      <div class="num">1</div>
    </section>

    <section class="slide">
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–∏—Ç–æ–≥–æ)</h2>
      <div class="grid2">
        <div class="imgbox"><img src="${img2}" alt=""></div>
        <div class="panel">${t2}</div>
      </div>
      <div class="num">2</div>
    </section>

    <section class="slide">
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425</h2>
      <div class="grid2">
        <div class="imgbox"><img src="${img3}" alt=""></div>
        <div class="panel">${t3}</div>
      </div>
      <div class="num">3</div>
    </section>

    <section class="slide">
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
      <div class="grid2">
        <div class="imgbox"><img src="${img4}" alt=""></div>
        <div class="panel">${t4}</div>
      </div>
      <div class="num">4</div>
    </section>

    <!-- –°–ª–∞–π–¥ 5: –º–∞—Ç—Ä–∏—Ü–∞ + –∏—Ç–æ–≥–∏ –Ω–∞ –û–î–ù–û–ú —Å–ª–∞–π–¥–µ, –∞–≤—Ç–æ-—Å–∫–µ–π–ª -->
    <section class="slide" id="slide5">
      <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º —Ä–∞–±–æ—Ç</h2>
      <div class="sub">–ú–∞—Ç—Ä–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –∏—Ç–æ–≥–∏</div>
      <div class="fitbox"><div class="fit-inner" id="fit-inner">
        ${stagesMatrix}<br>${stagesTotals}
      </div></div>
      <div class="num">5</div>
    </section>
  </div>

  <script>
  (function(){
    function fit(){
      const box=document.querySelector('.fitbox'); const inner=document.getElementById('fit-inner');
      if(!box||!inner) return;
      inner.style.transform='scale(1)';
      inner.style.left='0px'; inner.style.top='0px';
      const sw=box.clientWidth, sh=box.clientHeight;
      const w=inner.scrollWidth, h=inner.scrollHeight;
      const sc=Math.min(sw/w, sh/h, 1);
      inner.style.transform='scale('+sc+')';
      inner.style.position='relative';
      inner.style.left=Math.max(0,(sw-w*sc)/2)+'px';
      inner.style.top =Math.max(0,(sh-h*sc)/2)+'px';
    }
    window.addEventListener('load', ()=>setTimeout(fit,30));
    window.addEventListener('resize', fit);
  })();
  </script>
  </body></html>`;

  const blob=new Blob([html],{type:"text/html;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
  a.download=`–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${curr.date.replace(/\./g,'-')}.html`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
}

/* ----------------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ----------------------- */
document.getElementById("btnParse").addEventListener("click", async ()=>{
  const fPrev=document.getElementById("filePrev").files[0];
  const fCurr=document.getElementById("fileCurr").files[0];
  if(!fPrev || !fCurr){ alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ PDF: –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏ —Ç–µ–∫—É—â–∏–π."); return; }
  msg("–û–±—Ä–∞–±–æ—Ç–∫–∞ PDF‚Ä¶");
  try{
    const [pPrev, pCurr] = await Promise.all([pdfToPages(fPrev), pdfToPages(fCurr)]);
    const prev=parseReport(pPrev), curr=parseReport(pCurr);
    const dyn=computeDynamics(curr, prev);
    DATA={prev,curr,dyn};
    document.getElementById("dates").textContent = `–î–∞—Ç—ã: –ø—Ä–µ–¥. ${prev.date} ‚Ä¢ —Ç–µ–∫. ${curr.date}`;

    // KPI
    renderKPIs(curr, prev, dyn);

    // –¢–∞–±–ª–∏—Ü—ã
    const sortRows = rows => [...rows].sort((a,b)=>Math.abs(b.d)-Math.abs(a.d));
    fillBranchTable(sortRows(dyn.branchRows),   "t2", {p:"p2", c:"c2s", d:"d2"});
    fillBranchTable(sortRows(dyn.branchRowsS3), "t3", {p:"p3", c:"c3s", d:"d3"});
    fillBranchTable(sortRows(dyn.branchRowsS4), "t4", {p:"p4", c:"c4s", d:"d4"});

    // –ì—Ä–∞—Ñ–∏–∫–∏
    renderCharts(curr, prev);

    // –°—Ç–∞–¥–∏–∏
    renderStagesTable(dyn.stagesS2, "st2");
    renderStagesTable(dyn.stagesS4, "st4");

    // –ü–µ—á–∞—Ç–Ω—ã–µ –±–ª–æ–∫–∏
    buildPrintable(curr, prev, dyn);

    msg("–ì–æ—Ç–æ–≤–æ ‚úî", true);
  }catch(e){
    console.error(e); msg("–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ PDF. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç—á—ë—Ç–æ–≤.");
    alert("–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ PDF. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.");
  }
});

document.getElementById("exportPresPDF").addEventListener("click", ()=>{ if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã."); exportPDF("presentationPrint","–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°.pdf"); });
document.getElementById("exportBriefPDF").addEventListener("click", ()=>{ if(!DATA) return alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç—á—ë—Ç—ã."); exportPDF("summaryPrint","–í—ã–∂–∏–º–∫–∞_–í–û–õ–°.pdf"); });
document.getElementById("exportDocHTML").addEventListener("click", exportWordHTML);
document.getElementById("exportPresHTML").addEventListener("click", exportPresentationHTML);
</script>
</body>
</html>
