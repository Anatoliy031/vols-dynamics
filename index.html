<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ВОЛС — Еженедельная динамика (АО «Россети Кубань»)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --rs-blue:#0033A0; /* Россети синий */
      --rs-light:#f4f7fb;
      --rs-accent:#0A84FF;
      --ok:#0a7a2d; --bad:#b00020; --muted:#5f6b7a;
      --card:#ffffff; --border:#e7edf5;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--rs-light);color:#0b1a2b;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(90deg,var(--rs-blue),#0953d6);
      color:#fff; padding:18px 20px; box-shadow:0 4px 18px rgba(0,0,0,.08)
    }
    .brand{display:flex;gap:14px;align-items:center;font-weight:800;letter-spacing:.2px}
    .brand .dot{width:14px;height:14px;border-radius:50%;background:#fff;opacity:.9}
    .container{max-width:1200px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px 16px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    @media(max-width:1024px){.grid.cols-4{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:720px){.grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr}}
    .inputs{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:10px;border:1px dashed var(--border);background:#fff;border-radius:12px;padding:12px}
    input[type=file]{border:none}
    button.primary{
      background:var(--rs-blue);color:#fff;border:none;border-radius:12px;padding:12px 14px;font-weight:700;letter-spacing:.2px;cursor:pointer
    }
    button.secondary{
      background:#fff;color:var(--rs-blue);border:1px solid var(--rs-blue);border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer
    }
    h2{margin:4px 0 10px 0;font-size:20px}
    h3{margin:10px 0;font-size:16px;color:var(--muted);font-weight:600}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
    @media(max-width:1024px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .kpi .title{color:var(--muted);font-size:12px;font-weight:600}
    .kpi .value{font-size:24px;font-weight:800;margin-top:6px}
    .delta{font-size:12px;margin-top:4px}
    .up{color:var(--ok)} .down{color:var(--bad)} .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:right;font-variant-numeric:tabular-nums}
    th:first-child, td:first-child{text-align:left}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:#f8fafc;color:#334155}
    .exports{display:flex;flex-wrap:wrap;gap:10px}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin:6px 0 12px}
    .note{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:12px 0}
    /* печатные области */
    #presentationPrint, #summaryPrint { background:#fff; padding:20px; }
    .logoTitle{font-weight:800;color:var(--rs-blue);font-size:22px;margin-bottom:6px}
  </style>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span><span>АО «Россети Кубань» — ВОЛС: аналитика и отчётность</span></div>
  </header>

  <div class="container grid cols-2">
    <section class="card">
      <h2>Загрузка отчётов (PDF)</h2>
      <div class="inputs">
        <label class="pill">Предыдущая неделя (PDF)
          <input id="filePrev" type="file" accept="application/pdf" />
        </label>
        <label class="pill">Текущая неделя (PDF)
          <input id="fileCurr" type="file" accept="application/pdf" />
        </label>
        <button id="btnParse" class="primary">Проанализировать</button>
        <span class="note">Скрипт извлечёт текст из PDF, распарсит 4 раздела и посчитает динамику.</span>
      </div>
      <div class="hr"></div>
      <div id="dates" class="note">Даты отчётов: —</div>
    </section>

    <section class="card">
      <h2>Выгрузки (оформление — формат Россети)</h2>
      <div class="exports">
        <button class="secondary" id="exportPresPDF">Скачать презентацию (PDF)</button>
        <button class="secondary" id="exportPresPPTX">Скачать презентацию (PPTX)</button>
        <button class="secondary" id="exportBriefDOCX">Скачать выжимку (Word)</button>
        <button class="secondary" id="exportBriefPDF">Скачать выжимку (PDF)</button>
      </div>
      <div class="hr"></div>
      <div class="note">«Выявлено за неделю» = «В работе всего, шт.» (текущая) − «В работе всего, шт.» (предыдущая).</div>
    </section>
  </div>

  <div class="container card">
    <div class="section-title">
      <h2>Ключевые показатели</h2>
      <span class="badge">Нарастающим итогом (год) + динамика за неделю</span>
    </div>
    <div id="kpis" class="kpis">
      <!-- будет заполнено скриптом -->
    </div>
  </div>

  <div class="container grid cols-2">
    <section class="card">
      <div class="section-title">
        <h2>В работе по устранению — по филиалам (всего, шт.)</h2>
        <span class="badge">Текущая vs Предыдущая</span>
      </div>
      <canvas id="chartBranches"></canvas>
      <div class="hr"></div>
      <div class="note">11 филиалов: Сочинские, Тимашевские, Тихорецкие, Усть‑Лабинские, Юго‑Западные, Адыгейские, Армавирские, Краснодарские, Лабинские, Ленинградские, Славянские.</div>
    </section>

    <section class="card">
      <div class="section-title">
        <h2>Таблица филиалов — динамика (в работе всего)</h2>
        <span class="badge">Δ = тек. − пред.</span>
      </div>
      <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px">
        <table id="tblBranches">
          <thead>
            <tr>
              <th>Филиал</th>
              <th>Пред., шт.</th>
              <th>Тек., шт.</th>
              <th>Δ, шт.</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="container grid cols-2">
    <section class="card">
      <div class="section-title">
        <h2>Приказ №425 — выявление (итоги по филиалам)</h2>
        <span class="badge">Срез текущей недели</span>
      </div>
      <canvas id="chart425"></canvas>
    </section>

    <section class="card">
      <div class="section-title">
        <h2>ПАО «Ростелеком» — бездоговорное размещение (по филиалам)</h2>
        <span class="badge">Срез текущей недели</span>
      </div>
      <canvas id="chartRTK"></canvas>
    </section>
  </div>

  <!-- Печатные области для PDF-экспорта -->
  <div id="presentationPrint" style="display:none">
    <div class="logoTitle">АО «Россети Кубань» — Презентация (еженедельная динамика ВОЛС)</div>
    <div id="presDates" style="margin-bottom:8px;font-size:12px;color:#475569"></div>
    <div id="presKpis"></div>
    <div class="hr"></div>
    <div id="presTable"></div>
  </div>

  <div id="summaryPrint" style="display:none">
    <div class="logoTitle">Краткая выжимка для руководителя</div>
    <div id="briefDates" style="margin-bottom:8px;font-size:12px;color:#475569"></div>
    <div id="briefBullets"></div>
    <div class="hr"></div>
    <div id="briefTable"></div>
  </div>

  <!-- ======= Библиотеки с CDN ======= -->
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script> pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"; </script>
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <!-- PptxGenJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.12.0/pptxgen.bundle.js"></script>
  <!-- docx.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.js"></script>
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- ======= Логика приложения ======= -->
  <script>
  // ====== Утилиты ======
  const BRANCHES = [
    "Сочинские ЭС","Тимашевские ЭС","Тихорецкие ЭС","Усть-Лабинские ЭС","Юго-Западные ЭС",
    "Адыгейские ЭС","Армавирские ЭС","Краснодарские ЭС","Лабинские ЭС","Ленинградские ЭС","Славянские ЭС"
  ];
  const STATUS_PATTERNS = [
    {key:"work",       re: /В работе у филиала/iu},
    {key:"dismantled", re: /Демонтировано/iu},
    {key:"rc_digit",   re: /Договор на оформлении\s+Россети\s+Цифра/iu},
    {key:"op_sign",    re: /Договор на подписании у оператора/iu},
    {key:"filial_appr",re: /Договор на согласовании в филиале/iu},
    {key:"incl_next",  re: /Будет включено.*доп.*соглашение/iu},
  ];
  const numberize = s => Number(String(s||"").replace(/[^\d]/g,"")) || 0;
  const fmt = n => n.toLocaleString("ru-RU");

  async function pdfToText(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    let text = "";
    for (let p=1;p<=pdf.numPages;p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const pageText = content.items.map(i => i.str).join("\n");
      text += "\n" + pageText;
    }
    return text;
  }

  function splitSections(text){
    // Грубое деление по заголовкам разделов
    const idx2 = text.search(/Информация о бездоговорном подвесе ВОЛС в филиалах/iu);
    const idx3 = text.search(/Выявление .*приказа.*425/iu);
    const idx4 = text.search(/Информация о бездоговорном размещении ПАО\s*«?Ростелеком/iu);
    return {
      head: text.slice(0, idx2>0?idx2:text.length),
      sec2: idx2>0 ? text.slice(idx2, idx3>0?idx3:text.length) : "",
      sec3: idx3>0 ? text.slice(idx3, idx4>0?idx4:text.length) : "",
      sec4: idx4>0 ? text.slice(idx4) : ""
    };
  }

  function extractDate(s){
    const m = s.match(/по состоянию на\s+(\d{2}\.\d{2}\.\d{4})/iu);
    return m ? m[1] : "—";
  }

  function parseTotals(head){
    const totals = {};
    const find = (re)=>{ const m = head.match(re); return numberize(m&&m[1]); }
    totals.found_year   = find(/выявлено[^0-9]*([\d\s]+)\s*шт/iu);
    totals.legalized    = find(/Узаконено[^0-9]*([\d\s]+)/iu);
    totals.dismantled_ytd = find(/За\s*20\d{2}\s*год\s*демонтировано[^0-9]*([\d\s]+)/iu);
    totals.in_work_total = find(/В работе[\s\S]*?всего[^0-9]*([\d\s]+)\s*шт/iu);
    totals.rtk_in_work   = find(/в том числе\s*ПАО\s*«?Ростелеком»?[^0-9]*([\d\s]+)/iu);
    return totals;
  }

  function parseBranchesBlock(block){
    // Возвращает Map branch -> { total, statuses{} }
    const res = new Map();
    // нормализуем переносы/двойные пробелы
    const text = block.replace(/[ \t]+/g," ").replace(/\n{2,}/g,"\n");

    // Для каждого филиала возьмём срез до следующего филиала/итога
    const positions = [];
    BRANCHES.forEach(b=>{
      let i=0; while((i = text.indexOf(b, i)) !== -1){ positions.push({b, i}); i+=b.length; }
    });
    positions.sort((a,b)=>a.i-b.i);
    for (let k=0;k<positions.length;k++){
      const {b,i} = positions[k];
      const end = (k+1<positions.length?positions[k+1].i:text.length);
      const slice = text.slice(i, end);
      // первое число после названия — "Всего опор, шт."
      const mTotal = slice.match(new RegExp(b.replace(/[()]/g,"\\$&")+`\\s+([\\d\\s]+)`,"iu"));
      const total = numberize(mTotal && mTotal[1]);
      const statuses = {};
      for (const sp of STATUS_PATTERNS){
        const m = slice.match(new RegExp(sp.re.source + "[^\\d]*([\\d\\s]+)","iu"));
        if (m) statuses[sp.key] = numberize(m[1]);
      }
      res.set(b, { total, statuses });
    }
    // Попробуем общий итог, если есть
    const sumMatch = text.match(/Общий итог[^0-9]*([\d\s]+)/iu);
    const overall = sumMatch ? numberize(sumMatch[1]) : Array.from(res.values()).reduce((s,r)=>s+(r.total||0),0);
    return { branches: res, overall };
  }

  function parseReport(text){
    const sections = splitSections(text);
    const report = {
      date: extractDate(text),
      totals: parseTotals(sections.head),
      s2: parseBranchesBlock(sections.sec2),
      s3: parseBranchesBlock(sections.sec3),
      s4: parseBranchesBlock(sections.sec4),
    };
    return report;
  }

  function computeDynamics(curr, prev){
    const dyn = {
      found_year: (curr.totals.found_year - prev.totals.found_year) || 0,
      legalized: (curr.totals.legalized - prev.totals.legalized) || 0,
      dismantled_ytd: (curr.totals.dismantled_ytd - prev.totals.dismantled_ytd) || 0,
      in_work_total: (curr.totals.in_work_total - prev.totals.in_work_total) || 0,
      rtk_in_work: (curr.totals.rtk_in_work - prev.totals.rtk_in_work) || 0,
    };
    // выявлено за неделю — по вашему правилу: разница "В работе всего"
    dyn.found_week = dyn.in_work_total;
    return dyn;
  }

  // ====== Рендер ======
  let chartBranches, chart425, chartRTK;
  function renderKpis(curr, prev, dyn){
    const host = document.getElementById("kpis");
    const items = [
      {title:"В работе всего, шт.", curr:curr.totals.in_work_total, prev:prev.totals.in_work_total, delta:dyn.in_work_total},
      {title:"Выявлено за неделю, шт.", curr:dyn.found_week, prev:0, delta:dyn.found_week},
      {title:"ПАО «Ростелеком» в работе, шт.", curr:curr.totals.rtk_in_work, prev:prev.totals.rtk_in_work, delta:dyn.rtk_in_work},
      {title:"Узаконено (нарастающим), шт.", curr:curr.totals.legalized, prev:prev.totals.legalized, delta:dyn.legalized},
      {title:"Демонтировано (нарастающим), шт.", curr:curr.totals.dismantled_ytd, prev:prev.totals.dismantled_ytd, delta:dyn.dismantled_ytd},
    ];
    host.innerHTML = items.map(it=>{
      const cls = it.delta>0?"up":(it.delta<0?"down":"muted");
      const sign = it.delta>0?"+":"";
      return `<div class="kpi">
        <div class="title">${it.title}</div>
        <div class="value">${fmt(it.curr)}</div>
        <div class="delta ${cls}">${sign}${fmt(it.delta)} по сравнению с пред. неделей</div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(curr, prev){
    const tbody = document.querySelector("#tblBranches tbody");
    tbody.innerHTML = "";
    const rows = BRANCHES.map(b=>{
      const c = curr.s2.branches.get(b)?.total || 0;
      const p = prev.s2.branches.get(b)?.total || 0;
      return {b, p, c, d:c-p};
    }).sort((a,b)=>b.d-a.d);
    for (const r of rows){
      const cls = r.d>0?"up":(r.d<0?"down":"muted");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.b}</td>
        <td>${fmt(r.p)}</td>
        <td>${fmt(r.c)}</td>
        <td class="${cls}">${r.d>0?"+":""}${fmt(r.d)}</td>`;
      tbody.appendChild(tr);
    }
    return rows;
  }

  function makeBarChart(ctx, labels, seriesPrev, seriesCurr, title){
    const data = {
      labels,
      datasets: [
        {label:"Пред.", data:seriesPrev},
        {label:"Тек.", data:seriesCurr}
      ]
    };
    if (ctx.chart) ctx.chart.destroy?.();
    const ch = new Chart(ctx, {
      type:"bar",
      data,
      options:{
        responsive:true,
        plugins:{legend:{position:"top"}, title:{display:true,text:title}},
        scales:{y:{beginAtZero:true}}
      }
    });
    ctx.chart = ch;
    return ch;
  }

  function renderCharts(curr, prev){
    // Основной (в работе всего)
    const labels = BRANCHES;
    const prevData = labels.map(b=>prev.s2.branches.get(b)?.total||0);
    const currData = labels.map(b=>curr.s2.branches.get(b)?.total||0);
    chartBranches = makeBarChart(document.getElementById("chartBranches"), labels, prevData, currData, "В работе всего, шт.");

    // Приказ 425 — возьмём текущее «Всего по филиалу» из секции 3
    const s3 = curr.s3;
    const s3Data = labels.map(b=>s3.branches.get(b)?.total||0);
    chart425 = new Chart(document.getElementById("chart425"), {
      type:"bar",
      data:{labels, datasets:[{label:"Всего (приказ 425)", data:s3Data}]},
      options:{responsive:true, plugins:{legend:{position:"top"}, title:{display:true,text:"Приказ 425 — выявление, всего по филиалам"}}}
    });

    // ПАО Ростелеком — секция 4
    const s4 = curr.s4;
    const s4Data = labels.map(b=>s4.branches.get(b)?.total||0);
    chartRTK = new Chart(document.getElementById("chartRTK"), {
      type:"bar",
      data:{labels, datasets:[{label:"Всего (ПАО «Ростелеком»)", data:s4Data}]},
      options:{responsive:true, plugins:{legend:{position:"top"}, title:{display:true,text:"ПАО «Ростелеком» — бездоговорное, всего по филиалам"}}}
    });
  }

  // ====== Экспорт ======
  function buildPresentationHTML(curr, prev, dyn, rows){
    document.getElementById("presDates").textContent = `Предыдущий отчёт: ${prev.date} · Текущий отчёт: ${curr.date}`;
    const h = (title, value, delta)=>`
      <div style="border:1px solid #e7edf5;border-radius:10px;padding:10px;margin:6px 0">
        <div style="color:#5f6b7a;font-size:12px">${title}</div>
        <div style="font-weight:800;font-size:18px">${fmt(value)}</div>
        <div style="font-size:12px;color:${delta>0?'#0a7a2d':(delta<0?'#b00020':'#5f6b7a')}">${delta>0?'+':''}${fmt(delta)} неделя к неделе</div>
      </div>`;
    document.getElementById("presKpis").innerHTML = `
      ${h("В работе всего, шт.", curr.totals.in_work_total, dyn.in_work_total)}
      ${h("Выявлено за неделю, шт.", dyn.found_week, dyn.found_week)}
      ${h("ПАО «Ростелеком» в работе, шт.", curr.totals.rtk_in_work, dyn.rtk_in_work)}
      ${h("Узаконено (нарастающим), шт.", curr.totals.legalized, dyn.legalized)}
      ${h("Демонтировано (нарастающим), шт.", curr.totals.dismantled_ytd, dyn.dismantled_ytd)}
    `;
    const tbl = `
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead><tr>
          <th style="text-align:left;border-bottom:1px solid #e7edf5;padding:6px 4px">Филиал</th>
          <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Пред.</th>
          <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Тек.</th>
          <th style="text-align:right;border-bottom:1px solid #e7edf5;padding:6px 4px">Δ</th>
        </tr></thead>
        <tbody>
          ${rows.map(r=>`<tr>
            <td style="padding:6px 4px">${r.b}</td>
            <td style="padding:6px 4px;text-align:right">${fmt(r.p)}</td>
            <td style="padding:6px 4px;text-align:right">${fmt(r.c)}</td>
            <td style="padding:6px 4px;text-align:right;color:${r.d>0?'#0a7a2d':(r.d<0?'#b00020':'#5f6b7a')}">${r.d>0?'+':''}${fmt(r.d)}</td>
          </tr>`).join("")}
        </tbody>
      </table>`;
    document.getElementById("presTable").innerHTML = tbl;
  }

  async function exportPresPDF(){
    const el = document.getElementById("presentationPrint");
    el.style.display = "block";
    await html2pdf().from(el).set({
      margin:10, filename:`Презентация_ВОЛС.pdf`,
      image:{type:'jpeg', quality:0.98},
      html2canvas:{scale:2},
      jsPDF:{unit:'mm', format:'a4', orientation:'portrait'}
    }).save();
    el.style.display = "none";
  }

  async function exportPresPPTX(curr, prev, dyn, rows){
    const pptx = new PptxGenJS();
    pptx.author = "АО «Россети Кубань»";
    pptx.company = "Россети";
    pptx.title = "Еженедельная динамика ВОЛС";

    const slide1 = pptx.addSlide();
    slide1.addText("АО «Россети Кубань»", {x:0.5,y:0.4,fontSize:18,bold:true,color:"0033A0"});
    slide1.addText("ВОЛС: еженедельная динамика", {x:0.5,y:1,fontSize:28,bold:true});
    slide1.addText(`Пред.: ${prev.date}  ·  Тек.: ${curr.date}`, {x:0.5,y:1.6,fontSize:12,color:"666"});

    const kpiBox = (title,val,delta, y) => {
      slide1.addText(title, {x:0.5,y, fontSize:12,color:"666"});
      slide1.addText(fmt(val), {x:0.5,y:y+0.25,fontSize:18,bold:true});
      slide1.addText(`${delta>0?'+':''}${fmt(delta)} неделя к неделе`, {x:3,y:y+0.25,fontSize:12,color: delta>0?'228B22': (delta<0?'B00020':'666')});
    };
    kpiBox("В работе всего, шт.", curr.totals.in_work_total, dyn.in_work_total, 2.2);
    kpiBox("Выявлено за неделю, шт.", dyn.found_week, dyn.found_week, 2.9);
    kpiBox("ПАО «Ростелеком» в работе, шт.", curr.totals.rtk_in_work, dyn.rtk_in_work, 3.6);
    kpiBox("Узаконено (нар.), шт.", curr.totals.legalized, dyn.legalized, 4.3);
    kpiBox("Демонтировано (нар.), шт.", curr.totals.dismantled_ytd, dyn.dismantled_ytd, 5.0);

    const slide2 = pptx.addSlide();
    slide2.addText("В работе всего — по филиалам", {x:0.5,y:0.4,fontSize:18,bold:true,color:"0033A0"});
    const table = {
      x:0.5,y:1.0, w:9.0,
      rows: [
        [{text:"Филиал",options:{bold:true}}, {text:"Пред.",options:{bold:true}}, {text:"Тек.",options:{bold:true}}, {text:"Δ",options:{bold:true}}],
        ...rows.map(r=>[r.b, fmt(r.p), fmt(r.c), (r.d>0?'+':'')+fmt(r.d)])
      ]
    };
    slide2.addTable(table.rows, {x:table.x,y:table.y,w:table.w,border:{pt:1,color:"DDDDDD"},fill:"FFFFFF"});

    await pptx.writeFile({fileName:"Презентация_ВОЛС.pptx"});
  }

  async function exportBriefDOCX(curr, prev, dyn, rows){
    const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType } = docx;
    const doc = new Document({
      sections:[{
        properties:{},
        children:[
          new Paragraph({children:[new TextRun({text:"АО «Россети Кубань» — Краткая выжимка", bold:true, size:28, color:"0033A0"})]}),
          new Paragraph({children:[new TextRun({text:`Пред.: ${prev.date} · Тек.: ${curr.date}`, size:20, color:"666666"})]}),
          new Paragraph({text:"", spacing:{after:120}}),
          ...[
            `В работе всего: ${fmt(curr.totals.in_work_total)} (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)} неделя к неделе)`,
            `Выявлено за неделю: ${fmt(dyn.found_week)}`,
            `ПАО «Ростелеком» в работе: ${fmt(curr.totals.rtk_in_work)} (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})`,
            `Узаконено (нарастающим): ${fmt(curr.totals.legalized)} (${dyn.legalized>0?'+':''}${fmt(dyn.legalized)})`,
            `Демонтировано (нарастающим): ${fmt(curr.totals.dismantled_ytd)} (${dyn.dismantled_ytd>0?'+':''}${fmt(dyn.dismantled_ytd)})`,
          ].map(t=>new Paragraph({children:[new TextRun({text:"• "+t, size:22})], spacing:{after:80}})),
          new Paragraph({text:"", spacing:{after:120}}),
          // Таблица филиалов
          new Table({
            width:{size:100, type:WidthType.PERCENTAGE},
            rows:[
              new TableRow({
                children:["Филиал","Пред., шт.","Тек., шт.","Δ, шт."].map(h=>new TableCell({children:[new Paragraph({children:[new TextRun({text:h, bold:true})]})]}))
              }),
              ...rows.map(r=>new TableRow({children:[
                new TableCell({children:[new Paragraph(r.b)]}),
                new TableCell({children:[new Paragraph(fmt(r.p))]}),
                new TableCell({children:[new Paragraph(fmt(r.c))]}),
                new TableCell({children:[new Paragraph((r.d>0?'+':'')+fmt(r.d))]})
              ]}))
            ]
          })
        ]
      }]
    });
    const blob = await Packer.toBlob(doc);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "Выжимка_ВОЛС.docx";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function exportBriefPDF(){
    const el = document.getElementById("summaryPrint");
    el.style.display = "block";
    await html2pdf().from(el).set({
      margin:10, filename:`Выжимка_ВОЛС.pdf`,
      image:{type:'jpeg', quality:0.98},
      html2canvas:{scale:2},
      jsPDF:{unit:'mm', format:'a4', orientation:'portrait'}
    }).save();
    el.style.display = "none";
  }

  // ====== Взаимодействие ======
  let DATA = null;

  document.getElementById("btnParse").addEventListener("click", async ()=>{
    const fPrev = document.getElementById("filePrev").files[0];
    const fCurr = document.getElementById("fileCurr").files[0];
    if(!fPrev || !fCurr){ alert("Загрузите оба PDF: предыдущий и текущий."); return; }
    // 1) Извлечь текст из PDF
    const [tPrev, tCurr] = await Promise.all([pdfToText(fPrev), pdfToText(fCurr)]);
    // 2) Распарсить
    const prev = parseReport(tPrev);
    const curr = parseReport(tCurr);
    const dyn  = computeDynamics(curr, prev);
    DATA = {prev, curr, dyn};

    // 3) Рендер
    document.getElementById("dates").textContent = `Предыдущий: ${prev.date} · Текущий: ${curr.date}`;
    renderKpis(curr, prev, dyn);
    const rows = renderBranchesTable(curr, prev);
    renderCharts(curr, prev);

    // 4) Подготовить печатные области
    buildPresentationHTML(curr, prev, dyn, rows);
    document.getElementById("briefDates").textContent = `Предыдущий: ${prev.date} · Текущий: ${curr.date}`;
    document.getElementById("briefBullets").innerHTML = `
      <div>• В работе всего: <b>${fmt(curr.totals.in_work_total)}</b> (<span>${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)}</span> неделя к неделе)</div>
      <div>• Выявлено за неделю: <b>${fmt(dyn.found_week)}</b></div>
      <div>• ПАО «Ростелеком» в работе: <b>${fmt(curr.totals.rtk_in_work)}</b> (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</div>
      <div>• Узаконено (нарастающим): <b>${fmt(curr.totals.legalized)}</b> (${dyn.legalized>0?'+':''}${fmt(dyn.legalized)})</div>
      <div>• Демонтировано (нарастающим): <b>${fmt(curr.totals.dismantled_ytd)}</b> (${dyn.dismantled_ytd>0?'+':''}${fmt(dyn.dismantled_ytd)})</div>
    `;
    document.getElementById("briefTable").innerHTML = document.getElementById("presTable").innerHTML;
  });

  document.getElementById("exportPresPDF").addEventListener("click", async ()=>{
    if(!DATA){ alert("Сначала проанализируйте отчёты."); return; }
    await exportPresPDF();
  });

  document.getElementById("exportPresPPTX").addEventListener("click", async ()=>{
    if(!DATA){ alert("Сначала проанализируйте отчёты."); return; }
    // rows из текущей таблицы
    const tbody = document.querySelector("#tblBranches tbody");
    const rows = Array.from(tbody.querySelectorAll("tr")).map(tr=>{
      const tds = tr.querySelectorAll("td");
      return { b:tds[0].textContent, p:numberize(tds[1].textContent), c:numberize(tds[2].textContent), d:numberize(tds[3].textContent)};
    });
    await exportPresPPTX(DATA.curr, DATA.prev, DATA.dyn, rows);
  });

  document.getElementById("exportBriefDOCX").addEventListener("click", async ()=>{
    if(!DATA){ alert("Сначала проанализируйте отчёты."); return; }
    const tbody = document.querySelector("#tblBranches tbody");
    const rows = Array.from(tbody.querySelectorAll("tr")).map(tr=>{
      const tds = tr.querySelectorAll("td");
      return { b:tds[0].textContent, p:numberize(tds[1].textContent), c:numberize(tds[2].textContent), d:numberize(tds[3].textContent)};
    });
    await exportBriefDOCX(DATA.curr, DATA.prev, DATA.dyn, rows);
  });

  document.getElementById("exportBriefPDF").addEventListener("click", async ()=>{
    if(!DATA){ alert("Сначала проанализируйте отчёты."); return; }
    await exportBriefPDF();
  });
  </script>
</body>
</html>
